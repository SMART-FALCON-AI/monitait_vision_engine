<!DOCTYPE html>
<html>
    <head>
        <title>MonitaQC Vision Engine - Status Monitor</title>
        <style>
            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --secondary-color: #06b6d4;
                --success-color: #10b981;
                --warning-color: #f59e0b;
                --danger-color: #ef4444;
                --dark-bg: #1e293b;
                --light-bg: #f8fafc;
                --card-bg: #ffffff;
                --text-primary: #0f172a;
                --text-secondary: #64748b;
                --border-color: #e2e8f0;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: var(--card-bg);
                padding: 30px;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
            }

            .header-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid var(--border-color);
            }

            .header-title {
                margin: 0;
                font-size: 32px;
                font-weight: 700;
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .status-box {
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                padding: 24px;
                border-radius: 12px;
                box-shadow: var(--shadow-md);
                margin-bottom: 24px;
                border: 1px solid var(--border-color);
                transition: all 0.3s ease;
            }

            .status-box:hover {
                box-shadow: var(--shadow-lg);
                transform: translateY(-2px);
            }
            .status-box-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            .status-box-item {
                text-align: center;
            }
            .status-box-label {
                font-size: 14px;
                color: #666;
                margin-bottom: 5px;
            }
            .status-box-value {
                font-size: 18px;
                font-weight: bold;
            }
            .timestamp-details {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
            .connected { color: #006600; }
            .disconnected { color: #cc0000; }
            .error { color: #cc6600; }
            .status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .status-item {
                background-color: #f8f9fa;
                padding: 15px;
                border-radius: 6px;
                border: 1px solid #dee2e6;
            }
            .status-item h3 {
                margin: 0 0 10px 0;
                color: #495057;
            }
            .status-value {
                font-size: 24px;
                font-weight: bold;
                color: #212529;
            }
            .status-unit {
                font-size: 14px;
                color: #666;
            }
            .range-bar {
                width: 100%;
                height: 8px;
                background: #ddd;
                border-radius: 4px;
                margin-top: 5px;
                overflow: hidden;
            }
            .range-fill {
                height: 100%;
                background: #4CAF50;
                transition: width 0.3s ease;
            }
            .range-text {
                font-size: 12px;
                color: #666;
                margin-top: 2px;
            }
            .movement-indicator {
                display: inline-block;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                margin-right: 10px;
                transition: background-color 0.3s ease;
            }
            .movement-moving {
                background-color: #4CAF50;
                animation: pulse 1s infinite;
            }
            .movement-stopped {
                background-color: #ff4444;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            .device-status {
                font-size: 14px;
                margin-top: 10px;
                padding: 10px;
                border-radius: 4px;
                background: #fff;
            }
            .device-status.error {
                background: #ffebee;
                color: #c62828;
            }
            .device-status.connected {
                background: #e8f5e9;
                color: #2e7d32;
            }
            .status-indicators {
                display: flex;
                gap: 20px;
                margin: 10px 0;
            }
            .status-indicator {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .status-circle {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background-color: #ccc;
            }
            .status-circle.active {
                animation: pulse 2s infinite;
            }
            .status-circle.U.active {
                background-color: #2196F3;
            }
            .status-circle.B.active {
                background-color: #2196F3;
            }
            .status-circle.warning.active {
                background-color: #f44336;
                animation: pulse 1s infinite;
            }
            .data-source {
                font-weight: bold;
                padding: 4px 8px;
                border-radius: 4px;
                margin-left: 10px;
            }
            .data-source.serial {
                background-color: #007bff;
                color: white;
            }
            .data-source.gpio {
                background-color: #28a745;
                color: white;
            }
            .data-source.none {
                background-color: #dc3545;
                color: white;
            }
            .control-panel {
                margin-top: 30px;
                padding: 20px;
                background-color: #f8f9fa;
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
            .verbose-panel {
                margin-top: 20px;
                padding: 15px;
                background-color: #fff;
                border-radius: 6px;
                border: 1px dashed #ced4da;
            }
            .verbose-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 10px;
            }
            .verbose-item-label {
                font-size: 13px;
                color: #555;
            }
            .verbose-item-value {
                font-size: 16px;
                font-weight: 600;
                margin-top: 2px;
            }
            .control-section {
                margin-bottom: 20px;
            }
            .control-section h3 {
                margin: 0 0 15px 0;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
                padding-bottom: 8px;
            }
            .control-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            .control-item {
                background: white;
                padding: 15px;
                border-radius: 6px;
                border: 1px solid #dee2e6;
            }
            .control-label {
                font-size: 14px;
                color: #666;
                margin-bottom: 8px;
            }
            .control-input {
                width: 100%;
                padding: 8px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                margin-bottom: 8px;
                box-sizing: border-box;
            }
            .control-button {
                width: 100%;
                padding: 8px;
                border: none;
                border-radius: 4px;
                background-color: #007bff;
                color: white;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .control-button:hover {
                background-color: #0056b3;
            }
            .control-button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            .control-response {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
                min-height: 20px;
            }
            .control-response.success {
                color: #28a745;
            }
            .control-response.error {
                color: #dc3545;
            }
            .camera-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            .camera-table th, .camera-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #dee2e6;
            }
            .camera-table th {
                background-color: #f8f9fa;
                font-weight: bold;
            }
            .camera-ok { color: #28a745; font-weight: bold; }
            .camera-fail { color: #dc3545; font-weight: bold; }

            /* Camera Discovery Styles */
            .discovery-section {
                background: white;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .discovery-controls {
                display: grid;
                grid-template-columns: 2fr 2fr 2fr 1fr;
                gap: 15px;
                margin-bottom: 20px;
                align-items: end;
            }
            .discovery-input-group {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .discovery-input-group label {
                font-size: 14px;
                color: #666;
                font-weight: 500;
            }
            .discovery-input {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }
            .discovery-button {
                padding: 10px 20px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: background 0.2s;
            }
            .discovery-button:hover {
                background: #0056b3;
            }
            .discovery-button:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }
            .discovery-status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-size: 14px;
            }
            .discovery-status.scanning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
            .discovery-status.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .discovery-status.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .discovered-cameras-list {
                display: grid;
                gap: 15px;
                margin-top: 20px;
            }
            .discovered-camera-item {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                padding: 15px;
                display: grid;
                grid-template-columns: 1fr 2fr auto;
                gap: 15px;
                align-items: center;
            }
            .discovered-camera-info {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .discovered-camera-ip {
                font-size: 16px;
                font-weight: bold;
                color: #333;
            }
            .discovered-camera-url {
                font-size: 12px;
                color: #666;
                font-family: monospace;
            }
            .discovered-camera-credentials {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .discovered-camera-credentials input {
                padding: 6px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 13px;
                width: 120px;
            }
            .discovered-camera-actions {
                display: flex;
                gap: 10px;
            }
            .test-camera-button {
                padding: 8px 16px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
            }
            .test-camera-button:hover {
                background: #218838;
            }
            .test-camera-button:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }
            .camera-preview-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                justify-content: center;
                align-items: center;
            }
            .camera-preview-content {
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow: auto;
            }
            .camera-preview-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            .camera-preview-close {
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
            }
            .camera-preview-image {
                max-width: 100%;
                border-radius: 4px;
            }

            /* Camera Monitoring Styles */
            .camera-monitor-section {
                background: white;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #e0e0e0;
            }
            .section-header h2 {
                margin: 0;
                color: #333;
            }
            .camera-refresh-status {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                background-color: #28a745;
                color: white;
            }
            .camera-refresh-status.paused {
                background-color: #ffc107;
                color: #000;
            }
            .camera-refresh-status.error {
                background-color: #dc3545;
            }
            .camera-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
            }
            .camera-card {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                border: 1px solid #e0e0e0;
            }
            .camera-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid #dee2e6;
            }
            .camera-card-title {
                font-size: 16px;
                font-weight: bold;
                color: #333;
            }
            .camera-status-badge {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                color: white;
            }
            .camera-status-badge.running { background-color: #28a745; }
            .camera-status-badge.stopped { background-color: #dc3545; }
            .camera-card-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .camera-image-container {
                text-align: center;
            }
            .camera-image {
                max-width: 100%;
                max-height: 200px;
                border: 2px solid #ddd;
                border-radius: 6px;
                object-fit: contain;
                background: #f0f0f0;
            }
            .camera-no-image {
                padding: 40px 15px;
                background: #f0f0f0;
                border: 2px dashed #ccc;
                border-radius: 6px;
                color: #666;
                font-style: italic;
                font-size: 13px;
            }
            .camera-info {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .camera-info-item {
                display: flex;
                justify-content: space-between;
                padding: 6px 10px;
                background: white;
                border-radius: 4px;
                font-size: 13px;
            }
            .camera-info-label { color: #666; }
            .camera-info-value { font-weight: bold; color: #333; }
            .camera-config-section {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #dee2e6;
            }
            .camera-config-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 10px;
            }
            .camera-config-item {
                display: flex;
                flex-direction: column;
            }
            .camera-config-item label {
                font-size: 11px;
                color: #666;
                margin-bottom: 3px;
            }
            .camera-config-item input {
                padding: 5px 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 12px;
            }
            .camera-actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 10px;
            }
            .camera-btn {
                padding: 5px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s;
            }
            .camera-btn-primary { background-color: #007bff; color: white; }
            .camera-btn-primary:hover { background-color: #0056b3; }
            .camera-btn-success { background-color: #28a745; color: white; }
            .camera-btn-success:hover { background-color: #218838; }
            .camera-btn-danger { background-color: #dc3545; color: white; }
            .camera-btn-danger:hover { background-color: #c82333; }
            .camera-btn-secondary { background-color: #6c757d; color: white; }
            .camera-btn-secondary:hover { background-color: #545b62; }
            .camera-message {
                padding: 6px 10px;
                border-radius: 4px;
                margin-top: 8px;
                font-size: 12px;
                display: none;
            }
            .camera-message.success { background-color: #d4edda; color: #155724; display: block; }
            .camera-message.error { background-color: #f8d7da; color: #721c24; display: block; }
            .camera-message.info { background-color: #d1ecf1; color: #0c5460; display: block; }
            .camera-loading {
                text-align: center;
                padding: 40px;
                color: #666;
                font-style: italic;
            }

            .timestamp-footer {
                font-size: 14px;
                color: #666;
                margin-top: 20px;
                text-align: center;
            }

            /* Tab Navigation Styles */
            .tab-navigation {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                border-bottom: none;
                margin-bottom: 20px;
                background: linear-gradient(135deg, var(--light-bg), #e0e7ff);
                padding: 12px;
                border-radius: 12px;
                box-shadow: var(--shadow-sm);
            }

            .tab-button {
                padding: 10px 16px;
                background: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                color: var(--text-secondary);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                white-space: nowrap;
                position: relative;
                flex-shrink: 0;
            }

            .tab-button:hover {
                color: var(--primary-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
                background: white;
            }

            .tab-button.active {
                color: white;
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                box-shadow: var(--shadow-md);
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header-container">
                <h1 class="header-title">MonitaQC Vision Engine</h1>

                <!-- Connection Status & Last Update -->
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 11px; color: rgba(255,255,255,0.8);">Connection Status:</span>
                        <span style="font-size: 12px; font-weight: 600; color: var(--success-color);" id="connection-status">Connecting...</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 11px; color: rgba(255,255,255,0.8);">Last Update:</span>
                        <span style="font-size: 11px; font-weight: 500; color: white;" id="timestamp">-</span>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 6px; background: var(--light-bg); padding: 6px 10px; border-radius: 6px;">
                        <span style="font-weight: 600; font-size: 12px; color: var(--text-primary);">Config:</span>
                        <button onclick="saveAllServiceConfig()" style="padding: 4px 10px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            üíæ Save
                        </button>
                        <button onclick="loadServiceConfig()" style="padding: 4px 10px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            üìÇ Load
                        </button>
                        <button onclick="exportServiceConfig()" style="padding: 4px 10px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            ‚¨áÔ∏è Export
                        </button>
                        <button onclick="importServiceConfig()" style="padding: 4px 10px; background: var(--warning-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            ‚¨ÜÔ∏è Import
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 11px; color: var(--text-secondary); white-space: nowrap;">Last saved: <strong id="last-saved-time">Never</strong></span>
                        <span class="data-source" id="dataSource" style="font-size: 11px;">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab-button" onclick="switchTab('cameras')">üì∑ Cameras</button>
                <button class="tab-button" onclick="switchTab('control')">üéõÔ∏è Control Panel</button>
                <button class="tab-button" onclick="switchTab('counter')">‚öôÔ∏è Ejector/Counter</button>
                <button class="tab-button" onclick="switchTab('hardware')">üîß Hardware</button>
                <button class="tab-button" onclick="switchTab('infrastructure')">üèóÔ∏è Infrastructure</button>
                <button class="tab-button" onclick="switchTab('gallery')">üñºÔ∏è Gallery</button>
                <button class="tab-button" onclick="switchTab('grafana')">üìà Charts</button>
                <button class="tab-button" onclick="switchTab('ai')">ü§ñ AI Assistant</button>
                <button class="tab-button" onclick="switchTab('advanced')">‚ö° Advanced</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <div style="display: grid; grid-template-columns: 350px 1fr; gap: 24px;">
                    <!-- Left Column: Status Info -->
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Shipment -->
                        <div class="status-box" style="padding: 8px;">
                            <div>
                                <div style="font-size: 9px; color: var(--text-secondary); margin-bottom: 2px;">Current Shipment</div>
                                <div id="shipment-value" style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" onclick="editShipmentId()">
                                    <span id="shipment-text">-</span>
                                    <span style="font-size: 10px; opacity: 0.6;">‚úèÔ∏è</span>
                                </div>
                                <input type="text" id="shipment-input" style="display: none; padding: 4px; border: 2px solid var(--primary-color); border-radius: 4px; font-weight: bold; font-size: 11px; width: 100%;" placeholder="Enter shipment ID">
                                <div style="display: none; gap: 4px; margin-top: 4px;" id="shipment-buttons">
                                    <button onclick="saveShipmentId()" style="padding: 3px 10px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 10px;">‚úì</button>
                                    <button onclick="cancelEditShipment()" style="padding: 3px 10px; background: var(--text-secondary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 10px;">‚úó</button>
                                </div>
                            </div>
                            <div style="font-size: 9px; color: var(--text-secondary); margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color);" id="device-status">Checking...</div>
                        </div>

                        <!-- Stats Columns -->
                        <div class="status-box" style="padding: 8px;">
                            <div style="display: flex; flex-direction: column; gap: 3px;">
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Encoder Value</div>
                                    <div style="font-size: 13px; font-weight: 700; color: var(--text-primary);" id="encoder-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Speed (PPM)</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="speed-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Pulses / Second</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="pps-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Movement Status</div>
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <span class="movement-indicator" id="movement-indicator" style="width: 8px; height: 8px;"></span>
                                        <span style="font-size: 11px; font-weight: 600;" id="movement-value">-</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Ejector Queue</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="ejector-queue">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Ejector Active</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="ejector-running">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Ejector Enabled</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="ejector-enabled">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Ejector Offset</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="ejector-offset">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">OK Counter</div>
                                    <div style="font-size: 12px; font-weight: 600; color: var(--success-color);" id="ok-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">NG Counter</div>
                                    <div style="font-size: 12px; font-weight: 600; color: var(--danger-color);" id="ng-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Downtime</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="downtime-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Analog (ANG)</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="analog-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Power (PWR)</div>
                                    <div style="font-size: 11px; font-weight: 600;" id="power-value">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Camera Streams -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Live Camera Feed -->
                        <div class="status-box" style="text-align: center; padding: 20px;">
                            <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 700; color: var(--text-primary);">üìπ Live Camera Feed</h3>
                            <img src="/video_feed" style="width: 100%; max-height: 500px; border: 2px solid var(--border-color); border-radius: 8px; object-fit: contain;" alt="Live Stream">
                        </div>

                        <!-- Detection Results Stream -->
                        <div class="status-box" style="text-align: center; padding: 20px;">
                            <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 700; color: var(--text-primary);">üéØ Detection Results Stream</h3>
                            <img src="/detection_stream" style="width: 100%; max-height: 500px; border: 2px solid var(--border-color); border-radius: 8px; object-fit: contain;" alt="Detection Stream">
                            <div style="margin-top: 12px; padding: 12px; background: var(--light-bg); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                                <div style="margin-bottom: 8px;">
                                    üî¥ <strong>Live Inference Stream</strong> |
                                    <span id="inference-service">Service: <strong id="inference-service-name" style="color: var(--primary-color);">...</strong></span>
                                    <span id="gradio-restart-warning" style="display: none; color: var(--danger-color); font-weight: bold;"> ‚ö†Ô∏è May Need Restart</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                                    <div>
                                        <span id="inference-time">Processing: <strong id="inference-time-value">...</strong></span>
                                    </div>
                                    <div>
                                        <span id="frame-interval">Interval: <strong id="frame-interval-value">...</strong></span>
                                    </div>
                                    <div>
                                        <span id="inference-fps">Inference FPS: <strong id="inference-fps-value">...</strong></span>
                                    </div>
                                    <div>
                                        <span id="capture-fps">Capture FPS: <strong id="capture-fps-value">...</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Notifications & Timeline Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <!-- Audio Notifications -->
                        <div class="status-box" style="padding: 15px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                <span>üîä</span> Audio Notifications
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="audio-enabled" onchange="toggleAudio()" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-weight: 600;">Enable Audio</span>
                                    </label>
                                    <button onclick="testAudio()" style="padding: 4px 10px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Test</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 12px; color: var(--text-secondary); min-width: 50px;">Volume:</span>
                                    <input type="range" id="audio-volume" min="0" max="100" value="50" onchange="updateVolume()" style="flex: 1; cursor: pointer;">
                                    <span id="audio-volume-display" style="font-size: 12px; min-width: 35px;">50%</span>
                                </div>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" id="audio-ok" checked onchange="updateSoundType('ok')">
                                        <span style="color: var(--success-color);">OK</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" id="audio-ng" checked onchange="updateSoundType('ng')">
                                        <span style="color: var(--danger-color);">NG</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                                        <input type="checkbox" id="audio-object" onchange="updateSoundType('object')">
                                        <span style="color: var(--primary-color);">Object</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline View -->
                        <div class="status-box" style="padding: 15px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                <span>üïê</span> Camera Timeline
                                <span style="font-size: 11px; font-weight: normal; color: var(--text-secondary);">(History)</span>
                            </h3>
                            <div style="text-align: center;">
                                <img id="timeline-image" src="/timeline_image" style="max-width: 100%; max-height: 200px; border: 1px solid var(--border-color); border-radius: 6px; background: #f0f0f0;" alt="Timeline" onerror="this.style.display='none'; document.getElementById('timeline-placeholder').style.display='block';">
                                <div id="timeline-placeholder" style="display: none; padding: 30px; color: var(--text-secondary); font-size: 13px;">
                                    Timeline will appear once cameras capture frames
                                </div>
                                <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
                                    Columns = Cameras | Rows = Time (newest at top)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Dashboard Tab -->

            <!-- Cameras Tab -->
            <div id="tab-cameras" class="tab-content">
                <!-- Camera Discovery Section -->
                <div class="discovery-section">
                <div class="section-header">
                    <h2>üîç IP Camera Discovery</h2>
                </div>

                <div class="discovery-controls">
                    <div class="discovery-input-group">
                        <label for="subnet-input">Network Subnet (first 3 octets)</label>
                        <input type="text" id="subnet-input" class="discovery-input" value="192.168.0" placeholder="192.168.0">
                        <small style="color: #666; font-size: 11px;">Scan for IP cameras on this subnet</small>
                    </div>
                    <div class="discovery-input-group" style="display: flex; align-items: flex-end;">
                        <button id="scan-button" class="discovery-button" onclick="scanForCameras()">üîé Scan Network</button>
                    </div>
                </div>

                <div id="discovery-status-container"></div>

                <div id="discovered-cameras-container"></div>
            </div>

            <!-- Camera Preview Modal -->
            <div id="camera-preview-modal" class="camera-preview-modal" onclick="closeCameraPreview(event)">
                <div class="camera-preview-content" onclick="event.stopPropagation()">
                    <div class="camera-preview-header">
                        <h3 id="preview-camera-title">Camera Preview</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="save-camera-button" class="discovery-button" onclick="saveDiscoveredCamera()" style="padding: 8px 16px;">üíæ Save Camera</button>
                            <button class="camera-preview-close" onclick="closeCameraPreview()">Close</button>
                        </div>
                    </div>
                    <div id="preview-camera-info"></div>
                    <img id="preview-camera-image" class="camera-preview-image" src="" alt="Camera preview">
                    <div id="preview-camera-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Camera Name (optional):</label>
                            <input type="text" id="save-camera-name" placeholder="e.g., Front Door Camera, Line 1 Camera" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Monitoring Section -->
            <div class="camera-monitor-section">
                <div class="section-header">
                    <h2>üì∑ Camera Monitoring</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="camera-refresh-status" id="camera-refresh-status">Active</span>
                        <button class="control-button" style="width: auto; padding: 6px 12px;" onclick="refreshCameras()">üîÑ Refresh</button>
                    </div>
                </div>

                <div id="camera-grid" class="camera-grid">
                    <div class="camera-loading">Loading cameras...</div>
                </div>
            </div>

            <!-- Legacy Camera Status Table (kept for backward compatibility) -->
            <div id="legacy-camera-status-container" style="display: none;">
                <h2>Camera Connection Status</h2>
                <table class="camera-table">
                    <thead>
                        <tr>
                            <th>Camera</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="camera-table-body">
                        <tr><td colspan="2">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            </div>
            <!-- End Cameras Tab -->

            <!-- Control Panel Tab -->
            <div id="tab-control" class="tab-content">
            <div class="control-panel">
                <h2>Control Panel</h2>

                <!-- Status Indicators -->
                <div class="control-section">
                    <h3>Status Indicators</h3>
                    <div class="status-box" style="padding: 16px;">
                        <div class="status-indicators" style="justify-content: center; gap: 40px;">
                            <div class="status-indicator">
                                <div class="status-circle U" id="U-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">U (Upper)</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-circle B" id="B-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">B (Bottom)</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-circle warning" id="warning-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">Warning</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Basic Controls</h3>
                    <div class="control-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="control-item" style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 10px;">
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('U_ON_B_ON')">Both On</button>
                                <div class="control-response" id="cmd-U_ON_B_ON-response"></div>
                            </div>
                            <div class="control-item" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <button class="control-button" onclick="sendCommand('U_ON_B_OFF')">U On, B Off</button>
                                    <div class="control-response" id="cmd-U_ON_B_OFF-response"></div>
                                </div>
                                <div>
                                    <button class="control-button" onclick="sendCommand('B_ON_U_OFF')">B On, U Off</button>
                                    <div class="control-response" id="cmd-B_ON_U_OFF-response"></div>
                                </div>
                            </div>
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('B_OFF_U_OFF')">Both Off</button>
                                <div class="control-response" id="cmd-B_OFF_U_OFF-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Upper PWM Value (0-255)</div>
                                <input type="number" class="control-input" id="pwm-up" min="0" max="255" value="255">
                                <button class="control-button" onclick="sendCommand('U_SET_PWM', document.getElementById('pwm-up').value)">Set Upper PWM</button>
                                <div class="control-response" id="cmd-U_SET_PWM-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Bottom PWM Value (0-255)</div>
                                <input type="number" class="control-input" id="pwm-down" min="0" max="255" value="255">
                                <button class="control-button" onclick="sendCommand('B_SET_PWM', document.getElementById('pwm-down').value)">Set Bottom PWM</button>
                                <div class="control-response" id="cmd-B_SET_PWM-response"></div>
                            </div>
                        </div>
                        <div class="control-item" style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 10px;">
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('RESET_ENCODER')">Reset Encoder</button>
                                <div class="control-response" id="cmd-RESET_ENCODER-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Warning LED</div>
                                <button class="control-button" onclick="sendCommand('WARNING_ON')">Warning On</button>
                                <button class="control-button" onclick="sendCommand('WARNING_OFF')" style="margin-top: 5px;">Warning Off</button>
                                <div class="control-response" id="cmd-WARNING-response"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Control Panel Tab -->

            <!-- Ejector/Counter Tab -->
            <div id="tab-counter" class="tab-content">
                <div class="control-section">
                    <h3>OK Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">OK Counter Adjustment</div>
                            <input type="number" class="control-input" id="ok-adjust" value="0">
                            <button class="control-button" onclick="sendCommand('OK_ADJUST', document.getElementById('ok-adjust').value)">Adjust OK Counter</button>
                            <div class="control-response" id="cmd-OK_ADJUST-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Offset Delay (milliseconds)</div>
                            <input type="number" class="control-input" id="ok-offset-delay" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('OK_OFFSET_DELAY', document.getElementById('ok-offset-delay').value)">Set Offset Delay</button>
                            <div class="control-response" id="cmd-OK_OFFSET_DELAY-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Pulses (16us each)</div>
                            <input type="number" class="control-input" id="ok-duration-pulses" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('OK_DURATION_PULSES', document.getElementById('ok-duration-pulses').value)">Set Duration Pulses</button>
                            <div class="control-response" id="cmd-OK_DURATION_PULSES-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Percent</div>
                            <input type="number" class="control-input" id="ok-duration-percent" min="0" max="100" value="0">
                            <button class="control-button" onclick="sendCommand('OK_DURATION_PERCENT', document.getElementById('ok-duration-percent').value)">Set Duration Percent</button>
                            <div class="control-response" id="cmd-OK_DURATION_PERCENT-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Encoder Factor</div>
                            <input type="number" class="control-input" id="ok-encoder-factor" value="0">
                            <button class="control-button" onclick="sendCommand('OK_ENCODER_FACTOR', document.getElementById('ok-encoder-factor').value)">Set Encoder Factor</button>
                            <div class="control-response" id="cmd-OK_ENCODER_FACTOR-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>NG Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">NG Counter Adjustment</div>
                            <input type="number" class="control-input" id="ng-adjust" value="0">
                            <button class="control-button" onclick="sendCommand('NG_ADJUST', document.getElementById('ng-adjust').value)">Adjust NG Counter</button>
                            <div class="control-response" id="cmd-NG_ADJUST-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Offset Delay (milliseconds)</div>
                            <input type="number" class="control-input" id="ng-offset-delay" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('NG_OFFSET_DELAY', document.getElementById('ng-offset-delay').value)">Set Offset Delay</button>
                            <div class="control-response" id="cmd-NG_OFFSET_DELAY-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Pulses (16us each)</div>
                            <input type="number" class="control-input" id="ng-duration-pulses" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('NG_DURATION_PULSES', document.getElementById('ng-duration-pulses').value)">Set Duration Pulses</button>
                            <div class="control-response" id="cmd-NG_DURATION_PULSES-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Percent</div>
                            <input type="number" class="control-input" id="ng-duration-percent" min="0" max="100" value="0">
                            <button class="control-button" onclick="sendCommand('NG_DURATION_PERCENT', document.getElementById('ng-duration-percent').value)">Set Duration Percent</button>
                            <div class="control-response" id="cmd-NG_DURATION_PERCENT-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Encoder Factor</div>
                            <input type="number" class="control-input" id="ng-encoder-factor" value="0">
                            <button class="control-button" onclick="sendCommand('NG_ENCODER_FACTOR', document.getElementById('ng-encoder-factor').value)">Set Encoder Factor</button>
                            <div class="control-response" id="cmd-NG_ENCODER_FACTOR-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Counter Service Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Ejector Enabled</div>
                            <select class="control-input" id="ejector-enabled-input">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('ejector_enabled', document.getElementById('ejector-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-ejector_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Ejector Offset (encoder counts)</div>
                            <input type="number" class="control-input" id="ejector-offset-input" min="0" value="0">
                            <button class="control-button" onclick="updateConfig('ejector_offset', document.getElementById('ejector-offset-input').value)">Set Offset</button>
                            <div class="control-response" id="config-ejector_offset-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Ejector Duration (seconds)</div>
                            <input type="number" class="control-input" id="ejector-duration-input" min="0" step="0.1" value="0.4">
                            <button class="control-button" onclick="updateConfig('ejector_duration', document.getElementById('ejector-duration-input').value)">Set Duration</button>
                            <div class="control-response" id="config-ejector_duration-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Ejector Poll Interval (seconds)</div>
                            <input type="number" class="control-input" id="ejector-poll-input" min="0.001" step="0.01" value="0.03">
                            <button class="control-button" onclick="updateConfig('ejector_poll_interval', document.getElementById('ejector-poll-input').value)">Set Poll Interval</button>
                            <div class="control-response" id="config-ejector_poll_interval-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Time Between Packages (seconds)</div>
                            <input type="number" class="control-input" id="time-between-packages-input" min="0" step="0.001" value="0.305">
                            <button class="control-button" onclick="updateConfig('time_between_packages', document.getElementById('time-between-packages-input').value)">Set Time</button>
                            <div class="control-response" id="config-time_between_packages-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Capture Mode</div>
                            <select class="control-input" id="capture-mode-input">
                                <option value="single">Single</option>
                                <option value="multiple">Multiple</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('capture_mode', document.getElementById('capture-mode-input').value)">Set Mode</button>
                            <div class="control-response" id="config-capture_mode-response"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Ejector/Counter Tab -->

            <!-- Hardware Tab -->
            <div id="tab-hardware" class="tab-content">
                <div class="control-section">
                    <h3>Serial Port Configuration</h3>
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: bold;">Device Status:</span>
                            <span id="serial-device-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="serial-device-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="serial-device-text">Checking...</span>
                            </span>
                            <span id="serial-device-info" style="font-size: 12px; color: #6c757d;"></span>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Serial Port Device</div>
                            <input type="text" class="control-input" id="watcher-usb-input" value="/dev/ttyUSB0" placeholder="/dev/ttyUSB0">
                            <button class="control-button" onclick="updateConfig('watcher_usb', document.getElementById('watcher-usb-input').value)">Set Port</button>
                            <div class="control-response" id="config-watcher_usb-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Baud Rate</div>
                            <select class="control-input" id="baud-rate-input">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600" selected>57600</option>
                                <option value="115200">115200</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('baud_rate', document.getElementById('baud-rate-input').value)">Set Baud Rate</button>
                            <div class="control-response" id="config-baud_rate-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Serial Mode</div>
                            <select class="control-input" id="serial-mode-input">
                                <option value="new" selected>Normal</option>
                                <option value="legacy">Legacy</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('serial_mode', document.getElementById('serial-mode-input').value)">Set Mode</button>
                            <div class="control-response" id="config-serial_mode-response"></div>
                        </div>
                    </div>
                    <div style="background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: #0c5460;">
                        ‚ÑπÔ∏è <strong>Auto-Apply:</strong> Serial port settings are applied immediately when changed. The connection will be reinitialized automatically.
                    </div>
                </div>

                <div class="control-section">
                    <h3>Watcher Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Downtime Threshold (seconds)</div>
                            <input type="number" class="control-input" id="downtime-threshold" min="1" value="10">
                            <button class="control-button" onclick="sendCommand('SET_DOWNTIME', document.getElementById('downtime-threshold').value)">Set Threshold</button>
                            <div class="control-response" id="cmd-SET_DOWNTIME-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">External Reset</div>
                            <select class="control-input" id="external-reset">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                            <button class="control-button" onclick="sendCommand('SET_EXTERNAL_RESET', document.getElementById('external-reset').value)">Set External Reset</button>
                            <div class="control-response" id="cmd-SET_EXTERNAL_RESET-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Verbose Mode</div>
                            <select class="control-input" id="verbose-mode">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                            <button class="control-button" onclick="sendCommand('SET_VERBOSE', document.getElementById('verbose-mode').value)">Set Verbose Mode</button>
                            <div class="control-response" id="cmd-SET_VERBOSE-response"></div>
                        </div>
                    </div>
                    <div class="verbose-panel" style="margin-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Watcher Verbose Configuration (Read-only)</h4>
                        <div class="verbose-grid">
                            <div>
                                <div class="verbose-item-label">OK Offset Delay (OOD)</div>
                                <div class="verbose-item-value" id="v-ood">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Duration Pulses (ODP)</div>
                                <div class="verbose-item-value" id="v-odp">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Duration Percent (ODL)</div>
                                <div class="verbose-item-value" id="v-odl">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Encoder Factor (OEF)</div>
                                <div class="verbose-item-value" id="v-oef">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Offset Delay (NOD)</div>
                                <div class="verbose-item-value" id="v-nod">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Duration Pulses (NDP)</div>
                                <div class="verbose-item-value" id="v-ndp">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Duration Percent (NDL)</div>
                                <div class="verbose-item-value" id="v-ndl">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Encoder Factor (NEF)</div>
                                <div class="verbose-item-value" id="v-nef">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">External Reset (EXT)</div>
                                <div class="verbose-item-value" id="v-ext">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">Baud Rate (BUD)</div>
                                <div class="verbose-item-value" id="v-bud">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">Downtime Threshold (DWT)</div>
                                <div class="verbose-item-value" id="v-dwt">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Hardware Tab -->

            <!-- Infrastructure Tab -->
            <div id="tab-infrastructure" class="tab-content">
                <div class="control-section">
                    <h3>Infrastructure Configuration</h3>
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: bold;">Redis:</span>
                                <span id="redis-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                    <span id="redis-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                    <span id="redis-text">Checking...</span>
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: bold;">YOLO:</span>
                                <span id="yolo-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                    <span id="yolo-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                    <span id="yolo-text">Checking...</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Redis Host</div>
                            <input type="text" class="control-input" id="redis-host-input" value="redis" placeholder="redis">
                            <button class="control-button" onclick="updateConfig('redis_host', document.getElementById('redis-host-input').value)">Set Host</button>
                            <div class="control-response" id="config-redis_host-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Redis Port</div>
                            <input type="number" class="control-input" id="redis-port-input" value="6379" placeholder="6379">
                            <button class="control-button" onclick="updateConfig('redis_port', document.getElementById('redis-port-input').value)">Set Port</button>
                            <div class="control-response" id="config-redis_port-response"></div>
                        </div>
                    </div>
                    <div style="background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: #0c5460;">
                        ‚ÑπÔ∏è <strong>Auto-Apply:</strong> Infrastructure settings are applied immediately when changed. Connections will be reinitialized automatically.
                    </div>
                </div>

                <div class="control-section">
                    <h3>Inference Pipeline Management</h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Active Pipeline:</span>
                            <span id="current-pipeline-name" style="font-size: 16px; font-weight: bold; color: #007bff;">Loading...</span>
                            <span style="color: #666;">|</span>
                            <span style="font-weight: bold; color: #333;">Current Model:</span>
                            <span id="current-model-name" style="font-size: 16px; font-weight: bold; color: #28a745;">Loading...</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="camera-btn camera-btn-primary" onclick="refreshPipelineConfig()">Refresh</button>
                        </div>
                    </div>

                    <!-- PIPELINES SECTION -->
                    <div style="background: #fff; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 8px;">Pipeline Configuration</h4>

                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Available Pipelines</h5>
                            <div id="pipelines-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <span style="color: #666; font-style: italic;">Loading pipelines...</span>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Create/Edit Pipeline</h5>
                            <div class="control-grid" style="margin-bottom: 15px;">
                                <div class="control-item">
                                    <div class="control-label">Pipeline Name <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="pipeline-name-input" placeholder="e.g., defect_detection">
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Description</div>
                                    <input type="text" class="control-input" id="pipeline-desc-input" placeholder="Pipeline description...">
                                </div>
                                <div class="control-item" style="grid-column: span 2;">
                                    <div class="control-label">Models in Pipeline (select models to include)</div>
                                    <div id="pipeline-models-checklist" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; background: white; border: 1px solid #ccc; border-radius: 4px;">
                                        <span style="color: #666; font-style: italic;">Loading models...</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="control-button" style="background-color: #007bff;" onclick="createOrUpdatePipeline()">Create/Update Pipeline</button>
                                <button class="control-button" style="background-color: #dc3545;" onclick="deletePipeline()">Delete Pipeline</button>
                            </div>
                            <div class="control-response" id="pipeline-response"></div>
                        </div>
                    </div>

                    <!-- MODELS SECTION -->
                    <div style="background: #fff; border: 2px solid #28a745; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 8px;">Inference Models</h4>

                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Available Models</h5>
                            <div id="models-list" style="display: flex; flex-direction: column; gap: 10px;">
                                <span style="color: #666; font-style: italic;">Loading models...</span>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Create/Edit Model</h5>
                            <div class="control-grid" style="margin-bottom: 15px;">
                                <div class="control-item">
                                    <div class="control-label">Model Name <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="model-name-input" placeholder="e.g., Gradio HuggingFace">
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Type <span style="color: #dc3545;">*</span></div>
                                    <select class="control-input" id="model-type-input" onchange="handleModelTypeChange()">
                                        <option value="gradio">Gradio</option>
                                        <option value="yolo">YOLO</option>
                                    </select>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Inference URL <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="model-url-input" placeholder="https://..." onchange="fetchModelsFromGradio()">
                                    <button class="control-button" style="font-size: 11px; padding: 4px 8px; margin-top: 4px;" onclick="fetchModelsFromGradio()">Fetch Models</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Model Name (for Gradio)</div>
                                    <select class="control-input" id="model-gradio-name-input">
                                        <option value="Data Matrix">Data Matrix</option>
                                        <option value="Dental Implant">Dental Implant</option>
                                        <option value="Ball Pen">Ball Pen</option>
                                        <option value="Knit Up">Knit Up</option>
                                        <option value="Knit Back">Knit Back</option>
                                        <option value="Jean Back">Jean Back</option>
                                        <option value="Jean Up">Jean Up</option>
                                        <option value="Tire Cord">Tire Cord</option>
                                        <option value="predict">predict</option>
                                        <option value="N/A">N/A</option>
                                    </select>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Min Confidence (0-1)</div>
                                    <input type="number" class="control-input" id="model-confidence-input" min="0" max="1" step="0.05" value="0.25">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="control-button" style="background-color: #28a745;" onclick="createOrUpdateModel()">Create/Update Model</button>
                                <button class="control-button" style="background-color: #dc3545;" onclick="deleteModel()">Delete Model</button>
                            </div>
                            <div class="control-response" id="model-response"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Infrastructure Tab -->

            <!-- Gallery Tab -->
            <div id="tab-gallery" class="tab-content">
                <div style="width: 100%; height: calc(100vh - 200px); min-height: 600px;">
                    <iframe
                        src="http://localhost:5000"
                        style="width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: var(--shadow-lg);"
                        title="Image Gallery - Pigallery2"
                        allow="fullscreen">
                    </iframe>
                </div>
            </div>
            <!-- End Gallery Tab -->

            <!-- Grafana Tab -->
            <div id="tab-grafana" class="tab-content">
                <div style="width: 100%; height: calc(100vh - 200px); min-height: 600px;">
                    <iframe
                        src="http://localhost:3000"
                        style="width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: var(--shadow-lg);"
                        title="Grafana Dashboard"
                        allow="fullscreen">
                    </iframe>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #0c5460;">üìä Grafana Dashboard</h4>
                    <p style="margin: 0; font-size: 13px; color: #0c5460;">
                        <strong>Default Credentials:</strong> admin / admin<br>
                        <strong>TimescaleDB Connection:</strong><br>
                        ‚Ä¢ Host: <code>timescaledb:5432</code><br>
                        ‚Ä¢ Database: <code>monitaqc</code><br>
                        ‚Ä¢ User: <code>monitaqc</code><br>
                        ‚Ä¢ Password: <code>monitaqc2024</code>
                    </p>
                </div>
            </div>
            <!-- End Grafana Tab -->

            <!-- AI Assistant Tab -->
            <div id="tab-ai" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; height: calc(100vh - 200px);">
                    <!-- Left: Chat Interface -->
                    <div style="display: flex; flex-direction: column; background: white; border-radius: 8px; box-shadow: var(--shadow-md); overflow: hidden;">
                        <!-- Chat Header -->
                        <div style="padding: 15px 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                            <h3 style="margin: 0; font-size: 18px;">ü§ñ AI Analytics Assistant</h3>
                            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">Ask me about production data, defects, and quality metrics</p>
                        </div>

                        <!-- Chat Messages -->
                        <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc;">
                            <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid var(--primary-color); margin-bottom: 15px; box-shadow: var(--shadow-sm);">
                                <p style="margin: 0 0 10px 0; font-weight: 600; color: var(--text-primary);">üëã Welcome! Try asking:</p>
                                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-secondary); line-height: 1.8;">
                                    <li>What's the defect rate for the last hour?</li>
                                    <li>Show me the most common defect types today</li>
                                    <li>Compare production speed vs quality metrics</li>
                                    <li>Analyze trends in the last 24 hours</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div style="padding: 15px; background: white; border-top: 1px solid var(--border-color);">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input
                                    type="text"
                                    id="ai-input"
                                    class="control-input"
                                    placeholder="Type your question here..."
                                    style="flex: 1; margin: 0; font-size: 14px; min-width: 0; width: 100%;"
                                    onkeypress="if(event.key === 'Enter') sendAIMessage()"
                                >
                                <button class="control-button" onclick="sendAIMessage()" style="background: var(--primary-color); padding: 8px 12px; font-size: 20px; white-space: nowrap; width: 50px; flex-shrink: 0;">
                                    üöÄ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Configuration Panel -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- AI Model Configuration -->
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: var(--shadow-sm);">
                            <h4 style="margin: 0 0 12px 0; font-size: 15px; color: var(--text-primary);">üîë AI Configuration</h4>

                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 5px; font-weight: 600;">Model:</label>
                                <select id="ai-model" class="control-input" style="margin: 0; font-size: 13px;" onchange="updateAIModelFields()">
                                    <option value="claude">Claude (Anthropic)</option>
                                    <option value="chatgpt">ChatGPT (OpenAI)</option>
                                    <option value="gemini">Gemini (Google)</option>
                                    <option value="local">Local Model</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 5px; font-weight: 600;" id="api-key-label">API Key:</label>
                                <input
                                    type="password"
                                    id="ai-api-key"
                                    class="control-input"
                                    placeholder="sk-ant-..."
                                    style="margin: 0; font-size: 13px;"
                                >
                            </div>

                            <button class="control-button" onclick="saveAIConfig()" style="width: 100%; background: var(--success-color); font-size: 13px;">
                                üíæ Save Configuration
                            </button>

                            <div id="api-link-container" style="margin: 10px 0 0 0; font-size: 11px; color: var(--text-secondary); text-align: center;">
                                <a href="https://console.anthropic.com/" target="_blank" id="api-link" style="color: var(--primary-color);">Get API Key ‚Üí</a>
                            </div>
                        </div>

                        <!-- Database Configuration -->
                        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: var(--shadow-sm);">
                            <h4 style="margin: 0 0 12px 0; font-size: 15px; color: var(--text-primary);">‚öôÔ∏è Database Info</h4>
                            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.8;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: var(--text-primary);">Host:</strong><br>
                                    <code style="background: var(--light-bg); padding: 2px 6px; border-radius: 3px; font-size: 11px;">localhost:5432</code>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: var(--text-primary);">Database:</strong><br>
                                    <code style="background: var(--light-bg); padding: 2px 6px; border-radius: 3px; font-size: 11px;">monitaqc</code>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: var(--text-primary);">User:</strong><br>
                                    <code style="background: var(--light-bg); padding: 2px 6px; border-radius: 3px; font-size: 11px;">monitaqc</code>
                                </div>
                                <div>
                                    <strong style="color: var(--text-primary);">Status:</strong>
                                    <span id="db-status" style="margin-left: 5px; padding: 2px 8px; background: var(--warning-color); color: white; border-radius: 3px; font-size: 11px; font-weight: 600;">Checking...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Tips -->
                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary-color);">
                            <h5 style="margin: 0 0 8px 0; font-size: 13px; color: var(--primary-color);">üí° Quick Tips</h5>
                            <ul style="margin: 0; padding-left: 18px; font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                                <li>Ask specific time ranges</li>
                                <li>Request comparisons</li>
                                <li>Ask for trends & patterns</li>
                                <li>Query by shipment ID</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End AI Assistant Tab -->

            <!-- Advanced Tab -->
            <div id="tab-advanced" class="tab-content">
                <div class="control-section">
                    <h3>Image Processing Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item" style="grid-column: span 2;">
                            <div class="control-label">Parent Object List (comma-separated, use _root for no parent requirement)</div>
                            <input type="text" class="control-input" id="parent-object-list-input" value="_root,box,pack,DP-105,jean,knit">
                            <button class="control-button" onclick="updateConfig('parent_object_list', document.getElementById('parent-object-list-input').value)">Set Parent Objects</button>
                            <div class="control-response" id="config-parent_object_list-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Remove Raw Image After DM Decode</div>
                            <select class="control-input" id="remove-raw-image-input">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('remove_raw_image_when_dm_decoded', document.getElementById('remove-raw-image-input').value)">Set</button>
                            <div class="control-response" id="config-remove_raw_image_when_dm_decoded-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>DataMatrix Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Valid DM Char Sizes (comma-separated)</div>
                            <input type="text" class="control-input" id="dm-chars-sizes-input" value="13,19,26">
                            <button class="control-button" onclick="updateConfig('dm_chars_sizes', document.getElementById('dm-chars-sizes-input').value)">Set Sizes</button>
                            <div class="control-response" id="config-dm_chars_sizes-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Confidence Threshold (0-1)</div>
                            <input type="number" class="control-input" id="dm-confidence-input" min="0" max="1" step="0.05" value="0.8">
                            <button class="control-button" onclick="updateConfig('dm_confidence_threshold', document.getElementById('dm-confidence-input').value)">Set Confidence</button>
                            <div class="control-response" id="config-dm_confidence_threshold-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Overlap Threshold (0-1)</div>
                            <input type="number" class="control-input" id="dm-overlap-input" min="0" max="1" step="0.05" value="0.2">
                            <button class="control-button" onclick="updateConfig('dm_overlap_threshold', document.getElementById('dm-overlap-input').value)">Set Overlap</button>
                            <div class="control-response" id="config-dm_overlap_threshold-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Feature Toggles</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Histogram Feature</div>
                            <select class="control-input" id="histogram-enabled-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('histogram_enabled', document.getElementById('histogram-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-histogram_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Save Histogram Images</div>
                            <select class="control-input" id="histogram-save-image-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('histogram_save_image', document.getElementById('histogram-save-image-input').value)">Set</button>
                            <div class="control-response" id="config-histogram_save_image-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Class Count Check (equal counts)</div>
                            <select class="control-input" id="check-class-enabled-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('check_class_counts_enabled', document.getElementById('check-class-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-check_class_counts_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Classes to Check (comma-separated)</div>
                            <input type="text" class="control-input" id="check-class-classes-input" value="socket,nozzle">
                            <button class="control-button" onclick="updateConfig('check_class_counts_classes', document.getElementById('check-class-classes-input').value)">Set Classes</button>
                            <div class="control-response" id="config-check_class_counts_classes-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Class Count Confidence Threshold</div>
                            <input type="number" class="control-input" id="check-class-confidence-input" value="0.5" min="0" max="1" step="0.05">
                            <button class="control-button" onclick="updateConfig('check_class_counts_confidence', document.getElementById('check-class-confidence-input').value)">Set</button>
                            <div class="control-response" id="config-check_class_counts_confidence-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Light Status Check (closed-loop)</div>
                            <select class="control-input" id="light-status-check-input">
                                <option value="false" selected>Disabled (open-loop, faster)</option>
                                <option value="true">Enabled (verify via serial)</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('light_status_check_enabled', document.getElementById('light-status-check-input').value)">Set</button>
                            <div class="control-response" id="config-light_status_check_enabled-response"></div>
                        </div>
                        <div class="control-item" style="grid-column: span 2;">
                            <div class="control-label">Store Annotations</div>
                            <div style="margin-bottom: 10px;">
                                <input type="text" class="control-input" id="postgres-uri-input" placeholder="postgresql://user:password@host:port/database" value="postgresql://monitaqc:monitaqc2024@timescaledb:5432/monitaqc" style="width: 100%; margin-bottom: 8px;">
                                <div style="display: flex; gap: 10px;">
                                    <select class="control-input" id="store-annotation-enabled-input" style="flex: 1;">
                                        <option value="false">Disabled</option>
                                        <option value="true">Enabled</option>
                                    </select>
                                    <button class="control-button" onclick="updateConfig('store_annotation_enabled', document.getElementById('store-annotation-enabled-input').value)">Set</button>
                                </div>
                            </div>
                            <div class="control-response" id="config-store_annotation_enabled-response"></div>
                            <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                <strong>Default TimescaleDB:</strong> <code>postgresql://monitaqc:monitaqc2024@timescaledb:5432/monitaqc</code>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>State Management (Camera Capture Control)</h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Current State:</span>
                            <span id="current-state-name" style="font-size: 16px; font-weight: bold; color: #007bff;">Loading...</span>
                            <span id="capture-state-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="camera-btn camera-btn-success" onclick="triggerCapture()">Trigger Capture</button>
                            <button class="camera-btn camera-btn-primary" onclick="refreshStates()">Refresh</button>
                        </div>
                        <div id="state-message" style="margin-top: 8px; padding: 6px 10px; border-radius: 4px; font-size: 12px; display: none;"></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Available States</h4>
                        <div id="states-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading states...</span>
                        </div>
                    </div>

                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Create/Edit State (Multi-Phase Capture)</h4>
                        <div class="control-grid" style="margin-bottom: 15px;">
                            <div class="control-item">
                                <div class="control-label">State Name</div>
                                <input type="text" class="control-input" id="state-name-input" placeholder="e.g., default">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Enabled</div>
                                <select class="control-input" id="state-enabled-input">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5 style="margin: 0; color: #495057;">Capture Phases</h5>
                                <button class="camera-btn camera-btn-success" onclick="addPhase()" style="padding: 4px 10px; font-size: 11px;">+ Add Phase</button>
                            </div>

                            <div id="phases-container">
                                <!-- Phase 1 (default) - all cameras -->
                                <div class="phase-row" id="phase-row-0" style="display: grid; grid-template-columns: 1.2fr 0.8fr 1fr 0.8fr 0.8fr auto; gap: 6px; align-items: end; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Light Mode</label>
                                        <select class="control-input phase-light" style="margin: 0; padding: 4px; font-size: 12px;">
                                            <option value="U_ON_B_OFF" selected>U On, B Off</option>
                                            <option value="U_OFF_B_ON">U Off, B On</option>
                                            <option value="U_ON_B_ON">U On, B On</option>
                                            <option value="U_OFF_B_OFF">U Off, B Off</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Delay (s)</label>
                                        <input type="number" class="control-input phase-delay" value="0.1" min="0" step="0.01" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Cameras</label>
                                        <input type="text" class="control-input phase-cameras" value="1,2,3,4" placeholder="1,2,3,4" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Steps (-1=loop)</label>
                                        <input type="number" class="control-input phase-steps" value="1" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Analog (-1=off)</label>
                                        <input type="number" class="control-input phase-analog" value="-1" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <button class="camera-btn camera-btn-danger" onclick="removePhase(0)" style="padding: 4px 8px; font-size: 11px;">‚úï</button>
                                </div>
                            </div>
                            <p style="font-size: 10px; color: #888; margin: 8px 0 0 0;">Steps: -1=infinite loop, 1=every step, N=every N steps. Analog: -1=disabled, N=trigger when analog‚â•N.</p>
                        </div>

                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="control-button" style="background-color: #28a745;" onclick="createOrUpdateState()">Create/Update State</button>
                            <button class="control-button" style="background-color: #dc3545;" onclick="deleteCurrentState()">Delete State</button>
                        </div>
                        <div class="control-response" id="state-config-response"></div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Data File Editor</h3>
                    <div style="margin-bottom: 10px;">
                        <span class="control-label">File: </span><span id="data-file-path">Loading...</span>
                        <button class="control-button" style="width: auto; margin-left: 10px;" onclick="loadDataFile()">Reload</button>
                    </div>
                    <textarea id="data-file-content" class="control-input" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="control-button" style="background-color: #6c757d;" onclick="formatDataFile()">Format JSON</button>
                    </div>
                    <div class="control-response" id="data-file-response"></div>
                    <div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 4px; font-size: 12px; color: #0c5460;">
                        ‚ÑπÔ∏è <strong>Note:</strong> Use the "üíæ Save" button at the top of the page to save both service config and data file.
                    </div>
                </div>
            </div>
            <!-- End Advanced Tab -->

            <p class="timestamp-footer" id="refresh-footer">Real-time updates via SSE</p>
        </div>

        <script>
            // ===== Audio Notification System =====
            // Settings stored in localStorage and synced with DATA_FILE
            let audioSettings = {
                enabled: false,
                volume: 0.5,
                okSound: true,
                ngSound: true,
                objectSound: false
            };
            let audioContext = null;
            let lastEventTimestamp = 0;

            // Load audio settings from localStorage
            function loadAudioSettings() {
                const saved = localStorage.getItem('audioSettings');
                if (saved) {
                    try {
                        audioSettings = { ...audioSettings, ...JSON.parse(saved) };
                    } catch (e) {
                        console.error('Error loading audio settings:', e);
                    }
                }
                updateAudioUI();
            }

            // Save audio settings to localStorage
            function saveAudioSettings() {
                localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
                // Also save to server DATA_FILE
                fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ audio: audioSettings })
                }).catch(e => console.error('Error saving audio settings to server:', e));
            }

            // Update UI to reflect current settings
            function updateAudioUI() {
                const enabledEl = document.getElementById('audio-enabled');
                const volumeEl = document.getElementById('audio-volume');
                const okEl = document.getElementById('audio-ok');
                const ngEl = document.getElementById('audio-ng');
                const objectEl = document.getElementById('audio-object');
                const volumeDisplay = document.getElementById('audio-volume-display');

                if (enabledEl) enabledEl.checked = audioSettings.enabled;
                if (volumeEl) volumeEl.value = audioSettings.volume * 100;
                if (okEl) okEl.checked = audioSettings.okSound;
                if (ngEl) ngEl.checked = audioSettings.ngSound;
                if (objectEl) objectEl.checked = audioSettings.objectSound;
                if (volumeDisplay) volumeDisplay.textContent = Math.round(audioSettings.volume * 100) + '%';
            }

            // Initialize Web Audio API (must be called after user interaction)
            function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }

            // Play a beep sound using Web Audio API
            function playBeep(frequency, duration, type = 'sine') {
                if (!audioContext || !audioSettings.enabled) return;

                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = type;
                    oscillator.frequency.value = frequency;

                    gainNode.gain.setValueAtTime(audioSettings.volume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                } catch (e) {
                    console.error('Error playing beep:', e);
                }
            }

            // Play OK sound (pleasant ascending tone)
            function playOkSound() {
                if (!audioSettings.okSound) return;
                playBeep(523, 0.15, 'sine');  // C5
                setTimeout(() => playBeep(659, 0.15, 'sine'), 100);  // E5
                setTimeout(() => playBeep(784, 0.2, 'sine'), 200);  // G5
            }

            // Play NG sound (warning descending tone)
            function playNgSound() {
                if (!audioSettings.ngSound) return;
                playBeep(440, 0.2, 'square');  // A4
                setTimeout(() => playBeep(349, 0.2, 'square'), 150);  // F4
                setTimeout(() => playBeep(262, 0.3, 'square'), 300);  // C4
            }

            // Play object detected sound (short beep)
            function playObjectSound() {
                if (!audioSettings.objectSound) return;
                playBeep(880, 0.1, 'sine');  // A5
            }

            // Handle detection event from SSE
            function handleDetectionEvent(event) {
                if (!event || !audioSettings.enabled) return;

                // Debounce: don't play sounds for same timestamp
                if (event.timestamp === lastEventTimestamp) return;
                lastEventTimestamp = event.timestamp;

                // Initialize audio context on first event (browsers require user interaction)
                initAudioContext();

                switch (event.type) {
                    case 'ok':
                        playOkSound();
                        break;
                    case 'ng':
                        playNgSound();
                        break;
                    case 'object':
                    case 'datamatrix':
                        playObjectSound();
                        break;
                }
            }

            // Toggle audio enabled
            function toggleAudio() {
                const enabledEl = document.getElementById('audio-enabled');
                audioSettings.enabled = enabledEl.checked;
                if (audioSettings.enabled) {
                    initAudioContext();
                    // Play test sound to confirm audio is working
                    playBeep(440, 0.1, 'sine');
                }
                saveAudioSettings();
            }

            // Update volume
            function updateVolume() {
                const volumeEl = document.getElementById('audio-volume');
                const volumeDisplay = document.getElementById('audio-volume-display');
                audioSettings.volume = volumeEl.value / 100;
                if (volumeDisplay) volumeDisplay.textContent = Math.round(audioSettings.volume * 100) + '%';
                saveAudioSettings();
            }

            // Update sound type toggles
            function updateSoundType(type) {
                const el = document.getElementById('audio-' + type);
                if (type === 'ok') audioSettings.okSound = el.checked;
                else if (type === 'ng') audioSettings.ngSound = el.checked;
                else if (type === 'object') audioSettings.objectSound = el.checked;
                saveAudioSettings();
            }

            // Test audio button
            function testAudio() {
                initAudioContext();
                const originalEnabled = audioSettings.enabled;
                audioSettings.enabled = true;
                playOkSound();
                setTimeout(() => playNgSound(), 600);
                audioSettings.enabled = originalEnabled;
            }

            // Tab switching functionality
            function switchTab(tabName) {
                // Hide all tab contents
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(tab => tab.classList.remove('active'));

                // Remove active class from all buttons
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(btn => btn.classList.remove('active'));

                // Show selected tab content
                const selectedTab = document.getElementById('tab-' + tabName);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }

                // Add active class to clicked button
                event.target.classList.add('active');

                // Save selected tab to localStorage
                localStorage.setItem('selectedTab', tabName);
            }

            // Restore last selected tab on page load
            document.addEventListener('DOMContentLoaded', function() {
                const savedTab = localStorage.getItem('selectedTab');
                if (savedTab) {
                    const tabButton = document.querySelector(`.tab-button[onclick="switchTab('${savedTab}')"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }
            });

            // Shipment ID editing functionality
            function editShipmentId() {
                const shipmentValue = document.getElementById('shipment-value');
                const shipmentInput = document.getElementById('shipment-input');
                const shipmentButtons = document.getElementById('shipment-buttons');
                const shipmentText = document.getElementById('shipment-text');

                // Hide the display value, show input and buttons
                shipmentValue.style.display = 'none';
                shipmentInput.style.display = 'block';
                shipmentButtons.style.display = 'flex';

                // Set current value in input
                shipmentInput.value = shipmentText.textContent;
                shipmentInput.focus();
                shipmentInput.select();
            }

            function cancelEditShipment() {
                const shipmentValue = document.getElementById('shipment-value');
                const shipmentInput = document.getElementById('shipment-input');
                const shipmentButtons = document.getElementById('shipment-buttons');

                // Show the display value, hide input and buttons
                shipmentValue.style.display = 'flex';
                shipmentInput.style.display = 'none';
                shipmentButtons.style.display = 'none';
            }

            async function saveShipmentId() {
                const shipmentInput = document.getElementById('shipment-input');
                const newShipmentId = shipmentInput.value.trim() || 'no_shipment';

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            shipment: newShipmentId
                        })
                    });

                    if (response.ok) {
                        const shipmentText = document.getElementById('shipment-text');
                        shipmentText.textContent = newShipmentId;
                        cancelEditShipment();

                        // Show success message
                        const statusBox = shipmentInput.closest('.status-box-item');
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = 'color: var(--success-color); font-size: 12px; margin-top: 4px;';
                        successMsg.textContent = '‚úì Shipment ID updated';
                        statusBox.appendChild(successMsg);
                        setTimeout(() => successMsg.remove(), 3000);
                    } else {
                        alert('Failed to update shipment ID');
                    }
                } catch (error) {
                    console.error('Error updating shipment ID:', error);
                    alert('Error updating shipment ID');
                }
            }

            // Allow Enter key to save
            document.addEventListener('DOMContentLoaded', function() {
                const shipmentInput = document.getElementById('shipment-input');
                if (shipmentInput) {
                    shipmentInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            saveShipmentId();
                        } else if (e.key === 'Escape') {
                            cancelEditShipment();
                        }
                    });
                }
            });

            // Service Configuration functions
            async function saveAllServiceConfig() {
                try {
                    // Save service config
                    const response1 = await fetch('/api/save_service_config', { method: 'POST' });
                    // Save data file
                    const response2 = await fetch('/api/save_data_file', { method: 'POST' });

                    if (response1.ok && response2.ok) {
                        const timestamp = new Date().toISOString();
                        document.getElementById('last-saved-time').textContent = timestamp;
                        alert('‚úì All settings saved successfully!');
                    } else {
                        alert('‚ùå Failed to save settings');
                    }
                } catch (error) {
                    console.error('Error saving config:', error);
                    alert('‚ùå Error saving settings');
                }
            }

            async function loadServiceConfig() {
                if (!confirm('Load saved service configuration? This will reload the page.')) return;
                try {
                    const response = await fetch('/api/load_service_config', { method: 'POST' });
                    if (response.ok) {
                        alert('‚úì Configuration loaded! Reloading page...');
                        location.reload();
                    } else {
                        alert('‚ùå Failed to load configuration');
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                    alert('‚ùå Error loading configuration');
                }
            }

            async function exportServiceConfig() {
                try {
                    const response = await fetch('/api/export_service_config');
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `monitaqc_config_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        alert('‚ùå Failed to export configuration');
                    }
                } catch (error) {
                    console.error('Error exporting config:', error);
                    alert('‚ùå Error exporting configuration');
                }
            }

            function importServiceConfig() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch('/api/import_service_config', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            alert('‚úì Configuration imported! Reloading page...');
                            location.reload();
                        } else {
                            alert('‚ùå Failed to import configuration');
                        }
                    } catch (error) {
                        console.error('Error importing config:', error);
                        alert('‚ùå Error importing configuration');
                    }
                };
                input.click();
            }

            // AI Assistant Functions
            function updateAIModelFields() {
                const model = document.getElementById('ai-model').value;
                const apiKeyLabel = document.getElementById('api-key-label');
                const apiKeyInput = document.getElementById('ai-api-key');
                const apiLink = document.getElementById('api-link');

                const modelConfigs = {
                    'claude': {
                        label: 'Anthropic API Key:',
                        placeholder: 'sk-ant-...',
                        link: 'https://console.anthropic.com/',
                        linkText: 'Anthropic Console'
                    },
                    'chatgpt': {
                        label: 'OpenAI API Key:',
                        placeholder: 'sk-...',
                        link: 'https://platform.openai.com/api-keys',
                        linkText: 'OpenAI Platform'
                    },
                    'gemini': {
                        label: 'Google API Key:',
                        placeholder: 'AI...',
                        link: 'https://makersuite.google.com/app/apikey',
                        linkText: 'Google AI Studio'
                    },
                    'local': {
                        label: 'Model Endpoint:',
                        placeholder: 'http://localhost:11434',
                        link: 'https://ollama.ai/',
                        linkText: 'Ollama Documentation'
                    }
                };

                const config = modelConfigs[model];
                apiKeyLabel.textContent = config.label;
                apiKeyInput.placeholder = config.placeholder;
                apiLink.href = config.link;
                apiLink.textContent = config.linkText;
            }

            async function saveAIConfig() {
                const model = document.getElementById('ai-model').value;
                const apiKey = document.getElementById('ai-api-key').value;

                if (!apiKey.trim()) {
                    alert('‚ùå Please enter an API key or endpoint');
                    return;
                }

                try {
                    const response = await fetch('/api/ai_config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model, api_key: apiKey })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('‚úì AI configuration saved successfully!');
                    } else {
                        alert(`‚ùå Failed to save configuration: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error saving AI config:', error);
                    alert(`‚ùå Error saving configuration: ${error.message}`);
                }
            }

            async function sendAIMessage() {
                const input = document.getElementById('ai-input');
                const message = input.value.trim();

                if (!message) return;

                const chatMessages = document.getElementById('ai-chat-messages');

                // Add user message
                const userMsg = document.createElement('div');
                userMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 8px; text-align: right;';
                userMsg.innerHTML = `<strong>You:</strong> ${message}`;
                chatMessages.appendChild(userMsg);

                // Clear input
                input.value = '';

                // Add loading indicator
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'ai-loading';
                loadingMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px;';
                loadingMsg.innerHTML = '<strong>AI:</strong> <span style="animation: pulse 1.5s infinite;">Thinking...</span>';
                chatMessages.appendChild(loadingMsg);

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;

                try {
                    const response = await fetch('/api/ai_query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: message })
                    });

                    const data = await response.json();

                    // Remove loading indicator
                    loadingMsg.remove();

                    // Add AI response
                    const aiMsg = document.createElement('div');
                    aiMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: #f0f4f8; border-radius: 8px; border-left: 4px solid var(--primary-color);';
                    aiMsg.innerHTML = `<strong>AI:</strong> ${data.response || data.error || 'No response'}`;
                    chatMessages.appendChild(aiMsg);

                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                } catch (error) {
                    console.error('Error querying AI:', error);
                    loadingMsg.remove();

                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: #ffebee; border-radius: 8px; color: #c62828;';
                    errorMsg.innerHTML = `<strong>Error:</strong> Failed to get AI response. Please check your configuration.`;
                    chatMessages.appendChild(errorMsg);

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        </script>

        <script>
            // Update UI with status data (used by SSE stream)
            function updateStatusUI(data) {
                document.getElementById('encoder-value').textContent = data.encoder_value || 0;
                document.getElementById('speed-value').textContent = (data.ppm || 0).toFixed ? (data.ppm || 0).toFixed(2) : data.ppm || 0;
                document.getElementById('pps-value').textContent = data.pps || 0;
                document.getElementById('ok-counter').textContent = data.ok_counter || 0;
                document.getElementById('ng-counter').textContent = data.ng_counter || 0;
                document.getElementById('downtime-value').textContent = data.downtime_seconds || 0;
                document.getElementById('analog-value').textContent = data.analog_value || 0;
                document.getElementById('power-value').textContent = data.power_value || 0;
                const shipmentText = document.getElementById('shipment-text');
                if (shipmentText) {
                    shipmentText.textContent = data.shipment || 'no_shipment';
                }
                document.getElementById('ejector-queue').textContent = data.ejector_queue_length || 0;
                document.getElementById('ejector-running').textContent = data.ejector_running ? 'Yes' : 'No';
                document.getElementById('ejector-enabled').textContent = data.ejector_enabled ? 'Yes' : 'No';
                document.getElementById('ejector-offset').textContent = data.ejector_offset || 0;
                document.getElementById('timestamp').textContent = data.timestamp;

                // Update movement status
                const movementIndicator = document.getElementById('movement-indicator');
                const movementValue = document.getElementById('movement-value');
                if (data.is_moving) {
                    movementIndicator.className = 'movement-indicator movement-moving';
                    movementValue.textContent = 'Moving';
                } else {
                    movementIndicator.className = 'movement-indicator movement-stopped';
                    movementValue.textContent = 'Stopped';
                }

                // Update U/B/Warning status circles
                const status = data.status || {};
                const uEl = document.getElementById('U-status');
                const bEl = document.getElementById('B-status');
                const wEl = document.getElementById('warning-status');
                if (uEl) uEl.className = 'status-circle U' + (status.U ? ' active' : '');
                if (bEl) bEl.className = 'status-circle B' + (status.B ? ' active' : '');
                if (wEl) wEl.className = 'status-circle warning' + (status.warning ? ' active' : '');

                // Update serial device status
                const serialDevice = data.serial_device || {};
                const serialDot = document.getElementById('serial-device-dot');
                const serialText = document.getElementById('serial-device-text');
                const serialInfo = document.getElementById('serial-device-info');
                if (serialDot && serialText && serialInfo) {
                    if (serialDevice.connected) {
                        serialDot.style.background = '#28a745';
                        serialText.textContent = 'Connected';
                        serialText.style.color = '#28a745';
                        serialInfo.textContent = `${serialDevice.port} @ ${serialDevice.baudrate} (${serialDevice.mode})`;
                    } else {
                        serialDot.style.background = '#dc3545';
                        serialText.textContent = 'Disconnected';
                        serialText.style.color = '#dc3545';
                        serialInfo.textContent = `${serialDevice.port} not accessible`;
                    }
                }

                // Update connection status
                const connectionStatus = document.getElementById('connection-status');
                const deviceStatus = document.getElementById('device-status');
                if (serialDevice.connected) {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'status-box-value connected';
                    deviceStatus.textContent = 'Device connected and accessible';
                    deviceStatus.className = 'device-status connected';
                } else {
                    connectionStatus.textContent = 'Camera Only';
                    connectionStatus.className = 'status-box-value';
                    deviceStatus.textContent = 'Serial not connected';
                    deviceStatus.className = 'device-status';
                }

                // Update verbose configuration values
                const v = data.verbose_data || {};
                const setVerbose = (id, key) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = (v[key] === undefined || v[key] === null) ? '-' : v[key];
                };
                setVerbose('v-ood', 'OOD');
                setVerbose('v-odp', 'ODP');
                setVerbose('v-odl', 'ODL');
                setVerbose('v-oef', 'OEF');
                setVerbose('v-nod', 'NOD');
                setVerbose('v-ndp', 'NDP');
                setVerbose('v-ndl', 'NDL');
                setVerbose('v-nef', 'NEF');
                setVerbose('v-ext', 'EXT');
                setVerbose('v-bud', 'BUD');
                setVerbose('v-dwt', 'DWT');
            }

            // Server-Sent Events for real-time status updates
            let statusEventSource = null;

            function startStatusStream() {
                if (statusEventSource) {
                    statusEventSource.close();
                }

                statusEventSource = new EventSource('/api/status/stream');
                const dataSource = document.getElementById('dataSource');

                statusEventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        updateStatusUI(data);

                        // Update cameras from SSE
                        if (data.cameras) {
                            updateCameraTable(data.cameras);
                        }

                        // Update inference stats from SSE
                        if (data.inference) {
                            const inf = data.inference;
                            const avgTimeEl = document.getElementById('avg-inference-time');
                            const avgIntervalEl = document.getElementById('avg-frame-interval');
                            const fpsEl = document.getElementById('inference-fps');
                            if (avgTimeEl) avgTimeEl.textContent = inf.avg_time_ms.toFixed(1) + ' ms';
                            if (avgIntervalEl) avgIntervalEl.textContent = inf.avg_interval_ms.toFixed(1) + ' ms';
                            if (fpsEl) fpsEl.textContent = inf.fps.toFixed(1) + ' FPS';
                        }

                        // Update health/infrastructure from SSE
                        if (data.health) {
                            const updateInfraStatus = (prefix, available) => {
                                const dot = document.getElementById(`${prefix}-dot`);
                                const text = document.getElementById(`${prefix}-text`);
                                if (dot && text) {
                                    dot.style.background = available ? '#28a745' : '#6c757d';
                                    text.textContent = available ? 'Connected' : 'Not Available';
                                    text.style.color = available ? '#28a745' : '#6c757d';
                                }
                            };
                            updateInfraStatus('redis', data.health.redis === 'connected');

                            const restartWarning = document.getElementById('gradio-restart-warning');
                            if (restartWarning) {
                                restartWarning.style.display = data.health.gradio_needs_restart ? 'inline' : 'none';
                            }
                        }

                        // Handle detection events for audio notification
                        if (data.detection_event && audioSettings.enabled) {
                            handleDetectionEvent(data.detection_event);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                    }
                };

                statusEventSource.onerror = function(error) {
                    console.log('SSE reconnecting...');
                    dataSource.textContent = 'RECONNECTING';
                    dataSource.className = 'data-source';
                };

                statusEventSource.onopen = function() {
                    console.log('SSE connected');
                    dataSource.textContent = 'LIVE';
                    dataSource.className = 'data-source serial';
                };
            }

            // Refresh timeline image periodically (every 2 seconds)
            let timelineRefreshInterval = null;
            function startTimelineRefresh() {
                if (timelineRefreshInterval) clearInterval(timelineRefreshInterval);
                timelineRefreshInterval = setInterval(() => {
                    const timelineImg = document.getElementById('timeline-image');
                    const placeholder = document.getElementById('timeline-placeholder');
                    if (timelineImg) {
                        // Add timestamp to force browser to reload
                        const newSrc = '/timeline_image?t=' + Date.now();
                        const testImg = new Image();
                        testImg.onload = () => {
                            timelineImg.src = newSrc;
                            timelineImg.style.display = 'block';
                            if (placeholder) placeholder.style.display = 'none';
                        };
                        testImg.onerror = () => {
                            timelineImg.style.display = 'none';
                            if (placeholder) placeholder.style.display = 'block';
                        };
                        testImg.src = newSrc;
                    }
                }, 2000);
            }

            // Fetch health data (infrastructure status) - called periodically
            function fetchHealth() {
                fetch('/health')
                    .then(response => response.json())
                    .then(data => {
                        const restartWarning = document.getElementById('gradio-restart-warning');
                        if (restartWarning) {
                            restartWarning.style.display = data.gradio_needs_restart ? 'inline' : 'none';
                        }
                        if (data.cameras) {
                            updateCameraTable(data.cameras);
                        }
                        const updateInfraStatus = (prefix, available) => {
                            const dot = document.getElementById(`${prefix}-dot`);
                            const text = document.getElementById(`${prefix}-text`);
                            if (dot && text) {
                                dot.style.background = available ? '#28a745' : '#6c757d';
                                text.textContent = available ? 'Connected' : 'Not Available';
                                text.style.color = available ? '#28a745' : '#6c757d';
                            }
                        };
                        updateInfraStatus('redis', data.redis === 'connected');
                        updateInfraStatus('yolo', data.yolo === 'connected');
                    })
                    .catch(error => console.error('Error fetching health:', error));
            }

            // Legacy polling fallback (not used with SSE)
            function fetchStatus() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => updateStatusUI(data))
                    .catch(error => console.error('Error fetching status:', error));
            }

            // Separate function to fetch config - only called once on page load
            function fetchConfig() {
                fetch('/config')
                    .then(response => response.json())
                    .then(data => {
                        // Update counter service configuration inputs with current values
                        if (data.ejector) {
                            document.getElementById('ejector-enabled-input').value = data.ejector.enabled ? 'true' : 'false';
                            document.getElementById('ejector-offset-input').value = data.ejector.offset || 0;
                            document.getElementById('ejector-duration-input').value = data.ejector.duration || 0.4;
                            document.getElementById('ejector-poll-input').value = data.ejector.poll_interval || 0.03;
                        }
                        if (data.capture) {
                            document.getElementById('time-between-packages-input').value = data.capture.time_between_packages || 0.305;
                            document.getElementById('capture-mode-input').value = data.capture.mode || 'single';
                        }
                        // Image processing configuration
                        if (data.image_processing) {
                            document.getElementById('parent-object-list-input').value = (data.image_processing.parent_object_list || []).join(',');
                            document.getElementById('remove-raw-image-input').value = data.image_processing.remove_raw_image_when_dm_decoded ? 'true' : 'false';
                        }
                        // DataMatrix configuration
                        if (data.datamatrix) {
                            document.getElementById('dm-chars-sizes-input').value = (data.datamatrix.chars_sizes || [13,19,26]).join(',');
                            document.getElementById('dm-confidence-input').value = data.datamatrix.confidence_threshold || 0.8;
                            document.getElementById('dm-overlap-input').value = data.datamatrix.overlap_threshold || 0.2;
                        }
                        // Class count check configuration
                        if (data.class_count_check) {
                            document.getElementById('check-class-enabled-input').value = data.class_count_check.enabled ? 'true' : 'false';
                            document.getElementById('check-class-classes-input').value = (data.class_count_check.classes || []).join(',');
                            document.getElementById('check-class-confidence-input').value = data.class_count_check.confidence || 0.5;
                        }
                        // Light control configuration
                        if (data.light_control) {
                            document.getElementById('light-status-check-input').value = data.light_control.status_check_enabled ? 'true' : 'false';
                        }
                        // Histogram configuration
                        if (data.histogram) {
                            document.getElementById('histogram-enabled-input').value = data.histogram.enabled ? 'true' : 'false';
                            document.getElementById('histogram-save-image-input').value = data.histogram.save_image ? 'true' : 'false';
                        }
                        // Store annotation configuration
                        if (data.store_annotation) {
                            document.getElementById('store-annotation-enabled-input').value = data.store_annotation.enabled ? 'true' : 'false';
                            document.getElementById('postgres-info').textContent =
                                `PostgreSQL: ${data.store_annotation.postgres_host}:${data.store_annotation.postgres_port}/${data.store_annotation.postgres_db}`;
                        }
                        // Serial configuration
                        if (data.serial) {
                            document.getElementById('watcher-usb-input').value = data.serial.port || '/dev/ttyUSB0';
                            document.getElementById('baud-rate-input').value = data.serial.baud_rate || 57600;
                            document.getElementById('serial-mode-input').value = data.serial.mode || 'legacy';
                        }
                        // Infrastructure configuration
                        if (data.infrastructure) {
                            document.getElementById('redis-host-input').value = data.infrastructure.redis_host || 'redis';
                            document.getElementById('redis-port-input').value = data.infrastructure.redis_port || 6379;
                            document.getElementById('yolo-url-input').value = data.infrastructure.yolo_url || 'http://yolo_inference:4442/v1/object-detection/yolov5s/detect/';
                            document.getElementById('gradio-confidence-input').value = data.infrastructure.gradio_confidence || 0.25;
                        }
                    })
                    .catch(error => console.error('Error fetching config:', error));
            }

            // Data file functions
            async function loadDataFile() {
                try {
                    const response = await fetch('/api/data-file');
                    const data = await response.json();

                    if (response.ok) {
                        document.getElementById('data-file-path').textContent = data.file_path;
                        document.getElementById('data-file-content').value = data.content;
                    } else {
                        document.getElementById('data-file-path').textContent = 'Error loading';
                        document.getElementById('data-file-content').value = 'Error: ' + (data.detail || 'Unknown error');
                    }
                } catch (error) {
                    document.getElementById('data-file-path').textContent = 'Error';
                    document.getElementById('data-file-content').value = 'Error: ' + error.message;
                }
            }

            async function saveDataFile() {
                const responseEl = document.getElementById('data-file-response');
                const content = document.getElementById('data-file-content').value;

                try {
                    // Validate JSON first
                    JSON.parse(content);

                    const response = await fetch('/api/data-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: content })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Saved! ${data.entries_count} entries. Backup: ${data.backup_path}`;
                        responseEl.className = 'control-response success';
                    } else {
                        responseEl.textContent = `Error: ${data.detail || 'Unknown error'}`;
                        responseEl.className = 'control-response error';
                    }

                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 5000);
                } catch (error) {
                    responseEl.textContent = `Error: ${error.message}`;
                    responseEl.className = 'control-response error';
                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 5000);
                }
            }

            function formatDataFile() {
                const textarea = document.getElementById('data-file-content');
                const responseEl = document.getElementById('data-file-response');

                try {
                    const parsed = JSON.parse(textarea.value);
                    textarea.value = JSON.stringify(parsed, null, 2);
                    responseEl.textContent = 'JSON formatted successfully';
                    responseEl.className = 'control-response success';
                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 2000);
                } catch (error) {
                    responseEl.textContent = `Invalid JSON: ${error.message}`;
                    responseEl.className = 'control-response error';
                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 3000);
                }
            }

            function updateCameraTable(cameras) {
                const tbody = document.getElementById('camera-table-body');
                const container = document.getElementById('legacy-camera-status-container');
                tbody.innerHTML = '';

                const cameraNames = {
                    'cam_1': 'Camera 1',
                    'cam_2': 'Camera 2',
                    'cam_3': 'Camera 3',
                    'cam_4': 'Camera 4'
                };

                // Only show the table if there are cameras
                const hasCameras = Object.keys(cameras).length > 0;
                container.style.display = hasCameras ? 'block' : 'none';

                if (!hasCameras) {
                    return;
                }

                for (const [key, status] of Object.entries(cameras)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cameraNames[key] || key}</td>
                        <td class="${status ? 'camera-ok' : 'camera-fail'}">${status ? 'OK' : 'FAIL'}</td>
                    `;
                    tbody.appendChild(row);
                }
            }

            async function fetchGradioModels() {
                try {
                    const response = await fetch('/api/gradio/models');
                    const data = await response.json();

                    if (data.models && Array.isArray(data.models)) {
                        const modelSelect = document.getElementById('gradio-model-select');
                        modelSelect.innerHTML = '';  // Clear existing options

                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            modelSelect.appendChild(option);
                        });

                        console.log(`Loaded ${data.models.length} models from ${data.source}`);
                    }
                } catch (error) {
                    console.error('Failed to fetch Gradio models:', error);
                }
            }

            function updateAPITypeFields() {
                const apiType = document.getElementById('api-type-select').value;
                const urlLabel = document.getElementById('yolo-url-label');
                const urlInput = document.getElementById('yolo-url-input');
                const modelSelector = document.getElementById('gradio-model-selector');
                const confidenceField = document.getElementById('gradio-confidence-field');

                if (apiType === 'gradio') {
                    urlLabel.textContent = 'Gradio API URL (HuggingFace Space)';
                    urlInput.value = 'https://smartfalcon-ai-industrial-defect-detection.hf.space';
                    urlInput.placeholder = 'https://smartfalcon-ai-industrial-defect-detection.hf.space';
                    modelSelector.style.display = 'block';  // Show model selector
                    confidenceField.style.display = 'block';  // Show confidence field
                    // Fetch models from Gradio
                    fetchGradioModels();
                    // Show helper text
                    const responseDiv = document.getElementById('config-yolo_url-response');
                    responseDiv.innerHTML = '<span style="color: #0c5460;">üí° HuggingFace Space URL set - click "Set URL" to apply</span>';
                } else {
                    urlLabel.textContent = 'YOLO Inference URL';
                    urlInput.value = 'http://yolo_inference:4442/v1/object-detection/yolov5s/detect/';
                    urlInput.placeholder = 'http://yolo_inference:4442/v1/object-detection/yolov5s/detect/';
                    modelSelector.style.display = 'none';  // Hide model selector
                    confidenceField.style.display = 'none';  // Hide confidence field
                    const responseDiv = document.getElementById('config-yolo_url-response');
                    responseDiv.innerHTML = '';
                }
            }

            async function updateConfig(key, value) {
                const responseId = `config-${key}-response`;
                const responseEl = document.getElementById(responseId);

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ [key]: value })
                    });

                    const data = await response.json();

                    if (responseEl) {
                        if (response.ok) {
                            responseEl.textContent = `OK: ${key} = ${value}`;
                            responseEl.className = 'control-response success';

                            // Check if serial was reinitialized
                            if (data.serial_reinitialized) {
                                responseEl.textContent = `OK: ${key} = ${value} - Serial connection reinitialized`;
                            }

                            setTimeout(() => {
                                responseEl.textContent = '';
                                responseEl.className = 'control-response';
                            }, 3000);
                        } else {
                            responseEl.textContent = `Error: ${data.detail || 'Unknown error'}`;
                            responseEl.className = 'control-response error';
                            setTimeout(() => {
                                responseEl.textContent = '';
                                responseEl.className = 'control-response';
                            }, 3000);
                        }
                    }
                } catch (error) {
                    if (responseEl) {
                        responseEl.textContent = `Error: ${error.message}`;
                        responseEl.className = 'control-response error';
                        setTimeout(() => {
                            responseEl.textContent = '';
                            responseEl.className = 'control-response';
                        }, 3000);
                    }
                }
            }

            async function sendCommand(command, value = null) {
                const responseId = `cmd-${command}-response`;
                const responseEl = document.getElementById(responseId);

                try {
                    let url = `/${command}`;
                    if (value !== null) {
                        url += `?value=${value}`;
                    }

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (responseEl) {
                        if (response.ok) {
                            responseEl.textContent = `OK: ${data.command}`;
                            responseEl.className = 'control-response success';
                        } else {
                            responseEl.textContent = `Error: ${data.detail || 'Unknown error'}`;
                            responseEl.className = 'control-response error';
                        }

                        setTimeout(() => {
                            responseEl.textContent = '';
                            responseEl.className = 'control-response';
                        }, 3000);
                    }
                } catch (error) {
                    if (responseEl) {
                        responseEl.textContent = `Error: ${error.message}`;
                        responseEl.className = 'control-response error';
                        setTimeout(() => {
                            responseEl.textContent = '';
                            responseEl.className = 'control-response';
                        }, 3000);
                    }
                }
            }

            // ===== CAMERA MONITORING FUNCTIONS =====
            // Direct camera control through counter service API
            let cameraData = {};
            let cameraRefreshInterval = null;
            let isCameraUpdating = false;

            async function fetchCameraStatus() {
                if (isCameraUpdating) return;

                const statusEl = document.getElementById('camera-refresh-status');
                try {
                    statusEl.textContent = 'Updating...';
                    statusEl.className = 'camera-refresh-status';

                    const response = await fetch('/api/cameras');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Failed to get camera status');
                    }

                    const cameras = await response.json();

                    if (cameras.error) {
                        throw new Error(cameras.error);
                    }

                    cameraData = {};
                    cameras.forEach(c => cameraData[c.id] = c);

                    renderCameraCards();

                    statusEl.textContent = 'Active';
                    statusEl.className = 'camera-refresh-status';
                } catch (error) {
                    console.error('Error fetching camera status:', error);
                    statusEl.textContent = 'Error';
                    statusEl.className = 'camera-refresh-status error';

                    const grid = document.getElementById('camera-grid');
                    grid.innerHTML = `
                        <div class="camera-loading" style="color: #dc3545;">
                            ‚ö†Ô∏è Could not load camera status<br>
                            <small style="color: #666;">${error.message}</small>
                        </div>
                    `;
                }
            }

            function renderCameraCards() {
                const grid = document.getElementById('camera-grid');
                const cameraIds = Object.keys(cameraData).sort((a, b) => parseInt(a) - parseInt(b));

                if (cameraIds.length === 0) {
                    grid.innerHTML = '<div class="camera-loading">No cameras detected</div>';
                    return;
                }

                grid.innerHTML = '';
                cameraIds.forEach(cameraId => {
                    const camera = cameraData[cameraId];
                    const card = createCameraCard(cameraId, camera);
                    grid.appendChild(card);
                });
            }

            function createCameraCard(cameraId, camera) {
                const div = document.createElement('div');
                div.className = 'camera-card';
                div.id = `camera-card-${cameraId}`;

                const config = camera.config || {};
                const isConnected = camera.connected;
                const isIPCamera = camera.type === 'ip';
                const cameraName = camera.name || `Camera ${cameraId}`;

                div.innerHTML = `
                    <div class="camera-card-header">
                        <span class="camera-card-title">Camera ${cameraId}: ${cameraName}</span>
                        <span class="camera-status-badge ${isConnected ? 'running' : 'stopped'}">
                            ${isConnected ? 'CONNECTED' : 'DISCONNECTED'}
                        </span>
                    </div>

                    <div class="camera-message" id="camera-msg-${cameraId}"></div>

                    <div class="camera-card-content">
                        <div class="camera-image-container">
                            ${isConnected ?
                                `<img id="camera-img-${cameraId}" src="/api/camera/${cameraId}/snapshot?t=${Date.now()}" class="camera-image" alt="${cameraName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="camera-no-image" style="display:none;">Image load failed</div>` :
                                `<div class="camera-no-image">Camera not connected</div>`
                            }
                        </div>
                        <div class="camera-info">
                            ${isIPCamera ? `
                            <div class="camera-info-item">
                                <span class="camera-info-label">Type</span>
                                <span class="camera-info-value">IP Camera (${camera.ip || 'N/A'})</span>
                            </div>
                            ` : ''}
                            <div class="camera-info-item">
                                <span class="camera-info-label">Path</span>
                                <span class="camera-info-value" style="font-size: 11px;">${isIPCamera && camera.camera_path ? camera.camera_path : camera.path || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">Resolution</span>
                                <span class="camera-info-value">${config.width || '-'}x${config.height || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">FPS</span>
                                <span class="camera-info-value">${config.fps || '-'}</span>
                            </div>
                            ${!isIPCamera ? `
                            <div class="camera-info-item">
                                <span class="camera-info-label">Exposure</span>
                                <span class="camera-info-value">${config.exposure || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">Gain</span>
                                <span class="camera-info-value">${config.gain || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">Brightness</span>
                                <span class="camera-info-value">${config.brightness || '-'}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    ${isIPCamera ? `
                    <div class="camera-config-section">
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin-bottom: 10px; font-size: 13px;">
                            ‚ÑπÔ∏è <strong>IP Camera Note:</strong> Exposure, gain, and brightness cannot be controlled via software for RTSP/IP cameras.
                            These settings must be configured through the camera's web interface or manufacturer app.
                        </div>
                        <div class="camera-roi-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <label style="margin-right: 10px; font-weight: bold;">ROI (Region of Interest)</label>
                                <input type="checkbox" id="cam-cfg-roi-enabled-${cameraId}" ${config.roi_enabled ? 'checked' : ''} ${!isConnected ? 'disabled' : ''}>
                                <span style="margin-left: 5px; font-size: 11px;">Enable</span>
                            </div>
                            <div class="camera-config-grid">
                                <div class="camera-config-item">
                                    <label>X Min</label>
                                    <input type="number" id="cam-cfg-roi-xmin-${cameraId}" value="${config.roi_xmin || 0}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Min</label>
                                    <input type="number" id="cam-cfg-roi-ymin-${cameraId}" value="${config.roi_ymin || 0}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>X Max</label>
                                    <input type="number" id="cam-cfg-roi-xmax-${cameraId}" value="${config.roi_xmax || 1280}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Max</label>
                                    <input type="number" id="cam-cfg-roi-ymax-${cameraId}" value="${config.roi_ymax || 720}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                            </div>
                        </div>
                        <div class="camera-actions" style="margin-top: 15px;">
                            <button class="camera-btn camera-btn-secondary" onclick="restartCamera(${cameraId})" ${!isConnected ? 'disabled' : ''}>Restart</button>
                            <button class="camera-btn camera-btn-primary" onclick="applyCameraConfig(${cameraId})" ${!isConnected ? 'disabled' : ''}>Apply ROI</button>
                            <button class="camera-btn camera-btn-success" onclick="saveCameraConfig(${cameraId})">üíæ Save</button>
                        </div>
                    </div>
                    ` : `
                    <div class="camera-config-section">
                        <div class="camera-config-grid">
                            <div class="camera-config-item">
                                <label>Exposure</label>
                                <input type="number" id="cam-cfg-exposure-${cameraId}" value="${config.exposure || 100}" min="1" max="10000"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Gain</label>
                                <input type="number" id="cam-cfg-gain-${cameraId}" value="${config.gain || 100}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Brightness</label>
                                <input type="number" id="cam-cfg-brightness-${cameraId}" value="${config.brightness || 100}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Contrast</label>
                                <input type="number" id="cam-cfg-contrast-${cameraId}" value="${config.contrast || 0}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Saturation</label>
                                <input type="number" id="cam-cfg-saturation-${cameraId}" value="${config.saturation || 50}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>FPS</label>
                                <input type="number" id="cam-cfg-fps-${cameraId}" value="${config.fps || 30}" min="1" max="120"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                        </div>
                        <div class="camera-roi-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <label style="margin-right: 10px; font-weight: bold;">ROI</label>
                                <input type="checkbox" id="cam-cfg-roi-enabled-${cameraId}" ${config.roi_enabled ? 'checked' : ''} ${!isConnected ? 'disabled' : ''}>
                                <span style="margin-left: 5px; font-size: 11px;">Enable</span>
                            </div>
                            <div class="camera-config-grid">
                                <div class="camera-config-item">
                                    <label>X Min</label>
                                    <input type="number" id="cam-cfg-roi-xmin-${cameraId}" value="${config.roi_xmin || 0}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Min</label>
                                    <input type="number" id="cam-cfg-roi-ymin-${cameraId}" value="${config.roi_ymin || 0}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>X Max</label>
                                    <input type="number" id="cam-cfg-roi-xmax-${cameraId}" value="${config.roi_xmax || 1280}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Max</label>
                                    <input type="number" id="cam-cfg-roi-ymax-${cameraId}" value="${config.roi_ymax || 720}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                            </div>
                        </div>
                        <div class="camera-actions">
                            <button class="camera-btn camera-btn-secondary" onclick="restartCamera(${cameraId})" ${!isConnected ? 'disabled' : ''}>Restart</button>
                            <button class="camera-btn camera-btn-primary" onclick="applyCameraConfig(${cameraId})" ${!isConnected ? 'disabled' : ''}>Apply</button>
                            <button class="camera-btn camera-btn-success" onclick="saveCameraConfig(${cameraId})">üíæ Save</button>
                        </div>
                    </div>
                    `}
                `;

                return div;
            }

            function pauseCameraRefresh() {
                isCameraUpdating = true;
                const statusEl = document.getElementById('camera-refresh-status');
                if (statusEl) {
                    statusEl.textContent = 'Paused';
                    statusEl.className = 'camera-refresh-status paused';
                }
            }

            function resumeCameraRefresh() {
                setTimeout(() => {
                    isCameraUpdating = false;
                    const statusEl = document.getElementById('camera-refresh-status');
                    if (statusEl) {
                        statusEl.textContent = 'Active';
                        statusEl.className = 'camera-refresh-status';
                    }
                }, 200);
            }

            function showCameraMessage(cameraId, message, type) {
                const msgEl = document.getElementById(`camera-msg-${cameraId}`);
                if (!msgEl) return;

                msgEl.textContent = message;
                msgEl.className = `camera-message ${type}`;

                setTimeout(() => {
                    msgEl.className = 'camera-message';
                    msgEl.textContent = '';
                }, 3000);
            }

            async function restartCamera(cameraId) {
                try {
                    showCameraMessage(cameraId, 'Restarting camera...', 'info');

                    const response = await fetch(`/api/camera/${cameraId}/restart`, {
                        method: 'POST'
                    });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showCameraMessage(cameraId, 'Camera restarted successfully!', 'success');
                        setTimeout(() => fetchCameraStatus(), 2000);
                    } else {
                        showCameraMessage(cameraId, result.error || 'Failed to restart camera', 'error');
                    }
                } catch (error) {
                    showCameraMessage(cameraId, `Error: ${error.message}`, 'error');
                }
            }

            async function applyCameraConfig(cameraId) {
                pauseCameraRefresh();
                showCameraMessage(cameraId, 'Applying configuration...', 'info');

                try {
                    // Build config object with only available fields
                    const config = {
                        roi_enabled: document.getElementById(`cam-cfg-roi-enabled-${cameraId}`).checked,
                        roi_xmin: parseInt(document.getElementById(`cam-cfg-roi-xmin-${cameraId}`).value) || 0,
                        roi_ymin: parseInt(document.getElementById(`cam-cfg-roi-ymin-${cameraId}`).value) || 0,
                        roi_xmax: parseInt(document.getElementById(`cam-cfg-roi-xmax-${cameraId}`).value) || 1280,
                        roi_ymax: parseInt(document.getElementById(`cam-cfg-roi-ymax-${cameraId}`).value) || 720
                    };

                    // Add USB camera settings if they exist (will be null for IP cameras)
                    const fpsEl = document.getElementById(`cam-cfg-fps-${cameraId}`);
                    const exposureEl = document.getElementById(`cam-cfg-exposure-${cameraId}`);
                    const gainEl = document.getElementById(`cam-cfg-gain-${cameraId}`);
                    const brightnessEl = document.getElementById(`cam-cfg-brightness-${cameraId}`);
                    const contrastEl = document.getElementById(`cam-cfg-contrast-${cameraId}`);
                    const saturationEl = document.getElementById(`cam-cfg-saturation-${cameraId}`);

                    if (fpsEl) config.fps = parseInt(fpsEl.value) || 30;
                    if (exposureEl) config.exposure = parseInt(exposureEl.value) || 100;
                    if (gainEl) config.gain = parseInt(gainEl.value) || 100;
                    if (brightnessEl) config.brightness = parseInt(brightnessEl.value) || 100;
                    if (contrastEl) config.contrast = parseInt(contrastEl.value) || 0;
                    if (saturationEl) config.saturation = parseInt(saturationEl.value) || 50;

                    const response = await fetch(`/api/camera/${cameraId}/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        showCameraMessage(cameraId, 'Configuration applied!', 'success');
                        setTimeout(() => fetchCameraStatus(), 1000);
                    } else {
                        showCameraMessage(cameraId, result.error || 'Failed to apply config', 'error');
                    }
                } catch (error) {
                    showCameraMessage(cameraId, `Error: ${error.message}`, 'error');
                }

                setTimeout(resumeCameraRefresh, 2000);
            }

            async function saveCameraConfig(cameraId) {
                try {
                    showCameraMessage(cameraId, 'Saving camera configuration...', 'info');

                    // First apply the current settings
                    await applyCameraConfig(cameraId);

                    // Then save all config to file
                    const response = await fetch('/api/cameras/config/save', { method: 'POST' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showCameraMessage(cameraId, 'Camera settings saved!', 'success');
                    } else {
                        showCameraMessage(cameraId, result.error || 'Failed to save config', 'error');
                    }
                } catch (error) {
                    showCameraMessage(cameraId, `Error: ${error.message}`, 'error');
                }
            }

            function refreshCameras() {
                fetchCameraStatus();
            }

            function updateCameraImages() {
                if (isCameraUpdating) return;

                Object.keys(cameraData).forEach(cameraId => {
                    const camera = cameraData[cameraId];
                    if (camera.connected) {
                        const imgEl = document.getElementById(`camera-img-${cameraId}`);
                        if (imgEl) {
                            imgEl.src = `/api/camera/${cameraId}/snapshot?t=${Date.now()}`;
                        }
                    }
                });
            }

            // ===== CAMERA CONFIG PERSISTENCE FUNCTIONS =====
            function showConfigMessage(message, type) {
                const msgEl = document.getElementById('camera-config-message');
                msgEl.textContent = message;
                msgEl.style.display = 'block';
                msgEl.style.backgroundColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
                msgEl.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
                setTimeout(() => { msgEl.style.display = 'none'; }, 5000);
            }

            async function saveServiceConfig() {
                try {
                    showConfigMessage('Saving all service configuration...', 'info');
                    const response = await fetch('/api/cameras/config/save', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showConfigMessage(`All config saved! (${result.cameras_saved} cameras, ${result.states_saved || 0} states + service settings)`, 'success');
                        checkServiceConfigStatus();
                        refreshStates();  // Refresh states display
                    } else {
                        showConfigMessage(result.error || 'Failed to save', 'error');
                    }
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
            }

            async function loadServiceConfig() {
                try {
                    showConfigMessage('Loading all service configuration...', 'info');
                    const response = await fetch('/api/cameras/config/load', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showConfigMessage(`All config loaded! (${result.cameras_loaded} cameras, ${result.states_loaded || 0} states + service settings)`, 'success');
                        setTimeout(() => fetchCameraStatus(), 500);
                        refreshStates();  // Refresh states display
                    } else {
                        showConfigMessage(result.error || 'Failed to load', 'error');
                    }
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
            }

            async function downloadServiceConfig() {
                try {
                    const response = await fetch('/api/cameras/config');
                    const data = await response.json();
                    if (!data.exists || !data.config) {
                        showConfigMessage('No saved configuration to export', 'error');
                        return;
                    }
                    const blob = new Blob([JSON.stringify(data.config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `service_config_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showConfigMessage('All configuration exported!', 'success');
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
            }

            async function importServiceConfig(event) {
                const file = event.target.files[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const config = JSON.parse(text);
                    showConfigMessage('Uploading all service configuration...', 'info');
                    const response = await fetch('/api/cameras/config/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ config })
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showConfigMessage(`All config imported! (${result.cameras_loaded} cameras, ${result.states_loaded || 0} states + service settings)`, 'success');
                        setTimeout(() => fetchCameraStatus(), 500);
                        checkServiceConfigStatus();
                        refreshStates();  // Refresh states display
                    } else {
                        showConfigMessage(result.error || 'Failed to import', 'error');
                    }
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
                event.target.value = '';  // Reset file input
            }

            async function checkServiceConfigStatus() {
                try {
                    const response = await fetch('/api/cameras/config');
                    const data = await response.json();
                    const statusEl = document.getElementById('camera-config-status');
                    if (data.exists && data.config) {
                        statusEl.textContent = `Last saved: ${data.config.saved_at || 'unknown'}`;
                    } else {
                        statusEl.textContent = 'No saved config';
                    }
                } catch (error) {
                    document.getElementById('camera-config-status').textContent = '';
                }
            }

            // ===== STATE MANAGEMENT FUNCTIONS =====
            let statesData = {};

            function showStateMessage(message, type) {
                const msgEl = document.getElementById('state-message');
                msgEl.textContent = message;
                msgEl.style.display = 'block';
                msgEl.style.backgroundColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
                msgEl.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
                setTimeout(() => { msgEl.style.display = 'none'; }, 5000);
            }

            async function refreshStates() {
                try {
                    const response = await fetch('/api/states');
                    const data = await response.json();
                    statesData = data;

                    // Update current state display
                    const currentState = data.current_state;
                    document.getElementById('current-state-name').textContent = currentState ? currentState.name : 'None';

                    // Update capture state badge
                    const captureState = data.capture_state || 'idle';
                    const badge = document.getElementById('capture-state-badge');
                    badge.textContent = captureState.toUpperCase();
                    const badgeColors = {
                        'idle': '#6c757d',
                        'ready': '#17a2b8',
                        'capturing': '#28a745',
                        'processing': '#ffc107',
                        'error': '#dc3545'
                    };
                    badge.style.backgroundColor = badgeColors[captureState] || '#6c757d';

                    // Render states list
                    renderStatesList(data.states || {});

                } catch (error) {
                    console.error('Error fetching states:', error);
                    showStateMessage('Error loading states: ' + error.message, 'error');
                }
            }

            function renderStatesList(states) {
                const container = document.getElementById('states-list');
                const stateNames = Object.keys(states);

                if (stateNames.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No states configured</span>';
                    return;
                }

                container.innerHTML = '';
                stateNames.forEach(name => {
                    const state = states[name];
                    const isActive = statesData.current_state && statesData.current_state.name === name;

                    // Get phases info for display
                    const phases = state.phases || [];
                    const phaseCount = phases.length;
                    const allCameras = [...new Set(phases.flatMap(p => p.cameras || []))].sort();

                    // Get trigger thresholds from first phase (or state-level fallback)
                    const firstPhase = phases.length > 0 ? phases[0] : {};
                    let steps = firstPhase.steps !== undefined ? firstPhase.steps : (state.steps !== undefined ? state.steps : 1);
                    let analog = firstPhase.analog !== undefined ? firstPhase.analog : (state.analog !== undefined ? state.analog : -1);
                    const stepsDisplay = steps < 0 ? 'loop' : steps;
                    const analogDisplay = analog < 0 ? 'off' : analog;

                    // Get light mode and delay info from phases
                    const phasesInfo = phases.map((p, idx) => {
                        const lightMode = p.light_mode || 'U_ON_B_OFF';
                        const delay = p.delay !== undefined ? p.delay : 0;
                        return `${lightMode}:${delay}s`;
                    }).join(', ');

                    const btn = document.createElement('button');
                    btn.className = 'camera-btn ' + (isActive ? 'camera-btn-success' : 'camera-btn-secondary');
                    btn.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 8px 12px; min-width: 140px; cursor: pointer;';
                    btn.innerHTML = `
                        <span style="font-weight: bold;">${name}</span>
                        <span style="font-size: 10px; opacity: 0.8;">${phaseCount} phase${phaseCount !== 1 ? 's' : ''} | Cams: ${allCameras.join(',')}</span>
                        <span style="font-size: 10px; opacity: 0.8;">Steps: ${stepsDisplay} | Analog: ${analogDisplay}</span>
                        <span style="font-size: 9px; opacity: 0.7;">${phasesInfo || 'No phases'}</span>
                    `;
                    btn.onclick = () => activateState(name);
                    btn.ondblclick = () => loadStateToEditor(name, state);  // Double-click to edit
                    btn.title = 'Click to activate, double-click to edit\nLight modes: ' + phasesInfo;
                    container.appendChild(btn);
                });
            }

            function loadStateToEditor(name, state) {
                // Load state into editor form
                document.getElementById('state-name-input').value = name;
                document.getElementById('state-enabled-input').value = state.enabled ? 'true' : 'false';

                // Clear existing phases and rebuild
                const container = document.getElementById('phases-container');
                container.innerHTML = '';

                const phases = state.phases || [];
                phases.forEach((phase, idx) => {
                    const steps = phase.steps !== undefined ? phase.steps : (state.steps !== undefined ? state.steps : -1);
                    const analog = phase.analog !== undefined ? phase.analog : (state.analog !== undefined ? state.analog : -1);
                    addPhaseRow(idx, phase.light_mode, phase.delay, phase.cameras, steps, analog);
                });

                showStateMessage(`Loaded state '${name}' into editor`, 'info');
            }

            async function activateState(stateName) {
                try {
                    showStateMessage('Activating state...', 'info');
                    const response = await fetch(`/api/states/${stateName}/activate`, { method: 'POST' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showStateMessage(`State '${stateName}' activated!`, 'success');
                        refreshStates();
                    } else {
                        showStateMessage(result.error || 'Failed to activate state', 'error');
                    }
                } catch (error) {
                    showStateMessage('Error: ' + error.message, 'error');
                }
            }

            async function triggerCapture() {
                try {
                    showStateMessage('Triggering capture...', 'info');
                    const response = await fetch('/api/states/trigger-capture', { method: 'POST' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showStateMessage(`Capture triggered! Count: ${result.capture_count}`, 'success');
                        refreshStates();
                    } else {
                        showStateMessage(result.error || 'Failed to trigger capture', 'error');
                    }
                } catch (error) {
                    showStateMessage('Error: ' + error.message, 'error');
                }
            }

            // Phase management functions
            let phaseCounter = 1;  // Start at 1 since we have 1 default phase

            function addPhase() {
                addPhaseRow(phaseCounter, 'U_ON_B_OFF', 0.1, [1, 2, 3, 4]);
                phaseCounter++;
            }

            function addPhaseRow(idx, lightMode, delay, cameras, steps = 1, analog = -1) {
                const container = document.getElementById('phases-container');
                const div = document.createElement('div');
                div.className = 'phase-row';
                div.id = `phase-row-${idx}`;
                div.style.cssText = 'display: grid; grid-template-columns: 1.2fr 0.8fr 1fr 0.8fr 0.8fr auto; gap: 6px; align-items: end; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;';

                const camerasStr = Array.isArray(cameras) ? cameras.join(',') : cameras;

                div.innerHTML = `
                    <div>
                        <label style="font-size: 10px; color: #666;">Light Mode</label>
                        <select class="control-input phase-light" style="margin: 0; padding: 4px; font-size: 12px;">
                            <option value="U_ON_B_OFF" ${lightMode === 'U_ON_B_OFF' ? 'selected' : ''}>U On, B Off</option>
                            <option value="U_OFF_B_ON" ${lightMode === 'U_OFF_B_ON' ? 'selected' : ''}>U Off, B On</option>
                            <option value="U_ON_B_ON" ${lightMode === 'U_ON_B_ON' ? 'selected' : ''}>U On, B On</option>
                            <option value="U_OFF_B_OFF" ${lightMode === 'U_OFF_B_OFF' ? 'selected' : ''}>U Off, B Off</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Delay (s)</label>
                        <input type="number" class="control-input phase-delay" value="${delay}" min="0" step="0.01" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Cameras</label>
                        <input type="text" class="control-input phase-cameras" value="${camerasStr}" placeholder="1,2,3,4" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Steps (-1=loop)</label>
                        <input type="number" class="control-input phase-steps" value="${steps}" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Analog (-1=off)</label>
                        <input type="number" class="control-input phase-analog" value="${analog}" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <button class="camera-btn camera-btn-danger" onclick="removePhase('${idx}')" style="padding: 4px 8px; font-size: 11px;">‚úï</button>
                `;
                container.appendChild(div);
            }

            function removePhase(idx) {
                const row = document.getElementById(`phase-row-${idx}`);
                if (row) {
                    row.remove();
                }
                // Check if we have at least one phase
                const remaining = document.querySelectorAll('.phase-row').length;
                if (remaining === 0) {
                    addPhaseRow(phaseCounter++, 'U_ON_B_OFF', 0.1, [1, 2, 3, 4]);
                }
            }

            function collectPhases() {
                const phases = [];
                const rows = document.querySelectorAll('.phase-row');
                rows.forEach(row => {
                    const lightMode = row.querySelector('.phase-light').value;
                    const delay = parseFloat(row.querySelector('.phase-delay').value) || 0;
                    const camerasStr = row.querySelector('.phase-cameras').value.trim();
                    const cameras = camerasStr ? camerasStr.split(',').map(c => parseInt(c.trim())).filter(c => !isNaN(c)) : [];
                    const steps = parseInt(row.querySelector('.phase-steps').value) || -1;
                    const analog = parseInt(row.querySelector('.phase-analog').value) || -1;

                    // Allow phases without cameras (e.g., light-off phase)
                    phases.push({
                        light_mode: lightMode,
                        delay: delay,
                        cameras: cameras,
                        steps: steps,
                        analog: analog
                    });
                });
                return phases;
            }

            async function createOrUpdateState() {
                const responseEl = document.getElementById('state-config-response');
                const name = document.getElementById('state-name-input').value.trim();

                if (!name) {
                    responseEl.textContent = 'State name is required';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                const phases = collectPhases();

                if (phases.length === 0) {
                    responseEl.textContent = 'At least one phase is required';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                // Warn if no phase has cameras (but still allow it)
                const hasCapture = phases.some(p => p.cameras.length > 0);
                if (!hasCapture) {
                    console.warn('Warning: No phase has cameras configured - no images will be captured');
                }

                const stateData = {
                    name: name,
                    phases: phases,
                    enabled: document.getElementById('state-enabled-input').value === 'true'
                };

                try {
                    const response = await fetch('/api/states', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(stateData)
                    });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        responseEl.textContent = `State '${name}' created/updated with ${phases.length} phase(s)!`;
                        responseEl.className = 'control-response success';
                        refreshStates();
                    } else {
                        responseEl.textContent = result.error || 'Failed to create state';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function deleteCurrentState() {
                const responseEl = document.getElementById('state-config-response');
                const name = document.getElementById('state-name-input').value.trim();

                if (!name) {
                    responseEl.textContent = 'Enter state name to delete';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                if (name === 'default') {
                    responseEl.textContent = 'Cannot delete default state';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                if (!confirm(`Delete state '${name}'?`)) return;

                try {
                    const response = await fetch(`/api/states/${name}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        responseEl.textContent = `State '${name}' deleted!`;
                        responseEl.className = 'control-response success';
                        document.getElementById('state-name-input').value = '';
                        refreshStates();
                    } else {
                        responseEl.textContent = result.error || 'Failed to delete state';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            // ===== INFERENCE PIPELINE MANAGEMENT =====
            let pipelineData = {};

            async function refreshPipelineConfig() {
                try {
                    const response = await fetch('/api/pipelines');
                    const data = await response.json();
                    pipelineData = data;

                    // Update current pipeline/model display
                    const currentPipeline = pipelineData.current_pipeline || 'default';
                    const currentModel = pipelineData.current_model;

                    document.getElementById('current-pipeline-name').textContent = currentPipeline;
                    document.getElementById('current-model-name').textContent = currentModel ? currentModel.name : 'None';

                    // Render lists
                    renderPipelinesList(pipelineData.pipelines || {}, currentPipeline);
                    renderModelsList(pipelineData.models || {});
                    renderModelsChecklist(pipelineData.models || {});

                } catch (error) {
                    console.error('Error loading pipeline config:', error);
                }
            }

            async function fetchModelsFromGradio() {
                const url = document.getElementById('model-url-input').value.trim();
                const select = document.getElementById('model-gradio-name-input');
                const btn = event.target;

                if (!url) {
                    alert('Please enter a Gradio URL first');
                    return;
                }

                // Show loading state
                const originalText = btn.textContent;
                btn.textContent = 'Loading...';
                btn.disabled = true;

                try {
                    const response = await fetch(`/api/gradio/models?url=${encodeURIComponent(url)}`);
                    const data = await response.json();

                    if (data.models && data.models.length > 0) {
                        // Update select with fetched models
                        select.innerHTML = '';
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            select.appendChild(option);
                        });

                        if (data.note) {
                            console.log('Note:', data.note);
                        }
                        if (data.source) {
                            console.log('Models fetched from:', data.source);
                        }
                    } else {
                        alert('No models found from API. Using default list.');
                    }
                } catch (error) {
                    console.error('Error fetching models:', error);
                    alert('Failed to fetch models. Using default list.');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            function handleModelTypeChange() {
                const type = document.getElementById('model-type-input').value;
                const select = document.getElementById('model-gradio-name-input');

                if (type === 'yolo') {
                    select.innerHTML = '<option value="N/A">N/A</option>';
                } else if (type === 'gradio') {
                    select.innerHTML = `
                        <option value="Data Matrix">Data Matrix</option>
                        <option value="Dental Implant">Dental Implant</option>
                        <option value="Ball Pen">Ball Pen</option>
                        <option value="Knit Up">Knit Up</option>
                        <option value="Knit Back">Knit Back</option>
                        <option value="Jean Back">Jean Back</option>
                        <option value="Jean Up">Jean Up</option>
                        <option value="Tire Cord">Tire Cord</option>
                        <option value="predict">predict</option>
                        <option value="N/A">N/A</option>
                    `;
                }
            }

            function renderPipelinesList(pipelines, currentPipeline) {
                const container = document.getElementById('pipelines-list');
                const pipelineNames = Object.keys(pipelines);

                if (pipelineNames.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No pipelines configured</span>';
                    return;
                }

                container.innerHTML = '';
                pipelineNames.forEach(name => {
                    const pipeline = pipelines[name];
                    const isActive = name === currentPipeline;
                    const pipelineDiv = document.createElement('div');
                    pipelineDiv.style.cssText = `padding: 10px; background: ${isActive ? '#cce5ff' : '#f8f9fa'}; border: 2px solid ${isActive ? '#007bff' : '#dee2e6'}; border-radius: 6px; min-width: 200px;`;

                    const phaseModels = pipeline.phases.map(p => p.model_id).join(' -> ') || 'No models';
                    pipelineDiv.innerHTML = `
                        <div>
                            <strong style="font-size: 14px;">${pipeline.name}</strong>
                            ${isActive ? '<span style="margin-left: 8px; padding: 2px 6px; background: #007bff; color: white; border-radius: 3px; font-size: 10px;">ACTIVE</span>' : ''}
                            <div style="margin-top: 4px; font-size: 11px; color: #666;">${pipeline.description || 'No description'}</div>
                            <div style="margin-top: 4px; font-size: 10px; color: #888;">Phases: ${phaseModels}</div>
                            <div style="margin-top: 8px; display: flex; gap: 4px;">
                                ${!isActive ? `<button onclick="activatePipeline('${name}')" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Activate</button>` : ''}
                                <button onclick="loadPipelineForEdit('${name}')" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(pipelineDiv);
                });
            }

            function renderModelsList(models) {
                const container = document.getElementById('models-list');
                const modelIds = Object.keys(models);

                if (modelIds.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No models configured</span>';
                    return;
                }

                container.innerHTML = '';
                modelIds.forEach(id => {
                    const model = models[id];
                    const modelDiv = document.createElement('div');
                    modelDiv.style.cssText = 'padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;';
                    modelDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <strong style="font-size: 14px;">${model.name}</strong>
                                <span style="margin-left: 8px; padding: 2px 6px; background: ${model.model_type === 'gradio' ? '#17a2b8' : '#28a745'}; color: white; border-radius: 3px; font-size: 10px;">${model.model_type.toUpperCase()}</span>
                                <div style="margin-top: 4px; font-size: 11px; color: #666;">
                                    Model: ${model.model_name} | Confidence: ${model.confidence_threshold}
                                </div>
                                <div style="margin-top: 2px; font-size: 10px; color: #888; word-break: break-all;">${model.inference_url}</div>
                            </div>
                            <div style="display: flex; gap: 4px; margin-left: 10px;">
                                <button onclick="loadModelForEdit('${id}')" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(modelDiv);
                });
            }

            function renderModelsChecklist(models) {
                const container = document.getElementById('pipeline-models-checklist');
                const modelIds = Object.keys(models);

                if (modelIds.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No models available</span>';
                    return;
                }

                container.innerHTML = '';
                modelIds.forEach(id => {
                    const model = models[id];
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: #e9ecef; border-radius: 4px; cursor: pointer;';
                    label.innerHTML = `
                        <input type="checkbox" name="pipeline-model" value="${id}">
                        <span>${model.name}</span>
                    `;
                    container.appendChild(label);
                });
            }

            function loadPipelineForEdit(pipelineName) {
                const pipeline = pipelineData.pipelines[pipelineName];
                if (!pipeline) return;

                document.getElementById('pipeline-name-input').value = pipeline.name;
                document.getElementById('pipeline-desc-input').value = pipeline.description || '';

                // Check the models in this pipeline
                const checkboxes = document.querySelectorAll('input[name="pipeline-model"]');
                const pipelineModelIds = pipeline.phases.map(p => p.model_id);
                checkboxes.forEach(cb => {
                    cb.checked = pipelineModelIds.includes(cb.value);
                });
            }

            function loadModelForEdit(modelId) {
                const model = pipelineData.models[modelId];
                if (!model) return;

                document.getElementById('model-name-input').value = model.name;
                document.getElementById('model-type-input').value = model.model_type || 'gradio';
                document.getElementById('model-url-input').value = model.inference_url;
                document.getElementById('model-confidence-input').value = model.confidence_threshold;

                const modelSelect = document.getElementById('model-gradio-name-input');
                const modelValue = model.model_name;
                let found = false;
                for (let option of modelSelect.options) {
                    if (option.value === modelValue) {
                        modelSelect.value = modelValue;
                        found = true;
                        break;
                    }
                }
                if (!found && modelValue) {
                    const option = document.createElement('option');
                    option.value = modelValue;
                    option.textContent = modelValue;
                    modelSelect.appendChild(option);
                    modelSelect.value = modelValue;
                }
            }

            async function activatePipeline(pipelineName) {
                const responseEl = document.getElementById('pipeline-response');
                try {
                    const response = await fetch(`/api/pipelines/activate/${pipelineName}`, { method: 'POST' });
                    const result = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Pipeline '${pipelineName}' activated!`;
                        responseEl.className = 'control-response success';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to activate pipeline';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function createOrUpdatePipeline() {
                const pipelineName = document.getElementById('pipeline-name-input').value.trim();
                const description = document.getElementById('pipeline-desc-input').value.trim();
                const responseEl = document.getElementById('pipeline-response');

                if (!pipelineName) {
                    responseEl.textContent = 'Please enter a pipeline name';
                    responseEl.className = 'control-response error';
                    return;
                }

                // Get selected models
                const checkboxes = document.querySelectorAll('input[name="pipeline-model"]:checked');
                const phases = Array.from(checkboxes).map((cb, idx) => ({
                    model_id: cb.value,
                    enabled: true,
                    order: idx
                }));

                if (phases.length === 0) {
                    responseEl.textContent = 'Please select at least one model for the pipeline';
                    responseEl.className = 'control-response error';
                    return;
                }

                try {
                    const response = await fetch('/api/pipelines', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: pipelineName,
                            description: description,
                            phases: phases,
                            enabled: true
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        responseEl.textContent = `Pipeline '${pipelineName}' saved!`;
                        responseEl.className = 'control-response success';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to save pipeline';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function deletePipeline() {
                const pipelineName = document.getElementById('pipeline-name-input').value.trim();
                const responseEl = document.getElementById('pipeline-response');

                if (!pipelineName || !confirm(`Delete pipeline '${pipelineName}'?`)) return;

                try {
                    const response = await fetch(`/api/pipelines/${pipelineName}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Pipeline '${pipelineName}' deleted!`;
                        responseEl.className = 'control-response success';
                        document.getElementById('pipeline-name-input').value = '';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to delete pipeline';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function createOrUpdateModel() {
                const modelName = document.getElementById('model-name-input').value.trim();
                const modelType = document.getElementById('model-type-input').value;
                const modelGradioName = document.getElementById('model-gradio-name-input').value;
                const modelConfidence = parseFloat(document.getElementById('model-confidence-input').value);
                const modelUrl = document.getElementById('model-url-input').value.trim();
                const responseEl = document.getElementById('model-response');

                if (!modelName || !modelUrl) {
                    responseEl.textContent = 'Please fill in Model Name and URL';
                    responseEl.className = 'control-response error';
                    return;
                }

                // Generate model_id from name (lowercase, underscores)
                const modelId = modelName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                try {
                    const response = await fetch('/api/models', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_id: modelId,
                            name: modelName,
                            model_type: modelType,
                            model_name: modelGradioName,
                            confidence_threshold: modelConfidence,
                            inference_url: modelUrl
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        responseEl.textContent = `Model '${modelName}' saved!`;
                        responseEl.className = 'control-response success';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to save model';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function deleteModel() {
                const modelName = document.getElementById('model-name-input').value.trim();
                const responseEl = document.getElementById('model-response');

                if (!modelName) {
                    responseEl.textContent = 'Please enter a model name to delete';
                    responseEl.className = 'control-response error';
                    return;
                }

                const modelId = modelName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                if (!confirm(`Delete model '${modelName}'?`)) return;

                try {
                    const response = await fetch(`/api/models/${modelId}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Model '${modelName}' deleted!`;
                        responseEl.className = 'control-response success';
                        document.getElementById('model-name-input').value = '';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to delete model';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            // Legacy compatibility - keep old function name
            function refreshInferenceConfig() {
                refreshPipelineConfig();
            }

            // ===== Camera Discovery Functions =====
            async function scanForCameras() {
                const subnet = document.getElementById('subnet-input').value.trim();
                const scanButton = document.getElementById('scan-button');
                const statusContainer = document.getElementById('discovery-status-container');
                const camerasContainer = document.getElementById('discovered-cameras-container');

                // Validate subnet
                if (!subnet || !/^\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(subnet)) {
                    statusContainer.innerHTML = '<div class="discovery-status error">Invalid subnet format. Use format like: 192.168.0</div>';
                    return;
                }

                // Disable button and show scanning status
                scanButton.disabled = true;
                scanButton.textContent = 'üîÑ Scanning...';
                statusContainer.innerHTML = '<div class="discovery-status scanning">‚è≥ Scanning network ' + subnet + '.0/24 for camera devices... (Quick port scan, ~30 seconds)</div>';
                camerasContainer.innerHTML = '';

                try {
                    const response = await fetch('/api/cameras/discover', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subnet })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        statusContainer.innerHTML = `<div class="discovery-status success">‚úì Scan complete! Found ${result.count} potential camera device(s) on subnet ${result.subnet}.0/24</div>`;

                        if (result.cameras && result.cameras.length > 0) {
                            displayDiscoveredCameras(result.cameras);
                        } else {
                            camerasContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No cameras found on this network. Check if cameras are powered on and connected to the network.</p>';
                        }
                    } else {
                        statusContainer.innerHTML = `<div class="discovery-status error">‚ùå Error: ${result.error || 'Scan failed'}</div>`;
                        camerasContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Discovery error:', error);
                    statusContainer.innerHTML = `<div class="discovery-status error">‚ùå Error: ${error.message}</div>`;
                    camerasContainer.innerHTML = '';
                } finally {
                    scanButton.disabled = false;
                    scanButton.textContent = 'üîé Scan Network';
                }
            }

            function displayDiscoveredCameras(cameras) {
                const container = document.getElementById('discovered-cameras-container');
                container.innerHTML = '<div class="discovered-cameras-list">' + cameras.map((cam, idx) => {
                    const pathsHtml = cam.paths.map((p, pidx) => `
                        <div style="margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; font-family: monospace; margin-bottom: 5px;">Path ${pidx + 1}: ${p.path}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="camera-${idx}-path-${pidx}-username" placeholder="Username" value="admin" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 120px;">
                                <input type="password" id="camera-${idx}-path-${pidx}-password" placeholder="Password" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 120px;">
                                <button class="test-camera-button" onclick='testCameraPath(${idx}, ${pidx}, "${p.url}", "${cam.ip}", "${p.path}")'>
                                    üé• Test & Preview
                                </button>
                            </div>
                        </div>
                    `).join('');

                    return `
                        <div class="discovered-camera-item" id="discovered-camera-${idx}" style="display: block; grid-template-columns: none;">
                            <div style="margin-bottom: 10px;">
                                <div class="discovered-camera-ip">üìπ ${cam.ip} (${cam.protocol}:${cam.port})</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Found ${cam.paths.length} possible camera path(s) - test each with credentials:</div>
                            </div>
                            ${pathsHtml}
                        </div>
                    `;
                }).join('') + '</div>';
            }

            async function testCameraPath(camIdx, pathIdx, url, ip, path) {
                const username = document.getElementById(`camera-${camIdx}-path-${pathIdx}-username`).value.trim();
                const password = document.getElementById(`camera-${camIdx}-path-${pathIdx}-password`).value;
                const button = event.target;

                button.disabled = true;
                button.textContent = '‚è≥ Testing...';

                try {
                    const response = await fetch('/api/cameras/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, username, password })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Show camera preview (pass both display URL and full URL)
                        showCameraPreview(ip, path, result.image, result.resolution, result.authenticated_url, result.full_url);
                        button.textContent = '‚úì Success!';
                        button.style.background = '#218838';
                        setTimeout(() => {
                            button.textContent = 'üé• Test & Preview';
                            button.style.background = '#28a745';
                        }, 2000);
                    } else {
                        alert(`Camera test failed: ${result.error || 'Unable to connect'}\n\nTry checking:\n- Username and password are correct\n- This specific path works for your camera model\n- Camera is powered on and connected\n- Network connectivity`);
                        button.textContent = '‚ùå Failed';
                        button.style.background = '#dc3545';
                        setTimeout(() => {
                            button.textContent = 'üé• Test & Preview';
                            button.style.background = '#28a745';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Test error:', error);
                    alert(`Error testing camera: ${error.message}`);
                    button.textContent = '‚ùå Error';
                    button.style.background = '#dc3545';
                    setTimeout(() => {
                        button.textContent = 'üé• Test & Preview';
                        button.style.background = '#28a745';
                    }, 2000);
                } finally {
                    button.disabled = false;
                }
            }

            // Store current camera details for saving
            let currentCameraDetails = null;

            function showCameraPreview(ip, path, imageData, resolution, authenticatedUrl, fullUrl) {
                const modal = document.getElementById('camera-preview-modal');
                const title = document.getElementById('preview-camera-title');
                const info = document.getElementById('preview-camera-info');
                const image = document.getElementById('preview-camera-image');
                const nameInput = document.getElementById('save-camera-name');

                // Store camera details for saving (use fullUrl which has credentials)
                currentCameraDetails = {
                    ip: ip,
                    path: path,
                    url: fullUrl || authenticatedUrl,  // Use full URL with credentials for saving
                    resolution: resolution
                };

                // Auto-suggest camera name
                nameInput.value = `Camera ${ip}`;

                title.textContent = `Camera Preview - ${ip}`;
                info.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>IP:</strong> ${ip}<br>
                        <strong>Path:</strong> <span style="font-family: monospace; font-size: 12px;">${path}</span><br>
                        <strong>URL:</strong> <span style="font-family: monospace; font-size: 12px;">${authenticatedUrl || 'N/A'}</span><br>
                        <strong>Resolution:</strong> ${resolution.width} x ${resolution.height}
                    </div>
                `;
                image.src = imageData;

                modal.style.display = 'flex';
            }

            function closeCameraPreview(event) {
                if (!event || event.target.id === 'camera-preview-modal') {
                    document.getElementById('camera-preview-modal').style.display = 'none';
                    currentCameraDetails = null;
                }
            }

            async function saveDiscoveredCamera() {
                if (!currentCameraDetails) {
                    alert('No camera details available to save');
                    return;
                }

                const nameInput = document.getElementById('save-camera-name');
                const cameraName = nameInput.value.trim() || `Camera ${currentCameraDetails.ip}`;
                const saveButton = document.getElementById('save-camera-button');

                saveButton.disabled = true;
                saveButton.textContent = 'üíæ Saving...';

                try {
                    const response = await fetch('/api/cameras/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: cameraName,
                            ip: currentCameraDetails.ip,
                            url: currentCameraDetails.url,
                            path: currentCameraDetails.path,
                            resolution: currentCameraDetails.resolution
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        saveButton.textContent = '‚úì Saved!';
                        saveButton.style.background = '#28a745';

                        // Show success message
                        alert(`Camera "${cameraName}" saved successfully!\n\nYou can now use this camera in the Camera Monitoring section.`);

                        // Refresh camera status to show the new camera
                        setTimeout(() => {
                            fetchCameraStatus();
                            closeCameraPreview();
                        }, 1000);
                    } else {
                        alert(`Failed to save camera: ${result.error || 'Unknown error'}`);
                        saveButton.textContent = 'üíæ Save Camera';
                        saveButton.style.background = '#007bff';
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert(`Error saving camera: ${error.message}`);
                    saveButton.textContent = 'üíæ Save Camera';
                    saveButton.style.background = '#007bff';
                } finally {
                    saveButton.disabled = false;
                }
            }

            // Initial camera status fetch (SSE will handle updates)
            fetchCameraStatus();
            checkServiceConfigStatus();  // Check if saved service config exists

            // Fetch and update inference stats
            async function fetchInferenceStats() {
                try {
                    const response = await fetch('/api/inference/stats');
                    const data = await response.json();

                    // Update service name
                    const serviceNameEl = document.getElementById('inference-service-name');
                    if (serviceNameEl) {
                        serviceNameEl.textContent = data.service_type || '...';
                    }

                    // Update inference processing time (capture to result)
                    const timeValueEl = document.getElementById('inference-time-value');
                    if (timeValueEl) {
                        if (data.avg_inference_time_ms > 0) {
                            timeValueEl.textContent = data.avg_inference_time_ms + ' ms';
                        } else {
                            timeValueEl.textContent = 'N/A';
                        }
                    }

                    // Update frame interval (time between frames)
                    const intervalValueEl = document.getElementById('frame-interval-value');
                    if (intervalValueEl) {
                        if (data.avg_frame_interval_ms > 0) {
                            intervalValueEl.textContent = data.avg_frame_interval_ms + ' ms';
                        } else {
                            intervalValueEl.textContent = 'N/A';
                        }
                    }

                    // Update inference FPS (based on processing intervals)
                    const inferenceFpsValueEl = document.getElementById('inference-fps-value');
                    if (inferenceFpsValueEl) {
                        if (data.inference_fps > 0) {
                            inferenceFpsValueEl.textContent = data.inference_fps;
                        } else {
                            inferenceFpsValueEl.textContent = 'N/A';
                        }
                    }

                    // Update capture FPS (based on camera capture rate)
                    const captureFpsValueEl = document.getElementById('capture-fps-value');
                    if (captureFpsValueEl) {
                        if (data.capture_fps > 0) {
                            captureFpsValueEl.textContent = data.capture_fps;
                        } else {
                            captureFpsValueEl.textContent = 'N/A';
                        }
                    }
                } catch (error) {
                    console.error('Error fetching inference stats:', error);
                }
            }

            // Start Server-Sent Events for real-time status updates (replaces all polling)
            startStatusStream();

            // Load audio settings from localStorage
            loadAudioSettings();

            // Start timeline image refresh
            startTimelineRefresh();

            // Initial config fetch (once on page load)
            fetchConfig();
            fetchHealth();  // Get YOLO status
            loadDataFile();
            refreshStates();
            refreshInferenceConfig();

            // Refresh health status periodically (for YOLO status)
            setInterval(fetchHealth, 10000);

            // Set default API type fields (Gradio with HuggingFace URL)
            updateAPITypeFields();
        </script>
    </body>
</html>
