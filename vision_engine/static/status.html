<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
        <title>Monitait Vision Engine v2.0.0</title>
        <style>
            @font-face { font-family: 'Inter'; src: url('/static/fonts/Inter.ttf') format('truetype'); font-weight: 100 900; font-display: swap; }
            @font-face { font-family: 'Vazir'; src: url('/static/fonts/Vazir.woff2') format('woff2'); font-weight: 100 900; font-display: swap; }
            @font-face { font-family: 'Badr'; src: url('/static/fonts/Badr.ttf') format('truetype'); font-display: swap; }

            :root {
                --primary-color: #3b82f6;
                --primary-hover: #2563eb;
                --secondary-color: #06b6d4;
                --success-color: #10b981;
                --warning-color: #f59e0b;
                --danger-color: #ef4444;
                --dark-bg: #0f172a;
                --darker-bg: #020617;
                --light-bg: #1e293b;
                --card-bg: rgba(30, 41, 59, 0.6);
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --border-color: rgba(51, 65, 85, 0.6);
                --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.12);
                --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
                --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.2);
            }

            body, button, input, select, textarea, option {
                font-family: 'Inter', 'Vazir', 'Badr', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            }

            body {
                margin: 0;
                padding: 10px;
                background: linear-gradient(to bottom, #0f172a 0%, #1e293b 100%);
                min-height: 100vh;
                color: var(--text-primary);
            }

            .container {
                max-width: 100%;
                margin: 0 auto;
                background: rgba(15, 23, 42, 0.8);
                backdrop-filter: blur(8px);
                padding: 14px;
                border-radius: 10px;
                border: 1px solid rgba(59, 130, 246, 0.1);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            }

            .header-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid var(--border-color);
            }

            .header-title {
                margin: 0;
                font-size: 26px;
                font-weight: 700;
                color: var(--text-primary);
                letter-spacing: -0.5px;
            }
            .status-box {
                background: rgba(30, 41, 59, 0.4);
                backdrop-filter: blur(4px);
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 12px;
                border: 1px solid rgba(51, 65, 85, 0.5);
                transition: all 0.2s ease;
            }

            .status-box:hover {
                background: rgba(30, 41, 59, 0.6);
                border-color: rgba(59, 130, 246, 0.3);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            }
            .status-box-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            .status-box-item {
                text-align: center;
            }
            .status-box-label {
                font-size: 14px;
                color: #666;
                margin-bottom: 5px;
            }
            .status-box-value {
                font-size: 18px;
                font-weight: bold;
            }
            .timestamp-details {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
            .connected { color: #006600; }
            .disconnected { color: #cc0000; }
            .error { color: #cc6600; }
            .status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .status-item {
                background: rgba(30, 41, 59, 0.5);
                padding: 15px;
                border-radius: 8px;
                border: 1px solid rgba(51, 65, 85, 0.6);
            }
            .status-item h3 {
                margin: 0 0 10px 0;
                color: var(--text-primary);
                font-weight: 600;
            }
            .status-value {
                font-size: 24px;
                font-weight: bold;
                color: var(--text-primary);
            }
            .status-unit {
                font-size: 14px;
                color: var(--text-secondary);
            }
            .range-bar {
                width: 100%;
                height: 8px;
                background: #ddd;
                border-radius: 4px;
                margin-top: 5px;
                overflow: hidden;
            }
            .range-fill {
                height: 100%;
                background: #4CAF50;
                transition: width 0.3s ease;
            }
            .range-text {
                font-size: 12px;
                color: #666;
                margin-top: 2px;
            }
            .movement-indicator {
                display: inline-block;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                margin-right: 10px;
                transition: background-color 0.3s ease;
            }
            .movement-moving {
                background-color: #4CAF50;
                animation: pulse 1s infinite;
            }
            .movement-stopped {
                background-color: #ff4444;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            .device-status {
                font-size: 14px;
                margin-top: 10px;
                padding: 10px;
                border-radius: 4px;
                background: #fff;
            }
            .device-status.error {
                background: #ffebee;
                color: #c62828;
            }
            .device-status.connected {
                background: #e8f5e9;
                color: #2e7d32;
            }
            .status-indicators {
                display: flex;
                gap: 20px;
                margin: 10px 0;
            }
            .status-indicator {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .status-circle {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background-color: #ccc;
            }
            .status-circle.active {
                animation: pulse 2s infinite;
            }
            .status-circle.U.active {
                background-color: #2196F3;
            }
            .status-circle.B.active {
                background-color: #2196F3;
            }
            .status-circle.warning.active {
                background-color: #f44336;
                animation: pulse 1s infinite;
            }
            .data-source {
                font-weight: bold;
                padding: 4px 8px;
                border-radius: 4px;
                margin-left: 10px;
            }
            .data-source.serial {
                background-color: #007bff;
                color: white;
            }
            .data-source.gpio {
                background-color: #28a745;
                color: white;
            }
            .data-source.none {
                background-color: #dc3545;
                color: white;
            }
            .control-panel {
                margin-top: 30px;
                padding: 20px;
                background-color: #f8f9fa;
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
            .verbose-panel {
                margin-top: 20px;
                padding: 15px;
                background-color: #fff;
                border-radius: 6px;
                border: 1px dashed #ced4da;
            }
            .verbose-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 10px;
            }
            .verbose-item-label {
                font-size: 13px;
                color: #555;
            }
            .verbose-item-value {
                font-size: 16px;
                font-weight: 600;
                margin-top: 2px;
            }
            .control-section {
                margin-bottom: 20px;
            }
            .control-section h3 {
                margin: 0 0 15px 0;
                color: var(--text-primary);
                border-bottom: 2px solid rgba(51, 65, 85, 0.6);
                padding-bottom: 8px;
                font-weight: 600;
            }
            .control-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            .control-item {
                background: rgba(30, 41, 59, 0.5);
                padding: 15px;
                border-radius: 8px;
                border: 1px solid rgba(51, 65, 85, 0.6);
            }
            .control-label {
                font-size: 14px;
                color: var(--text-secondary);
                margin-bottom: 8px;
                font-weight: 500;
            }
            .control-input {
                width: 100%;
                padding: 8px;
                border: 1px solid rgba(51, 65, 85, 0.6);
                background: rgba(15, 23, 42, 0.5);
                color: var(--text-primary);
                border-radius: 4px;
                margin-bottom: 8px;
                box-sizing: border-box;
            }
            .control-button {
                width: 100%;
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                background: var(--primary-color);
                color: white;
                cursor: pointer;
                transition: all 0.2s ease;
                font-weight: 500;
            }
            .control-button:hover {
                background: var(--primary-hover);
            }
            .control-button:disabled {
                background: #475569;
                cursor: not-allowed;
                opacity: 0.6;
            }
            .control-response {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 5px;
                min-height: 20px;
            }
            .control-response.success {
                color: var(--success-color);
            }
            .control-response.error {
                color: var(--danger-color);
            }
            .camera-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            .camera-table th, .camera-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid rgba(51, 65, 85, 0.6);
                color: var(--text-primary);
            }
            .camera-table th {
                background: rgba(30, 41, 59, 0.5);
                font-weight: 600;
            }
            .camera-ok { color: var(--success-color); font-weight: bold; }
            .camera-fail { color: var(--danger-color); font-weight: bold; }

            /* Camera Discovery Styles */
            .discovery-section {
                background: rgba(30, 41, 59, 0.4);
                border: 1px solid rgba(51, 65, 85, 0.6);
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
            }
            .discovery-controls {
                display: grid;
                grid-template-columns: 2fr 2fr 2fr 1fr;
                gap: 15px;
                margin-bottom: 20px;
                align-items: end;
            }
            .discovery-input-group {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .discovery-input-group label {
                font-size: 14px;
                color: var(--text-secondary);
                font-weight: 500;
            }
            .discovery-input {
                padding: 8px 12px;
                border: 1px solid rgba(51, 65, 85, 0.6);
                border-radius: 6px;
                font-size: 14px;
                background: rgba(15, 23, 42, 0.5);
                color: var(--text-primary);
            }
            .discovery-button {
                padding: 10px 20px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s;
            }
            .discovery-button:hover {
                background: var(--primary-hover);
            }
            .discovery-button:disabled {
                background: #475569;
                cursor: not-allowed;
                opacity: 0.6;
            }
            .discovery-status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-size: 14px;
            }
            .discovery-status.scanning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
            .discovery-status.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .discovery-status.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .discovered-cameras-list {
                display: grid;
                gap: 15px;
                margin-top: 20px;
            }
            .discovered-camera-item {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                padding: 15px;
                display: grid;
                grid-template-columns: 1fr 2fr auto;
                gap: 15px;
                align-items: center;
            }
            .discovered-camera-info {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .discovered-camera-ip {
                font-size: 16px;
                font-weight: bold;
                color: #333;
            }
            .discovered-camera-url {
                font-size: 12px;
                color: #666;
                font-family: monospace;
            }
            .discovered-camera-credentials {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .discovered-camera-credentials input {
                padding: 6px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 13px;
                width: 120px;
            }
            .discovered-camera-actions {
                display: flex;
                gap: 10px;
            }
            .test-camera-button {
                padding: 8px 16px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
            }
            .test-camera-button:hover {
                background: #218838;
            }
            .test-camera-button:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }
            .camera-preview-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                justify-content: center;
                align-items: center;
            }
            .camera-preview-content {
                background: white;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow: auto;
            }
            .camera-preview-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            .camera-preview-close {
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
            }
            .camera-preview-image {
                max-width: 100%;
                border-radius: 4px;
            }

            /* Camera Monitoring Styles */
            .camera-monitor-section {
                background: rgba(30, 41, 59, 0.4);
                border: 1px solid rgba(51, 65, 85, 0.6);
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
            }
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid rgba(51, 65, 85, 0.6);
            }
            .section-header h2 {
                margin: 0;
                color: var(--text-primary);
                font-weight: 600;
            }
            .camera-refresh-status {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                background-color: var(--success-color);
                color: white;
                font-weight: 500;
            }
            .camera-refresh-status.paused {
                background-color: var(--warning-color);
                color: #000;
            }
            .camera-refresh-status.error {
                background-color: var(--danger-color);
            }
            .camera-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
            }
            .camera-card {
                background: rgba(30, 41, 59, 0.5);
                border-radius: 8px;
                padding: 15px;
                border: 1px solid rgba(51, 65, 85, 0.6);
            }
            .camera-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(51, 65, 85, 0.6);
            }
            .camera-card-title {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }
            .camera-status-badge {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                color: white;
                font-weight: 500;
            }
            .camera-status-badge.running { background-color: var(--success-color); }
            .camera-status-badge.stopped { background-color: var(--danger-color); }
            .camera-card-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .camera-image-container {
                text-align: center;
            }
            .camera-image {
                max-width: 100%;
                max-height: 200px;
                border: 2px solid rgba(51, 65, 85, 0.6);
                border-radius: 6px;
                object-fit: contain;
                background: rgba(15, 23, 42, 0.3);
            }
            .camera-no-image {
                padding: 40px 15px;
                background: rgba(30, 41, 59, 0.3);
                border: 2px dashed rgba(51, 65, 85, 0.6);
                border-radius: 6px;
                color: var(--text-secondary);
                font-style: italic;
                font-size: 13px;
            }
            .camera-info {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .camera-info-item {
                display: flex;
                justify-content: space-between;
                padding: 6px 10px;
                background: rgba(15, 23, 42, 0.5);
                border: 1px solid rgba(51, 65, 85, 0.6);
                border-radius: 4px;
                font-size: 13px;
            }
            .camera-info-label { color: var(--text-secondary); }
            .camera-info-value { font-weight: bold; color: var(--text-primary); }
            .camera-config-section {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid rgba(51, 65, 85, 0.6);
            }
            .camera-config-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 10px;
            }
            .camera-config-item {
                display: flex;
                flex-direction: column;
            }
            .camera-config-item label {
                font-size: 11px;
                color: var(--text-secondary);
                margin-bottom: 3px;
            }
            .camera-config-item input {
                padding: 5px 8px;
                border: 1px solid rgba(51, 65, 85, 0.6);
                background: rgba(15, 23, 42, 0.5);
                color: var(--text-primary);
                border-radius: 4px;
                font-size: 12px;
            }
            .camera-actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 10px;
            }
            .camera-btn {
                padding: 5px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s;
                font-weight: 500;
            }
            .camera-btn-primary { background-color: var(--primary-color); color: white; }
            .camera-btn-primary:hover { background-color: var(--primary-hover); }
            .camera-btn-success { background-color: var(--success-color); color: white; }
            .camera-btn-success:hover { background-color: #059669; }
            .camera-btn-danger { background-color: var(--danger-color); color: white; }
            .camera-btn-danger:hover { background-color: #dc2626; }
            .camera-btn-secondary { background-color: rgba(100, 116, 139, 0.8); color: white; }
            .camera-btn-secondary:hover { background-color: rgba(71, 85, 105, 0.9); }
            .camera-message {
                padding: 6px 10px;
                border-radius: 4px;
                margin-top: 8px;
                font-size: 12px;
                display: none;
            }
            .camera-message.success { background-color: rgba(16, 185, 129, 0.2); color: var(--success-color); border: 1px solid var(--success-color); display: block; }
            .camera-message.error { background-color: rgba(239, 68, 68, 0.2); color: var(--danger-color); border: 1px solid var(--danger-color); display: block; }
            .camera-message.info { background-color: rgba(59, 130, 246, 0.2); color: var(--primary-color); border: 1px solid var(--primary-color); display: block; }
            .camera-loading {
                text-align: center;
                padding: 40px;
                color: var(--text-secondary);
                font-style: italic;
            }

            .timestamp-footer {
                font-size: 14px;
                color: #666;
                margin-top: 20px;
                text-align: center;
            }

            /* Tab Navigation Styles */
            .tab-navigation {
                display: flex;
                flex-wrap: nowrap;
                gap: 6px;
                border-bottom: none;
                margin-bottom: 0;
                background: rgba(30, 41, 59, 0.3);
                padding: 8px;
                border-radius: 8px;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
            }

            .tab-navigation::-webkit-scrollbar {
                height: 4px;
            }

            .tab-navigation::-webkit-scrollbar-track {
                background: transparent;
            }

            .tab-navigation::-webkit-scrollbar-thumb {
                background: rgba(59, 130, 246, 0.3);
                border-radius: 2px;
            }

            .tab-button {
                padding: 9px 18px;
                background: rgba(30, 41, 59, 0.3);
                border: 1px solid rgba(51, 65, 85, 0.4);
                border-radius: 7px;
                cursor: pointer;
                font-family: inherit;
                font-size: 12px;
                font-weight: 500;
                color: var(--text-secondary);
                transition: all 0.25s ease;
                white-space: nowrap;
                position: relative;
                flex-shrink: 0;
            }

            .tab-button:hover {
                color: var(--text-primary);
                background: rgba(30, 41, 59, 0.5);
                border-color: rgba(59, 130, 246, 0.3);
                transform: translateY(-1px);
            }

            .tab-button.active {
                color: white;
                background: var(--primary-color);
                border-color: var(--primary-color);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            /* Timeline Slideshow Navigation Buttons */
            .timeline-nav-btn {
                font-size: 14px;
                font-weight: bold;
                padding: 6px 12px;
                cursor: pointer;
                background: #222;
                color: #fff;
                border: 1px solid #555;
                border-radius: 4px;
                transition: background 0.2s ease;
            }
            .timeline-nav-btn:hover {
                background: #444;
            }
            .timeline-nav-btn:active {
                transform: scale(0.95);
            }
            #timeline-toggle-auto.stopped {
                background: #800;
            }

            /* Responsive Design for Mobile */
            @media (max-width: 768px) {
                body {
                    padding: 6px;
                }

                .container {
                    padding: 10px;
                    border-radius: 8px;
                }

                .header-container {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 12px;
                    margin-bottom: 20px;
                    padding-bottom: 12px;
                }

                .header-title {
                    font-size: 20px;
                }

                /* Stack dashboard layout vertically on mobile */
                #tab-dashboard > div:first-child {
                    grid-template-columns: 1fr !important;
                    gap: 12px !important;
                }

                /* Make tabs scrollable horizontally */
                .tab-navigation {
                    overflow-x: auto;
                    overflow-y: hidden;
                    -webkit-overflow-scrolling: touch;
                    scrollbar-width: none;
                    gap: 6px !important;
                }

                .tab-navigation::-webkit-scrollbar {
                    display: none;
                }

                .tab-button {
                    padding: 8px 14px;
                    font-size: 11px;
                    white-space: nowrap;
                }

                /* Adjust status boxes */
                .status-box {
                    padding: 10px;
                }

                /* Timeline adjustments */
                #timeline-slide-wrapper {
                    height: 300px !important;
                }

                .timeline-nav-btn {
                    padding: 4px 8px;
                    font-size: 12px;
                }

                #timeline-counter {
                    font-size: 11px !important;
                }

                /* Control buttons */
                .control-button {
                    padding: 10px;
                    font-size: 14px;
                }

                /* Serial data grid - 2 columns on mobile */
                .status-box [style*="grid-template-columns: repeat(3"] {
                    grid-template-columns: repeat(2, 1fr) !important;
                }

                /* System resources - stack vertically */
                .status-box [style*="grid-template-columns: 1fr 1fr 1fr"] {
                    grid-template-columns: 1fr !important;
                }

                /* Save button adjustments */
                .header-container > div:last-child {
                    width: 100%;
                }

                .header-container > div:last-child button {
                    width: 100%;
                }
            }

            @media (max-width: 480px) {
                .header-title {
                    font-size: 18px;
                }

                .tab-button {
                    padding: 7px 12px;
                    font-size: 10px;
                }

                .status-box {
                    padding: 8px;
                    font-size: 11px;
                }

                #timeline-slide-wrapper {
                    height: 250px !important;
                }

                /* Audio section - stack vertically */
                .status-box [style*="display: flex"][style*="gap: 4px"] {
                    flex-direction: column !important;
                    align-items: flex-start !important;
                }
            }

            /* RTL support for Arabic and Persian */
            [dir="rtl"] .tab-navigation { direction: rtl; }
            [dir="rtl"] .header-container { direction: rtl; }
            [dir="rtl"] select, [dir="rtl"] input, [dir="rtl"] textarea { direction: rtl; }
        </style>
    </head>
    <body>
        <script>
            // ===== Internationalization (i18n) System =====
            var currentLang = localStorage.getItem('monitaqc_lang') || 'en';

            var translations = {
                en: {
                    // Tabs
                    tab_dashboard: "Dashboard", tab_ai: "AI Assistant", tab_gallery: "Gallery",
                    tab_charts: "Charts", tab_hardware: "Hardware", tab_cameras: "Cameras",
                    tab_inference: "Inference", tab_advanced: "Advanced",
                    // Header
                    save_all: "Save All Configuration", last_saved: "Last:", never: "Never",
                    // Dashboard
                    shipment: "Shipment", status: "Status", encoder: "Encoder", speed: "Speed",
                    movement: "Movement", ej_queue: "Ej Queue", ej_active: "Ej Active",
                    ej_enable: "Ej Enable", ej_offset: "Ej Offset",
                    ok: "OK", ng: "NG", downtime: "Downtime", analog: "Analog",
                    power: "Power", capture: "Capture", inference: "Inference",
                    checking: "Checking...", online: "Online", offline: "Offline",
                    moving: "Moving", stopped: "Stopped", enabled: "Enabled", disabled: "Disabled",
                    // Timeline
                    first: "First", previous: "Previous", next: "Next", last: "Last",
                    zoom_in: "Zoom In", reset_zoom: "Reset Zoom", zoom_out: "Zoom Out",
                    stop_update: "Stop Auto-Update", resume_update: "Resume Auto-Update",
                    no_frames: "No frames yet",
                    // Cameras
                    camera_discovery: "IP Camera Discovery", network_subnet: "Network Subnet (first 3 octets)",
                    scan_network: "Scan Network", camera_preview: "Camera Preview",
                    camera_name: "Camera Name (optional)", camera_monitoring: "Camera Monitoring",
                    refresh: "Refresh", apply: "Apply", save: "Save", delete: "Delete",
                    // Image Processing
                    image_processing: "Image Processing Configuration",
                    parent_objects: "Parent Object List", remove_raw: "Remove Raw Image After DM Decode",
                    // DataMatrix
                    dm_config: "DataMatrix Configuration", valid_dm_sizes: "Valid DM Char Sizes",
                    confidence_threshold: "Confidence Threshold", overlap_threshold: "Overlap Threshold",
                    // Features
                    histogram_feature: "Histogram Feature", save_histogram: "Save Histogram Images",
                    class_count_check: "Class Count Check", classes_to_check: "Classes to Check",
                    class_confidence: "Class Count Confidence Threshold",
                    light_status: "Light Status Check",
                    // State Management
                    state_management: "State Management (Camera Capture Control)",
                    trigger_capture: "Trigger Capture", available_states: "Available States",
                    create_edit_state: "Create/Edit State (Multi-Phase Capture)",
                    state_name: "State Name", delay: "Delay (s)", cameras: "Cameras",
                    // Hardware
                    hardware_config: "Hardware Configuration",
                    ok_config: "OK Counter Adjustment", ng_config: "NG Counter Adjustment",
                    offset_delay: "Offset Delay (milliseconds)", duration_pulses: "Duration Pulses",
                    duration_percent: "Duration Percent", encoder_factor: "Encoder Factor",
                    set: "Set", adjust: "Adjust",
                    // Counter Service
                    ejector_enabled: "Ejector Enabled", ejector_offset: "Ejector Offset (encoder counts)",
                    ejector_duration: "Ejector Duration (seconds)", ejector_poll: "Ejector Poll Interval (seconds)",
                    time_between: "Time Between Packages (seconds)",
                    capture_mode: "Capture Mode",
                    // Serial Port
                    serial_config: "Serial Port Configuration", serial_port: "Serial Port Device",
                    baud_rate: "Baud Rate", serial_mode: "Serial Mode",
                    auto_apply_serial: "Auto-Apply: Serial port settings are applied immediately when changed",
                    // Inference
                    inference_status: "Inference Status", pipeline: "Pipeline",
                    pipeline_management: "Inference Pipeline Management",
                    active_pipeline: "Active Pipeline", pipeline_config: "Pipeline Configuration",
                    available_pipelines: "Available Pipelines",
                    create_edit_pipeline: "Create/Edit Pipeline",
                    pipeline_name: "Pipeline Name", description: "Description",
                    models_in_pipeline: "Models in Pipeline", create_update: "Create/Update",
                    inference_models: "Inference Models", create_edit_model: "Create/Edit Model",
                    model_name: "Model Name", type: "Type", inference_url: "Inference URL",
                    fetch_models: "Fetch Models", min_confidence: "Min Confidence",
                    // Advanced
                    timeline_config: "Timeline Configuration",
                    show_bboxes: "Show Bounding Boxes", camera_order: "Camera Order (Columns)",
                    image_quality: "Image Quality", rows_per_page: "Rows per Page",
                    total_frames: "Total Frames Stored",
                    apply_timeline: "Apply Timeline Configuration",
                    redis_config: "Redis Configuration", redis_host: "Redis Host", redis_port: "Redis Port",
                    ai_config: "AI Configuration", active_model: "Active Model",
                    configured_models: "Configured Models", add_edit_model: "Add / Edit Model",
                    provider: "Provider", api_key: "API Key", save_model: "Save Model", clear: "Clear",
                    get_api_key: "Get API Key",
                    db_config: "Database Configuration", active_profile: "Active Profile",
                    configured_profiles: "Configured Profiles", add_edit_profile: "Add / Edit Profile",
                    profile_name: "Profile Name", host: "Host", port: "Port", database: "Database",
                    user: "User", password: "Password", save_profile: "Save Profile",
                    audio_config: "Audio Alerts Configuration",
                    voice_narration: "Enable Voice Narration", beep_sounds: "Enable Beep Sounds",
                    volume: "Volume", test_audio: "Test Audio",
                    per_object: "Per-Object Configuration", enable_all: "Enable All",
                    db_storage: "Database Storage Configuration",
                    store_annotations: "Store Annotations to Database",
                    // Charts
                    grafana_dashboard: "Grafana Dashboard",
                    default_creds: "Default Credentials",
                    connection_info: "TimescaleDB Connection",
                    // Language
                    language: "Language"
                },
                fa: {
                    tab_dashboard: "داشبورد", tab_ai: "دستیار هوشمند", tab_gallery: "گالری",
                    tab_charts: "نمودارها", tab_hardware: "سخت‌افزار", tab_cameras: "دوربین‌ها",
                    tab_inference: "استنتاج", tab_advanced: "پیشرفته",
                    save_all: "ذخیره تمام تنظیمات", last_saved: "آخرین:", never: "هرگز",
                    shipment: "محموله", status: "وضعیت", encoder: "انکودر", speed: "سرعت",
                    movement: "حرکت", ej_queue: "صف خروج", ej_active: "خروجی فعال",
                    ej_enable: "خروجی", ej_offset: "آفست خروجی",
                    ok: "سالم", ng: "معیوب", downtime: "توقف", analog: "آنالوگ",
                    power: "برق", capture: "ثبت", inference: "استنتاج",
                    checking: "در حال بررسی...", online: "آنلاین", offline: "آفلاین",
                    moving: "در حال حرکت", stopped: "متوقف", enabled: "فعال", disabled: "غیرفعال",
                    first: "اول", previous: "قبلی", next: "بعدی", last: "آخر",
                    zoom_in: "بزرگنمایی", reset_zoom: "بازنشانی", zoom_out: "کوچکنمایی",
                    stop_update: "توقف بروزرسانی", resume_update: "ادامه بروزرسانی",
                    no_frames: "هنوز فریمی نیست",
                    camera_discovery: "جستجوی دوربین IP", network_subnet: "زیرشبکه (۳ اکتت اول)",
                    scan_network: "اسکن شبکه", camera_preview: "پیش‌نمایش دوربین",
                    camera_name: "نام دوربین (اختیاری)", camera_monitoring: "مانیتورینگ دوربین",
                    refresh: "بروزرسانی", apply: "اعمال", save: "ذخیره", delete: "حذف",
                    image_processing: "تنظیمات پردازش تصویر",
                    parent_objects: "لیست اشیاء والد", remove_raw: "حذف تصویر خام بعد از دیکد",
                    dm_config: "تنظیمات DataMatrix", valid_dm_sizes: "اندازه‌های معتبر DM",
                    confidence_threshold: "آستانه اطمینان", overlap_threshold: "آستانه همپوشانی",
                    histogram_feature: "ویژگی هیستوگرام", save_histogram: "ذخیره تصاویر هیستوگرام",
                    class_count_check: "بررسی تعداد کلاس", classes_to_check: "کلاس‌های مورد بررسی",
                    class_confidence: "آستانه اطمینان تعداد کلاس",
                    light_status: "بررسی وضعیت نور",
                    state_management: "مدیریت وضعیت (کنترل ثبت دوربین)",
                    trigger_capture: "شروع ثبت", available_states: "وضعیت‌های موجود",
                    create_edit_state: "ایجاد/ویرایش وضعیت (ثبت چندمرحله‌ای)",
                    state_name: "نام وضعیت", delay: "تاخیر (ثانیه)", cameras: "دوربین‌ها",
                    hardware_config: "تنظیمات سخت‌افزار",
                    ok_config: "تنظیم شمارنده سالم", ng_config: "تنظیم شمارنده معیوب",
                    offset_delay: "تاخیر آفست (میلی‌ثانیه)", duration_pulses: "مدت پالس",
                    duration_percent: "درصد مدت", encoder_factor: "ضریب انکودر",
                    set: "تنظیم", adjust: "تنظیم",
                    ejector_enabled: "خروجی فعال", ejector_offset: "آفست خروجی (شمارش انکودر)",
                    ejector_duration: "مدت خروجی (ثانیه)", ejector_poll: "فاصله نظرسنجی خروجی (ثانیه)",
                    time_between: "زمان بین بسته‌ها (ثانیه)", capture_mode: "حالت ثبت",
                    serial_config: "تنظیمات پورت سریال", serial_port: "دستگاه پورت سریال",
                    baud_rate: "نرخ بود", serial_mode: "حالت سریال",
                    auto_apply_serial: "اعمال خودکار: تنظیمات پورت سریال فوری اعمال می‌شوند",
                    inference_status: "وضعیت استنتاج", pipeline: "خط لوله",
                    pipeline_management: "مدیریت خط لوله استنتاج",
                    active_pipeline: "خط لوله فعال", pipeline_config: "تنظیمات خط لوله",
                    available_pipelines: "خطوط لوله موجود",
                    create_edit_pipeline: "ایجاد/ویرایش خط لوله",
                    pipeline_name: "نام خط لوله", description: "توضیحات",
                    models_in_pipeline: "مدل‌ها در خط لوله", create_update: "ایجاد/بروزرسانی",
                    inference_models: "مدل‌های استنتاج", create_edit_model: "ایجاد/ویرایش مدل",
                    model_name: "نام مدل", type: "نوع", inference_url: "آدرس استنتاج",
                    fetch_models: "دریافت مدل‌ها", min_confidence: "حداقل اطمینان",
                    timeline_config: "تنظیمات تایم‌لاین",
                    show_bboxes: "نمایش جعبه‌های مرزی", camera_order: "ترتیب دوربین (ستون‌ها)",
                    image_quality: "کیفیت تصویر", rows_per_page: "ردیف در هر صفحه",
                    total_frames: "کل فریم‌های ذخیره شده",
                    apply_timeline: "اعمال تنظیمات تایم‌لاین",
                    redis_config: "تنظیمات Redis", redis_host: "هاست Redis", redis_port: "پورت Redis",
                    ai_config: "تنظیمات هوش مصنوعی", active_model: "مدل فعال",
                    configured_models: "مدل‌های تنظیم شده", add_edit_model: "افزودن / ویرایش مدل",
                    provider: "ارائه‌دهنده", api_key: "کلید API", save_model: "ذخیره مدل", clear: "پاک کردن",
                    get_api_key: "دریافت کلید API",
                    db_config: "تنظیمات پایگاه داده", active_profile: "پروفایل فعال",
                    configured_profiles: "پروفایل‌های تنظیم شده", add_edit_profile: "افزودن / ویرایش پروفایل",
                    profile_name: "نام پروفایل", host: "هاست", port: "پورت", database: "پایگاه داده",
                    user: "کاربر", password: "رمز عبور", save_profile: "ذخیره پروفایل",
                    audio_config: "تنظیمات هشدار صوتی",
                    voice_narration: "فعال‌سازی روایت صوتی", beep_sounds: "فعال‌سازی صدای بیپ",
                    volume: "حجم صدا", test_audio: "تست صدا",
                    per_object: "تنظیمات هر شیء", enable_all: "فعال‌سازی همه",
                    db_storage: "تنظیمات ذخیره‌سازی پایگاه داده",
                    store_annotations: "ذخیره حاشیه‌نویسی در پایگاه داده",
                    grafana_dashboard: "داشبورد Grafana",
                    default_creds: "اطلاعات ورود پیش‌فرض",
                    connection_info: "اتصال TimescaleDB",
                    language: "زبان"
                },
                ar: {
                    tab_dashboard: "لوحة التحكم", tab_ai: "مساعد ذكي", tab_gallery: "معرض",
                    tab_charts: "رسوم بيانية", tab_hardware: "أجهزة", tab_cameras: "كاميرات",
                    tab_inference: "استدلال", tab_advanced: "متقدم",
                    save_all: "حفظ جميع الإعدادات", last_saved: "آخر:", never: "أبداً",
                    shipment: "شحنة", status: "الحالة", encoder: "المشفر", speed: "السرعة",
                    movement: "الحركة", ej_queue: "طابور الطرد", ej_active: "الطرد نشط",
                    ej_enable: "تفعيل الطرد", ej_offset: "إزاحة الطرد",
                    ok: "سليم", ng: "معيب", downtime: "توقف", analog: "تناظري",
                    power: "الطاقة", capture: "التقاط", inference: "استدلال",
                    checking: "جاري الفحص...", online: "متصل", offline: "غير متصل",
                    moving: "متحرك", stopped: "متوقف", enabled: "مفعل", disabled: "معطل",
                    first: "الأول", previous: "السابق", next: "التالي", last: "الأخير",
                    zoom_in: "تكبير", reset_zoom: "إعادة تعيين", zoom_out: "تصغير",
                    stop_update: "إيقاف التحديث", resume_update: "استئناف التحديث",
                    no_frames: "لا توجد إطارات بعد",
                    camera_discovery: "اكتشاف كاميرا IP", network_subnet: "الشبكة الفرعية",
                    scan_network: "مسح الشبكة", camera_preview: "معاينة الكاميرا",
                    camera_name: "اسم الكاميرا (اختياري)", camera_monitoring: "مراقبة الكاميرا",
                    refresh: "تحديث", apply: "تطبيق", save: "حفظ", delete: "حذف",
                    image_processing: "إعدادات معالجة الصور",
                    parent_objects: "قائمة الكائنات الأصلية", remove_raw: "حذف الصورة الخام بعد الفك",
                    dm_config: "إعدادات DataMatrix", valid_dm_sizes: "أحجام DM الصالحة",
                    confidence_threshold: "عتبة الثقة", overlap_threshold: "عتبة التداخل",
                    histogram_feature: "ميزة الرسم البياني", save_histogram: "حفظ صور الرسم البياني",
                    class_count_check: "فحص عدد الفئات", classes_to_check: "الفئات المراد فحصها",
                    class_confidence: "عتبة ثقة عدد الفئات", light_status: "فحص حالة الضوء",
                    state_management: "إدارة الحالة (التحكم بالتقاط الكاميرا)",
                    trigger_capture: "بدء الالتقاط", available_states: "الحالات المتاحة",
                    create_edit_state: "إنشاء/تحرير حالة", state_name: "اسم الحالة",
                    delay: "تأخير (ثانية)", cameras: "كاميرات",
                    hardware_config: "إعدادات الأجهزة",
                    ok_config: "ضبط عداد السليم", ng_config: "ضبط عداد المعيب",
                    offset_delay: "تأخير الإزاحة (مللي ثانية)", duration_pulses: "نبضات المدة",
                    duration_percent: "نسبة المدة", encoder_factor: "معامل المشفر",
                    set: "تعيين", adjust: "ضبط",
                    ejector_enabled: "الطارد مفعل", ejector_offset: "إزاحة الطارد",
                    ejector_duration: "مدة الطارد (ثانية)", ejector_poll: "فاصل استقصاء الطارد",
                    time_between: "الوقت بين الحزم (ثانية)", capture_mode: "وضع الالتقاط",
                    serial_config: "إعدادات المنفذ التسلسلي", serial_port: "جهاز المنفذ",
                    baud_rate: "معدل البود", serial_mode: "وضع المنفذ",
                    auto_apply_serial: "تطبيق تلقائي: يتم تطبيق إعدادات المنفذ فوراً",
                    inference_status: "حالة الاستدلال", pipeline: "خط الأنابيب",
                    pipeline_management: "إدارة خطوط الاستدلال",
                    active_pipeline: "خط الأنابيب النشط", pipeline_config: "إعدادات خط الأنابيب",
                    available_pipelines: "الخطوط المتاحة",
                    create_edit_pipeline: "إنشاء/تحرير خط", pipeline_name: "اسم الخط",
                    description: "الوصف", models_in_pipeline: "نماذج في الخط",
                    create_update: "إنشاء/تحديث",
                    inference_models: "نماذج الاستدلال", create_edit_model: "إنشاء/تحرير نموذج",
                    model_name: "اسم النموذج", type: "النوع", inference_url: "عنوان الاستدلال",
                    fetch_models: "جلب النماذج", min_confidence: "الحد الأدنى للثقة",
                    timeline_config: "إعدادات الجدول الزمني",
                    show_bboxes: "إظهار المربعات المحيطة", camera_order: "ترتيب الكاميرا",
                    image_quality: "جودة الصورة", rows_per_page: "صفوف في الصفحة",
                    total_frames: "إجمالي الإطارات المخزنة",
                    apply_timeline: "تطبيق إعدادات الجدول",
                    redis_config: "إعدادات Redis", redis_host: "مضيف Redis", redis_port: "منفذ Redis",
                    ai_config: "إعدادات الذكاء الاصطناعي", active_model: "النموذج النشط",
                    configured_models: "النماذج المهيأة", add_edit_model: "إضافة / تحرير نموذج",
                    provider: "المزود", api_key: "مفتاح API", save_model: "حفظ النموذج", clear: "مسح",
                    get_api_key: "الحصول على مفتاح API",
                    db_config: "إعدادات قاعدة البيانات", active_profile: "الملف النشط",
                    configured_profiles: "الملفات المهيأة", add_edit_profile: "إضافة / تحرير ملف",
                    profile_name: "اسم الملف", host: "المضيف", port: "المنفذ", database: "قاعدة البيانات",
                    user: "المستخدم", password: "كلمة المرور", save_profile: "حفظ الملف",
                    audio_config: "إعدادات التنبيهات الصوتية",
                    voice_narration: "تفعيل السرد الصوتي", beep_sounds: "تفعيل أصوات التنبيه",
                    volume: "مستوى الصوت", test_audio: "اختبار الصوت",
                    per_object: "إعدادات كل كائن", enable_all: "تفعيل الكل",
                    db_storage: "إعدادات تخزين قاعدة البيانات",
                    store_annotations: "تخزين التعليقات في قاعدة البيانات",
                    grafana_dashboard: "لوحة Grafana", default_creds: "بيانات الدخول الافتراضية",
                    connection_info: "اتصال TimescaleDB", language: "اللغة"
                },
                de: {
                    tab_dashboard: "Dashboard", tab_ai: "KI-Assistent", tab_gallery: "Galerie",
                    tab_charts: "Diagramme", tab_hardware: "Hardware", tab_cameras: "Kameras",
                    tab_inference: "Inferenz", tab_advanced: "Erweitert",
                    save_all: "Alle Einstellungen speichern", last_saved: "Zuletzt:", never: "Nie",
                    shipment: "Sendung", status: "Status", encoder: "Encoder", speed: "Geschwindigkeit",
                    movement: "Bewegung", ej_queue: "Ausw. Warteschlange", ej_active: "Ausw. Aktiv",
                    ej_enable: "Auswerfer", ej_offset: "Ausw. Offset",
                    ok: "OK", ng: "Fehler", downtime: "Stillstand", analog: "Analog",
                    power: "Strom", capture: "Erfassung", inference: "Inferenz",
                    checking: "Prüfe...", online: "Online", offline: "Offline",
                    moving: "Bewegend", stopped: "Gestoppt", enabled: "Aktiviert", disabled: "Deaktiviert",
                    first: "Erste", previous: "Zurück", next: "Weiter", last: "Letzte",
                    zoom_in: "Vergrößern", reset_zoom: "Zurücksetzen", zoom_out: "Verkleinern",
                    stop_update: "Update stoppen", resume_update: "Update fortsetzen",
                    no_frames: "Noch keine Frames",
                    camera_discovery: "IP-Kamera Erkennung", network_subnet: "Netzwerk-Subnetz",
                    scan_network: "Netzwerk scannen", camera_preview: "Kamera-Vorschau",
                    camera_name: "Kameraname (optional)", camera_monitoring: "Kamera-Überwachung",
                    refresh: "Aktualisieren", apply: "Anwenden", save: "Speichern", delete: "Löschen",
                    image_processing: "Bildverarbeitungseinstellungen",
                    parent_objects: "Elternobjektliste", remove_raw: "Rohbild nach DM-Dekodierung löschen",
                    dm_config: "DataMatrix-Konfiguration", valid_dm_sizes: "Gültige DM-Größen",
                    confidence_threshold: "Konfidenzschwelle", overlap_threshold: "Überlappungsschwelle",
                    histogram_feature: "Histogramm-Funktion", save_histogram: "Histogrammbilder speichern",
                    class_count_check: "Klassenanzahl-Prüfung", classes_to_check: "Zu prüfende Klassen",
                    class_confidence: "Klassenanzahl-Konfidenzschwelle", light_status: "Lichtstatus-Prüfung",
                    state_management: "Zustandsverwaltung (Kamera-Erfassungssteuerung)",
                    trigger_capture: "Erfassung auslösen", available_states: "Verfügbare Zustände",
                    create_edit_state: "Zustand erstellen/bearbeiten", state_name: "Zustandsname",
                    delay: "Verzögerung (s)", cameras: "Kameras",
                    hardware_config: "Hardware-Konfiguration",
                    ok_config: "OK-Zähler Einstellung", ng_config: "Fehler-Zähler Einstellung",
                    offset_delay: "Offset-Verzögerung (ms)", duration_pulses: "Dauerimpulse",
                    duration_percent: "Dauer-Prozent", encoder_factor: "Encoder-Faktor",
                    set: "Setzen", adjust: "Anpassen",
                    ejector_enabled: "Auswerfer aktiv", ejector_offset: "Auswerfer-Offset",
                    ejector_duration: "Auswerfer-Dauer (s)", ejector_poll: "Auswerfer-Abfrageintervall",
                    time_between: "Zeit zwischen Paketen (s)", capture_mode: "Erfassungsmodus",
                    serial_config: "Serielle Schnittstelle", serial_port: "Serieller Port",
                    baud_rate: "Baudrate", serial_mode: "Serieller Modus",
                    auto_apply_serial: "Automatisch: Serielle Einstellungen werden sofort angewendet",
                    inference_status: "Inferenz-Status", pipeline: "Pipeline",
                    pipeline_management: "Inferenz-Pipeline-Verwaltung",
                    active_pipeline: "Aktive Pipeline", pipeline_config: "Pipeline-Konfiguration",
                    available_pipelines: "Verfügbare Pipelines",
                    create_edit_pipeline: "Pipeline erstellen/bearbeiten", pipeline_name: "Pipeline-Name",
                    description: "Beschreibung", models_in_pipeline: "Modelle in Pipeline",
                    create_update: "Erstellen/Aktualisieren",
                    inference_models: "Inferenz-Modelle", create_edit_model: "Modell erstellen/bearbeiten",
                    model_name: "Modellname", type: "Typ", inference_url: "Inferenz-URL",
                    fetch_models: "Modelle abrufen", min_confidence: "Min. Konfidenz",
                    timeline_config: "Timeline-Konfiguration",
                    show_bboxes: "Begrenzungsrahmen anzeigen", camera_order: "Kamera-Reihenfolge",
                    image_quality: "Bildqualität", rows_per_page: "Zeilen pro Seite",
                    total_frames: "Gespeicherte Frames gesamt",
                    apply_timeline: "Timeline-Konfiguration anwenden",
                    redis_config: "Redis-Konfiguration", redis_host: "Redis-Host", redis_port: "Redis-Port",
                    ai_config: "KI-Konfiguration", active_model: "Aktives Modell",
                    configured_models: "Konfigurierte Modelle", add_edit_model: "Modell hinzufügen/bearbeiten",
                    provider: "Anbieter", api_key: "API-Schlüssel", save_model: "Modell speichern", clear: "Löschen",
                    get_api_key: "API-Schlüssel erhalten",
                    db_config: "Datenbank-Konfiguration", active_profile: "Aktives Profil",
                    configured_profiles: "Konfigurierte Profile", add_edit_profile: "Profil hinzufügen/bearbeiten",
                    profile_name: "Profilname", host: "Host", port: "Port", database: "Datenbank",
                    user: "Benutzer", password: "Passwort", save_profile: "Profil speichern",
                    audio_config: "Audio-Alarm-Konfiguration",
                    voice_narration: "Sprachausgabe aktivieren", beep_sounds: "Signaltöne aktivieren",
                    volume: "Lautstärke", test_audio: "Audio testen",
                    per_object: "Objekt-Konfiguration", enable_all: "Alle aktivieren",
                    db_storage: "Datenbank-Speicher-Konfiguration",
                    store_annotations: "Annotationen in Datenbank speichern",
                    grafana_dashboard: "Grafana-Dashboard", default_creds: "Standard-Zugangsdaten",
                    connection_info: "TimescaleDB-Verbindung", language: "Sprache"
                },
                tr: {
                    tab_dashboard: "Panel", tab_ai: "Yapay Zeka", tab_gallery: "Galeri",
                    tab_charts: "Grafikler", tab_hardware: "Donanım", tab_cameras: "Kameralar",
                    tab_inference: "Çıkarım", tab_advanced: "Gelişmiş",
                    save_all: "Tüm Ayarları Kaydet", last_saved: "Son:", never: "Hiç",
                    shipment: "Sevkiyat", status: "Durum", encoder: "Enkoder", speed: "Hız",
                    movement: "Hareket", ej_queue: "Atıcı Kuyruk", ej_active: "Atıcı Aktif",
                    ej_enable: "Atıcı", ej_offset: "Atıcı Offset",
                    ok: "İyi", ng: "Hatalı", downtime: "Duruş", analog: "Analog",
                    power: "Güç", capture: "Yakalama", inference: "Çıkarım",
                    checking: "Kontrol ediliyor...", online: "Çevrimiçi", offline: "Çevrimdışı",
                    moving: "Hareket ediyor", stopped: "Durdu", enabled: "Etkin", disabled: "Devre dışı",
                    first: "İlk", previous: "Önceki", next: "Sonraki", last: "Son",
                    zoom_in: "Yakınlaştır", reset_zoom: "Sıfırla", zoom_out: "Uzaklaştır",
                    stop_update: "Güncellemeyi durdur", resume_update: "Güncellemeye devam",
                    no_frames: "Henüz kare yok",
                    camera_discovery: "IP Kamera Keşfi", network_subnet: "Ağ Alt Ağı",
                    scan_network: "Ağı Tara", camera_preview: "Kamera Önizleme",
                    camera_name: "Kamera Adı (isteğe bağlı)", camera_monitoring: "Kamera İzleme",
                    refresh: "Yenile", apply: "Uygula", save: "Kaydet", delete: "Sil",
                    image_processing: "Görüntü İşleme Ayarları",
                    parent_objects: "Ana Nesne Listesi", remove_raw: "DM Çözümlemesinden Sonra Ham Görüntüyü Sil",
                    hardware_config: "Donanım Yapılandırması",
                    ok_config: "İyi Sayaç Ayarı", ng_config: "Hatalı Sayaç Ayarı",
                    offset_delay: "Offset Gecikmesi (ms)", set: "Ayarla", adjust: "Ayarla",
                    serial_config: "Seri Port Yapılandırması", baud_rate: "Baud Hızı",
                    inference_status: "Çıkarım Durumu", pipeline: "Boru Hattı",
                    pipeline_management: "Çıkarım Boru Hattı Yönetimi",
                    active_pipeline: "Aktif Boru Hattı",
                    inference_models: "Çıkarım Modelleri", model_name: "Model Adı",
                    timeline_config: "Zaman Çizelgesi Yapılandırması",
                    redis_config: "Redis Yapılandırması",
                    ai_config: "Yapay Zeka Yapılandırması",
                    db_config: "Veritabanı Yapılandırması",
                    audio_config: "Sesli Uyarı Yapılandırması",
                    language: "Dil"
                },
                ja: {
                    tab_dashboard: "ダッシュボード", tab_ai: "AIアシスタント", tab_gallery: "ギャラリー",
                    tab_charts: "チャート", tab_hardware: "ハードウェア", tab_cameras: "カメラ",
                    tab_inference: "推論", tab_advanced: "詳細設定",
                    save_all: "全設定を保存", last_saved: "最終:", never: "なし",
                    shipment: "出荷", status: "状態", encoder: "エンコーダ", speed: "速度",
                    movement: "動作", ej_queue: "排出キュー", ej_active: "排出中",
                    ej_enable: "排出器", ej_offset: "排出オフセット",
                    ok: "良品", ng: "不良", downtime: "停止時間", analog: "アナログ",
                    power: "電源", capture: "キャプチャ", inference: "推論",
                    checking: "確認中...", online: "オンライン", offline: "オフライン",
                    moving: "動作中", stopped: "停止", enabled: "有効", disabled: "無効",
                    first: "最初", previous: "前へ", next: "次へ", last: "最後",
                    zoom_in: "拡大", reset_zoom: "リセット", zoom_out: "縮小",
                    stop_update: "更新停止", resume_update: "更新再開",
                    no_frames: "フレームがありません",
                    camera_discovery: "IPカメラ検出", scan_network: "ネットワークスキャン",
                    camera_monitoring: "カメラ監視",
                    refresh: "更新", apply: "適用", save: "保存", delete: "削除",
                    hardware_config: "ハードウェア設定",
                    ok_config: "良品カウンタ調整", ng_config: "不良カウンタ調整",
                    set: "設定", adjust: "調整",
                    serial_config: "シリアルポート設定",
                    inference_status: "推論状態", pipeline: "パイプライン",
                    pipeline_management: "推論パイプライン管理",
                    inference_models: "推論モデル", model_name: "モデル名",
                    timeline_config: "タイムライン設定",
                    redis_config: "Redis設定",
                    ai_config: "AI設定", db_config: "データベース設定",
                    audio_config: "音声アラート設定",
                    language: "言語"
                },
                es: {
                    tab_dashboard: "Panel", tab_ai: "Asistente IA", tab_gallery: "Galería",
                    tab_charts: "Gráficos", tab_hardware: "Hardware", tab_cameras: "Cámaras",
                    tab_inference: "Inferencia", tab_advanced: "Avanzado",
                    save_all: "Guardar toda la configuración", last_saved: "Último:", never: "Nunca",
                    shipment: "Envío", status: "Estado", encoder: "Codificador", speed: "Velocidad",
                    movement: "Movimiento", ej_queue: "Cola eyector", ej_active: "Eyector activo",
                    ej_enable: "Eyector", ej_offset: "Offset eyector",
                    ok: "OK", ng: "Defecto", downtime: "Inactividad", analog: "Analógico",
                    power: "Energía", capture: "Captura", inference: "Inferencia",
                    checking: "Verificando...", online: "En línea", offline: "Fuera de línea",
                    moving: "En movimiento", stopped: "Detenido", enabled: "Habilitado", disabled: "Deshabilitado",
                    first: "Primero", previous: "Anterior", next: "Siguiente", last: "Último",
                    zoom_in: "Acercar", reset_zoom: "Restablecer", zoom_out: "Alejar",
                    stop_update: "Detener actualización", resume_update: "Reanudar actualización",
                    no_frames: "Sin cuadros aún",
                    camera_discovery: "Descubrimiento de cámaras IP", scan_network: "Escanear red",
                    camera_monitoring: "Monitoreo de cámaras",
                    refresh: "Actualizar", apply: "Aplicar", save: "Guardar", delete: "Eliminar",
                    hardware_config: "Configuración de hardware",
                    ok_config: "Ajuste contador OK", ng_config: "Ajuste contador defectos",
                    set: "Establecer", adjust: "Ajustar",
                    serial_config: "Configuración de puerto serie",
                    inference_status: "Estado de inferencia", pipeline: "Tubería",
                    pipeline_management: "Gestión de tuberías de inferencia",
                    inference_models: "Modelos de inferencia", model_name: "Nombre del modelo",
                    timeline_config: "Configuración de línea de tiempo",
                    redis_config: "Configuración de Redis",
                    ai_config: "Configuración de IA", db_config: "Configuración de base de datos",
                    audio_config: "Configuración de alertas de audio",
                    language: "Idioma"
                }
            };

            // Get translation with English fallback
            function t(key) {
                return (translations[currentLang] && translations[currentLang][key]) || translations.en[key] || key;
            }

            // Apply translations to all elements with data-i18n attribute
            function applyLanguage(lang) {
                if (lang) {
                    currentLang = lang;
                    localStorage.setItem('monitaqc_lang', lang);
                }
                // Set RTL for Arabic and Persian
                var isRTL = (currentLang === 'ar' || currentLang === 'fa');
                document.documentElement.dir = isRTL ? 'rtl' : 'ltr';

                // Update all data-i18n elements
                document.querySelectorAll('[data-i18n]').forEach(function(el) {
                    var key = el.getAttribute('data-i18n');
                    var prefix = el.getAttribute('data-i18n-prefix') || '';
                    el.textContent = prefix + t(key);
                });
                // Update all data-i18n-placeholder elements
                document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
                    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
                });
                // Update language selector display
                var langSelect = document.getElementById('lang-select');
                if (langSelect) langSelect.value = currentLang;
            }
        </script>
        <div class="container">
            <!-- Compact Header: 3-column layout (sticky so tabs are always reachable) -->
            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: start; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 100; background: var(--bg-color, #0f172a); padding-top: 12px;">

                <!-- LEFT: Monitait Title (compact) -->
                <div style="min-width: 150px;">
                    <div style="font-size: 18px; font-weight: 700; line-height: 1.2; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        Monitait<br>Vision<br>Engine
                    </div>
                    <div style="font-size: 9px; color: var(--text-secondary); margin-top: 2px;">v2.0.0</div>
                </div>

                <!-- CENTER: Tab Navigation -->
                <div class="tab-navigation" style="margin: 0; flex: 1;">
                    <button class="tab-button active" onclick="switchTab('dashboard')">📊 <span data-i18n="tab_dashboard">Dashboard</span></button>
                    <button class="tab-button" onclick="switchTab('ai')">🤖 <span data-i18n="tab_ai">AI Assistant</span></button>
                    <button class="tab-button" onclick="switchTab('gallery')">🖼️ <span data-i18n="tab_gallery">Gallery</span></button>
                    <button class="tab-button" onclick="switchTab('grafana')">📈 <span data-i18n="tab_charts">Charts</span></button>
                    <button class="tab-button" onclick="switchTab('hardware')">🔧 <span data-i18n="tab_hardware">Hardware</span></button>
                    <button class="tab-button" onclick="switchTab('cameras')">📷 <span data-i18n="tab_cameras">Cameras</span></button>
                    <button class="tab-button" onclick="switchTab('infrastructure')">🔮 <span data-i18n="tab_inference">Inference</span></button>
                    <button class="tab-button" onclick="switchTab('advanced')">⚡ <span data-i18n="tab_advanced">Advanced</span></button>
                </div>

                <!-- RIGHT: Language + Save -->
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                    <select id="lang-select" onchange="applyLanguage(this.value)" style="padding: 4px 8px; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; font-size: 11px; cursor: pointer; margin-bottom: 2px;">
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="ja">日本語</option>
                        <option value="tr">Türkçe</option>
                        <option value="es">Español</option>
                        <option value="ar">العربية</option>
                        <option value="fa">فارسی</option>
                    </select>
                    <button onclick="saveAllServiceConfig()" style="padding: 8px 12px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                        💾 <span data-i18n="save_all">Save All Configuration</span>
                    </button>
                    <div style="font-size: 9px; color: var(--text-secondary);">
                        <span data-i18n="last_saved">Last:</span> <strong id="last-saved-time" style="color: var(--text-primary);"><span data-i18n="never">Never</span></strong>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <div style="display: grid; grid-template-columns: 10% 90%; gap: 8px;">
                    <!-- Left Column: Compact Stats Grid (10% width) -->
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <!-- Shipment & Status Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                            <!-- Shipment -->
                            <div class="status-box" style="padding: 5px;">
                                <div style="font-size: 8px; color: var(--text-secondary); margin-bottom: 2px;" data-i18n="shipment">Shipment</div>
                                <div id="shipment-value" style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 10px; font-weight: 600;" onclick="editShipmentId()">
                                    <span id="shipment-text">-</span>
                                    <span style="font-size: 9px; opacity: 0.6;">✏️</span>
                                </div>
                                <input type="text" id="shipment-input" style="display: none; padding: 3px; border: 2px solid var(--primary-color); border-radius: 3px; font-weight: bold; font-size: 10px; width: 100%;" placeholder="Shipment ID">
                                <div style="display: none; gap: 3px; margin-top: 3px;" id="shipment-buttons">
                                    <button onclick="saveShipmentId()" style="padding: 2px 8px; background: var(--success-color); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 9px;">✓</button>
                                    <button onclick="cancelEditShipment()" style="padding: 2px 8px; background: var(--text-secondary); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 9px;">✗</button>
                                </div>
                                <div style="font-size: 8px; color: var(--text-secondary); margin-top: 3px; padding-top: 3px; border-top: 1px solid var(--border-color);" id="device-status">Checking...</div>
                            </div>

                            <!-- Connection Status -->
                            <div class="status-box" style="padding: 5px;">
                                <div style="font-size: 8px; color: var(--text-secondary); margin-bottom: 2px;" data-i18n="status">Status</div>
                                <div class="data-source" id="dataSource" style="font-size: 9px; padding: 2px; background: var(--light-bg); border-radius: 3px; margin-bottom: 3px;">Loading...</div>
                                <div style="font-size: 8px; color: var(--text-secondary);">
                                    Last: <strong id="last-saved-time">Never</strong>
                                </div>
                            </div>
                        </div>

                        <!-- System Resources -->
                        <div class="status-box" style="padding: 5px;">
                            <div style="font-size: 8px; color: var(--text-secondary); margin-bottom: 3px;">💻 System</div>
                            <div style="font-size: 9px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px;">
                                <div>CPU: <strong id="system-cpu-value" style="color: var(--primary-color);">...</strong><br><span id="system-cpu-cores" style="font-size: 8px; color: var(--text-secondary);">...</span></div>
                                <div>RAM: <strong id="system-ram-value" style="color: var(--primary-color);">...</strong><br><span id="system-ram-details" style="font-size: 8px; color: var(--text-secondary);">...</span></div>
                                <div>Disk: <strong id="system-disk-value" style="color: var(--primary-color);">...</strong><br><span id="system-disk-details" style="font-size: 8px; color: var(--text-secondary);">...</span></div>
                            </div>
                        </div>

                        <!-- Serial Data Grid (3 columns) -->
                        <div class="status-box" style="padding: 5px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="encoder">Encoder</div>
                                    <div style="font-size: 10px; font-weight: 700; color: var(--text-primary);" id="encoder-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="speed">Speed</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="speed-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);">Pulses/s</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="pps-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="movement">Movement</div>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span class="movement-indicator" id="movement-indicator" style="width: 7px; height: 7px;"></span>
                                        <span style="font-size: 9px; font-weight: 600;" id="movement-value">-</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="ej_queue">Ej Queue</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="ejector-queue">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="ej_active">Ej Active</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="ejector-running">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="ej_enable">Ej Enable</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="ejector-enabled">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="ej_offset">Ej Offset</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="ejector-offset">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="ok">OK</div>
                                    <div style="font-size: 10px; font-weight: 600; color: var(--success-color);" id="ok-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="ng">NG</div>
                                    <div style="font-size: 10px; font-weight: 600; color: var(--danger-color);" id="ng-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="downtime">Downtime</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="downtime-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="analog">Analog</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="analog-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);" data-i18n="power">Power</div>
                                    <div style="font-size: 9px; font-weight: 600;" id="power-value">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Live Inference Stats -->
                        <div class="status-box" style="padding: 5px;">
                            <div style="font-size: 9px; color: var(--text-secondary); margin-bottom: 4px;">
                                <strong>Capture:</strong> <span id="inference-state-name" style="color: var(--primary-color); font-weight: 700;">...</span>
                                <span id="capture-heartbeat" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); margin-left: 4px; opacity: 0;"></span>
                            </div>
                            <div style="font-size: 9px; color: var(--text-secondary); margin-bottom: 4px;">
                                <strong>Inference:</strong>
                                <strong id="inference-service-name" style="color: var(--primary-color);">...</strong>
                                <span id="inference-heartbeat" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); margin-left: 4px; opacity: 0;"></span>
                                <span id="gradio-restart-warning" style="display: none; color: var(--danger-color); font-weight: bold;"> ⚠️</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 9px;">
                                <div>Proc: <strong id="inference-time-value">...</strong></div>
                                <div>Int: <strong id="frame-interval-value">...</strong></div>
                                <div>Inf: <strong id="inference-fps-value" style="color: inherit;">...</strong></div>
                                <div>Cap: <strong id="capture-fps-value">...</strong></div>
                            </div>
                            <!-- Queue Status Indicator -->
                            <div id="queue-status-bar" style="margin-top: 6px; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; display: none; align-items: center; gap: 6px;">
                                <span id="queue-icon">⚠️</span>
                                <span id="queue-message">Queue building up</span>
                                <span id="queue-ratio" style="margin-left: auto; font-size: 8px;"></span>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Camera Timeline -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Camera Timeline Slideshow with Embedded Controls -->
                        <div class="status-box" style="padding: 15px;">

                            <!-- Slideshow Container -->
                            <div id="timeline-slideshow-container" style="position: relative; background: #111; border: 2px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                <div id="timeline-slide-wrapper" style="width: 100%; height: 500px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                    <img id="timeline-slide" src="/timeline_image?page=0" style="max-width: 100%; max-height: 100%; width: auto; height: auto; user-select: none; display: block; object-fit: contain;" alt="Timeline" draggable="false" />
                                </div>

                                <!-- Navigation Footer -->
                                <div id="timeline-footer" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--border-color); flex-wrap: wrap;">
                                    <button id="timeline-first" class="timeline-nav-btn" title="First">&laquo;</button>
                                    <button id="timeline-prev" class="timeline-nav-btn" title="Previous">&larr;</button>
                                    <button id="timeline-next" class="timeline-nav-btn" title="Next">&rarr;</button>
                                    <button id="timeline-last" class="timeline-nav-btn" title="Last">&raquo;</button>
                                    <span style="width: 1px; height: 20px; background: var(--border-color); margin: 0 4px;"></span>
                                    <button id="timeline-zoom-in" class="timeline-nav-btn" title="Zoom In">+</button>
                                    <button id="timeline-reset-zoom" class="timeline-nav-btn" title="Reset Zoom">Reset</button>
                                    <button id="timeline-zoom-out" class="timeline-nav-btn" title="Zoom Out">–</button>
                                    <span style="width: 1px; height: 20px; background: var(--border-color); margin: 0 4px;"></span>
                                    <button id="timeline-toggle-auto" class="timeline-nav-btn" title="Stop/Resume Auto-Update">Stop</button>
                                    <span id="timeline-counter" style="font-size: 13px; font-weight: bold; color: #fff; margin-left: 8px;">1 / 1</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- End Dashboard Tab -->

            <!-- Cameras Tab -->
            <div id="tab-cameras" class="tab-content">
                <!-- Camera Discovery Section -->
                <div class="discovery-section">
                <div class="section-header">
                    <h2>🔍 <span data-i18n="camera_discovery">IP Camera Discovery</span></h2>
                </div>

                <div class="discovery-controls">
                    <div class="discovery-input-group">
                        <label for="subnet-input">Network Subnet (first 3 octets)</label>
                        <input type="text" id="subnet-input" class="discovery-input" value="192.168.0" placeholder="192.168.0">
                        <small style="color: #666; font-size: 11px;">Scan for IP cameras on this subnet</small>
                    </div>
                    <div class="discovery-input-group" style="display: flex; align-items: flex-end;">
                        <button id="scan-button" class="discovery-button" onclick="scanForCameras()">🔎 Scan Network</button>
                    </div>
                </div>

                <div id="discovery-status-container"></div>

                <div id="discovered-cameras-container"></div>
            </div>

            <!-- Camera Preview Modal -->
            <div id="camera-preview-modal" class="camera-preview-modal" onclick="closeCameraPreview(event)">
                <div class="camera-preview-content" onclick="event.stopPropagation()">
                    <div class="camera-preview-header">
                        <h3 id="preview-camera-title">Camera Preview</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="save-camera-button" class="discovery-button" onclick="saveDiscoveredCamera()" style="padding: 8px 16px;">💾 Save Camera</button>
                            <button class="camera-preview-close" onclick="closeCameraPreview()">Close</button>
                        </div>
                    </div>
                    <div id="preview-camera-info"></div>
                    <img id="preview-camera-image" class="camera-preview-image" src="" alt="Camera preview">
                    <div id="preview-camera-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Camera Name (optional):</label>
                            <input type="text" id="save-camera-name" placeholder="e.g., Front Door Camera, Line 1 Camera" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Monitoring Section -->
            <div class="camera-monitor-section">
                <div class="section-header">
                    <h2>📷 <span data-i18n="camera_monitoring">Camera Monitoring</span></h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="camera-refresh-status" id="camera-refresh-status">Active</span>
                        <button class="control-button" style="width: auto; padding: 6px 12px;" onclick="refreshCameras()">🔄 Refresh</button>
                    </div>
                </div>

                <div id="camera-grid" class="camera-grid">
                    <div class="camera-loading">Loading camera controls...</div>
                </div>
            </div>

            <!-- Legacy Camera Status Table (kept for backward compatibility) -->
            <div id="legacy-camera-status-container" style="display: none;">
                <h2>Camera Connection Status</h2>
                <table class="camera-table">
                    <thead>
                        <tr>
                            <th>Camera</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="camera-table-body">
                        <tr><td colspan="2">Loading...</td></tr>
                    </tbody>
                </table>

                <div class="control-section">
                    <h3 data-i18n="image_processing">Image Processing Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item" style="grid-column: span 2;">
                            <div class="control-label">Parent Object List (comma-separated, use _root for no parent requirement)</div>
                            <input type="text" class="control-input" id="parent-object-list-input" value="_root,box,pack,DP-105,jean,knit">
                            <button class="control-button" onclick="updateConfig('parent_object_list', document.getElementById('parent-object-list-input').value)">Set Parent Objects</button>
                            <div class="control-response" id="config-parent_object_list-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Remove Raw Image After DM Decode</div>
                            <select class="control-input" id="remove-raw-image-input">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('remove_raw_image_when_dm_decoded', document.getElementById('remove-raw-image-input').value)">Set</button>
                            <div class="control-response" id="config-remove_raw_image_when_dm_decoded-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3 data-i18n="dm_config">DataMatrix Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Valid DM Char Sizes (comma-separated)</div>
                            <input type="text" class="control-input" id="dm-chars-sizes-input" value="13,19,26">
                            <button class="control-button" onclick="updateConfig('dm_chars_sizes', document.getElementById('dm-chars-sizes-input').value)">Set Sizes</button>
                            <div class="control-response" id="config-dm_chars_sizes-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Confidence Threshold (0-1)</div>
                            <input type="number" class="control-input" id="dm-confidence-input" min="0" max="1" step="0.05" value="0.8">
                            <button class="control-button" onclick="updateConfig('dm_confidence_threshold', document.getElementById('dm-confidence-input').value)">Set Confidence</button>
                            <div class="control-response" id="config-dm_confidence_threshold-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Overlap Threshold (0-1)</div>
                            <input type="number" class="control-input" id="dm-overlap-input" min="0" max="1" step="0.05" value="0.2">
                            <button class="control-button" onclick="updateConfig('dm_overlap_threshold', document.getElementById('dm-overlap-input').value)">Set Overlap</button>
                            <div class="control-response" id="config-dm_overlap_threshold-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Feature Toggles</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Histogram Feature</div>
                            <select class="control-input" id="histogram-enabled-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('histogram_enabled', document.getElementById('histogram-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-histogram_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Save Histogram Images</div>
                            <select class="control-input" id="histogram-save-image-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('histogram_save_image', document.getElementById('histogram-save-image-input').value)">Set</button>
                            <div class="control-response" id="config-histogram_save_image-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Class Count Check (equal counts)</div>
                            <select class="control-input" id="check-class-enabled-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('check_class_counts_enabled', document.getElementById('check-class-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-check_class_counts_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Classes to Check (comma-separated)</div>
                            <input type="text" class="control-input" id="check-class-classes-input" value="socket,nozzle">
                            <button class="control-button" onclick="updateConfig('check_class_counts_classes', document.getElementById('check-class-classes-input').value)">Set Classes</button>
                            <div class="control-response" id="config-check_class_counts_classes-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Class Count Confidence Threshold</div>
                            <input type="number" class="control-input" id="check-class-confidence-input" value="0.5" min="0" max="1" step="0.05">
                            <button class="control-button" onclick="updateConfig('check_class_counts_confidence', document.getElementById('check-class-confidence-input').value)">Set</button>
                            <div class="control-response" id="config-check_class_counts_confidence-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Light Status Check (closed-loop)</div>
                            <select class="control-input" id="light-status-check-input">
                                <option value="false" selected>Disabled (open-loop, faster)</option>
                                <option value="true">Enabled (verify via serial)</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('light_status_check_enabled', document.getElementById('light-status-check-input').value)">Set</button>
                            <div class="control-response" id="config-light_status_check_enabled-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3 data-i18n="state_management">State Management (Camera Capture Control)</h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Current State:</span>
                            <span id="current-state-name" style="font-size: 16px; font-weight: bold; color: #007bff;">Loading...</span>
                            <span id="capture-state-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="camera-btn camera-btn-success" onclick="triggerCapture()">Trigger Capture</button>
                            <button class="camera-btn camera-btn-primary" onclick="refreshStates()">Refresh</button>
                        </div>
                        <div id="state-message" style="margin-top: 8px; padding: 6px 10px; border-radius: 4px; font-size: 12px; display: none;"></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Available States</h4>
                        <div id="states-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading states...</span>
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Create/Edit State (Multi-Phase Capture)</h4>
                        <div class="control-grid" style="margin-bottom: 15px;">
                            <div class="control-item">
                                <div class="control-label">State Name</div>
                                <input type="text" class="control-input" id="state-name-input" placeholder="e.g., default">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Enabled</div>
                                <select class="control-input" id="state-enabled-input">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5 style="margin: 0; color: #495057;">Capture Phases</h5>
                                <button class="camera-btn camera-btn-success" onclick="addPhase()" style="padding: 4px 10px; font-size: 11px;">+ Add Phase</button>
                            </div>

                            <div id="phases-container">
                                <!-- Phase 1 (default) - all cameras -->
                                <div class="phase-row" id="phase-row-0" style="display: grid; grid-template-columns: 1.2fr 0.8fr 1fr 0.8fr 0.8fr auto; gap: 6px; align-items: end; margin-bottom: 8px; padding: 8px; background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(51, 65, 85, 0.4); border-radius: 4px;">
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Light Mode</label>
                                        <select class="control-input phase-light" style="margin: 0; padding: 4px; font-size: 12px;">
                                            <option value="U_ON_B_OFF" selected>U On, B Off</option>
                                            <option value="U_OFF_B_ON">U Off, B On</option>
                                            <option value="U_ON_B_ON">U On, B On</option>
                                            <option value="U_OFF_B_OFF">U Off, B Off</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Delay (s)</label>
                                        <input type="number" class="control-input phase-delay" value="0.1" min="0" step="0.01" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Cameras</label>
                                        <input type="text" class="control-input phase-cameras" value="1,2,3,4" placeholder="1,2,3,4" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Steps (-1=loop)</label>
                                        <input type="number" class="control-input phase-steps" value="1" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Analog (-1=off)</label>
                                        <input type="number" class="control-input phase-analog" value="-1" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <button class="camera-btn camera-btn-danger" onclick="removePhase(0)" style="padding: 4px 8px; font-size: 11px;">✕</button>
                                </div>
                            </div>
                            <p style="font-size: 10px; color: #888; margin: 8px 0 0 0;">Steps: -1=infinite loop, 1=every step, N=every N steps. Analog: -1=disabled, N=trigger when analog≥N.</p>
                        </div>

                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="control-button" style="background-color: #28a745;" onclick="createOrUpdateState()">Create/Update State</button>
                            <button class="control-button" style="background-color: #dc3545;" onclick="deleteCurrentState()">Delete State</button>
                        </div>
                        <div class="control-response" id="state-config-response"></div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Cameras Tab -->

            <!-- Hardware Tab -->
            <div id="tab-hardware" class="tab-content">
                <h2 style="margin: 0 0 20px 0; color: var(--text-primary); font-weight: 600;" data-i18n="hardware_config">Hardware Configuration</h2>

                <!-- Status Indicators -->
                <div class="control-section">
                    <h3>Status Indicators</h3>
                    <div class="status-box" style="padding: 16px;">
                        <div class="status-indicators" style="justify-content: center; gap: 40px;">
                            <div class="status-indicator">
                                <div class="status-circle U" id="U-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">U (Upper)</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-circle B" id="B-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">B (Bottom)</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-circle warning" id="warning-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">Warning</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Controls -->
                <div class="control-section">
                    <h3>Basic Controls</h3>
                    <div class="control-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="control-item" style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 10px;">
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('U_ON_B_ON')">Both On</button>
                                <div class="control-response" id="cmd-U_ON_B_ON-response"></div>
                            </div>
                            <div class="control-item" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <button class="control-button" onclick="sendCommand('U_ON_B_OFF')">U On, B Off</button>
                                    <div class="control-response" id="cmd-U_ON_B_OFF-response"></div>
                                </div>
                                <div>
                                    <button class="control-button" onclick="sendCommand('B_ON_U_OFF')">B On, U Off</button>
                                    <div class="control-response" id="cmd-B_ON_U_OFF-response"></div>
                                </div>
                            </div>
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('B_OFF_U_OFF')">Both Off</button>
                                <div class="control-response" id="cmd-B_OFF_U_OFF-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Upper PWM Value (0-255)</div>
                                <input type="number" class="control-input" id="pwm-up" min="0" max="255" value="255">
                                <button class="control-button" onclick="sendCommand('U_SET_PWM', document.getElementById('pwm-up').value)">Set Upper PWM</button>
                                <div class="control-response" id="cmd-U_SET_PWM-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Bottom PWM Value (0-255)</div>
                                <input type="number" class="control-input" id="pwm-down" min="0" max="255" value="255">
                                <button class="control-button" onclick="sendCommand('B_SET_PWM', document.getElementById('pwm-down').value)">Set Bottom PWM</button>
                                <div class="control-response" id="cmd-B_SET_PWM-response"></div>
                            </div>
                        </div>
                        <div class="control-item" style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 10px;">
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('RESET_ENCODER')">Reset Encoder</button>
                                <div class="control-response" id="cmd-RESET_ENCODER-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label">Warning LED</div>
                                <button class="control-button" onclick="sendCommand('WARNING_ON')">Warning On</button>
                                <button class="control-button" onclick="sendCommand('WARNING_OFF')" style="margin-top: 5px;">Warning Off</button>
                                <div class="control-response" id="cmd-WARNING-response"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OK Configuration -->
                <div class="control-section">
                    <h3>OK Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">OK Counter Adjustment</div>
                            <input type="number" class="control-input" id="ok-adjust" value="0">
                            <button class="control-button" onclick="sendCommand('OK_ADJUST', document.getElementById('ok-adjust').value)">Adjust OK Counter</button>
                            <div class="control-response" id="cmd-OK_ADJUST-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Offset Delay (milliseconds)</div>
                            <input type="number" class="control-input" id="ok-offset-delay" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('OK_OFFSET_DELAY', document.getElementById('ok-offset-delay').value)">Set Offset Delay</button>
                            <div class="control-response" id="cmd-OK_OFFSET_DELAY-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Pulses (16us each)</div>
                            <input type="number" class="control-input" id="ok-duration-pulses" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('OK_DURATION_PULSES', document.getElementById('ok-duration-pulses').value)">Set Duration Pulses</button>
                            <div class="control-response" id="cmd-OK_DURATION_PULSES-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Percent</div>
                            <input type="number" class="control-input" id="ok-duration-percent" min="0" max="100" value="0">
                            <button class="control-button" onclick="sendCommand('OK_DURATION_PERCENT', document.getElementById('ok-duration-percent').value)">Set Duration Percent</button>
                            <div class="control-response" id="cmd-OK_DURATION_PERCENT-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Encoder Factor</div>
                            <input type="number" class="control-input" id="ok-encoder-factor" value="0">
                            <button class="control-button" onclick="sendCommand('OK_ENCODER_FACTOR', document.getElementById('ok-encoder-factor').value)">Set Encoder Factor</button>
                            <div class="control-response" id="cmd-OK_ENCODER_FACTOR-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>NG Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">NG Counter Adjustment</div>
                            <input type="number" class="control-input" id="ng-adjust" value="0">
                            <button class="control-button" onclick="sendCommand('NG_ADJUST', document.getElementById('ng-adjust').value)">Adjust NG Counter</button>
                            <div class="control-response" id="cmd-NG_ADJUST-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Offset Delay (milliseconds)</div>
                            <input type="number" class="control-input" id="ng-offset-delay" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('NG_OFFSET_DELAY', document.getElementById('ng-offset-delay').value)">Set Offset Delay</button>
                            <div class="control-response" id="cmd-NG_OFFSET_DELAY-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Pulses (16us each)</div>
                            <input type="number" class="control-input" id="ng-duration-pulses" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('NG_DURATION_PULSES', document.getElementById('ng-duration-pulses').value)">Set Duration Pulses</button>
                            <div class="control-response" id="cmd-NG_DURATION_PULSES-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Duration Percent</div>
                            <input type="number" class="control-input" id="ng-duration-percent" min="0" max="100" value="0">
                            <button class="control-button" onclick="sendCommand('NG_DURATION_PERCENT', document.getElementById('ng-duration-percent').value)">Set Duration Percent</button>
                            <div class="control-response" id="cmd-NG_DURATION_PERCENT-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Encoder Factor</div>
                            <input type="number" class="control-input" id="ng-encoder-factor" value="0">
                            <button class="control-button" onclick="sendCommand('NG_ENCODER_FACTOR', document.getElementById('ng-encoder-factor').value)">Set Encoder Factor</button>
                            <div class="control-response" id="cmd-NG_ENCODER_FACTOR-response"></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Counter Service Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Ejector Enabled</div>
                            <select class="control-input" id="ejector-enabled-input">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('ejector_enabled', document.getElementById('ejector-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-ejector_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Ejector Offset (encoder counts)</div>
                            <input type="number" class="control-input" id="ejector-offset-input" min="0" value="0">
                            <button class="control-button" onclick="updateConfig('ejector_offset', document.getElementById('ejector-offset-input').value)">Set Offset</button>
                            <div class="control-response" id="config-ejector_offset-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Ejector Duration (seconds)</div>
                            <input type="number" class="control-input" id="ejector-duration-input" min="0" step="0.1" value="0.4">
                            <button class="control-button" onclick="updateConfig('ejector_duration', document.getElementById('ejector-duration-input').value)">Set Duration</button>
                            <div class="control-response" id="config-ejector_duration-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Ejector Poll Interval (seconds)</div>
                            <input type="number" class="control-input" id="ejector-poll-input" min="0.001" step="0.01" value="0.03">
                            <button class="control-button" onclick="updateConfig('ejector_poll_interval', document.getElementById('ejector-poll-input').value)">Set Poll Interval</button>
                            <div class="control-response" id="config-ejector_poll_interval-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Time Between Packages (seconds)</div>
                            <input type="number" class="control-input" id="time-between-packages-input" min="0" step="0.001" value="0.305">
                            <button class="control-button" onclick="updateConfig('time_between_packages', document.getElementById('time-between-packages-input').value)">Set Time</button>
                            <div class="control-response" id="config-time_between_packages-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Capture Mode</div>
                            <select class="control-input" id="capture-mode-input">
                                <option value="single">Single</option>
                                <option value="multiple">Multiple</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('capture_mode', document.getElementById('capture-mode-input').value)">Set Mode</button>
                            <div class="control-response" id="config-capture_mode-response"></div>
                        </div>
                    </div>
                </div>

                <!-- Serial Port Configuration -->
                <div class="control-section">
                    <h3 data-i18n="serial_config">Serial Port Configuration</h3>
                    <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Device Status:</span>
                            <span id="serial-device-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="serial-device-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="serial-device-text" style="color: var(--text-primary);">Checking...</span>
                            </span>
                            <span id="serial-device-info" style="font-size: 12px; color: var(--text-secondary);"></span>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Serial Port Device</div>
                            <input type="text" class="control-input" id="watcher-usb-input" value="/dev/ttyUSB0" placeholder="/dev/ttyUSB0">
                            <button class="control-button" onclick="updateConfig('watcher_usb', document.getElementById('watcher-usb-input').value)">Set Port</button>
                            <div class="control-response" id="config-watcher_usb-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Baud Rate</div>
                            <select class="control-input" id="baud-rate-input">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600" selected>57600</option>
                                <option value="115200">115200</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('baud_rate', document.getElementById('baud-rate-input').value)">Set Baud Rate</button>
                            <div class="control-response" id="config-baud_rate-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Serial Mode</div>
                            <select class="control-input" id="serial-mode-input">
                                <option value="new" selected>Normal</option>
                                <option value="legacy">Legacy</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('serial_mode', document.getElementById('serial-mode-input').value)">Set Mode</button>
                            <div class="control-response" id="config-serial_mode-response"></div>
                        </div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: var(--primary-color);">
                        ℹ️ <strong>Auto-Apply:</strong> Serial port settings are applied immediately when changed. The connection will be reinitialized automatically.
                    </div>
                </div>

                <div class="control-section">
                    <h3>Watcher Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Downtime Threshold (seconds)</div>
                            <input type="number" class="control-input" id="downtime-threshold" min="1" value="10">
                            <button class="control-button" onclick="sendCommand('SET_DOWNTIME', document.getElementById('downtime-threshold').value)">Set Threshold</button>
                            <div class="control-response" id="cmd-SET_DOWNTIME-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">External Reset</div>
                            <select class="control-input" id="external-reset">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                            <button class="control-button" onclick="sendCommand('SET_EXTERNAL_RESET', document.getElementById('external-reset').value)">Set External Reset</button>
                            <div class="control-response" id="cmd-SET_EXTERNAL_RESET-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Verbose Mode</div>
                            <select class="control-input" id="verbose-mode">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                            <button class="control-button" onclick="sendCommand('SET_VERBOSE', document.getElementById('verbose-mode').value)">Set Verbose Mode</button>
                            <div class="control-response" id="cmd-SET_VERBOSE-response"></div>
                        </div>
                    </div>
                    <div class="verbose-panel" style="margin-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Watcher Verbose Configuration (Read-only)</h4>
                        <div class="verbose-grid">
                            <div>
                                <div class="verbose-item-label">OK Offset Delay (OOD)</div>
                                <div class="verbose-item-value" id="v-ood">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Duration Pulses (ODP)</div>
                                <div class="verbose-item-value" id="v-odp">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Duration Percent (ODL)</div>
                                <div class="verbose-item-value" id="v-odl">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Encoder Factor (OEF)</div>
                                <div class="verbose-item-value" id="v-oef">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Offset Delay (NOD)</div>
                                <div class="verbose-item-value" id="v-nod">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Duration Pulses (NDP)</div>
                                <div class="verbose-item-value" id="v-ndp">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Duration Percent (NDL)</div>
                                <div class="verbose-item-value" id="v-ndl">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Encoder Factor (NEF)</div>
                                <div class="verbose-item-value" id="v-nef">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">External Reset (EXT)</div>
                                <div class="verbose-item-value" id="v-ext">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">Baud Rate (BUD)</div>
                                <div class="verbose-item-value" id="v-bud">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">Downtime Threshold (DWT)</div>
                                <div class="verbose-item-value" id="v-dwt">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Hardware Tab -->

            <!-- Inference Tab -->
            <div id="tab-infrastructure" class="tab-content">
                <div class="control-section">
                    <h3 data-i18n="inference_status">Inference Status</h3>
                    <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Pipeline:</span>
                            <span id="pipeline-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="pipeline-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="pipeline-text" style="color: var(--text-primary);">Checking...</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3 data-i18n="pipeline_management">Inference Pipeline Management</h3>
                    <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Active Pipeline:</span>
                            <span id="current-pipeline-name" style="font-size: 16px; font-weight: bold; color: var(--primary-color);">Loading...</span>
                            <span style="color: var(--text-secondary);">|</span>
                            <span style="font-weight: bold; color: var(--text-primary);">Current Model:</span>
                            <span id="current-model-name" style="font-size: 16px; font-weight: bold; color: var(--success-color);">Loading...</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="camera-btn camera-btn-primary" onclick="refreshPipelineConfig()">Refresh</button>
                        </div>
                    </div>

                    <!-- PIPELINES SECTION -->
                    <div style="background: rgba(30, 41, 59, 0.4); border: 2px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px;">Pipeline Configuration</h4>

                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Available Pipelines</h5>
                            <div id="pipelines-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <span style="color: var(--text-secondary); font-style: italic;">Loading pipelines...</span>
                            </div>
                        </div>

                        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Create/Edit Pipeline</h5>
                            <div class="control-grid" style="margin-bottom: 15px;">
                                <div class="control-item">
                                    <div class="control-label">Pipeline Name <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="pipeline-name-input" placeholder="e.g., defect_detection">
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Description</div>
                                    <input type="text" class="control-input" id="pipeline-desc-input" placeholder="Pipeline description...">
                                </div>
                                <div class="control-item" style="grid-column: span 2;">
                                    <div class="control-label">Models in Pipeline (select models to include)</div>
                                    <div id="pipeline-models-checklist" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px;">
                                        <span style="color: var(--text-secondary); font-style: italic;">Loading models...</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="control-button" style="background-color: var(--primary-color);" onclick="createOrUpdatePipeline()">Create/Update Pipeline</button>
                                <button class="control-button" style="background-color: var(--danger-color);" onclick="deletePipeline()">Delete Pipeline</button>
                            </div>
                            <div class="control-response" id="pipeline-response"></div>
                        </div>
                    </div>

                    <!-- MODELS SECTION -->
                    <div style="background: rgba(30, 41, 59, 0.4); border: 2px solid var(--success-color); border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--success-color); border-bottom: 2px solid var(--success-color); padding-bottom: 8px;">Inference Models</h4>

                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Available Models</h5>
                            <div id="models-list" style="display: flex; flex-direction: column; gap: 10px;">
                                <span style="color: var(--text-secondary); font-style: italic;">Loading models...</span>
                            </div>
                        </div>

                        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Create/Edit Model</h5>
                            <div class="control-grid" style="margin-bottom: 15px;">
                                <div class="control-item">
                                    <div class="control-label">Model Name <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="model-name-input" placeholder="e.g., Gradio HuggingFace">
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Type <span style="color: #dc3545;">*</span></div>
                                    <select class="control-input" id="model-type-input" onchange="handleModelTypeChange()">
                                        <option value="gradio">Gradio</option>
                                        <option value="yolo">YOLO</option>
                                    </select>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Inference URL <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="model-url-input" placeholder="https://..." onchange="fetchModelsFromGradio()">
                                    <button class="control-button" style="font-size: 11px; padding: 4px 8px; margin-top: 4px;" onclick="fetchModelsFromGradio()">Fetch Models</button>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Model Name (for Gradio)</div>
                                    <select class="control-input" id="model-gradio-name-input">
                                        <option value="Data Matrix">Data Matrix</option>
                                        <option value="Dental Implant">Dental Implant</option>
                                        <option value="Ball Pen">Ball Pen</option>
                                        <option value="Knit Up">Knit Up</option>
                                        <option value="Knit Back">Knit Back</option>
                                        <option value="Jean Back">Jean Back</option>
                                        <option value="Jean Up">Jean Up</option>
                                        <option value="Tire Cord">Tire Cord</option>
                                        <option value="predict">predict</option>
                                        <option value="N/A">N/A</option>
                                    </select>
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Min Confidence (0-1)</div>
                                    <input type="number" class="control-input" id="model-confidence-input" min="0" max="1" step="0.05" value="0.25">
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="control-button" style="background-color: #28a745;" onclick="createOrUpdateModel()">Create/Update Model</button>
                                <button class="control-button" style="background-color: #dc3545;" onclick="deleteModel()">Delete Model</button>
                            </div>
                            <div class="control-response" id="model-response"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Inference Tab -->

            <!-- Gallery Tab (iframe created dynamically - no static iframe in DOM) -->
            <div id="tab-gallery" class="tab-content">
                <div id="gallery-iframe-container" style="width: 100%; height: calc(100vh - 120px); min-height: 400px;">
                    <!-- iframe injected dynamically by loadIframeForTab() -->
                </div>
            </div>
            <!-- End Gallery Tab -->

            <!-- Grafana Tab (iframe created dynamically - no static iframe in DOM) -->
            <div id="tab-grafana" class="tab-content">
                <div id="grafana-iframe-container" style="width: 100%; height: calc(100vh - 120px); min-height: 400px;">
                    <!-- iframe injected dynamically by loadIframeForTab() -->
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #0c5460;">📊 Grafana Dashboard</h4>
                    <p style="margin: 0; font-size: 13px; color: #0c5460;">
                        <strong>Default Credentials:</strong> admin / admin<br>
                        <strong>TimescaleDB Connection:</strong><br>
                        • Host: <code>timescaledb:5432</code><br>
                        • Database: <code>monitaqc</code><br>
                        • User: <code>monitaqc</code><br>
                        • Password: <code>monitaqc2024</code>
                    </p>
                </div>
            </div>
            <script>
                // Dynamic iframe management - iframes are CREATED when tab opens and DESTROYED when leaving
                // This prevents any phantom iframe from blocking the page
                var iframeConfig = {
                    'gallery': { containerId: 'gallery-iframe-container', port: 5000 },
                    'grafana': { containerId: 'grafana-iframe-container', port: 3000 }
                };

                function loadIframeForTab(tabName) {
                    // Create iframe for active tab
                    var cfg = iframeConfig[tabName];
                    if (cfg) {
                        var url = 'http://' + window.location.hostname + ':' + cfg.port;
                        var container = document.getElementById(cfg.containerId);
                        if (container && !container.querySelector('iframe')) {
                            var iframe = document.createElement('iframe');
                            iframe.src = url;
                            iframe.style.cssText = 'width: 100%; height: 100%; border: 2px solid var(--border-color); border-radius: 8px;';
                            iframe.allow = 'fullscreen';
                            container.appendChild(iframe);
                        }
                    }
                    // DESTROY iframes in other tabs completely
                    Object.keys(iframeConfig).forEach(function(t) {
                        if (t !== tabName) {
                            var cont = document.getElementById(iframeConfig[t].containerId);
                            if (cont) { cont.innerHTML = ''; }
                        }
                    });
                }
            </script>
            <!-- End Grafana Tab -->

            <!-- AI Assistant Tab -->
            <div id="tab-ai" class="tab-content">
                <div style="height: calc(100vh - 150px);">
                    <!-- Chat Interface -->
                    <div style="display: flex; flex-direction: column; background: rgba(30, 41, 59, 0.4); border-radius: 8px; box-shadow: var(--shadow-md); overflow: hidden; height: 100%; border: 1px solid rgba(51, 65, 85, 0.6);">
                        <!-- Chat Header -->
                        <div style="padding: 15px 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 18px;">🤖 AI Analytics Assistant</h3>
                                <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">Ask me about production data, defects, and quality metrics</p>
                            </div>
                            <button onclick="clearChatHistory()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                🗑️ Clear History
                            </button>
                        </div>

                        <!-- Chat Messages -->
                        <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(15, 23, 42, 0.3);">
                            <div style="padding: 15px; background: rgba(30, 41, 59, 0.6); border-radius: 8px; border-left: 4px solid var(--primary-color); margin-bottom: 15px; box-shadow: var(--shadow-sm);">
                                <p style="margin: 0 0 10px 0; font-weight: 600; color: var(--text-primary);">👋 Welcome! Try asking:</p>
                                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-primary); line-height: 1.8;">
                                    <li>What's the defect rate for the last hour?</li>
                                    <li>Show me the most common defect types today</li>
                                    <li>Compare production speed vs quality metrics</li>
                                    <li>Analyze trends in the last 24 hours</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div style="padding: 15px; background: rgba(30, 41, 59, 0.6); border-top: 1px solid rgba(51, 65, 85, 0.6);">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input
                                    type="text"
                                    id="ai-input"
                                    class="control-input"
                                    placeholder="Type your question here..."
                                    style="flex: 1; margin: 0; font-size: 14px; min-width: 0; width: 100%;"
                                    onkeypress="if(event.key === 'Enter') sendAIMessage()"
                                >
                                <button class="control-button" onclick="sendAIMessage()" style="background: var(--primary-color); padding: 8px 12px; font-size: 20px; white-space: nowrap; width: 50px; flex-shrink: 0;">
                                    🚀
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End AI Assistant Tab -->

            <!-- Advanced Tab -->
            <div id="tab-advanced" class="tab-content">
                <!-- Timeline Configuration Section -->
                <div class="control-section">
                    <h3>⚙️ <span data-i18n="timeline_config">Timeline Configuration</span></h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label class="control-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="timeline-show-bbox" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600;">Show Bounding Boxes</span>
                            </label>
                        </div>

                        <div class="control-item">
                            <div class="control-label">Camera Order (Columns)</div>
                            <div style="display: flex; gap: 12px; margin-top: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                    <input type="radio" name="camera-order" value="normal" checked>
                                    <span>1→2→3→4→5→6</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                    <input type="radio" name="camera-order" value="reverse">
                                    <span>6→5→4→3→2→1</span>
                                </label>
                            </div>
                        </div>

                        <div class="control-item">
                            <div class="control-label">Image Quality: <strong id="timeline-quality-value">85%</strong></div>
                            <input type="range" id="timeline-quality" min="50" max="100" value="85" style="width: 100%; margin-top: 8px; cursor: pointer;">
                        </div>

                        <div class="control-item">
                            <div class="control-label">Rows per Page: <strong id="timeline-rows-value">10</strong></div>
                            <input type="range" id="timeline-rows" min="1" max="50" value="10" style="width: 100%; margin-top: 8px; cursor: pointer;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Frames displayed per page</div>
                        </div>

                        <div class="control-item">
                            <div class="control-label">Total Frames Stored: <strong id="timeline-buffer-value">20</strong></div>
                            <input type="range" id="timeline-buffer" min="10" max="5000" value="20" step="10" style="width: 100%; margin-top: 8px; cursor: pointer;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Total frames kept in history (affects pages)</div>
                        </div>

                        <div class="control-item" style="grid-column: span 2;">
                            <button id="timeline-apply-config" class="control-button" style="background: var(--primary-color); color: white; font-weight: 600; padding: 10px 20px;">
                                ✓ Apply Timeline Configuration
                            </button>
                            <div class="control-response" id="timeline-config-response"></div>
                        </div>
                    </div>
                </div>

                <!-- Redis Configuration Section -->
                <div class="control-section">
                    <h3>🔴 <span data-i18n="redis_config">Redis Configuration</span></h3>
                    <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Redis:</span>
                            <span id="redis-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="redis-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="redis-text" style="color: var(--text-primary);">Checking...</span>
                            </span>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">Redis Host</div>
                            <input type="text" class="control-input" id="redis-host-input" value="redis" placeholder="redis">
                            <button class="control-button" onclick="updateConfig('redis_host', document.getElementById('redis-host-input').value)">Set Host</button>
                            <div class="control-response" id="config-redis_host-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Redis Port</div>
                            <input type="number" class="control-input" id="redis-port-input" value="6379" placeholder="6379">
                            <button class="control-button" onclick="updateConfig('redis_port', document.getElementById('redis-port-input').value)">Set Port</button>
                            <div class="control-response" id="config-redis_port-response"></div>
                        </div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: var(--primary-color);">
                        ℹ️ <strong>Auto-Apply:</strong> Redis settings are applied immediately when changed. Connection will be reinitialized automatically.
                    </div>
                </div>

                <!-- AI Configuration Section -->
                <div class="control-section">
                    <h3>🔑 <span data-i18n="ai_config">AI Configuration</span></h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Active Model:</span>
                            <span id="ai-active-model-name" style="font-size: 16px; font-weight: bold; color: #007bff;">None</span>
                            <span id="ai-active-model-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Configured Models</h4>
                        <div id="ai-models-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading models...</span>
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Add / Edit Model</h4>
                        <div class="control-grid">
                            <div class="control-item">
                                <div class="control-label">Model Name</div>
                                <input type="text" class="control-input" id="ai-model-name" placeholder="e.g., My ChatGPT">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Provider</div>
                                <select id="ai-model-provider" class="control-input" onchange="updateAIModelFields()">
                                    <option value="claude">Claude (Anthropic)</option>
                                    <option value="chatgpt">ChatGPT (OpenAI)</option>
                                    <option value="gemini">Gemini (Google)</option>
                                    <option value="local">Local Model (Ollama)</option>
                                </select>
                            </div>
                            <div class="control-item">
                                <div class="control-label" id="api-key-label">API Key</div>
                                <input type="password" id="ai-api-key" class="control-input" placeholder="sk-ant-...">
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <button class="camera-btn camera-btn-success" onclick="saveAIModel()">Save Model</button>
                            <button class="camera-btn camera-btn-secondary" onclick="clearAIModelForm()">Clear</button>
                            <span style="margin-left: auto; font-size: 12px; color: var(--text-secondary);">
                                <a id="ai-api-link" href="https://console.anthropic.com/" target="_blank" style="color: var(--primary-color);">Get API Key</a>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Database Configuration Section -->
                <div class="control-section">
                    <h3>⚙️ <span data-i18n="db_config">Database Configuration</span></h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Active Profile:</span>
                            <span id="db-active-profile-name" style="font-size: 16px; font-weight: bold; color: #007bff;">None</span>
                            <span id="db-active-profile-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                            <div id="db-status" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background: var(--warning-color); color: white;">Checking...</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Configured Profiles</h4>
                        <div id="db-profiles-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading profiles...</span>
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Add / Edit Profile</h4>
                        <div class="control-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="control-item">
                                <div class="control-label">Profile Name</div>
                                <input type="text" class="control-input" id="db-profile-name" placeholder="e.g., Production">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Host</div>
                                <input type="text" class="control-input" id="db-host" placeholder="timescaledb">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Port</div>
                                <input type="number" class="control-input" id="db-port" value="5432">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Database</div>
                                <input type="text" class="control-input" id="db-database" placeholder="monitaqc">
                            </div>
                            <div class="control-item">
                                <div class="control-label">User</div>
                                <input type="text" class="control-input" id="db-user" placeholder="monitaqc">
                            </div>
                            <div class="control-item">
                                <div class="control-label">Password</div>
                                <input type="password" class="control-input" id="db-password" placeholder="***">
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <button class="camera-btn camera-btn-success" onclick="saveDBProfile()">Save Profile</button>
                            <button class="camera-btn camera-btn-secondary" onclick="clearDBProfileForm()">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Audio Alerts Configuration Section -->
                <div class="control-section">
                    <h3>🔊 <span data-i18n="audio_config">Audio Alerts Configuration</span></h3>

                    <!-- Global Audio Controls -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="control-item">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="audio-narrate" onchange="toggleNarration()" style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-weight: 600;">Enable Voice Narration</span>
                            </label>
                            <p style="margin: 5px 0 0 24px; font-size: 12px; color: var(--text-secondary);">Speak detected object names</p>
                        </div>
                        <div class="control-item">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="audio-beep" onchange="toggleBeep()" style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-weight: 600;">Enable Beep Sounds</span>
                            </label>
                            <p style="margin: 5px 0 0 24px; font-size: 12px; color: var(--text-secondary);">Play alert sound on detection</p>
                        </div>
                        <div class="control-item">
                            <div style="font-weight: 600; margin-bottom: 5px;">Volume: <span id="audio-volume-display">50%</span></div>
                            <input type="range" id="audio-volume" min="0" max="100" value="50" onchange="updateVolume()" style="width: 100%; cursor: pointer;">
                        </div>
                        <div class="control-item">
                            <button onclick="testAudio()" class="control-button" style="background: var(--secondary-color); width: 100%;">🔊 Test Audio</button>
                        </div>
                    </div>

                    <!-- Per-Object Configuration -->
                    <div style="background: rgba(30, 41, 59, 0.3); padding: 15px; border-radius: 8px; border: 1px solid rgba(51, 65, 85, 0.6);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: var(--text-primary);">Per-Object Configuration</h4>
                            <button onclick="enableAllObjects()" class="control-button" style="padding: 6px 12px; font-size: 13px;">✅ Enable All</button>
                        </div>
                        <div id="audio-objects-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                            <div style="padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 6px; text-align: center; color: var(--text-secondary); font-style: italic;">
                                No objects detected yet. Start detection to see objects here.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Storage Configuration Section -->
                <div class="control-section">
                    <h3>💾 <span data-i18n="db_storage">Database Storage Configuration</span></h3>
                    <div class="control-grid">
                        <div class="control-item" style="grid-column: span 2;">
                            <div class="control-label">PostgreSQL Connection URI</div>
                            <input type="text" class="control-input" id="postgres-uri-input" placeholder="postgresql://user:password@host:port/database" value="postgresql://monitaqc:monitaqc2024@timescaledb:5432/monitaqc" style="width: 100%;">
                            <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                <strong>Default TimescaleDB:</strong> <code>postgresql://monitaqc:monitaqc2024@timescaledb:5432/monitaqc</code>
                            </div>
                        </div>
                        <div class="control-item">
                            <div class="control-label">Store Annotations to Database</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select class="control-input" id="store-annotation-enabled-input" style="flex: 3; min-width: 150px;">
                                    <option value="false">Disabled</option>
                                    <option value="true">Enabled</option>
                                </select>
                                <button class="control-button" onclick="updateConfig('store_annotation_enabled', document.getElementById('store-annotation-enabled-input').value)" style="flex: 0 0 80px;">Set</button>
                            </div>
                            <div class="control-response" id="config-store_annotation_enabled-response"></div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 6px; font-size: 13px; color: #0c5460;">
                        <strong>ℹ️ Info:</strong> When enabled, all detection annotations (bounding boxes, labels, confidence scores) are stored in TimescaleDB for historical analysis and Grafana dashboards.
                    </div>
                </div>

                <!-- Data File Editor Section -->
                <div class="control-section">
                    <h3>📝 Data File Editor</h3>
                    <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div>
                            <span class="control-label">File: </span><span id="data-file-path">Loading...</span>
                        </div>
                        <button class="control-button" style="width: auto;" onclick="loadDataFile()">Reload</button>
                        <div style="flex: 1;"></div>
                        <button onclick="exportServiceConfig()" style="padding: 8px 12px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            ⬇️ Export Config
                        </button>
                        <button onclick="importServiceConfig()" style="padding: 8px 12px; background: var(--warning-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            ⬆️ Import Config
                        </button>
                        <div class="data-source" id="dataSource" style="font-size: 11px; padding: 4px 8px; background: var(--light-bg); border-radius: 4px;">Loading...</div>
                    </div>
                    <textarea id="data-file-content" class="control-input" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="control-button" style="background-color: #6c757d;" onclick="formatDataFile()">Format JSON</button>
                    </div>
                    <div class="control-response" id="data-file-response"></div>
                    <div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 4px; font-size: 12px; color: #0c5460;">
                        ℹ️ <strong>Note:</strong> Use the "💾 Save" button at the top of the page to save both service config and data file.
                    </div>
                </div>
            </div>
            <!-- End Advanced Tab -->
        </div>

        <script>
            // ===== Audio Alert System =====
            // Production line alarm system for real-time object detection
            let audioSettings = {
                narrate: false,        // Voice narration of detected objects
                beep: false,           // Beep sound for selected objects
                volume: 0.5,
                enabledObjects: {},    // { "socket": true, "defect": false, ... }
                objectBeepSounds: {}   // { "socket": "sine", "defect": "square", ... }
            };
            let audioContext = null;
            let detectedObjectClasses = new Set();  // Track all detected objects
            let lastNarrationTime = 0;
            let lastBeepTime = 0;
            const NARRATION_COOLDOWN = 2000;  // 2 seconds between same narrations
            const BEEP_COOLDOWN = 1000;       // 1 second between beeps

            // Load audio settings from localStorage
            function loadAudioSettings() {
                const saved = localStorage.getItem('audioSettings');
                if (saved) {
                    try {
                        audioSettings = { ...audioSettings, ...JSON.parse(saved) };
                    } catch (e) {
                        console.error('Error loading audio settings:', e);
                    }
                }
                updateAudioUI();
            }

            // Save audio settings to localStorage
            function saveAudioSettings() {
                localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
            }

            // Update UI to reflect current settings
            function updateAudioUI() {
                const narrateEl = document.getElementById('audio-narrate');
                const beepEl = document.getElementById('audio-beep');
                const volumeEl = document.getElementById('audio-volume');
                const volumeDisplay = document.getElementById('audio-volume-display');
                const beepConfig = document.getElementById('audio-beep-config');

                if (narrateEl) narrateEl.checked = audioSettings.narrate;
                if (beepEl) beepEl.checked = audioSettings.beep;
                if (volumeEl) volumeEl.value = audioSettings.volume * 100;
                if (volumeDisplay) volumeDisplay.textContent = Math.round(audioSettings.volume * 100) + '%';

                // Show/hide beep configuration
                if (beepConfig) {
                    beepConfig.style.display = audioSettings.beep ? 'block' : 'none';
                }
            }

            // Initialize Web Audio API (must be called after user interaction)
            function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }

            // Toggle narration
            function toggleNarration() {
                const narrateEl = document.getElementById('audio-narrate');
                audioSettings.narrate = narrateEl.checked;
                saveAudioSettings();
                console.log('[Audio] Narration', audioSettings.narrate ? 'enabled' : 'disabled');
            }

            // Toggle beep
            function toggleBeep() {
                const beepEl = document.getElementById('audio-beep');
                audioSettings.beep = beepEl.checked;

                // Initialize audio context when beep is enabled
                if (audioSettings.beep) {
                    initAudioContext();
                }

                saveAudioSettings();
                console.log('[Audio] Beep', audioSettings.beep ? 'enabled' : 'disabled');
            }

            // Update volume
            function updateVolume() {
                const volumeEl = document.getElementById('audio-volume');
                const volumeDisplay = document.getElementById('audio-volume-display');
                audioSettings.volume = volumeEl.value / 100;
                if (volumeDisplay) volumeDisplay.textContent = Math.round(audioSettings.volume * 100) + '%';
                saveAudioSettings();
            }

            // Toggle object in beep list
            function toggleObjectBeep(objectName) {
                audioSettings.enabledObjects[objectName] = !audioSettings.enabledObjects[objectName];
                saveAudioSettings();
                updateObjectsList();
                console.log('[Audio] Object', objectName, audioSettings.enabledObjects[objectName] ? 'enabled' : 'disabled');
            }

            // Play a beep sound using Web Audio API (non-blocking)
            function playAlarmBeep() {
                if (!audioContext || !audioSettings.beep) return;

                // Run audio in next event loop to avoid blocking main thread
                setTimeout(() => {
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.type = 'sine';
                        oscillator.frequency.value = 880;  // A5 - attention-grabbing frequency

                        gainNode.gain.setValueAtTime(audioSettings.volume, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.2);
                    } catch (e) {
                        console.error('Error playing beep:', e);
                    }
                }, 0);
            }

            // Narrate detected object using Web Speech API (non-blocking)
            function narrateObject(objectName) {
                if (!audioSettings.narrate) return;

                // Cooldown check
                const now = Date.now();
                if (now - lastNarrationTime < NARRATION_COOLDOWN) {
                    console.log('[Audio] Narration on cooldown');
                    return;
                }
                lastNarrationTime = now;

                // Run speech synthesis in next event loop to avoid blocking main thread
                setTimeout(() => {
                    // Check if browser supports speech synthesis
                    if ('speechSynthesis' in window) {
                        // Cancel any ongoing speech
                        window.speechSynthesis.cancel();

                        // Create utterance
                        const utterance = new SpeechSynthesisUtterance(objectName);
                        utterance.rate = 1.0;
                        utterance.pitch = 1.0;
                        utterance.volume = audioSettings.volume;

                        console.log('[Audio] Narrating:', objectName);
                        window.speechSynthesis.speak(utterance);
                    } else {
                        console.warn('[Audio] Text-to-speech not supported in this browser');
                    }
                }, 0);
            }

            // Update the objects list in the UI
            function updateObjectsList() {
                const listEl = document.getElementById('audio-objects-list');
                if (!listEl) return;

                // Clear existing list
                listEl.innerHTML = '';

                // If no objects detected yet
                if (detectedObjectClasses.size === 0) {
                    listEl.innerHTML = '<div style="padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 6px; text-align: center; color: var(--text-secondary); font-style: italic;">No objects detected yet. Start detection to see objects here.</div>';
                    return;
                }

                // Create card for each detected object class
                const sortedObjects = Array.from(detectedObjectClasses).sort();
                sortedObjects.forEach(objectName => {
                    const isEnabled = audioSettings.enabledObjects[objectName] || false;
                    const beepSound = audioSettings.objectBeepSounds?.[objectName] || 'sine';

                    const card = document.createElement('div');
                    card.style.cssText = 'padding: 12px; background: rgba(51, 65, 85, 0.4); border-radius: 6px; border: 1px solid rgba(51, 65, 85, 0.6);';

                    card.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1;">
                                <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleObjectBeep('${objectName}')" style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-weight: 600; color: var(--text-primary);">${objectName}</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select onchange="updateObjectBeepSound('${objectName}', this.value)" style="flex: 1; padding: 4px 8px; background: rgba(30, 41, 59, 0.6); color: var(--text-primary); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; font-size: 12px;">
                                <option value="sine" ${beepSound === 'sine' ? 'selected' : ''}>🔔 Sine (Bell)</option>
                                <option value="square" ${beepSound === 'square' ? 'selected' : ''}>📢 Square (Buzzer)</option>
                                <option value="sawtooth" ${beepSound === 'sawtooth' ? 'selected' : ''}>🎺 Sawtooth (Horn)</option>
                                <option value="triangle" ${beepSound === 'triangle' ? 'selected' : ''}>🎵 Triangle (Soft)</option>
                            </select>
                            <button onclick="testObjectBeep('${objectName}')" style="padding: 4px 10px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">▶ Test</button>
                        </div>
                    `;

                    listEl.appendChild(card);
                });
            }

            // Enable all detected objects
            function enableAllObjects() {
                detectedObjectClasses.forEach(objectName => {
                    audioSettings.enabledObjects[objectName] = true;
                });
                saveAudioSettings();
                updateObjectsList();
            }

            // Update beep sound for specific object
            function updateObjectBeepSound(objectName, soundType) {
                if (!audioSettings.objectBeepSounds) {
                    audioSettings.objectBeepSounds = {};
                }
                audioSettings.objectBeepSounds[objectName] = soundType;
                saveAudioSettings();
            }

            // Test beep for specific object
            function testObjectBeep(objectName) {
                initAudioContext();
                const soundType = audioSettings.objectBeepSounds?.[objectName] || 'sine';
                playBeepWithType(soundType);
            }

            // Play beep with specific wave type
            function playBeepWithType(waveType) {
                if (!audioContext) return;

                setTimeout(() => {
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.type = waveType;
                        oscillator.frequency.value = 880;

                        gainNode.gain.setValueAtTime(audioSettings.volume, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.2);
                    } catch (e) {
                        console.error('Error playing beep:', e);
                    }
                }, 0);
            }

            // Handle detection from timeline data (non-blocking)
            function processDetectionForAudio(detectionData) {
                if (!detectionData || !detectionData.detections) {
                    return;
                }

                // Process in next event loop to avoid blocking main thread
                setTimeout(() => {
                    // Extract unique object classes from detections
                    detectionData.detections.forEach(det => {
                        if (det.class_name && det.class_name !== 'Unknown') {
                            const className = det.class_name;

                            // Add to detected classes set
                            const wasNew = !detectedObjectClasses.has(className);
                            detectedObjectClasses.add(className);

                            // Update UI if new object detected
                            if (wasNew) {
                                // Initialize as disabled by default
                                if (audioSettings.enabledObjects[className] === undefined) {
                                    audioSettings.enabledObjects[className] = false;
                                }
                                updateObjectsList();
                            }

                            // Only play audio if this specific object is enabled
                            const isEnabled = audioSettings.enabledObjects[className] === true;

                            // Narrate if narration is enabled AND this object is enabled
                            if (audioSettings.narrate && isEnabled) {
                                narrateObject(className);
                            }

                            // Beep if beep is enabled AND this object is enabled
                            if (audioSettings.beep && isEnabled) {
                                const now = Date.now();
                                if (now - lastBeepTime >= BEEP_COOLDOWN) {
                                    lastBeepTime = now;
                                    const soundType = audioSettings.objectBeepSounds?.[className] || 'sine';
                                    playBeepWithType(soundType);
                                }
                            }
                        }
                    });
                }, 0);
            }

            // Test audio button
            function testAudio() {
                initAudioContext();

                if (audioSettings.narrate) {
                    narrateObject('Test detection');
                }

                if (audioSettings.beep) {
                    playAlarmBeep();
                }

                // If nothing is enabled, play beep anyway to test volume
                if (!audioSettings.narrate && !audioSettings.beep) {
                    audioSettings.beep = true;  // Temporarily enable
                    playAlarmBeep();
                    audioSettings.beep = false;
                }
            }

            // Tab switching functionality
            function switchTab(tabName) {
                // Hide all tab contents
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(tab => tab.classList.remove('active'));

                // Remove active class from all buttons
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(btn => btn.classList.remove('active'));

                // Show selected tab content
                const selectedTab = document.getElementById('tab-' + tabName);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }

                // Add active class to clicked button
                event.target.classList.add('active');

                // Save selected tab to localStorage
                localStorage.setItem('selectedTab', tabName);

                // Load chat history when switching to AI tab
                if (tabName === 'ai') {
                    setTimeout(() => loadChatHistory(), 100);
                }

                // Lazy-load/unload iframes for gallery and grafana tabs
                if (typeof loadIframeForTab === 'function') {
                    loadIframeForTab(tabName);
                }
            }

            // Restore last selected tab on page load (skip iframe tabs to prevent blocking)
            document.addEventListener('DOMContentLoaded', function() {
                const savedTab = localStorage.getItem('selectedTab');
                const iframeTabs = ['gallery', 'grafana'];
                if (savedTab && !iframeTabs.includes(savedTab)) {
                    const tabButton = document.querySelector(`.tab-button[onclick="switchTab('${savedTab}')"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }
            });

            // ========================================
            // Timeline Slideshow Functionality (Embedded)
            // ========================================

            // Panzoom library v4.6.0 (embedded inline)
            ((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Panzoom=e()})(this,function(){var a,X=function(){return(X=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},i=("undefined"!=typeof window&&(window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),"function"!=typeof window.CustomEvent)&&(window.CustomEvent=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:null};var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n}),"undefined"!=typeof document&&!!document.documentMode);var c=["webkit","moz","ms"],l={};function Y(t){if(l[t])return l[t];var e=a=a||document.createElement("div").style;if(t in e)return l[t]=t;for(var n=t[0].toUpperCase()+t.slice(1),o=c.length;o--;){var r="".concat(c[o]).concat(n);if(r in e)return l[t]=r}}function o(t,e){return parseFloat(e[Y(t)])||0}function s(t,e,n){void 0===n&&(n=window.getComputedStyle(t));t="border"===e?"Width":"";return{left:o("".concat(e,"Left").concat(t),n),right:o("".concat(e,"Right").concat(t),n),top:o("".concat(e,"Top").concat(t),n),bottom:o("".concat(e,"Bottom").concat(t),n)}}function C(t,e,n){t.style[Y(e)]=n}function N(t){var e=t.parentNode,n=window.getComputedStyle(t),o=window.getComputedStyle(e),r=t.getBoundingClientRect(),a=e.getBoundingClientRect();return{elem:{style:n,width:r.width,height:r.height,top:r.top,bottom:r.bottom,left:r.left,right:r.right,margin:s(t,"margin",n),border:s(t,"border",n)},parent:{style:o,width:a.width,height:a.height,top:a.top,bottom:a.bottom,left:a.left,right:a.right,padding:s(e,"padding",o),border:s(e,"border",o)}}}var T={down:"mousedown",move:"mousemove",up:"mouseup mouseleave"};function L(t,e,n,o){T[t].split(" ").forEach(function(t){e.addEventListener(t,n,o)})}function V(t,e,n){T[t].split(" ").forEach(function(t){e.removeEventListener(t,n)})}function G(t,e){for(var n=t.length;n--;)if(t[n].pointerId===e.pointerId)return n;return-1}function I(t,e){if(e.touches)for(var n=0,o=0,r=e.touches;o<r.length;o++){var a=r[o];a.pointerId=n++,I(t,a)}else-1<(n=G(t,e))&&t.splice(n,1),t.push(e)}function R(t){for(var e,n=(t=t.slice(0)).pop();e=t.pop();)n={clientX:(e.clientX-n.clientX)/2+n.clientX,clientY:(e.clientY-n.clientY)/2+n.clientY};return n}function W(t){var e;return t.length<2?0:(e=t[0],t=t[1],Math.sqrt(Math.pow(Math.abs(t.clientX-e.clientX),2)+Math.pow(Math.abs(t.clientY-e.clientY),2)))}"undefined"!=typeof window&&("function"==typeof window.PointerEvent?T={down:"pointerdown",move:"pointermove",up:"pointerup pointerleave pointercancel"}:"function"==typeof window.TouchEvent&&(T={down:"touchstart",move:"touchmove",up:"touchend touchcancel"}));var Z=/^http:[\w\.\/]+svg$/;var q={animate:!1,canvas:!1,cursor:"move",disablePan:!1,disableZoom:!1,disableXAxis:!1,disableYAxis:!1,duration:200,easing:"ease-in-out",exclude:[],excludeClass:"panzoom-exclude",handleStartEvent:function(t){t.preventDefault(),t.stopPropagation()},maxScale:4,minScale:.125,overflow:"hidden",panOnlyWhenZoomed:!1,pinchAndPan:!1,relative:!1,setTransform:function(t,e,n){var o=e.x,r=e.y,a=e.isSVG;C(t,"transform","scale(".concat(e.scale,") translate(").concat(o,"px, ").concat(r,"px)")),a&&i&&(e=window.getComputedStyle(t).getPropertyValue("transform"),t.setAttribute("transform",e))},startX:0,startY:0,startScale:1,step:.3,touchAction:"none"};function t(u,f){if(!u)throw new Error("Panzoom requires an element as an argument");if(1!==u.nodeType)throw new Error("Panzoom requires an element with a nodeType of 1");if(!(t=>{for(var e=t;e&&e.parentNode;){if(e.parentNode===document)return 1;e=e.parentNode instanceof ShadowRoot?e.parentNode.host:e.parentNode}})(u))throw new Error("Panzoom should be called on elements that have been attached to the DOM");f=X(X({},q),f);t=u;var t,l=Z.test(t.namespaceURI)&&"svg"!==t.nodeName.toLowerCase(),n=u.parentNode;n.style.overflow=f.overflow,n.style.userSelect="none",n.style.touchAction=f.touchAction,(f.canvas?n:u).style.cursor=f.cursor,u.style.userSelect="none",u.style.touchAction=f.touchAction,C(u,"transformOrigin","string"==typeof f.origin?f.origin:l?"0 0":"50% 50%");var r,a,i,c,s,d,m=0,h=0,v=1,p=!1;function g(t,e,n){n.silent||(n=new CustomEvent(t,{detail:e}),u.dispatchEvent(n))}function y(o,r,t){var a={x:m,y:h,scale:v,isSVG:l,originalEvent:t};return requestAnimationFrame(function(){var t,e,n;"boolean"==typeof r.animate&&(r.animate?(t=u,e=r,n=Y("transform"),C(t,"transition","".concat(n," ").concat(e.duration,"ms ").concat(e.easing))):C(u,"transition","none")),r.setTransform(u,a,r),g(o,a,r),g("panzoomchange",a,r)}),a}function w(t,e,n,o){var r,a,i,c,l,s,d,o=X(X({},f),o),p={x:m,y:h,opts:o};return!o.force&&(o.disablePan||o.panOnlyWhenZoomed&&v===o.startScale)||(t=parseFloat(t),e=parseFloat(e),o.disableXAxis||(p.x=(o.relative?m:0)+t),o.disableYAxis||(p.y=(o.relative?h:0)+e),o.contain&&(e=((r=(e=(t=N(u)).elem.width/v)*n)-e)/2,i=((a=(i=t.elem.height/v)*n)-i)/2,"inside"===o.contain?(c=(-t.elem.margin.left-t.parent.padding.left+e)/n,l=(t.parent.width-r-t.parent.padding.left-t.elem.margin.left-t.parent.border.left-t.parent.border.right+e)/n,p.x=Math.max(Math.min(p.x,l),c),s=(-t.elem.margin.top-t.parent.padding.top+i)/n,d=(t.parent.height-a-t.parent.padding.top-t.elem.margin.top-t.parent.border.top-t.parent.border.bottom+i)/n,p.y=Math.max(Math.min(p.y,d),s)):"outside"===o.contain&&(c=(-(r-t.parent.width)-t.parent.padding.left-t.parent.border.left-t.parent.border.right+e)/n,l=(e-t.parent.padding.left)/n,p.x=Math.max(Math.min(p.x,l),c),s=(-(a-t.parent.height)-t.parent.padding.top-t.parent.border.top-t.parent.border.bottom+i)/n,d=(i-t.parent.padding.top)/n,p.y=Math.max(Math.min(p.y,d),s))),o.roundPixels&&(p.x=Math.round(p.x),p.y=Math.round(p.y))),p}function b(t,e){var n,o,r,a,e=X(X({},f),e),i={scale:v,opts:e};return!e.force&&e.disableZoom||(n=f.minScale,o=f.maxScale,e.contain&&(a=(e=N(u)).elem.width/v,r=e.elem.height/v,1<a)&&1<r&&(a=(e.parent.width-e.parent.border.left-e.parent.border.right)/a,e=(e.parent.height-e.parent.border.top-e.parent.border.bottom)/r,"inside"===f.contain?o=Math.min(o,a,e):"outside"===f.contain&&(n=Math.max(n,a,e))),i.scale=Math.min(Math.max(t,n),o)),i}function x(t,e,n,o){t=w(t,e,v,n);return m!==t.x||h!==t.y?(m=t.x,h=t.y,y("panzoompan",t.opts,o)):{x:m,y:h,scale:v,isSVG:l,originalEvent:o}}function S(t,e,n){var o,r,e=b(t,e),a=e.opts;if(a.force||!a.disableZoom)return t=e.scale,e=m,o=h,a.focal&&(e=((r=a.focal).x/t-r.x/v+m*t)/t,o=(r.y/t-r.y/v+h*t)/t),r=w(e,o,t,{relative:!1,force:!0}),m=r.x,h=r.y,v=t,y("panzoomzoom",a,n)}function e(t,e){e=X(X(X({},f),{animate:!0}),e);return S(v*Math.exp((t?1:-1)*e.step),e)}function E(t,e,n,o){var r=N(u),a=r.parent.width-r.parent.padding.left-r.parent.padding.right-r.parent.border.left-r.parent.border.right,i=r.parent.height-r.parent.padding.top-r.parent.padding.bottom-r.parent.border.top-r.parent.border.bottom,c=e.clientX-r.parent.left-r.parent.padding.left-r.parent.border.left-r.elem.margin.left,e=e.clientY-r.parent.top-r.parent.padding.top-r.parent.border.top-r.elem.margin.top,r=(l||(c-=r.elem.width/v/2,e-=r.elem.height/v/2),{x:c/a*(a*t),y:e/i*(i*t)});return S(t,X(X({},n),{animate:!1,focal:r}),o)}S(f.startScale,{animate:!1,force:!0}),setTimeout(function(){x(f.startX,f.startY,{animate:!1,force:!0})});var M=[];function o(t){((t,e)=>{for(var n,o,r=t;null!=r;r=r.parentNode)if(n=r,o=e.excludeClass,1===n.nodeType&&-1<" ".concat((n.getAttribute("class")||"").trim()," ").indexOf(" ".concat(o," "))||-1<e.exclude.indexOf(r))return 1})(t.target,f)||(I(M,t),p=!0,f.handleStartEvent(t),g("panzoomstart",{x:r=m,y:a=h,scale:v,isSVG:l,originalEvent:t},f),t=R(M),i=t.clientX,c=t.clientY,s=v,d=W(M))}function A(t){var e,n,o;p&&void 0!==r&&void 0!==a&&void 0!==i&&void 0!==c&&(I(M,t),e=R(M),n=1<M.length,o=v,n&&(0===d&&(d=W(M)),E(o=b((W(M)-d)*f.step/80+s).scale,e,{animate:!1},t)),n&&!f.pinchAndPan||x(r+(e.clientX-i)/o,a+(e.clientY-c)/o,{animate:!1},t))}function P(t){1===M.length&&g("panzoomend",{x:m,y:h,scale:v,isSVG:l,originalEvent:t},f);var e=M;if(t.touches)for(;e.length;)e.pop();else{t=G(e,t);-1<t&&e.splice(t,1)}p&&(p=!1,r=a=i=c=void 0)}var O=!1;function z(){O||(O=!0,L("down",f.canvas?n:u,o),L("move",document,A,{passive:!0}),L("up",document,P,{passive:!0}))}return f.noBind||z(),{bind:z,destroy:function(){O=!1,V("down",f.canvas?n:u,o),V("move",document,A),V("up",document,P)},eventNames:T,getPan:function(){return{x:m,y:h}},getScale:function(){return v},getOptions:function(){var t,e=f,n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},handleDown:o,handleMove:A,handleUp:P,pan:x,reset:function(t){var t=X(X(X({},f),{animate:!0,force:!0}),t),e=(v=b(t.startScale,t).scale,w(t.startX,t.startY,v,t));return m=e.x,h=e.y,y("panzoomreset",t)},resetStyle:function(){n.style.overflow="",n.style.userSelect="",n.style.touchAction="",n.style.cursor="",u.style.cursor="",u.style.userSelect="",u.style.touchAction="",C(u,"transformOrigin","")},setOptions:function(t){for(var e in t=void 0===t?{}:t)t.hasOwnProperty(e)&&(f[e]=t[e]);(t.hasOwnProperty("cursor")||t.hasOwnProperty("canvas"))&&(n.style.cursor=u.style.cursor="",(f.canvas?n:u).style.cursor=f.cursor),t.hasOwnProperty("overflow")&&(n.style.overflow=t.overflow),t.hasOwnProperty("touchAction")&&(n.style.touchAction=t.touchAction,u.style.touchAction=t.touchAction)},setStyle:function(t,e){return C(u,t,e)},zoom:S,zoomIn:function(t){return e(!0,t)},zoomOut:function(t){return e(!1,t)},zoomToPoint:E,zoomWithWheel:function(t,e){t.preventDefault();var e=X(X(X({},f),e),{animate:!1}),n=0===t.deltaY&&t.deltaX?t.deltaX:t.deltaY;return E(b(v*Math.exp((n<0?1:-1)*e.step/3),e).scale,t,e,t)}}}return t.defaultOptions=q,t});

            // Initialize timeline slideshow (single image with auto-refresh)
            (function() {
                const slide = document.getElementById("timeline-slide");
                const wrapper = document.getElementById("timeline-slide-wrapper");
                const counter = document.getElementById("timeline-counter");
                const toggleBtn = document.getElementById("timeline-toggle-auto");

                let autoUpdate = true;
                let refreshInterval;

                // Initialize Panzoom on the timeline image
                const panzoom = Panzoom(slide, { maxScale: 40 });

                // Timeline pagination (navigate through pages of concatenated frames)
                let currentPage = 0;
                let totalPages = 0;
                let totalFrames = 0;
                let rowsPerPage = 10;

                async function updatePageCount() {
                    try {
                        const response = await fetch('/api/timeline_count');
                        const data = await response.json();
                        totalFrames = data.total_frames;
                        totalPages = data.total_pages;
                        rowsPerPage = data.rows_per_page;
                        updateCounter();
                    } catch (error) {
                        console.error('Error fetching page count:', error);
                    }
                }

                function updateCounter() {
                    if (totalPages > 0) {
                        if (autoUpdate) {
                            counter.textContent = `1 / ${totalPages}`;
                        } else {
                            counter.textContent = `${currentPage + 1} / ${totalPages}`;
                        }
                    } else {
                        counter.textContent = "0 / 0";
                    }
                }

                function loadPage(page) {
                    if (page < 0 || page >= totalPages) return;
                    currentPage = page;
                    const timestamp = new Date().getTime();
                    slide.src = `/timeline_image?page=${page}&t=${timestamp}`;
                    updateCounter();
                    panzoom.reset();
                }

                // Auto-refresh functionality (reload latest page)
                async function refreshImage() {
                    if (autoUpdate) {
                        await updatePageCount();
                        currentPage = 0; // Always show latest page
                        const timestamp = new Date().getTime();
                        slide.src = `/timeline_image?page=0&t=${timestamp}`;
                        updateCounter();
                    }
                }

                // Start auto-refresh
                function startAutoRefresh() {
                    refreshInterval = setInterval(refreshImage, 5000);
                }

                // Stop auto-refresh
                function stopAutoRefresh() {
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                }

                // Toggle auto-update
                toggleBtn.onclick = () => {
                    autoUpdate = !autoUpdate;
                    if (autoUpdate) {
                        toggleBtn.textContent = "Stop";
                        toggleBtn.classList.remove("stopped");
                        currentPage = 0;
                        startAutoRefresh();
                        refreshImage();
                    } else {
                        toggleBtn.textContent = "Resume";
                        toggleBtn.classList.add("stopped");
                        stopAutoRefresh();
                        counter.textContent = "Paused";
                    }
                };

                // Navigation buttons (page navigation)
                document.getElementById("timeline-first").addEventListener('click', () => {
                    stopAutoRefresh();
                    autoUpdate = false;
                    toggleBtn.textContent = "Resume";
                    loadPage(totalPages - 1); // Oldest page
                });

                document.getElementById("timeline-prev").addEventListener('click', () => {
                    stopAutoRefresh();
                    autoUpdate = false;
                    toggleBtn.textContent = "Resume";
                    loadPage(Math.min(totalPages - 1, currentPage + 1)); // Older page
                });

                document.getElementById("timeline-next").addEventListener('click', () => {
                    stopAutoRefresh();
                    autoUpdate = false;
                    toggleBtn.textContent = "Resume";
                    loadPage(Math.max(0, currentPage - 1)); // Newer page
                });

                document.getElementById("timeline-last").addEventListener('click', () => {
                    stopAutoRefresh();
                    autoUpdate = false;
                    toggleBtn.textContent = "Resume";
                    loadPage(0); // Latest page
                });

                // Update page count periodically
                setInterval(updatePageCount, 5000);
                updatePageCount();

                // Zoom controls
                document.getElementById("timeline-zoom-in").addEventListener('click', panzoom.zoomIn);
                document.getElementById("timeline-zoom-out").addEventListener('click', panzoom.zoomOut);
                document.getElementById("timeline-reset-zoom").addEventListener('click', panzoom.reset);

                // Wheel zoom
                wrapper.addEventListener("wheel", panzoom.zoomWithWheel);

                // Double-click to toggle zoom
                slide.addEventListener("dblclick", () => {
                    panzoom.zoom(panzoom.getScale() === 1 ? 2 : 1);
                });

                // Start auto-refresh on load
                updatePageCount();
                startAutoRefresh();
                refreshImage();
            })();

            // ========================================
            // Timeline Configuration Controls
            // ========================================
            (function() {
                const qualitySlider = document.getElementById('timeline-quality');
                const qualityValue = document.getElementById('timeline-quality-value');
                const rowsSlider = document.getElementById('timeline-rows');
                const rowsValue = document.getElementById('timeline-rows-value');
                const bufferSlider = document.getElementById('timeline-buffer');
                const bufferValue = document.getElementById('timeline-buffer-value');
                const applyBtn = document.getElementById('timeline-apply-config');

                // Load saved configuration from server
                async function loadSavedConfig() {
                    try {
                        const response = await fetch('/api/timeline_count');
                        const data = await response.json();
                        if (data.rows_per_page) {
                            rowsSlider.value = data.rows_per_page;
                            rowsValue.textContent = data.rows_per_page;
                        }
                        // Note: Quality is stored in timeline_config but not returned by timeline_count API
                        // We'll load it from the data file via getData API
                        const configResponse = await fetch('/api/getData');
                        const configData = await configResponse.json();
                        if (configData.timeline_config) {
                            if (configData.timeline_config.image_quality) {
                                qualitySlider.value = configData.timeline_config.image_quality;
                                qualityValue.textContent = configData.timeline_config.image_quality + '%';
                            }
                            if (configData.timeline_config.num_rows) {
                                rowsSlider.value = configData.timeline_config.num_rows;
                                rowsValue.textContent = configData.timeline_config.num_rows;
                            }
                            if (configData.timeline_config.buffer_size) {
                                bufferSlider.value = configData.timeline_config.buffer_size;
                                bufferValue.textContent = configData.timeline_config.buffer_size;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading timeline config:', error);
                    }
                }

                // Load config on page load
                loadSavedConfig();

                // Update slider value displays
                qualitySlider.addEventListener('input', () => {
                    qualityValue.textContent = qualitySlider.value + '%';
                });

                rowsSlider.addEventListener('input', () => {
                    rowsValue.textContent = rowsSlider.value;
                });

                bufferSlider.addEventListener('input', () => {
                    bufferValue.textContent = bufferSlider.value;
                });

                // Apply configuration
                applyBtn.addEventListener('click', async () => {
                    const showBbox = document.getElementById('timeline-show-bbox').checked;
                    const cameraOrder = document.querySelector('input[name="camera-order"]:checked').value;
                    const quality = qualitySlider.value;
                    const rows = rowsSlider.value;
                    const buffer = bufferSlider.value;
                    const responseDiv = document.getElementById('timeline-config-response');

                    applyBtn.textContent = '⏳ Applying...';
                    applyBtn.disabled = true;
                    responseDiv.textContent = 'Applying configuration...';
                    responseDiv.style.color = '#666';

                    try {
                        const response = await fetch('/api/timeline_config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                show_bounding_boxes: showBbox,
                                camera_order: cameraOrder,
                                image_quality: parseInt(quality),
                                num_rows: parseInt(rows),
                                buffer_size: parseInt(buffer)
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            applyBtn.textContent = '✓ Applied!';
                            applyBtn.style.background = 'var(--success-color)';
                            responseDiv.textContent = '✓ Configuration applied successfully! Timeline will update on next refresh.';
                            responseDiv.style.color = 'var(--success-color)';

                            // Auto-save to DATA_FILE
                            await saveAllServiceConfig();

                            // Refresh timeline image after config change
                            setTimeout(() => {
                                const timestamp = new Date().getTime();
                                document.getElementById('timeline-slide').src = `/timeline_image?t=${timestamp}`;

                                applyBtn.textContent = '✓ Apply Timeline Configuration';
                                applyBtn.style.background = 'var(--primary-color)';
                                applyBtn.disabled = false;
                            }, 1500);
                        } else {
                            throw new Error(result.error || 'Failed to apply configuration');
                        }
                    } catch (error) {
                        console.error('Error applying timeline configuration:', error);
                        applyBtn.textContent = '⚠️ Error - Retry';
                        applyBtn.style.background = 'var(--danger-color)';
                        responseDiv.textContent = `⚠️ Error: ${error.message}`;
                        responseDiv.style.color = 'var(--danger-color)';

                        setTimeout(() => {
                            applyBtn.textContent = '✓ Apply Timeline Configuration';
                            applyBtn.style.background = 'var(--primary-color)';
                            applyBtn.disabled = false;
                        }, 3000);
                    }
                });
            })();

            // Shipment ID editing functionality
            function editShipmentId() {
                const shipmentValue = document.getElementById('shipment-value');
                const shipmentInput = document.getElementById('shipment-input');
                const shipmentButtons = document.getElementById('shipment-buttons');
                const shipmentText = document.getElementById('shipment-text');

                // Hide the display value, show input and buttons
                shipmentValue.style.display = 'none';
                shipmentInput.style.display = 'block';
                shipmentButtons.style.display = 'flex';

                // Set current value in input
                shipmentInput.value = shipmentText.textContent;
                shipmentInput.focus();
                shipmentInput.select();
            }

            function cancelEditShipment() {
                const shipmentValue = document.getElementById('shipment-value');
                const shipmentInput = document.getElementById('shipment-input');
                const shipmentButtons = document.getElementById('shipment-buttons');

                // Show the display value, hide input and buttons
                shipmentValue.style.display = 'flex';
                shipmentInput.style.display = 'none';
                shipmentButtons.style.display = 'none';
            }

            async function saveShipmentId() {
                const shipmentInput = document.getElementById('shipment-input');
                const newShipmentId = shipmentInput.value.trim() || 'no_shipment';

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            shipment: newShipmentId
                        })
                    });

                    if (response.ok) {
                        const shipmentText = document.getElementById('shipment-text');
                        shipmentText.textContent = newShipmentId;
                        cancelEditShipment();

                        // Show success message
                        const statusBox = shipmentInput.closest('.status-box-item');
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = 'color: var(--success-color); font-size: 12px; margin-top: 4px;';
                        successMsg.textContent = '✓ Shipment ID updated';
                        statusBox.appendChild(successMsg);
                        setTimeout(() => successMsg.remove(), 3000);
                    } else {
                        alert('Failed to update shipment ID');
                    }
                } catch (error) {
                    console.error('Error updating shipment ID:', error);
                    alert('Error updating shipment ID');
                }
            }

            // Allow Enter key to save
            document.addEventListener('DOMContentLoaded', function() {
                const shipmentInput = document.getElementById('shipment-input');
                if (shipmentInput) {
                    shipmentInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            saveShipmentId();
                        } else if (e.key === 'Escape') {
                            cancelEditShipment();
                        }
                    });
                }
            });

            // Service Configuration functions
            async function saveAllServiceConfig() {
                try {
                    // Save all configuration (cameras + settings) using the correct endpoint
                    const response = await fetch('/api/cameras/config/save', { method: 'POST' });

                    if (response.ok) {
                        const data = await response.json();
                        const timestamp = new Date().toISOString();
                        document.getElementById('last-saved-time').textContent = timestamp;
                        alert('✓ All settings saved successfully!');
                    } else {
                        const data = await response.json();
                        alert(`❌ Failed to save settings: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error saving config:', error);
                    alert('❌ Error saving settings');
                }
            }

            async function loadServiceConfig() {
                if (!confirm('Load saved service configuration? This will reload the page.')) return;
                try {
                    const response = await fetch('/api/cameras/config/load', { method: 'POST' });
                    if (response.ok) {
                        alert('✓ Configuration loaded! Reloading page...');
                        location.reload();
                    } else {
                        const data = await response.json();
                        alert(`❌ Failed to load configuration: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                    alert('❌ Error loading configuration');
                }
            }

            async function exportServiceConfig() {
                try {
                    const response = await fetch('/api/export_service_config');
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `monitaqc_config_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        alert('❌ Failed to export configuration');
                    }
                } catch (error) {
                    console.error('Error exporting config:', error);
                    alert('❌ Error exporting configuration');
                }
            }

            function importServiceConfig() {
                // Trigger file input for the working import function below
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const config = JSON.parse(text);
                        const response = await fetch('/api/cameras/config/upload', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ config })
                        });
                        const result = await response.json();
                        if (response.ok && result.success) {
                            alert(`✓ Config imported! (${result.cameras_loaded} cameras loaded)`);
                            location.reload();
                        } else {
                            alert(`❌ Failed to import: ${result.error || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error('Error importing config:', error);
                        alert(`❌ Error: ${error.message}`);
                    }
                };
                input.click();
            }

            // AI Assistant Functions
            const aiProviderConfigs = {
                'claude': { label: 'Anthropic API Key:', placeholder: 'sk-ant-...', link: 'https://console.anthropic.com/', linkText: 'Anthropic Console' },
                'chatgpt': { label: 'OpenAI API Key:', placeholder: 'sk-...', link: 'https://platform.openai.com/api-keys', linkText: 'OpenAI Platform' },
                'gemini': { label: 'Google API Key:', placeholder: 'AI...', link: 'https://makersuite.google.com/app/apikey', linkText: 'Google AI Studio' },
                'local': { label: 'Model Endpoint:', placeholder: 'http://localhost:11434', link: 'https://ollama.ai/', linkText: 'Ollama Documentation' }
            };

            let aiModelsData = { models: {}, active: null };

            function updateAIModelFields() {
                const provider = document.getElementById('ai-model-provider').value;
                const cfg = aiProviderConfigs[provider];
                document.getElementById('api-key-label').textContent = cfg.label;
                document.getElementById('ai-api-key').placeholder = cfg.placeholder;
                document.getElementById('ai-api-link').href = cfg.link;
                document.getElementById('ai-api-link').textContent = cfg.linkText;
            }

            async function loadAIModels() {
                try {
                    const response = await fetch('/api/ai_config');
                    const data = await response.json();
                    aiModelsData = data;
                    renderAIModelsList(data);
                    updateAIActiveDisplay(data.active, data.models);
                } catch (error) {
                    console.error('Error loading AI models:', error);
                }
            }

            function updateAIActiveDisplay(activeName, models) {
                const nameEl = document.getElementById('ai-active-model-name');
                const badgeEl = document.getElementById('ai-active-model-badge');
                if (activeName && models && models[activeName]) {
                    const provider = models[activeName].provider;
                    const providerLabels = { claude: 'Claude', chatgpt: 'ChatGPT', gemini: 'Gemini', local: 'Local' };
                    nameEl.textContent = activeName;
                    badgeEl.textContent = (providerLabels[provider] || provider).toUpperCase();
                    badgeEl.style.backgroundColor = '#28a745';
                } else {
                    nameEl.textContent = 'None';
                    badgeEl.textContent = 'NOT SET';
                    badgeEl.style.backgroundColor = '#6c757d';
                }
            }

            function renderAIModelsList(data) {
                const container = document.getElementById('ai-models-list');
                const modelNames = Object.keys(data.models || {});
                if (modelNames.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No models configured. Add one below.</span>';
                    return;
                }
                container.innerHTML = '';
                const providerLabels = { claude: 'Claude', chatgpt: 'ChatGPT', gemini: 'Gemini', local: 'Local' };
                modelNames.forEach(name => {
                    const model = data.models[name];
                    const isActive = data.active === name;
                    const btn = document.createElement('button');
                    btn.className = 'camera-btn ' + (isActive ? 'camera-btn-success' : 'camera-btn-secondary');
                    btn.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 8px 12px; min-width: 140px; cursor: pointer; position: relative;';
                    btn.innerHTML = `
                        <span style="font-weight: bold;">${name}</span>
                        <span style="font-size: 10px; opacity: 0.8;">${providerLabels[model.provider] || model.provider}</span>
                        <span style="font-size: 9px; opacity: 0.7;">${model.api_key_masked || '***'}</span>
                        ${isActive ? '<span style="font-size: 9px; color: #90ee90;">ACTIVE</span>' : ''}
                    `;
                    btn.onclick = () => activateAIModel(name);
                    btn.title = isActive ? 'Currently active' : 'Click to activate';

                    // Delete button (small X in corner)
                    const delBtn = document.createElement('span');
                    delBtn.textContent = 'x';
                    delBtn.style.cssText = 'position: absolute; top: 2px; right: 6px; font-size: 12px; cursor: pointer; opacity: 0.6; color: #ff6b6b;';
                    delBtn.title = 'Delete this model';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteAIModel(name); };
                    btn.appendChild(delBtn);

                    container.appendChild(btn);
                });
            }

            async function saveAIModel() {
                const name = document.getElementById('ai-model-name').value.trim();
                const provider = document.getElementById('ai-model-provider').value;
                const apiKey = document.getElementById('ai-api-key').value.trim();

                if (!name) { alert('Please enter a model name'); return; }
                if (!apiKey) { alert('Please enter an API key or endpoint'); return; }

                try {
                    const response = await fetch('/api/ai_config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, provider, api_key: apiKey })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        clearAIModelForm();
                        loadAIModels();
                    } else {
                        alert('Failed to save: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            async function activateAIModel(name) {
                try {
                    const response = await fetch('/api/ai_config/activate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    if (response.ok) { loadAIModels(); }
                    else { const d = await response.json(); alert('Failed: ' + (d.error || 'Unknown')); }
                } catch (error) { alert('Error: ' + error.message); }
            }

            async function deleteAIModel(name) {
                if (!confirm('Delete model "' + name + '"?')) return;
                try {
                    const response = await fetch('/api/ai_config/' + encodeURIComponent(name), { method: 'DELETE' });
                    if (response.ok) { loadAIModels(); }
                    else { const d = await response.json(); alert('Failed: ' + (d.error || 'Unknown')); }
                } catch (error) { alert('Error: ' + error.message); }
            }

            function clearAIModelForm() {
                document.getElementById('ai-model-name').value = '';
                document.getElementById('ai-api-key').value = '';
                document.getElementById('ai-model-provider').selectedIndex = 0;
                updateAIModelFields();
            }

            // Database Profile Functions
            let dbProfilesData = { profiles: {}, active: null };

            async function loadDBProfiles() {
                try {
                    const response = await fetch('/api/db_config');
                    const data = await response.json();
                    dbProfilesData = data;
                    renderDBProfilesList(data);
                    updateDBActiveDisplay(data.active, data.profiles);
                } catch (error) {
                    console.error('Error loading DB profiles:', error);
                }
            }

            function updateDBActiveDisplay(activeName, profiles) {
                const nameEl = document.getElementById('db-active-profile-name');
                const badgeEl = document.getElementById('db-active-profile-badge');
                if (activeName && profiles && profiles[activeName]) {
                    const p = profiles[activeName];
                    nameEl.textContent = activeName;
                    badgeEl.textContent = `${p.host}:${p.port}`;
                    badgeEl.style.backgroundColor = '#28a745';
                } else {
                    nameEl.textContent = 'None';
                    badgeEl.textContent = 'NOT SET';
                    badgeEl.style.backgroundColor = '#6c757d';
                }
            }

            function renderDBProfilesList(data) {
                const container = document.getElementById('db-profiles-list');
                const names = Object.keys(data.profiles || {});
                if (names.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No profiles configured. Add one below.</span>';
                    return;
                }
                container.innerHTML = '';
                names.forEach(name => {
                    const p = data.profiles[name];
                    const isActive = data.active === name;
                    const btn = document.createElement('button');
                    btn.className = 'camera-btn ' + (isActive ? 'camera-btn-success' : 'camera-btn-secondary');
                    btn.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 8px 12px; min-width: 140px; cursor: pointer; position: relative;';
                    btn.innerHTML = `
                        <span style="font-weight: bold;">${name}</span>
                        <span style="font-size: 10px; opacity: 0.8;">${p.host}:${p.port}</span>
                        <span style="font-size: 9px; opacity: 0.7;">${p.database} (${p.user})</span>
                        ${isActive ? '<span style="font-size: 9px; color: #90ee90;">ACTIVE</span>' : ''}
                    `;
                    btn.onclick = () => activateDBProfile(name);
                    btn.title = isActive ? 'Currently active' : 'Click to activate';

                    const delBtn = document.createElement('span');
                    delBtn.textContent = 'x';
                    delBtn.style.cssText = 'position: absolute; top: 2px; right: 6px; font-size: 12px; cursor: pointer; opacity: 0.6; color: #ff6b6b;';
                    delBtn.title = 'Delete this profile';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteDBProfile(name); };
                    btn.appendChild(delBtn);

                    container.appendChild(btn);
                });
            }

            async function saveDBProfile() {
                const name = document.getElementById('db-profile-name').value.trim();
                const host = document.getElementById('db-host').value.trim();
                const port = parseInt(document.getElementById('db-port').value) || 5432;
                const database = document.getElementById('db-database').value.trim();
                const user = document.getElementById('db-user').value.trim();
                const password = document.getElementById('db-password').value.trim();

                if (!name) { alert('Please enter a profile name'); return; }
                if (!host) { alert('Please enter a host'); return; }

                try {
                    const response = await fetch('/api/db_config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, host, port, database, user, password })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        clearDBProfileForm();
                        loadDBProfiles();
                    } else {
                        alert('Failed to save: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) { alert('Error: ' + error.message); }
            }

            async function activateDBProfile(name) {
                try {
                    const response = await fetch('/api/db_config/activate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    if (response.ok) { loadDBProfiles(); }
                    else { const d = await response.json(); alert('Failed: ' + (d.error || 'Unknown')); }
                } catch (error) { alert('Error: ' + error.message); }
            }

            async function deleteDBProfile(name) {
                if (!confirm('Delete profile "' + name + '"?')) return;
                try {
                    const response = await fetch('/api/db_config/' + encodeURIComponent(name), { method: 'DELETE' });
                    if (response.ok) { loadDBProfiles(); }
                    else { const d = await response.json(); alert('Failed: ' + (d.error || 'Unknown')); }
                } catch (error) { alert('Error: ' + error.message); }
            }

            function clearDBProfileForm() {
                document.getElementById('db-profile-name').value = '';
                document.getElementById('db-host').value = '';
                document.getElementById('db-port').value = '5432';
                document.getElementById('db-database').value = '';
                document.getElementById('db-user').value = '';
                document.getElementById('db-password').value = '';
            }

            // Load chat history from localStorage
            function loadChatHistory() {
                const chatMessages = document.getElementById('ai-chat-messages');
                const history = JSON.parse(localStorage.getItem('ai_chat_history') || '[]');

                // Clear existing messages (except welcome message)
                const welcomeMsg = chatMessages.querySelector('div');
                chatMessages.innerHTML = '';
                if (welcomeMsg) chatMessages.appendChild(welcomeMsg);

                // Restore messages
                history.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    if (msg.type === 'user') {
                        msgDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; text-align: right; color: var(--text-primary);';
                        msgDiv.innerHTML = `<strong>You:</strong> ${msg.content}`;
                    } else if (msg.type === 'ai') {
                        msgDiv.style.cssText = 'margin-bottom: 10px; padding: 15px; background: rgba(30, 41, 59, 0.6); border-radius: 8px; border-left: 4px solid var(--primary-color); color: var(--text-primary); line-height: 1.6;';
                        msgDiv.innerHTML = `<div style="margin-bottom: 8px;"><strong style="color: var(--primary-color);">🤖 AI:</strong></div><div>${msg.content}</div>`;
                    } else if (msg.type === 'error') {
                        msgDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger-color); border-radius: 8px; color: var(--danger-color);';
                        msgDiv.innerHTML = `<strong>Error:</strong> ${msg.content}`;
                    }
                    chatMessages.appendChild(msgDiv);
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Save message to history
            function saveChatMessage(type, content) {
                const history = JSON.parse(localStorage.getItem('ai_chat_history') || '[]');
                history.push({ type, content, timestamp: new Date().toISOString() });

                // Keep only last 50 messages to avoid localStorage quota
                if (history.length > 50) {
                    history.splice(0, history.length - 50);
                }

                localStorage.setItem('ai_chat_history', JSON.stringify(history));
            }

            // Clear chat history
            function clearChatHistory() {
                if (confirm('Clear all chat history?')) {
                    localStorage.removeItem('ai_chat_history');
                    location.reload();
                }
            }

            async function sendAIMessage() {
                const input = document.getElementById('ai-input');
                const message = input.value.trim();

                if (!message) return;

                const chatMessages = document.getElementById('ai-chat-messages');

                // Add user message
                const userMsg = document.createElement('div');
                userMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; text-align: right; color: var(--text-primary);';
                userMsg.innerHTML = `<strong>You:</strong> ${message}`;
                chatMessages.appendChild(userMsg);

                // Save to history
                saveChatMessage('user', message);

                // Clear input
                input.value = '';

                // Add loading indicator
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'ai-loading';
                loadingMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 8px; color: var(--text-secondary);';
                loadingMsg.innerHTML = '<strong>AI:</strong> <span style="animation: pulse 1.5s infinite;">Thinking...</span>';
                chatMessages.appendChild(loadingMsg);

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;

                try {
                    const response = await fetch('/api/ai_query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: message })
                    });

                    const data = await response.json();

                    // Remove loading indicator
                    loadingMsg.remove();

                    // Add AI response
                    const aiMsg = document.createElement('div');
                    aiMsg.style.cssText = 'margin-bottom: 10px; padding: 15px; background: rgba(30, 41, 59, 0.6); border-radius: 8px; border-left: 4px solid var(--primary-color); color: var(--text-primary); line-height: 1.6;';

                    // Format the response with better line breaks and preserve markdown-like formatting
                    let formattedResponse = (data.response || data.error || 'No response')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/• /g, '&nbsp;&nbsp;• ');

                    aiMsg.innerHTML = `<div style="margin-bottom: 8px;"><strong style="color: var(--primary-color);">🤖 AI:</strong></div><div>${formattedResponse}</div>`;
                    chatMessages.appendChild(aiMsg);

                    // Save to history
                    saveChatMessage('ai', formattedResponse);

                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                } catch (error) {
                    console.error('Error querying AI:', error);
                    loadingMsg.remove();

                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'margin-bottom: 10px; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger-color); border-radius: 8px; color: var(--danger-color);';
                    const errorContent = 'Failed to get AI response. Please check your configuration.';
                    errorMsg.innerHTML = `<strong>Error:</strong> ${errorContent}`;
                    chatMessages.appendChild(errorMsg);

                    // Save to history
                    saveChatMessage('error', errorContent);

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            // Load history, AI models, and DB profiles on page load
            document.addEventListener('DOMContentLoaded', function() {
                loadAIModels();
                loadDBProfiles();
                // Load history if on AI tab
                if (document.getElementById('tab-ai').style.display !== 'none') {
                    loadChatHistory();
                }
            });
        </script>

        <script>
            // Update UI with status data (used by SSE stream)
            function updateStatusUI(data) {
                document.getElementById('encoder-value').textContent = data.encoder_value || 0;
                document.getElementById('speed-value').textContent = (data.ppm || 0).toFixed ? (data.ppm || 0).toFixed(2) : data.ppm || 0;
                document.getElementById('pps-value').textContent = data.pps || 0;
                document.getElementById('ok-counter').textContent = data.ok_counter || 0;
                document.getElementById('ng-counter').textContent = data.ng_counter || 0;
                document.getElementById('downtime-value').textContent = data.downtime_seconds || 0;
                document.getElementById('analog-value').textContent = data.analog_value || 0;
                document.getElementById('power-value').textContent = data.power_value || 0;
                const shipmentText = document.getElementById('shipment-text');
                if (shipmentText) {
                    shipmentText.textContent = data.shipment || 'no_shipment';
                }
                document.getElementById('ejector-queue').textContent = data.ejector_queue_length || 0;
                document.getElementById('ejector-running').textContent = data.ejector_running ? 'Yes' : 'No';
                document.getElementById('ejector-enabled').textContent = data.ejector_enabled ? 'Yes' : 'No';
                document.getElementById('ejector-offset').textContent = data.ejector_offset || 0;

                // Update movement status
                const movementIndicator = document.getElementById('movement-indicator');
                const movementValue = document.getElementById('movement-value');
                if (data.is_moving) {
                    movementIndicator.className = 'movement-indicator movement-moving';
                    movementValue.textContent = 'Moving';
                } else {
                    movementIndicator.className = 'movement-indicator movement-stopped';
                    movementValue.textContent = 'Stopped';
                }

                // Update U/B/Warning status circles
                const status = data.status || {};
                const uEl = document.getElementById('U-status');
                const bEl = document.getElementById('B-status');
                const wEl = document.getElementById('warning-status');
                if (uEl) uEl.className = 'status-circle U' + (status.U ? ' active' : '');
                if (bEl) bEl.className = 'status-circle B' + (status.B ? ' active' : '');
                if (wEl) wEl.className = 'status-circle warning' + (status.warning ? ' active' : '');

                // Update serial device status
                const serialDevice = data.serial_device || {};
                const serialDot = document.getElementById('serial-device-dot');
                const serialText = document.getElementById('serial-device-text');
                const serialInfo = document.getElementById('serial-device-info');
                if (serialDot && serialText && serialInfo) {
                    if (serialDevice.connected) {
                        serialDot.style.background = '#28a745';
                        serialText.textContent = 'Connected';
                        serialText.style.color = '#28a745';
                        serialInfo.textContent = `${serialDevice.port} @ ${serialDevice.baudrate} (${serialDevice.mode})`;
                    } else {
                        serialDot.style.background = '#dc3545';
                        serialText.textContent = 'Disconnected';
                        serialText.style.color = '#dc3545';
                        serialInfo.textContent = `${serialDevice.port} not accessible`;
                    }
                }

                // Update device status in sidebar
                const deviceStatus = document.getElementById('device-status');
                if (deviceStatus) {
                    if (serialDevice.connected) {
                        deviceStatus.textContent = 'Device connected';
                        deviceStatus.style.color = 'var(--success-color)';
                    } else {
                        deviceStatus.textContent = 'Serial not connected';
                        deviceStatus.style.color = 'var(--text-secondary)';
                    }
                }

                // Update verbose configuration values
                const v = data.verbose_data || {};
                const setVerbose = (id, key) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = (v[key] === undefined || v[key] === null) ? '-' : v[key];
                };
                setVerbose('v-ood', 'OOD');
                setVerbose('v-odp', 'ODP');
                setVerbose('v-odl', 'ODL');
                setVerbose('v-oef', 'OEF');
                setVerbose('v-nod', 'NOD');
                setVerbose('v-ndp', 'NDP');
                setVerbose('v-ndl', 'NDL');
                setVerbose('v-nef', 'NEF');
                setVerbose('v-ext', 'EXT');
                setVerbose('v-bud', 'BUD');
                setVerbose('v-dwt', 'DWT');
            }

            // Server-Sent Events for real-time status updates
            let statusEventSource = null;

            function startStatusStream() {
                if (statusEventSource) {
                    statusEventSource.close();
                }

                statusEventSource = new EventSource('/api/status/stream');
                const dataSource = document.getElementById('dataSource');

                statusEventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);

                        // Debug: Log detection events
                        if (data.detection_event) {
                            console.log('[SSE] Detection event received:', data.detection_event);
                        }

                        updateStatusUI(data);

                        // Update cameras from SSE
                        if (data.cameras) {
                            updateCameraTable(data.cameras);
                        }

                        // Update inference stats from SSE
                        if (data.inference) {
                            const inf = data.inference;
                            const avgTimeEl = document.getElementById('avg-inference-time');
                            const avgIntervalEl = document.getElementById('avg-frame-interval');
                            const fpsEl = document.getElementById('inference-fps');
                            if (avgTimeEl) avgTimeEl.textContent = inf.avg_time_ms.toFixed(1) + ' ms';
                            if (avgIntervalEl) avgIntervalEl.textContent = inf.avg_interval_ms.toFixed(1) + ' ms';
                            if (fpsEl) fpsEl.textContent = inf.fps.toFixed(1) + ' FPS';

                            // Process detections for audio alerts
                            if (inf.last_detection) {
                                processDetectionForAudio(inf.last_detection);
                            }
                        }

                        // Update health/infrastructure from SSE
                        if (data.health) {
                            const updateInfraStatus = (prefix, available) => {
                                const dot = document.getElementById(`${prefix}-dot`);
                                const text = document.getElementById(`${prefix}-text`);
                                if (dot && text) {
                                    dot.style.background = available ? '#28a745' : '#6c757d';
                                    text.textContent = available ? 'Connected' : 'Not Available';
                                    text.style.color = available ? '#28a745' : '#6c757d';
                                }
                            };
                            updateInfraStatus('redis', data.health.redis === 'connected');

                            const restartWarning = document.getElementById('gradio-restart-warning');
                            if (restartWarning) {
                                restartWarning.style.display = data.health.gradio_needs_restart ? 'inline' : 'none';
                            }
                        }

                        // Process detection events for audio alerts
                        if (data.detection_event && data.detection_event.details && data.detection_event.details.detections) {
                            processDetectionForAudio(data.detection_event.details);
                        }

                        // Process detections for audio alerts (if detections come directly in data)
                        if (data.detections) {
                            processDetectionForAudio(data);
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                    }
                };

                statusEventSource.onerror = function(error) {
                    console.log('SSE reconnecting...');
                    dataSource.textContent = 'RECONNECTING';
                    dataSource.className = 'data-source';
                };

                statusEventSource.onopen = function() {
                    console.log('SSE connected');
                    dataSource.textContent = 'LIVE';
                    dataSource.className = 'data-source serial';
                };
            }

            // Refresh timeline image periodically (every 2 seconds)
            let timelineRefreshInterval = null;
            function startTimelineRefresh() {
                if (timelineRefreshInterval) clearInterval(timelineRefreshInterval);
                timelineRefreshInterval = setInterval(() => {
                    const timelineImg = document.getElementById('timeline-image');
                    const placeholder = document.getElementById('timeline-placeholder');
                    if (timelineImg) {
                        // Add timestamp to force browser to reload
                        const newSrc = '/timeline_image?t=' + Date.now();
                        const testImg = new Image();
                        testImg.onload = () => {
                            timelineImg.src = newSrc;
                            timelineImg.style.display = 'block';
                            if (placeholder) placeholder.style.display = 'none';
                        };
                        testImg.onerror = () => {
                            timelineImg.style.display = 'none';
                            if (placeholder) placeholder.style.display = 'block';
                        };
                        testImg.src = newSrc;
                    }
                }, 2000);
            }

            // Fetch health data (infrastructure status) - called periodically
            function fetchHealth() {
                fetch('/health')
                    .then(response => response.json())
                    .then(data => {
                        const restartWarning = document.getElementById('gradio-restart-warning');
                        if (restartWarning) {
                            restartWarning.style.display = data.gradio_needs_restart ? 'inline' : 'none';
                        }
                        if (data.cameras) {
                            updateCameraTable(data.cameras);
                        }

                        // Update Redis status
                        const redisDot = document.getElementById('redis-dot');
                        const redisText = document.getElementById('redis-text');
                        if (redisDot && redisText) {
                            const redisOk = data.redis === 'connected';
                            redisDot.style.background = redisOk ? '#28a745' : '#6c757d';
                            redisText.textContent = redisOk ? 'Connected' : 'Not Available';
                            redisText.style.color = redisOk ? '#28a745' : '#6c757d';
                        }

                        // Update Pipeline status (YOLO/Gradio)
                        const pipelineDot = document.getElementById('pipeline-dot');
                        const pipelineText = document.getElementById('pipeline-text');
                        if (pipelineDot && pipelineText) {
                            const pipelineOk = data.yolo === 'connected';
                            const gradioStatus = data.gradio_status || '';

                            if (pipelineOk) {
                                // Show more detailed status for Gradio
                                if (gradioStatus === 'healthy') {
                                    pipelineDot.style.background = '#28a745';
                                    pipelineText.textContent = 'Healthy';
                                    pipelineText.style.color = '#28a745';
                                } else if (gradioStatus === 'warning' || gradioStatus === 'idle') {
                                    pipelineDot.style.background = '#ffc107';
                                    pipelineText.textContent = gradioStatus === 'idle' ? 'Idle' : 'Warning';
                                    pipelineText.style.color = '#856404';
                                } else {
                                    pipelineDot.style.background = '#28a745';
                                    pipelineText.textContent = 'Connected';
                                    pipelineText.style.color = '#28a745';
                                }
                            } else {
                                // Not connected
                                if (gradioStatus === 'offline' || gradioStatus === 'stale') {
                                    pipelineDot.style.background = '#dc3545';
                                    pipelineText.textContent = gradioStatus === 'stale' ? 'Stale' : 'Offline';
                                    pipelineText.style.color = '#dc3545';
                                } else {
                                    pipelineDot.style.background = '#6c757d';
                                    pipelineText.textContent = 'Not Available';
                                    pipelineText.style.color = '#6c757d';
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching health:', error));
            }

            // Legacy polling fallback (not used with SSE)
            function fetchStatus() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => updateStatusUI(data))
                    .catch(error => console.error('Error fetching status:', error));
            }

            // Separate function to fetch config - only called once on page load
            function fetchConfig() {
                fetch('/config')
                    .then(response => response.json())
                    .then(data => {
                        // Update counter service configuration inputs with current values
                        if (data.ejector) {
                            document.getElementById('ejector-enabled-input').value = data.ejector.enabled ? 'true' : 'false';
                            document.getElementById('ejector-offset-input').value = data.ejector.offset || 0;
                            document.getElementById('ejector-duration-input').value = data.ejector.duration || 0.4;
                            document.getElementById('ejector-poll-input').value = data.ejector.poll_interval || 0.03;
                        }
                        if (data.capture) {
                            document.getElementById('time-between-packages-input').value = data.capture.time_between_packages || 0.305;
                            document.getElementById('capture-mode-input').value = data.capture.mode || 'single';
                        }
                        // Image processing configuration
                        if (data.image_processing) {
                            document.getElementById('parent-object-list-input').value = (data.image_processing.parent_object_list || []).join(',');
                            document.getElementById('remove-raw-image-input').value = data.image_processing.remove_raw_image_when_dm_decoded ? 'true' : 'false';
                        }
                        // DataMatrix configuration
                        if (data.datamatrix) {
                            document.getElementById('dm-chars-sizes-input').value = (data.datamatrix.chars_sizes || [13,19,26]).join(',');
                            document.getElementById('dm-confidence-input').value = data.datamatrix.confidence_threshold || 0.8;
                            document.getElementById('dm-overlap-input').value = data.datamatrix.overlap_threshold || 0.2;
                        }
                        // Class count check configuration
                        if (data.class_count_check) {
                            document.getElementById('check-class-enabled-input').value = data.class_count_check.enabled ? 'true' : 'false';
                            document.getElementById('check-class-classes-input').value = (data.class_count_check.classes || []).join(',');
                            document.getElementById('check-class-confidence-input').value = data.class_count_check.confidence || 0.5;
                        }
                        // Light control configuration
                        if (data.light_control) {
                            document.getElementById('light-status-check-input').value = data.light_control.status_check_enabled ? 'true' : 'false';
                        }
                        // Histogram configuration
                        if (data.histogram) {
                            document.getElementById('histogram-enabled-input').value = data.histogram.enabled ? 'true' : 'false';
                            document.getElementById('histogram-save-image-input').value = data.histogram.save_image ? 'true' : 'false';
                        }
                        // Store annotation configuration
                        if (data.store_annotation) {
                            document.getElementById('store-annotation-enabled-input').value = data.store_annotation.enabled ? 'true' : 'false';
                            document.getElementById('postgres-info').textContent =
                                `PostgreSQL: ${data.store_annotation.postgres_host}:${data.store_annotation.postgres_port}/${data.store_annotation.postgres_db}`;
                        }
                        // Serial configuration
                        if (data.serial) {
                            document.getElementById('watcher-usb-input').value = data.serial.port || '/dev/ttyUSB0';
                            document.getElementById('baud-rate-input').value = data.serial.baud_rate || 57600;
                            document.getElementById('serial-mode-input').value = data.serial.mode || 'legacy';
                        }
                        // Infrastructure configuration
                        if (data.infrastructure) {
                            document.getElementById('redis-host-input').value = data.infrastructure.redis_host || 'redis';
                            document.getElementById('redis-port-input').value = data.infrastructure.redis_port || 6379;
                            document.getElementById('yolo-url-input').value = data.infrastructure.yolo_url || 'http://yolo_inference:4442/v1/object-detection/yolov5s/detect/';
                            document.getElementById('gradio-confidence-input').value = data.infrastructure.gradio_confidence || 0.25;
                        }
                    })
                    .catch(error => console.error('Error fetching config:', error));
            }

            // Data file functions
            async function loadDataFile() {
                try {
                    const response = await fetch('/api/data-file');
                    const data = await response.json();

                    if (response.ok) {
                        document.getElementById('data-file-path').textContent = data.file_path;
                        document.getElementById('data-file-content').value = data.content;
                    } else {
                        document.getElementById('data-file-path').textContent = 'Error loading';
                        document.getElementById('data-file-content').value = 'Error: ' + (data.detail || 'Unknown error');
                    }
                } catch (error) {
                    document.getElementById('data-file-path').textContent = 'Error';
                    document.getElementById('data-file-content').value = 'Error: ' + error.message;
                }
            }

            async function saveDataFile() {
                const responseEl = document.getElementById('data-file-response');
                const content = document.getElementById('data-file-content').value;

                try {
                    // Validate JSON first
                    JSON.parse(content);

                    const response = await fetch('/api/data-file', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: content })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Saved! ${data.entries_count} entries. Backup: ${data.backup_path}`;
                        responseEl.className = 'control-response success';
                    } else {
                        responseEl.textContent = `Error: ${data.detail || 'Unknown error'}`;
                        responseEl.className = 'control-response error';
                    }

                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 5000);
                } catch (error) {
                    responseEl.textContent = `Error: ${error.message}`;
                    responseEl.className = 'control-response error';
                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 5000);
                }
            }

            function formatDataFile() {
                const textarea = document.getElementById('data-file-content');
                const responseEl = document.getElementById('data-file-response');

                try {
                    const parsed = JSON.parse(textarea.value);
                    textarea.value = JSON.stringify(parsed, null, 2);
                    responseEl.textContent = 'JSON formatted successfully';
                    responseEl.className = 'control-response success';
                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 2000);
                } catch (error) {
                    responseEl.textContent = `Invalid JSON: ${error.message}`;
                    responseEl.className = 'control-response error';
                    setTimeout(() => {
                        responseEl.textContent = '';
                        responseEl.className = 'control-response';
                    }, 3000);
                }
            }

            function updateCameraTable(cameras) {
                const tbody = document.getElementById('camera-table-body');
                const container = document.getElementById('legacy-camera-status-container');
                tbody.innerHTML = '';

                const cameraNames = {
                    'cam_1': 'Camera 1',
                    'cam_2': 'Camera 2',
                    'cam_3': 'Camera 3',
                    'cam_4': 'Camera 4'
                };

                // Only show the table if there are cameras
                const hasCameras = Object.keys(cameras).length > 0;
                container.style.display = hasCameras ? 'block' : 'none';

                if (!hasCameras) {
                    return;
                }

                for (const [key, status] of Object.entries(cameras)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cameraNames[key] || key}</td>
                        <td class="${status ? 'camera-ok' : 'camera-fail'}">${status ? 'OK' : 'FAIL'}</td>
                    `;
                    tbody.appendChild(row);
                }
            }

            async function fetchGradioModels() {
                try {
                    const response = await fetch('/api/gradio/models');
                    const data = await response.json();

                    if (data.models && Array.isArray(data.models)) {
                        const modelSelect = document.getElementById('gradio-model-select');
                        modelSelect.innerHTML = '';  // Clear existing options

                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            modelSelect.appendChild(option);
                        });

                        console.log(`Loaded ${data.models.length} models from ${data.source}`);
                    }
                } catch (error) {
                    console.error('Failed to fetch Gradio models:', error);
                }
            }

            function updateAPITypeFields() {
                const apiTypeEl = document.getElementById('api-type-select');
                if (!apiTypeEl) return;  // Element not found, exit early

                const apiType = apiTypeEl.value;
                const urlLabel = document.getElementById('yolo-url-label');
                const urlInput = document.getElementById('yolo-url-input');
                const modelSelector = document.getElementById('gradio-model-selector');
                const confidenceField = document.getElementById('gradio-confidence-field');

                if (apiType === 'gradio') {
                    urlLabel.textContent = 'Gradio API URL (HuggingFace Space)';
                    urlInput.value = 'https://smartfalcon-ai-industrial-defect-detection.hf.space';
                    urlInput.placeholder = 'https://smartfalcon-ai-industrial-defect-detection.hf.space';
                    modelSelector.style.display = 'block';  // Show model selector
                    confidenceField.style.display = 'block';  // Show confidence field
                    // Fetch models from Gradio
                    fetchGradioModels();
                    // Show helper text
                    const responseDiv = document.getElementById('config-yolo_url-response');
                    responseDiv.innerHTML = '<span style="color: #0c5460;">💡 HuggingFace Space URL set - click "Set URL" to apply</span>';
                } else {
                    urlLabel.textContent = 'YOLO Inference URL';
                    urlInput.value = 'http://yolo_inference:4442/v1/object-detection/yolov5s/detect/';
                    urlInput.placeholder = 'http://yolo_inference:4442/v1/object-detection/yolov5s/detect/';
                    modelSelector.style.display = 'none';  // Hide model selector
                    confidenceField.style.display = 'none';  // Hide confidence field
                    const responseDiv = document.getElementById('config-yolo_url-response');
                    responseDiv.innerHTML = '';
                }
            }

            async function updateConfig(key, value) {
                const responseId = `config-${key}-response`;
                const responseEl = document.getElementById(responseId);

                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ [key]: value })
                    });

                    const data = await response.json();

                    if (responseEl) {
                        if (response.ok) {
                            responseEl.textContent = `OK: ${key} = ${value}`;
                            responseEl.className = 'control-response success';

                            // Check if serial was reinitialized
                            if (data.serial_reinitialized) {
                                responseEl.textContent = `OK: ${key} = ${value} - Serial connection reinitialized`;
                            }

                            setTimeout(() => {
                                responseEl.textContent = '';
                                responseEl.className = 'control-response';
                            }, 3000);
                        } else {
                            responseEl.textContent = `Error: ${data.detail || 'Unknown error'}`;
                            responseEl.className = 'control-response error';
                            setTimeout(() => {
                                responseEl.textContent = '';
                                responseEl.className = 'control-response';
                            }, 3000);
                        }
                    }
                } catch (error) {
                    if (responseEl) {
                        responseEl.textContent = `Error: ${error.message}`;
                        responseEl.className = 'control-response error';
                        setTimeout(() => {
                            responseEl.textContent = '';
                            responseEl.className = 'control-response';
                        }, 3000);
                    }
                }
            }

            async function sendCommand(command, value = null) {
                const responseId = `cmd-${command}-response`;
                const responseEl = document.getElementById(responseId);

                try {
                    let url = `/${command}`;
                    if (value !== null) {
                        url += `?value=${value}`;
                    }

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (responseEl) {
                        if (response.ok) {
                            responseEl.textContent = `OK: ${data.command}`;
                            responseEl.className = 'control-response success';
                        } else {
                            responseEl.textContent = `Error: ${data.detail || 'Unknown error'}`;
                            responseEl.className = 'control-response error';
                        }

                        setTimeout(() => {
                            responseEl.textContent = '';
                            responseEl.className = 'control-response';
                        }, 3000);
                    }
                } catch (error) {
                    if (responseEl) {
                        responseEl.textContent = `Error: ${error.message}`;
                        responseEl.className = 'control-response error';
                        setTimeout(() => {
                            responseEl.textContent = '';
                            responseEl.className = 'control-response';
                        }, 3000);
                    }
                }
            }

            // ===== CAMERA MONITORING FUNCTIONS =====
            // Direct camera control through counter service API
            let cameraData = {};
            let cameraRefreshInterval = null;
            let isCameraUpdating = false;

            async function fetchCameraStatus() {
                if (isCameraUpdating) return;

                const statusEl = document.getElementById('camera-refresh-status');
                try {
                    statusEl.textContent = 'Updating...';
                    statusEl.className = 'camera-refresh-status';

                    const response = await fetch('/api/cameras');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Failed to get camera status');
                    }

                    const cameras = await response.json();

                    if (cameras.error) {
                        throw new Error(cameras.error);
                    }

                    cameraData = {};
                    cameras.forEach(c => cameraData[c.id] = c);

                    renderCameraCards();

                    statusEl.textContent = 'Active';
                    statusEl.className = 'camera-refresh-status';
                } catch (error) {
                    console.error('Error fetching camera status:', error);
                    statusEl.textContent = 'Error';
                    statusEl.className = 'camera-refresh-status error';

                    const grid = document.getElementById('camera-grid');
                    grid.innerHTML = `
                        <div class="camera-loading" style="color: #dc3545;">
                            ⚠️ Could not load camera status<br>
                            <small style="color: #666;">${error.message}</small>
                        </div>
                    `;
                }
            }

            function renderCameraCards() {
                const grid = document.getElementById('camera-grid');
                const cameraIds = Object.keys(cameraData).sort((a, b) => parseInt(a) - parseInt(b));

                if (cameraIds.length === 0) {
                    grid.innerHTML = '<div class="camera-loading">No cameras detected</div>';
                    return;
                }

                grid.innerHTML = '';
                cameraIds.forEach(cameraId => {
                    const camera = cameraData[cameraId];
                    const card = createCameraCard(cameraId, camera);
                    grid.appendChild(card);
                });
            }

            function createCameraCard(cameraId, camera) {
                const div = document.createElement('div');
                div.className = 'camera-card';
                div.id = `camera-card-${cameraId}`;

                const config = camera.config || {};
                const isConnected = camera.connected;
                const isIPCamera = camera.type === 'ip';
                const cameraName = camera.name || `Camera ${cameraId}`;

                div.innerHTML = `
                    <div class="camera-card-header">
                        <span class="camera-card-title">Camera ${cameraId}: ${cameraName}</span>
                        <span class="camera-status-badge ${isConnected ? 'running' : 'stopped'}">
                            ${isConnected ? 'CONNECTED' : 'DISCONNECTED'}
                        </span>
                    </div>

                    <div class="camera-message" id="camera-msg-${cameraId}"></div>

                    <div class="camera-card-content">
                        <div class="camera-image-container">
                            ${isConnected ?
                                `<img id="camera-img-${cameraId}"
                                      src="/api/camera/${cameraId}/snapshot?t=${Date.now()}"
                                      class="camera-image camera-live-feed"
                                      data-camera-id="${cameraId}"
                                      alt="${cameraName}"
                                      onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="camera-no-image" style="display:none;">📷 Camera feed unavailable</div>` :
                                `<div class="camera-no-image">Camera not connected</div>`
                            }
                        </div>
                        <div class="camera-info">
                            ${isIPCamera ? `
                            <div class="camera-info-item">
                                <span class="camera-info-label">Type</span>
                                <span class="camera-info-value">IP Camera (${camera.ip || 'N/A'})</span>
                            </div>
                            ` : ''}
                            <div class="camera-info-item">
                                <span class="camera-info-label">Path</span>
                                <span class="camera-info-value" style="font-size: 11px;">${isIPCamera && camera.camera_path ? camera.camera_path : camera.path || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">Resolution</span>
                                <span class="camera-info-value">${config.width || '-'}x${config.height || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">FPS</span>
                                <span class="camera-info-value">${config.fps || '-'}</span>
                            </div>
                            ${!isIPCamera ? `
                            <div class="camera-info-item">
                                <span class="camera-info-label">Exposure</span>
                                <span class="camera-info-value">${config.exposure || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">Gain</span>
                                <span class="camera-info-value">${config.gain || '-'}</span>
                            </div>
                            <div class="camera-info-item">
                                <span class="camera-info-label">Brightness</span>
                                <span class="camera-info-value">${config.brightness || '-'}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    ${isIPCamera ? `
                    <div class="camera-config-section">
                        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin-bottom: 10px; font-size: 13px;">
                            ℹ️ <strong>IP Camera Note:</strong> Exposure, gain, and brightness cannot be controlled via software for RTSP/IP cameras.
                            These settings must be configured through the camera's web interface or manufacturer app.
                        </div>
                        <div class="camera-roi-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <label style="margin-right: 10px; font-weight: bold;">ROI (Region of Interest)</label>
                                <input type="checkbox" id="cam-cfg-roi-enabled-${cameraId}" ${config.roi_enabled ? 'checked' : ''} ${!isConnected ? 'disabled' : ''}>
                                <span style="margin-left: 5px; font-size: 11px;">Enable</span>
                            </div>
                            <div class="camera-config-grid">
                                <div class="camera-config-item">
                                    <label>X Min</label>
                                    <input type="number" id="cam-cfg-roi-xmin-${cameraId}" value="${config.roi_xmin || 0}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Min</label>
                                    <input type="number" id="cam-cfg-roi-ymin-${cameraId}" value="${config.roi_ymin || 0}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>X Max</label>
                                    <input type="number" id="cam-cfg-roi-xmax-${cameraId}" value="${config.roi_xmax || 1280}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Max</label>
                                    <input type="number" id="cam-cfg-roi-ymax-${cameraId}" value="${config.roi_ymax || 720}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                            </div>
                        </div>
                        <div class="camera-actions" style="margin-top: 15px;">
                            <button class="camera-btn camera-btn-secondary" onclick="restartCamera(${cameraId})" ${!isConnected ? 'disabled' : ''}>Restart</button>
                            <button class="camera-btn camera-btn-primary" onclick="applyCameraConfig(${cameraId})" ${!isConnected ? 'disabled' : ''}>Apply ROI</button>
                            <button class="camera-btn camera-btn-success" onclick="saveCameraConfig(${cameraId})">💾 Save</button>
                        </div>
                    </div>
                    ` : `
                    <div class="camera-config-section">
                        <div class="camera-config-grid">
                            <div class="camera-config-item">
                                <label>Exposure</label>
                                <input type="number" id="cam-cfg-exposure-${cameraId}" value="${config.exposure || 100}" min="1" max="100000"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Gain</label>
                                <input type="number" id="cam-cfg-gain-${cameraId}" value="${config.gain || 100}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Brightness</label>
                                <input type="number" id="cam-cfg-brightness-${cameraId}" value="${config.brightness || 100}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Contrast</label>
                                <input type="number" id="cam-cfg-contrast-${cameraId}" value="${config.contrast || 0}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>Saturation</label>
                                <input type="number" id="cam-cfg-saturation-${cameraId}" value="${config.saturation || 50}" min="0" max="255"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                            <div class="camera-config-item">
                                <label>FPS</label>
                                <input type="number" id="cam-cfg-fps-${cameraId}" value="${config.fps || 30}" min="1" max="120"
                                       onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                            </div>
                        </div>
                        <div class="camera-roi-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <label style="margin-right: 10px; font-weight: bold;">ROI</label>
                                <input type="checkbox" id="cam-cfg-roi-enabled-${cameraId}" ${config.roi_enabled ? 'checked' : ''} ${!isConnected ? 'disabled' : ''}>
                                <span style="margin-left: 5px; font-size: 11px;">Enable</span>
                            </div>
                            <div class="camera-config-grid">
                                <div class="camera-config-item">
                                    <label>X Min</label>
                                    <input type="number" id="cam-cfg-roi-xmin-${cameraId}" value="${config.roi_xmin || 0}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Min</label>
                                    <input type="number" id="cam-cfg-roi-ymin-${cameraId}" value="${config.roi_ymin || 0}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>X Max</label>
                                    <input type="number" id="cam-cfg-roi-xmax-${cameraId}" value="${config.roi_xmax || 1280}" min="0" max="1280"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                                <div class="camera-config-item">
                                    <label>Y Max</label>
                                    <input type="number" id="cam-cfg-roi-ymax-${cameraId}" value="${config.roi_ymax || 720}" min="0" max="720"
                                           onfocus="pauseCameraRefresh()" onblur="resumeCameraRefresh()" ${!isConnected ? 'disabled' : ''}>
                                </div>
                            </div>
                        </div>
                        <div class="camera-actions">
                            <button class="camera-btn camera-btn-secondary" onclick="restartCamera(${cameraId})" ${!isConnected ? 'disabled' : ''}>Restart</button>
                            <button class="camera-btn camera-btn-primary" onclick="applyCameraConfig(${cameraId})" ${!isConnected ? 'disabled' : ''}>Apply</button>
                            <button class="camera-btn camera-btn-success" onclick="saveCameraConfig(${cameraId})">💾 Save</button>
                        </div>
                    </div>
                    `}
                `;

                return div;
            }

            function pauseCameraRefresh() {
                isCameraUpdating = true;
                const statusEl = document.getElementById('camera-refresh-status');
                if (statusEl) {
                    statusEl.textContent = 'Paused';
                    statusEl.className = 'camera-refresh-status paused';
                }
            }

            function resumeCameraRefresh() {
                setTimeout(() => {
                    isCameraUpdating = false;
                    const statusEl = document.getElementById('camera-refresh-status');
                    if (statusEl) {
                        statusEl.textContent = 'Active';
                        statusEl.className = 'camera-refresh-status';
                    }
                }, 200);
            }

            function showCameraMessage(cameraId, message, type) {
                const msgEl = document.getElementById(`camera-msg-${cameraId}`);
                if (!msgEl) return;

                msgEl.textContent = message;
                msgEl.className = `camera-message ${type}`;

                setTimeout(() => {
                    msgEl.className = 'camera-message';
                    msgEl.textContent = '';
                }, 3000);
            }

            async function restartCamera(cameraId) {
                try {
                    showCameraMessage(cameraId, 'Restarting camera...', 'info');

                    const response = await fetch(`/api/camera/${cameraId}/restart`, {
                        method: 'POST'
                    });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showCameraMessage(cameraId, 'Camera restarted successfully!', 'success');
                        setTimeout(() => fetchCameraStatus(), 2000);
                    } else {
                        showCameraMessage(cameraId, result.error || 'Failed to restart camera', 'error');
                    }
                } catch (error) {
                    showCameraMessage(cameraId, `Error: ${error.message}`, 'error');
                }
            }

            async function applyCameraConfig(cameraId) {
                pauseCameraRefresh();
                showCameraMessage(cameraId, 'Applying configuration...', 'info');

                try {
                    // Build config object with only available fields
                    const config = {
                        roi_enabled: document.getElementById(`cam-cfg-roi-enabled-${cameraId}`).checked,
                        roi_xmin: parseInt(document.getElementById(`cam-cfg-roi-xmin-${cameraId}`).value) || 0,
                        roi_ymin: parseInt(document.getElementById(`cam-cfg-roi-ymin-${cameraId}`).value) || 0,
                        roi_xmax: parseInt(document.getElementById(`cam-cfg-roi-xmax-${cameraId}`).value) || 1280,
                        roi_ymax: parseInt(document.getElementById(`cam-cfg-roi-ymax-${cameraId}`).value) || 720
                    };

                    // Add USB camera settings if they exist (will be null for IP cameras)
                    const fpsEl = document.getElementById(`cam-cfg-fps-${cameraId}`);
                    const exposureEl = document.getElementById(`cam-cfg-exposure-${cameraId}`);
                    const gainEl = document.getElementById(`cam-cfg-gain-${cameraId}`);
                    const brightnessEl = document.getElementById(`cam-cfg-brightness-${cameraId}`);
                    const contrastEl = document.getElementById(`cam-cfg-contrast-${cameraId}`);
                    const saturationEl = document.getElementById(`cam-cfg-saturation-${cameraId}`);

                    if (fpsEl) config.fps = parseInt(fpsEl.value) || 30;
                    if (exposureEl) config.exposure = parseInt(exposureEl.value) || 100;
                    if (gainEl) config.gain = parseInt(gainEl.value) || 100;
                    if (brightnessEl) config.brightness = parseInt(brightnessEl.value) || 100;
                    if (contrastEl) config.contrast = parseInt(contrastEl.value) || 0;
                    if (saturationEl) config.saturation = parseInt(saturationEl.value) || 50;

                    const response = await fetch(`/api/camera/${cameraId}/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        showCameraMessage(cameraId, 'Configuration applied!', 'success');
                        setTimeout(() => fetchCameraStatus(), 1000);
                    } else {
                        showCameraMessage(cameraId, result.error || 'Failed to apply config', 'error');
                    }
                } catch (error) {
                    showCameraMessage(cameraId, `Error: ${error.message}`, 'error');
                }

                setTimeout(resumeCameraRefresh, 2000);
            }

            async function saveCameraConfig(cameraId) {
                try {
                    showCameraMessage(cameraId, 'Saving camera configuration...', 'info');

                    // First apply the current settings
                    await applyCameraConfig(cameraId);

                    // Then save all config to file
                    const response = await fetch('/api/cameras/config/save', { method: 'POST' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showCameraMessage(cameraId, 'Camera settings saved!', 'success');
                    } else {
                        showCameraMessage(cameraId, result.error || 'Failed to save config', 'error');
                    }
                } catch (error) {
                    showCameraMessage(cameraId, `Error: ${error.message}`, 'error');
                }
            }

            function refreshCameras() {
                fetchCameraStatus();
            }

            function updateCameraImages() {
                if (isCameraUpdating) return;

                Object.keys(cameraData).forEach(cameraId => {
                    const camera = cameraData[cameraId];
                    if (camera.connected) {
                        const imgEl = document.getElementById(`camera-img-${cameraId}`);
                        if (imgEl) {
                            // Update snapshot to create live feed effect
                            imgEl.src = `/api/camera/${cameraId}/snapshot?t=${Date.now()}`;
                        }
                    }
                });
            }

            // Start continuous live feed updates for all camera feeds
            // Only runs when cameras tab is visible to avoid server overload
            let liveFeedInterval = null;
            function startLiveFeedUpdates() {
                if (liveFeedInterval) return; // Already running

                liveFeedInterval = setInterval(() => {
                    // Only update when cameras tab is active
                    const camerasTab = document.getElementById('tab-cameras');
                    if (!camerasTab || !camerasTab.classList.contains('active')) return;

                    document.querySelectorAll('.camera-live-feed').forEach(img => {
                        const cameraId = img.getAttribute('data-camera-id');
                        if (cameraId && cameraData[cameraId] && cameraData[cameraId].connected) {
                            img.src = `/api/camera/${cameraId}/snapshot?t=${Date.now()}`;
                        }
                    });
                }, 1000); // Update every 1s when cameras tab is active
            }

            function stopLiveFeedUpdates() {
                if (liveFeedInterval) {
                    clearInterval(liveFeedInterval);
                    liveFeedInterval = null;
                }
            }

            // Start live feed updates when cameras are loaded
            window.addEventListener('load', () => {
                setTimeout(startLiveFeedUpdates, 1000);
            });

            // ===== CAMERA CONFIG PERSISTENCE FUNCTIONS =====
            function showConfigMessage(message, type) {
                const msgEl = document.getElementById('camera-config-message');
                msgEl.textContent = message;
                msgEl.style.display = 'block';
                msgEl.style.backgroundColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
                msgEl.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
                setTimeout(() => { msgEl.style.display = 'none'; }, 5000);
            }

            async function saveServiceConfig() {
                try {
                    showConfigMessage('Saving all service configuration...', 'info');
                    const response = await fetch('/api/cameras/config/save', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showConfigMessage(`All config saved! (${result.cameras_saved} cameras, ${result.states_saved || 0} states + service settings)`, 'success');
                        checkServiceConfigStatus();
                        refreshStates();  // Refresh states display
                    } else {
                        showConfigMessage(result.error || 'Failed to save', 'error');
                    }
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
            }

            async function loadServiceConfig() {
                try {
                    showConfigMessage('Loading all service configuration...', 'info');
                    const response = await fetch('/api/cameras/config/load', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showConfigMessage(`All config loaded! (${result.cameras_loaded} cameras, ${result.states_loaded || 0} states + service settings)`, 'success');
                        setTimeout(() => fetchCameraStatus(), 500);
                        refreshStates();  // Refresh states display
                    } else {
                        showConfigMessage(result.error || 'Failed to load', 'error');
                    }
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
            }

            async function downloadServiceConfig() {
                try {
                    const response = await fetch('/api/cameras/config');
                    const data = await response.json();
                    if (!data.exists || !data.config) {
                        showConfigMessage('No saved configuration to export', 'error');
                        return;
                    }
                    const blob = new Blob([JSON.stringify(data.config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `service_config_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showConfigMessage('All configuration exported!', 'success');
                } catch (error) {
                    showConfigMessage(`Error: ${error.message}`, 'error');
                }
            }


            async function checkServiceConfigStatus() {
                try {
                    const response = await fetch('/api/cameras/config');
                    const data = await response.json();
                    const statusEl = document.getElementById('camera-config-status');
                    if (statusEl) {
                        if (data.exists && data.config) {
                            statusEl.textContent = `Last saved: ${data.config.saved_at || 'unknown'}`;
                        } else {
                            statusEl.textContent = 'No saved config';
                        }
                    }
                } catch (error) {
                    const statusEl = document.getElementById('camera-config-status');
                    if (statusEl) statusEl.textContent = '';
                }
            }

            // ===== STATE MANAGEMENT FUNCTIONS =====
            let statesData = {};

            function showStateMessage(message, type) {
                const msgEl = document.getElementById('state-message');
                msgEl.textContent = message;
                msgEl.style.display = 'block';
                msgEl.style.backgroundColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
                msgEl.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
                setTimeout(() => { msgEl.style.display = 'none'; }, 5000);
            }

            async function refreshStates() {
                try {
                    const response = await fetch('/api/states');
                    const data = await response.json();
                    statesData = data;

                    // Update current state display
                    const currentState = data.current_state;
                    document.getElementById('current-state-name').textContent = currentState ? currentState.name : 'None';

                    // Update capture state badge
                    const captureState = data.capture_state || 'idle';
                    const badge = document.getElementById('capture-state-badge');
                    badge.textContent = captureState.toUpperCase();
                    const badgeColors = {
                        'idle': '#6c757d',
                        'ready': '#17a2b8',
                        'capturing': '#28a745',
                        'processing': '#ffc107',
                        'error': '#dc3545'
                    };
                    badge.style.backgroundColor = badgeColors[captureState] || '#6c757d';

                    // Render states list
                    renderStatesList(data.states || {});

                } catch (error) {
                    console.error('Error fetching states:', error);
                    showStateMessage('Error loading states: ' + error.message, 'error');
                }
            }

            function renderStatesList(states) {
                const container = document.getElementById('states-list');
                const stateNames = Object.keys(states);

                if (stateNames.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No states configured</span>';
                    return;
                }

                container.innerHTML = '';
                stateNames.forEach(name => {
                    const state = states[name];
                    const isActive = statesData.current_state && statesData.current_state.name === name;

                    // Get phases info for display
                    const phases = state.phases || [];
                    const phaseCount = phases.length;
                    const allCameras = [...new Set(phases.flatMap(p => p.cameras || []))].sort();

                    // Get trigger thresholds from first phase (or state-level fallback)
                    const firstPhase = phases.length > 0 ? phases[0] : {};
                    let steps = firstPhase.steps !== undefined ? firstPhase.steps : (state.steps !== undefined ? state.steps : 1);
                    let analog = firstPhase.analog !== undefined ? firstPhase.analog : (state.analog !== undefined ? state.analog : -1);
                    const stepsDisplay = steps < 0 ? 'loop' : steps;
                    const analogDisplay = analog < 0 ? 'off' : analog;

                    // Get light mode and delay info from phases
                    const phasesInfo = phases.map((p, idx) => {
                        const lightMode = p.light_mode || 'U_ON_B_OFF';
                        const delay = p.delay !== undefined ? p.delay : 0;
                        return `${lightMode}:${delay}s`;
                    }).join(', ');

                    const btn = document.createElement('button');
                    btn.className = 'camera-btn ' + (isActive ? 'camera-btn-success' : 'camera-btn-secondary');
                    btn.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 8px 12px; min-width: 140px; cursor: pointer;';
                    btn.innerHTML = `
                        <span style="font-weight: bold;">${name}</span>
                        <span style="font-size: 10px; opacity: 0.8;">${phaseCount} phase${phaseCount !== 1 ? 's' : ''} | Cams: ${allCameras.join(',')}</span>
                        <span style="font-size: 10px; opacity: 0.8;">Steps: ${stepsDisplay} | Analog: ${analogDisplay}</span>
                        <span style="font-size: 9px; opacity: 0.7;">${phasesInfo || 'No phases'}</span>
                    `;
                    btn.onclick = () => activateState(name);
                    btn.ondblclick = () => loadStateToEditor(name, state);  // Double-click to edit
                    btn.title = 'Click to activate, double-click to edit\nLight modes: ' + phasesInfo;
                    container.appendChild(btn);
                });
            }

            function loadStateToEditor(name, state) {
                // Load state into editor form
                document.getElementById('state-name-input').value = name;
                document.getElementById('state-enabled-input').value = state.enabled ? 'true' : 'false';

                // Clear existing phases and rebuild
                const container = document.getElementById('phases-container');
                container.innerHTML = '';

                const phases = state.phases || [];
                phases.forEach((phase, idx) => {
                    const steps = phase.steps !== undefined ? phase.steps : (state.steps !== undefined ? state.steps : -1);
                    const analog = phase.analog !== undefined ? phase.analog : (state.analog !== undefined ? state.analog : -1);
                    addPhaseRow(idx, phase.light_mode, phase.delay, phase.cameras, steps, analog);
                });

                showStateMessage(`Loaded state '${name}' into editor`, 'info');
            }

            async function activateState(stateName) {
                try {
                    showStateMessage('Activating state...', 'info');
                    const response = await fetch(`/api/states/${stateName}/activate`, { method: 'POST' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showStateMessage(`State '${stateName}' activated!`, 'success');
                        refreshStates();
                    } else {
                        showStateMessage(result.error || 'Failed to activate state', 'error');
                    }
                } catch (error) {
                    showStateMessage('Error: ' + error.message, 'error');
                }
            }

            async function triggerCapture() {
                try {
                    showStateMessage('Triggering capture...', 'info');
                    const response = await fetch('/api/states/trigger-capture', { method: 'POST' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        showStateMessage(`Capture triggered! Count: ${result.capture_count}`, 'success');
                        refreshStates();
                    } else {
                        showStateMessage(result.error || 'Failed to trigger capture', 'error');
                    }
                } catch (error) {
                    showStateMessage('Error: ' + error.message, 'error');
                }
            }

            // Phase management functions
            let phaseCounter = 1;  // Start at 1 since we have 1 default phase

            function addPhase() {
                addPhaseRow(phaseCounter, 'U_ON_B_OFF', 0.1, [1, 2, 3, 4]);
                phaseCounter++;
            }

            function addPhaseRow(idx, lightMode, delay, cameras, steps = 1, analog = -1) {
                const container = document.getElementById('phases-container');
                const div = document.createElement('div');
                div.className = 'phase-row';
                div.id = `phase-row-${idx}`;
                div.style.cssText = 'display: grid; grid-template-columns: 1.2fr 0.8fr 1fr 0.8fr 0.8fr auto; gap: 6px; align-items: end; margin-bottom: 8px; padding: 8px; background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(51, 65, 85, 0.4); border-radius: 4px;';

                const camerasStr = Array.isArray(cameras) ? cameras.join(',') : cameras;

                div.innerHTML = `
                    <div>
                        <label style="font-size: 10px; color: #666;">Light Mode</label>
                        <select class="control-input phase-light" style="margin: 0; padding: 4px; font-size: 12px;">
                            <option value="U_ON_B_OFF" ${lightMode === 'U_ON_B_OFF' ? 'selected' : ''}>U On, B Off</option>
                            <option value="U_OFF_B_ON" ${lightMode === 'U_OFF_B_ON' ? 'selected' : ''}>U Off, B On</option>
                            <option value="U_ON_B_ON" ${lightMode === 'U_ON_B_ON' ? 'selected' : ''}>U On, B On</option>
                            <option value="U_OFF_B_OFF" ${lightMode === 'U_OFF_B_OFF' ? 'selected' : ''}>U Off, B Off</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Delay (s)</label>
                        <input type="number" class="control-input phase-delay" value="${delay}" min="0" step="0.01" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Cameras</label>
                        <input type="text" class="control-input phase-cameras" value="${camerasStr}" placeholder="1,2,3,4" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Steps (-1=loop)</label>
                        <input type="number" class="control-input phase-steps" value="${steps}" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666;">Analog (-1=off)</label>
                        <input type="number" class="control-input phase-analog" value="${analog}" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                    </div>
                    <button class="camera-btn camera-btn-danger" onclick="removePhase('${idx}')" style="padding: 4px 8px; font-size: 11px;">✕</button>
                `;
                container.appendChild(div);
            }

            function removePhase(idx) {
                const row = document.getElementById(`phase-row-${idx}`);
                if (row) {
                    row.remove();
                }
                // Check if we have at least one phase
                const remaining = document.querySelectorAll('.phase-row').length;
                if (remaining === 0) {
                    addPhaseRow(phaseCounter++, 'U_ON_B_OFF', 0.1, [1, 2, 3, 4]);
                }
            }

            function collectPhases() {
                const phases = [];
                const rows = document.querySelectorAll('.phase-row');
                rows.forEach(row => {
                    const lightMode = row.querySelector('.phase-light').value;
                    const delay = parseFloat(row.querySelector('.phase-delay').value) || 0;
                    const camerasStr = row.querySelector('.phase-cameras').value.trim();
                    const cameras = camerasStr ? camerasStr.split(',').map(c => parseInt(c.trim())).filter(c => !isNaN(c)) : [];
                    const steps = parseInt(row.querySelector('.phase-steps').value) || -1;
                    const analog = parseInt(row.querySelector('.phase-analog').value) || -1;

                    // Allow phases without cameras (e.g., light-off phase)
                    phases.push({
                        light_mode: lightMode,
                        delay: delay,
                        cameras: cameras,
                        steps: steps,
                        analog: analog
                    });
                });
                return phases;
            }

            async function createOrUpdateState() {
                const responseEl = document.getElementById('state-config-response');
                const name = document.getElementById('state-name-input').value.trim();

                if (!name) {
                    responseEl.textContent = 'State name is required';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                const phases = collectPhases();

                if (phases.length === 0) {
                    responseEl.textContent = 'At least one phase is required';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                // Warn if no phase has cameras (but still allow it)
                const hasCapture = phases.some(p => p.cameras.length > 0);
                if (!hasCapture) {
                    console.warn('Warning: No phase has cameras configured - no images will be captured');
                }

                const stateData = {
                    name: name,
                    phases: phases,
                    enabled: document.getElementById('state-enabled-input').value === 'true'
                };

                try {
                    const response = await fetch('/api/states', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(stateData)
                    });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        responseEl.textContent = `State '${name}' created/updated with ${phases.length} phase(s)!`;
                        responseEl.className = 'control-response success';
                        refreshStates();
                    } else {
                        responseEl.textContent = result.error || 'Failed to create state';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function deleteCurrentState() {
                const responseEl = document.getElementById('state-config-response');
                const name = document.getElementById('state-name-input').value.trim();

                if (!name) {
                    responseEl.textContent = 'Enter state name to delete';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                if (name === 'default') {
                    responseEl.textContent = 'Cannot delete default state';
                    responseEl.className = 'control-response error';
                    setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
                    return;
                }

                if (!confirm(`Delete state '${name}'?`)) return;

                try {
                    const response = await fetch(`/api/states/${name}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        responseEl.textContent = `State '${name}' deleted!`;
                        responseEl.className = 'control-response success';
                        document.getElementById('state-name-input').value = '';
                        refreshStates();
                    } else {
                        responseEl.textContent = result.error || 'Failed to delete state';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            // ===== INFERENCE PIPELINE MANAGEMENT =====
            let pipelineData = {};

            async function refreshPipelineConfig() {
                try {
                    const response = await fetch('/api/pipelines');
                    const data = await response.json();
                    pipelineData = data;

                    // Update current pipeline/model display
                    const currentPipeline = pipelineData.current_pipeline || 'default';
                    const currentModel = pipelineData.current_model;

                    document.getElementById('current-pipeline-name').textContent = currentPipeline;
                    document.getElementById('current-model-name').textContent = currentModel ? currentModel.name : 'None';

                    // Render lists
                    renderPipelinesList(pipelineData.pipelines || {}, currentPipeline);
                    renderModelsList(pipelineData.models || {});
                    renderModelsChecklist(pipelineData.models || {});

                } catch (error) {
                    console.error('Error loading pipeline config:', error);
                }
            }

            async function fetchModelsFromGradio() {
                const url = document.getElementById('model-url-input').value.trim();
                const select = document.getElementById('model-gradio-name-input');
                const btn = event.target;

                if (!url) {
                    alert('Please enter a Gradio URL first');
                    return;
                }

                // Show loading state
                const originalText = btn.textContent;
                btn.textContent = 'Loading...';
                btn.disabled = true;

                try {
                    const response = await fetch(`/api/gradio/models?url=${encodeURIComponent(url)}`);
                    const data = await response.json();

                    if (data.models && data.models.length > 0) {
                        // Update select with fetched models
                        select.innerHTML = '';
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            select.appendChild(option);
                        });

                        if (data.note) {
                            console.log('Note:', data.note);
                        }
                        if (data.source) {
                            console.log('Models fetched from:', data.source);
                        }
                    } else {
                        alert('No models found from API. Using default list.');
                    }
                } catch (error) {
                    console.error('Error fetching models:', error);
                    alert('Failed to fetch models. Using default list.');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            function handleModelTypeChange() {
                const type = document.getElementById('model-type-input').value;
                const select = document.getElementById('model-gradio-name-input');

                if (type === 'yolo') {
                    select.innerHTML = '<option value="N/A">N/A</option>';
                } else if (type === 'gradio') {
                    select.innerHTML = `
                        <option value="Data Matrix">Data Matrix</option>
                        <option value="Dental Implant">Dental Implant</option>
                        <option value="Ball Pen">Ball Pen</option>
                        <option value="Knit Up">Knit Up</option>
                        <option value="Knit Back">Knit Back</option>
                        <option value="Jean Back">Jean Back</option>
                        <option value="Jean Up">Jean Up</option>
                        <option value="Tire Cord">Tire Cord</option>
                        <option value="predict">predict</option>
                        <option value="N/A">N/A</option>
                    `;
                }
            }

            function renderPipelinesList(pipelines, currentPipeline) {
                const container = document.getElementById('pipelines-list');
                const pipelineNames = Object.keys(pipelines);

                if (pipelineNames.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No pipelines configured</span>';
                    return;
                }

                container.innerHTML = '';
                pipelineNames.forEach(name => {
                    const pipeline = pipelines[name];
                    const isActive = name === currentPipeline;
                    const pipelineDiv = document.createElement('div');
                    pipelineDiv.style.cssText = `padding: 10px; background: ${isActive ? 'rgba(59, 130, 246, 0.15)' : 'rgba(30, 41, 59, 0.6)'}; border: 2px solid ${isActive ? 'var(--primary-color)' : 'var(--border-color)'}; border-radius: 6px; min-width: 200px;`;

                    const phaseModels = pipeline.phases.map(p => p.model_id).join(' -> ') || 'No models';
                    pipelineDiv.innerHTML = `
                        <div>
                            <strong style="font-size: 14px; color: var(--text-primary);">${pipeline.name}</strong>
                            ${isActive ? '<span style="margin-left: 8px; padding: 2px 6px; background: var(--primary-color); color: white; border-radius: 3px; font-size: 10px;">ACTIVE</span>' : ''}
                            <div style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">${pipeline.description || 'No description'}</div>
                            <div style="margin-top: 4px; font-size: 10px; color: var(--text-secondary);">Phases: ${phaseModels}</div>
                            <div style="margin-top: 8px; display: flex; gap: 4px;">
                                ${!isActive ? `<button onclick="activatePipeline('${name}')" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Activate</button>` : ''}
                                <button onclick="loadPipelineForEdit('${name}')" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(pipelineDiv);
                });
            }

            function renderModelsList(models) {
                const container = document.getElementById('models-list');
                const modelIds = Object.keys(models);

                if (modelIds.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No models configured</span>';
                    return;
                }

                container.innerHTML = '';
                modelIds.forEach(id => {
                    const model = models[id];
                    const modelDiv = document.createElement('div');
                    modelDiv.style.cssText = 'padding: 10px; background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-color); border-radius: 4px;';
                    modelDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <strong style="font-size: 14px; color: var(--text-primary);">${model.name}</strong>
                                <span style="margin-left: 8px; padding: 2px 6px; background: ${model.model_type === 'gradio' ? '#17a2b8' : '#28a745'}; color: white; border-radius: 3px; font-size: 10px;">${model.model_type.toUpperCase()}</span>
                                <div style="margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
                                    Model: ${model.model_name} | Confidence: ${model.confidence_threshold}
                                </div>
                                <div style="margin-top: 2px; font-size: 10px; color: var(--text-secondary); word-break: break-all;">${model.inference_url}</div>
                            </div>
                            <div style="display: flex; gap: 4px; margin-left: 10px;">
                                <button onclick="loadModelForEdit('${id}')" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Edit</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(modelDiv);
                });
            }

            function renderModelsChecklist(models) {
                const container = document.getElementById('pipeline-models-checklist');
                const modelIds = Object.keys(models);

                if (modelIds.length === 0) {
                    container.innerHTML = '<span style="color: #666; font-style: italic;">No models available</span>';
                    return;
                }

                container.innerHTML = '';
                modelIds.forEach(id => {
                    const model = models[id];
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: #e9ecef; border-radius: 4px; cursor: pointer;';
                    label.innerHTML = `
                        <input type="checkbox" name="pipeline-model" value="${id}">
                        <span>${model.name}</span>
                    `;
                    container.appendChild(label);
                });
            }

            function loadPipelineForEdit(pipelineName) {
                const pipeline = pipelineData.pipelines[pipelineName];
                if (!pipeline) return;

                document.getElementById('pipeline-name-input').value = pipeline.name;
                document.getElementById('pipeline-desc-input').value = pipeline.description || '';

                // Check the models in this pipeline
                const checkboxes = document.querySelectorAll('input[name="pipeline-model"]');
                const pipelineModelIds = pipeline.phases.map(p => p.model_id);
                checkboxes.forEach(cb => {
                    cb.checked = pipelineModelIds.includes(cb.value);
                });
            }

            function loadModelForEdit(modelId) {
                const model = pipelineData.models[modelId];
                if (!model) return;

                document.getElementById('model-name-input').value = model.name;
                document.getElementById('model-type-input').value = model.model_type || 'gradio';
                document.getElementById('model-url-input').value = model.inference_url;
                document.getElementById('model-confidence-input').value = model.confidence_threshold;

                const modelSelect = document.getElementById('model-gradio-name-input');
                const modelValue = model.model_name;
                let found = false;
                for (let option of modelSelect.options) {
                    if (option.value === modelValue) {
                        modelSelect.value = modelValue;
                        found = true;
                        break;
                    }
                }
                if (!found && modelValue) {
                    const option = document.createElement('option');
                    option.value = modelValue;
                    option.textContent = modelValue;
                    modelSelect.appendChild(option);
                    modelSelect.value = modelValue;
                }
            }

            async function activatePipeline(pipelineName) {
                const responseEl = document.getElementById('pipeline-response');
                try {
                    const response = await fetch(`/api/pipelines/activate/${pipelineName}`, { method: 'POST' });
                    const result = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Pipeline '${pipelineName}' activated!`;
                        responseEl.className = 'control-response success';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to activate pipeline';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function createOrUpdatePipeline() {
                const pipelineName = document.getElementById('pipeline-name-input').value.trim();
                const description = document.getElementById('pipeline-desc-input').value.trim();
                const responseEl = document.getElementById('pipeline-response');

                if (!pipelineName) {
                    responseEl.textContent = 'Please enter a pipeline name';
                    responseEl.className = 'control-response error';
                    return;
                }

                // Get selected models
                const checkboxes = document.querySelectorAll('input[name="pipeline-model"]:checked');
                const phases = Array.from(checkboxes).map((cb, idx) => ({
                    model_id: cb.value,
                    enabled: true,
                    order: idx
                }));

                if (phases.length === 0) {
                    responseEl.textContent = 'Please select at least one model for the pipeline';
                    responseEl.className = 'control-response error';
                    return;
                }

                try {
                    const response = await fetch('/api/pipelines', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: pipelineName,
                            description: description,
                            phases: phases,
                            enabled: true
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        responseEl.textContent = `Pipeline '${pipelineName}' saved!`;
                        responseEl.className = 'control-response success';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to save pipeline';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function deletePipeline() {
                const pipelineName = document.getElementById('pipeline-name-input').value.trim();
                const responseEl = document.getElementById('pipeline-response');

                if (!pipelineName || !confirm(`Delete pipeline '${pipelineName}'?`)) return;

                try {
                    const response = await fetch(`/api/pipelines/${pipelineName}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Pipeline '${pipelineName}' deleted!`;
                        responseEl.className = 'control-response success';
                        document.getElementById('pipeline-name-input').value = '';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to delete pipeline';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function createOrUpdateModel() {
                const modelName = document.getElementById('model-name-input').value.trim();
                const modelType = document.getElementById('model-type-input').value;
                const modelGradioName = document.getElementById('model-gradio-name-input').value;
                const modelConfidence = parseFloat(document.getElementById('model-confidence-input').value);
                const modelUrl = document.getElementById('model-url-input').value.trim();
                const responseEl = document.getElementById('model-response');

                if (!modelName || !modelUrl) {
                    responseEl.textContent = 'Please fill in Model Name and URL';
                    responseEl.className = 'control-response error';
                    return;
                }

                // Generate model_id from name (lowercase, underscores)
                const modelId = modelName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                try {
                    const response = await fetch('/api/models', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_id: modelId,
                            name: modelName,
                            model_type: modelType,
                            model_name: modelGradioName,
                            confidence_threshold: modelConfidence,
                            inference_url: modelUrl
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        responseEl.textContent = `Model '${modelName}' saved!`;
                        responseEl.className = 'control-response success';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to save model';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            async function deleteModel() {
                const modelName = document.getElementById('model-name-input').value.trim();
                const responseEl = document.getElementById('model-response');

                if (!modelName) {
                    responseEl.textContent = 'Please enter a model name to delete';
                    responseEl.className = 'control-response error';
                    return;
                }

                const modelId = modelName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                if (!confirm(`Delete model '${modelName}'?`)) return;

                try {
                    const response = await fetch(`/api/models/${modelId}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok) {
                        responseEl.textContent = `Model '${modelName}' deleted!`;
                        responseEl.className = 'control-response success';
                        document.getElementById('model-name-input').value = '';
                        refreshPipelineConfig();
                    } else {
                        responseEl.textContent = result.error || 'Failed to delete model';
                        responseEl.className = 'control-response error';
                    }
                } catch (error) {
                    responseEl.textContent = 'Error: ' + error.message;
                    responseEl.className = 'control-response error';
                }
                setTimeout(() => { responseEl.textContent = ''; responseEl.className = 'control-response'; }, 3000);
            }

            // Legacy compatibility - keep old function name
            function refreshInferenceConfig() {
                refreshPipelineConfig();
            }

            // ===== Camera Discovery Functions =====
            async function scanForCameras() {
                const subnet = document.getElementById('subnet-input').value.trim();
                const scanButton = document.getElementById('scan-button');
                const statusContainer = document.getElementById('discovery-status-container');
                const camerasContainer = document.getElementById('discovered-cameras-container');

                // Validate subnet
                if (!subnet || !/^\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(subnet)) {
                    statusContainer.innerHTML = '<div class="discovery-status error">Invalid subnet format. Use format like: 192.168.0</div>';
                    return;
                }

                // Disable button and show scanning status
                scanButton.disabled = true;
                scanButton.textContent = '🔄 Scanning...';
                statusContainer.innerHTML = '<div class="discovery-status scanning">⏳ Scanning network ' + subnet + '.0/24 for camera devices... (Quick port scan, ~30 seconds)</div>';
                camerasContainer.innerHTML = '';

                try {
                    const response = await fetch('/api/cameras/discover', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subnet })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        statusContainer.innerHTML = `<div class="discovery-status success">✓ Scan complete! Found ${result.count} potential camera device(s) on subnet ${result.subnet}.0/24</div>`;

                        if (result.cameras && result.cameras.length > 0) {
                            displayDiscoveredCameras(result.cameras);
                        } else {
                            camerasContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No cameras found on this network. Check if cameras are powered on and connected to the network.</p>';
                        }
                    } else {
                        statusContainer.innerHTML = `<div class="discovery-status error">❌ Error: ${result.error || 'Scan failed'}</div>`;
                        camerasContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Discovery error:', error);
                    statusContainer.innerHTML = `<div class="discovery-status error">❌ Error: ${error.message}</div>`;
                    camerasContainer.innerHTML = '';
                } finally {
                    scanButton.disabled = false;
                    scanButton.textContent = '🔎 Scan Network';
                }
            }

            function displayDiscoveredCameras(cameras) {
                const container = document.getElementById('discovered-cameras-container');
                container.innerHTML = '<div class="discovered-cameras-list">' + cameras.map((cam, idx) => {
                    const pathsHtml = cam.paths.map((p, pidx) => `
                        <div style="margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666; font-family: monospace; margin-bottom: 5px;">Path ${pidx + 1}: ${p.path}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="camera-${idx}-path-${pidx}-username" placeholder="Username" value="admin" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 120px;">
                                <input type="password" id="camera-${idx}-path-${pidx}-password" placeholder="Password" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 120px;">
                                <button class="test-camera-button" onclick='testCameraPath(${idx}, ${pidx}, "${p.url}", "${cam.ip}", "${p.path}")'>
                                    🎥 Test & Preview
                                </button>
                            </div>
                        </div>
                    `).join('');

                    return `
                        <div class="discovered-camera-item" id="discovered-camera-${idx}" style="display: block; grid-template-columns: none;">
                            <div style="margin-bottom: 10px;">
                                <div class="discovered-camera-ip">📹 ${cam.ip} (${cam.protocol}:${cam.port})</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Found ${cam.paths.length} possible camera path(s) - test each with credentials:</div>
                            </div>
                            ${pathsHtml}
                        </div>
                    `;
                }).join('') + '</div>';
            }

            async function testCameraPath(camIdx, pathIdx, url, ip, path) {
                const username = document.getElementById(`camera-${camIdx}-path-${pathIdx}-username`).value.trim();
                const password = document.getElementById(`camera-${camIdx}-path-${pathIdx}-password`).value;
                const button = event.target;

                button.disabled = true;
                button.textContent = '⏳ Testing...';

                try {
                    const response = await fetch('/api/cameras/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, username, password })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Show camera preview (pass both display URL and full URL)
                        showCameraPreview(ip, path, result.image, result.resolution, result.authenticated_url, result.full_url);
                        button.textContent = '✓ Success!';
                        button.style.background = '#218838';
                        setTimeout(() => {
                            button.textContent = '🎥 Test & Preview';
                            button.style.background = '#28a745';
                        }, 2000);
                    } else {
                        alert(`Camera test failed: ${result.error || 'Unable to connect'}\n\nTry checking:\n- Username and password are correct\n- This specific path works for your camera model\n- Camera is powered on and connected\n- Network connectivity`);
                        button.textContent = '❌ Failed';
                        button.style.background = '#dc3545';
                        setTimeout(() => {
                            button.textContent = '🎥 Test & Preview';
                            button.style.background = '#28a745';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Test error:', error);
                    alert(`Error testing camera: ${error.message}`);
                    button.textContent = '❌ Error';
                    button.style.background = '#dc3545';
                    setTimeout(() => {
                        button.textContent = '🎥 Test & Preview';
                        button.style.background = '#28a745';
                    }, 2000);
                } finally {
                    button.disabled = false;
                }
            }

            // Store current camera details for saving
            let currentCameraDetails = null;

            function showCameraPreview(ip, path, imageData, resolution, authenticatedUrl, fullUrl) {
                const modal = document.getElementById('camera-preview-modal');
                const title = document.getElementById('preview-camera-title');
                const info = document.getElementById('preview-camera-info');
                const image = document.getElementById('preview-camera-image');
                const nameInput = document.getElementById('save-camera-name');

                // Store camera details for saving (use fullUrl which has credentials)
                currentCameraDetails = {
                    ip: ip,
                    path: path,
                    url: fullUrl || authenticatedUrl,  // Use full URL with credentials for saving
                    resolution: resolution
                };

                // Auto-suggest camera name
                nameInput.value = `Camera ${ip}`;

                title.textContent = `Camera Preview - ${ip}`;
                info.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>IP:</strong> ${ip}<br>
                        <strong>Path:</strong> <span style="font-family: monospace; font-size: 12px;">${path}</span><br>
                        <strong>URL:</strong> <span style="font-family: monospace; font-size: 12px;">${authenticatedUrl || 'N/A'}</span><br>
                        <strong>Resolution:</strong> ${resolution.width} x ${resolution.height}
                    </div>
                `;
                image.src = imageData;

                modal.style.display = 'flex';
            }

            function closeCameraPreview(event) {
                if (!event || event.target.id === 'camera-preview-modal') {
                    document.getElementById('camera-preview-modal').style.display = 'none';
                    currentCameraDetails = null;
                }
            }

            async function saveDiscoveredCamera() {
                if (!currentCameraDetails) {
                    alert('No camera details available to save');
                    return;
                }

                const nameInput = document.getElementById('save-camera-name');
                const cameraName = nameInput.value.trim() || `Camera ${currentCameraDetails.ip}`;
                const saveButton = document.getElementById('save-camera-button');

                saveButton.disabled = true;
                saveButton.textContent = '💾 Saving...';

                try {
                    const response = await fetch('/api/cameras/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: cameraName,
                            ip: currentCameraDetails.ip,
                            url: currentCameraDetails.url,
                            path: currentCameraDetails.path,
                            resolution: currentCameraDetails.resolution
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        saveButton.textContent = '✓ Saved!';
                        saveButton.style.background = '#28a745';

                        // Show success message
                        alert(`Camera "${cameraName}" saved successfully!\n\nYou can now use this camera in the Camera Monitoring section.`);

                        // Refresh camera status to show the new camera
                        setTimeout(() => {
                            fetchCameraStatus();
                            closeCameraPreview();
                        }, 1000);
                    } else {
                        alert(`Failed to save camera: ${result.error || 'Unknown error'}`);
                        saveButton.textContent = '💾 Save Camera';
                        saveButton.style.background = '#007bff';
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert(`Error saving camera: ${error.message}`);
                    saveButton.textContent = '💾 Save Camera';
                    saveButton.style.background = '#007bff';
                } finally {
                    saveButton.disabled = false;
                }
            }

            // Initial camera status fetch (SSE will handle updates)
            fetchCameraStatus();
            checkServiceConfigStatus();  // Check if saved service config exists

            // Fetch and update inference stats
            async function fetchInferenceStats() {
                try {
                    const response = await fetch('/api/inference/stats');
                    const data = await response.json();

                    // Update state name
                    const stateNameEl = document.getElementById('inference-state-name');
                    if (stateNameEl) {
                        const stateName = data.state_name || 'unknown';
                        stateNameEl.textContent = stateName;
                    }

                    // Update service name
                    const serviceNameEl = document.getElementById('inference-service-name');
                    if (serviceNameEl) {
                        serviceNameEl.textContent = data.service_type || '...';
                    }

                    // Update inference processing time (capture to result)
                    const timeValueEl = document.getElementById('inference-time-value');
                    if (timeValueEl) {
                        if (data.avg_inference_time_ms > 0) {
                            timeValueEl.textContent = data.avg_inference_time_ms + ' ms';
                        } else {
                            timeValueEl.textContent = 'N/A';
                        }
                    }

                    // Update frame interval (time between frames)
                    const intervalValueEl = document.getElementById('frame-interval-value');
                    if (intervalValueEl) {
                        if (data.avg_frame_interval_ms > 0) {
                            intervalValueEl.textContent = data.avg_frame_interval_ms + ' ms';
                        } else {
                            intervalValueEl.textContent = 'N/A';
                        }
                    }

                    // Update inference FPS (convert ms to FPS: 1000/ms)
                    const inferenceFpsValueEl = document.getElementById('inference-fps-value');
                    if (inferenceFpsValueEl) {
                        if (data.inference_fps > 0) {
                            const infMs = parseFloat(data.inference_fps);
                            const infFps = 1000 / infMs; // Convert ms to FPS
                            inferenceFpsValueEl.textContent = infFps.toFixed(2);

                            // Color-code based on milliseconds performance
                            if (infMs < 100) {
                                inferenceFpsValueEl.style.color = 'var(--success-color)'; // Fast: <100ms (>10 FPS) - green
                            } else if (infMs < 300) {
                                inferenceFpsValueEl.style.color = '#FFA500'; // Acceptable: 100-300ms (3-10 FPS) - orange
                            } else if (infMs < 1000) {
                                inferenceFpsValueEl.style.color = 'var(--warning-color)'; // Slow: 300-1000ms (1-3 FPS) - yellow
                            } else {
                                inferenceFpsValueEl.style.color = 'var(--danger-color)'; // Very slow: >1000ms (<1 FPS) - red
                            }

                            // Trigger inference heartbeat animation
                            pulseHeartbeat('inference-heartbeat');
                        } else {
                            inferenceFpsValueEl.textContent = 'N/A';
                        }
                    }

                    // Update capture FPS (based on camera capture rate)
                    const captureFpsValueEl = document.getElementById('capture-fps-value');
                    if (captureFpsValueEl) {
                        if (data.capture_fps !== undefined && data.capture_fps !== null) {
                            captureFpsValueEl.textContent = data.capture_fps.toFixed(2);
                            // Trigger capture heartbeat animation
                            pulseHeartbeat('capture-heartbeat');
                        } else {
                            captureFpsValueEl.textContent = 'N/A';
                        }
                    }

                    // Queue Status Monitoring - Compare Capture vs Inference FPS
                    updateQueueStatus(data);
                } catch (error) {
                    console.error('Error fetching inference stats:', error);
                }
            }

            // Queue Status Monitor - Visual alarm when queue is building up
            function updateQueueStatus(data) {
                const queueBar = document.getElementById('queue-status-bar');
                const queueIcon = document.getElementById('queue-icon');
                const queueMessage = document.getElementById('queue-message');
                const queueRatio = document.getElementById('queue-ratio');

                if (!queueBar || !data.inference_fps || !data.capture_fps) return;

                // Calculate FPS values
                const infMs = parseFloat(data.inference_fps);
                const inferenceFps = 1000 / infMs; // Convert ms to FPS
                const captureFps = parseFloat(data.capture_fps);

                // Calculate the ratio: how much faster is capture compared to inference?
                const ratio = captureFps / inferenceFps;

                // Show warning if capture is faster than inference (queue building up)
                if (captureFps > inferenceFps && inferenceFps > 0) {
                    queueBar.style.display = 'flex';
                    queueRatio.textContent = `Cap/Inf: ${ratio.toFixed(2)}x`;

                    // Severity levels based on ratio
                    if (ratio > 3) {
                        // Critical: Capture is 3x faster than inference
                        queueBar.style.background = 'rgba(239, 68, 68, 0.2)'; // Red
                        queueBar.style.border = '1px solid var(--danger-color)';
                        queueBar.style.color = 'var(--danger-color)';
                        queueIcon.textContent = '🚨';
                        queueMessage.textContent = 'CRITICAL: Queue overload!';
                    } else if (ratio > 1.5) {
                        // Warning: Capture is 1.5x faster
                        queueBar.style.background = 'rgba(251, 191, 36, 0.2)'; // Yellow
                        queueBar.style.border = '1px solid var(--warning-color)';
                        queueBar.style.color = 'var(--warning-color)';
                        queueIcon.textContent = '⚠️';
                        queueMessage.textContent = 'WARNING: Queue building up';
                    } else {
                        // Minor: Slightly faster
                        queueBar.style.background = 'rgba(59, 130, 246, 0.2)'; // Blue
                        queueBar.style.border = '1px solid var(--primary-color)';
                        queueBar.style.color = 'var(--primary-color)';
                        queueIcon.textContent = 'ℹ️';
                        queueMessage.textContent = 'Queue accumulating';
                    }
                } else if (inferenceFps > captureFps && captureFps > 0) {
                    // Good: Inference is faster than capture (ideal)
                    queueBar.style.display = 'flex';
                    queueBar.style.background = 'rgba(34, 197, 94, 0.2)'; // Green
                    queueBar.style.border = '1px solid var(--success-color)';
                    queueBar.style.color = 'var(--success-color)';
                    queueIcon.textContent = '✓';
                    queueMessage.textContent = 'OK: Inference keeping up';
                    queueRatio.textContent = `Inf/Cap: ${(inferenceFps / captureFps).toFixed(2)}x`;
                } else {
                    // Hide if no data or equal rates
                    queueBar.style.display = 'none';
                }
            }

            // Heartbeat pulse animation
            function pulseHeartbeat(elementId) {
                const heartbeat = document.getElementById(elementId);
                if (!heartbeat) return;

                // Fade in quickly, fade out slowly
                heartbeat.style.transition = 'opacity 0.15s ease-in';
                heartbeat.style.opacity = '1';

                setTimeout(() => {
                    heartbeat.style.transition = 'opacity 0.5s ease-out';
                    heartbeat.style.opacity = '0';
                }, 150);
            }

            // Poll for latest detections (fallback for audio when SSE isn't working)
            let lastProcessedDetectionTime = 0;
            async function pollLatestDetections() {
                console.log('[Polling] pollLatestDetections() called');
                try {
                    const response = await fetch('/api/latest_detections');
                    console.log('[Polling] Response received:', response.status);
                    const data = await response.json();
                    console.log('[Polling] Data:', data);

                    if (data.has_detection && data.event) {
                        const event = data.event;
                        // Only process if we haven't seen this timestamp before
                        if (event.timestamp !== lastProcessedDetectionTime) {
                            lastProcessedDetectionTime = event.timestamp;
                            console.log('[Polling] New detection event:', event);

                            // Process for audio
                            if (event.details && event.details.detections) {
                                processDetectionForAudio(event.details);
                            }
                        }
                    }
                } catch (e) {
                    console.error('[Polling] Error fetching detections:', e);
                }
            }

            // Fetch and update system metrics
            async function fetchSystemMetrics() {
                try {
                    const response = await fetch('/api/system/metrics');
                    const data = await response.json();

                    // Update CPU
                    const cpuValueEl = document.getElementById('system-cpu-value');
                    const cpuCoresEl = document.getElementById('system-cpu-cores');
                    if (cpuValueEl && data.cpu) {
                        cpuValueEl.textContent = `${data.cpu.percent}%`;
                        if (cpuCoresEl) {
                            cpuCoresEl.textContent = `${data.cpu.cores_logical} cores`;
                        }
                    }

                    // Update RAM
                    const ramValueEl = document.getElementById('system-ram-value');
                    const ramDetailsEl = document.getElementById('system-ram-details');
                    if (ramValueEl && data.memory) {
                        ramValueEl.textContent = `${data.memory.percent}%`;
                        if (ramDetailsEl) {
                            ramDetailsEl.textContent = `${data.memory.used_gb}GB / ${data.memory.total_gb}GB`;
                        }
                    }

                    // Update Disk
                    const diskValueEl = document.getElementById('system-disk-value');
                    const diskDetailsEl = document.getElementById('system-disk-details');
                    if (diskValueEl && data.disk) {
                        diskValueEl.textContent = `${data.disk.percent}%`;
                        if (diskDetailsEl) {
                            diskDetailsEl.textContent = `${data.disk.free_gb}GB free`;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching system metrics:', error);
                }
            }

            // Start Server-Sent Events for real-time status updates (replaces all polling)
            startStatusStream();

            // Load audio settings from localStorage
            loadAudioSettings();

            // Start timeline image refresh
            startTimelineRefresh();

            // Initial inference stats fetch and set up refresh interval
            fetchInferenceStats();
            setInterval(fetchInferenceStats, 2000);  // Update every 2 seconds

            // Initial system metrics fetch and set up refresh interval
            fetchSystemMetrics();
            setInterval(fetchSystemMetrics, 3000);  // Update every 3 seconds

            // Polling disabled - using SSE for audio alerts now
            // pollLatestDetections();
            // setInterval(pollLatestDetections, 1000);

            // Initial config fetch (once on page load)
            fetchConfig();
            fetchHealth();  // Get YOLO status
            loadDataFile();
            refreshStates();
            refreshInferenceConfig();

            // Refresh health status periodically (for YOLO status)
            setInterval(fetchHealth, 10000);

            // Set default API type fields (Gradio with HuggingFace URL)
            updateAPITypeFields();

            // Apply saved language preference
            applyLanguage(currentLang);
        </script>
    </body>
</html>
