<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
        <title>MonitaQC Vision Engine</title>
        <link rel="stylesheet" href="/static/css/main.css">
    </head>
    <body>
        <script src="/static/js/i18n.js"></script>
        <div class="container">
            <!-- Compact Header: 3-column layout (sticky so tabs are always reachable) -->
            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: start; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 100; background: var(--bg-color, #0f172a); padding-top: 12px;">

                <!-- LEFT: Monitait Title (compact) -->
                <div style="min-width: 150px;">
                    <div style="font-size: 18px; font-weight: 700; line-height: 1.2; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        Monitait<br>Vision<br>Engine
                    </div>
                    <div style="font-size: 9px; color: var(--text-secondary); margin-top: 2px;" id="app-version">...</div>
                </div>

                <!-- CENTER: Tab Navigation -->
                <div class="tab-navigation" style="margin: 0; flex: 1;">
                    <button class="tab-button active" onclick="switchTab('dashboard')">üìä <span data-i18n="tab_dashboard">Dashboard</span></button>
                    <button class="tab-button" onclick="switchTab('ai')">ü§ñ <span data-i18n="tab_ai">AI Assistant</span></button>
                    <button class="tab-button" onclick="switchTab('gallery')">üñºÔ∏è <span data-i18n="tab_gallery">Gallery</span></button>
                    <button class="tab-button" onclick="switchTab('grafana')">üìà <span data-i18n="tab_charts">Charts</span></button>
                    <button class="tab-button" onclick="switchTab('hardware')">üîß <span data-i18n="tab_hardware">Hardware</span></button>
                    <button class="tab-button" onclick="switchTab('cameras')">üì∑ <span data-i18n="tab_cameras">Cameras</span></button>
                    <button class="tab-button" onclick="switchTab('infrastructure')">üîÆ <span data-i18n="tab_inference">Inference</span></button>
                    <button class="tab-button" onclick="switchTab('process')">‚öôÔ∏è <span data-i18n="tab_process">Process</span></button>
                    <button class="tab-button" onclick="switchTab('advanced')">‚ö° <span data-i18n="tab_advanced">Advanced</span></button>
                </div>

                <!-- RIGHT: Language + Save -->
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                    <select id="lang-select" onchange="applyLanguage(this.value)" style="padding: 4px 8px; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; font-size: 11px; cursor: pointer; margin-bottom: 2px;">
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="tr">T√ºrk√ße</option>
                        <option value="es">Espa√±ol</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
                    </select>
                    <button onclick="saveAllServiceConfig()" style="padding: 8px 12px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                        üíæ <span data-i18n="save_all">Save All Configuration</span>
                    </button>
                    <div style="font-size: 9px; color: var(--text-secondary);">
                        <span data-i18n="last_saved">Last:</span> <strong id="last-saved-time" style="color: var(--text-primary);"><span data-i18n="never">Never</span></strong>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <div style="display: grid; grid-template-columns: 160px 1fr; gap: 8px;">
                    <!-- Left Column: Compact Stats Grid (fixed 160px) -->
                    <div style="display: flex; flex-direction: column; gap: 5px; min-width: 0;">
                        <!-- Shipment -->
                        <div class="status-box" style="padding: 5px;">
                            <div style="font-size: 8px; color: var(--text-secondary); margin-bottom: 2px;"><span data-i18n="shipment">Shipment</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_shipment">Current shipment/batch ID. Click to edit.</span></span></div>
                            <div id="shipment-value" style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 10px; font-weight: 600;" onclick="editShipmentId()">
                                <span id="shipment-text">-</span>
                                <span style="font-size: 9px; opacity: 0.6;">‚úèÔ∏è</span>
                            </div>
                            <input type="text" id="shipment-input" style="display: none; padding: 3px; border: 2px solid var(--primary-color); border-radius: 3px; font-weight: bold; font-size: 10px; width: 100%;" placeholder="Shipment ID">
                            <div style="display: none; gap: 3px; margin-top: 3px;" id="shipment-buttons">
                                <button onclick="saveShipmentId()" style="padding: 2px 8px; background: var(--success-color); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 9px;">‚úì</button>
                                <button onclick="cancelEditShipment()" style="padding: 2px 8px; background: var(--text-secondary); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 9px;">‚úó</button>
                            </div>
                        </div>

                        <!-- Serial Data Grid (2 columns, stable layout) -->
                        <div class="status-box" style="padding: 5px; font-variant-numeric: tabular-nums;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px 6px;">
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="encoder">Encoder</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_encoder">Rotary encoder position count. Tracks conveyor movement.</span></span></div>
                                    <div style="font-size: 10px; font-weight: 700; color: var(--text-primary);" id="encoder-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="speed">Speed</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_speed">Production speed in pulses per minute (PPM).</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="speed-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="pulses_s">Pulses/s</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_pulses_s">Raw encoder pulses per second.</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="pps-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="movement">Movement</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_movement">Whether the conveyor belt is currently moving.</span></span></div>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span class="movement-indicator" id="movement-indicator" style="width: 7px; height: 7px;"></span>
                                        <span style="font-size: 9px; font-weight: 600;" id="movement-value">-</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ej_queue">Ej Queue</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ej_queue">Number of items waiting to be ejected.</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="ejector-queue">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ej_active">Ej Active</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ej_active">Whether the ejector is currently firing.</span></span></div>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span class="movement-indicator" id="ejector-running-indicator" style="width: 7px; height: 7px;"></span>
                                        <span style="font-size: 9px; font-weight: 600;" id="ejector-running">-</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ej_enable">Ej Enable</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ej_enable">Whether ejection is enabled. Disable to inspect without ejecting.</span></span></div>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span class="movement-indicator" id="ejector-enabled-indicator" style="width: 7px; height: 7px;"></span>
                                        <span style="font-size: 9px; font-weight: 600;" id="ejector-enabled">-</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ej_offset">Ej Offset</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ej_offset">Encoder count delay between camera and ejector position.</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="ejector-offset">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ok">OK</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ok">Total count of items that passed inspection.</span></span></div>
                                    <div style="font-size: 10px; font-weight: 600; color: var(--success-color);" id="ok-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ng">NG</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ng">Total count of rejected (No Good) items.</span></span></div>
                                    <div style="font-size: 10px; font-weight: 600; color: var(--danger-color);" id="ng-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ej_ok">Ej OK</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ej_ok">Software count of frames that passed (no eject).</span></span></div>
                                    <div style="font-size: 10px; font-weight: 600; color: var(--success-color);" id="eject-ok-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="ej_ng">Ej NG</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ej_ng">Software count of frames that triggered ejection.</span></span></div>
                                    <div style="font-size: 10px; font-weight: 600; color: var(--danger-color);" id="eject-ng-counter">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="downtime">Downtime</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_downtime">Seconds since the conveyor last stopped moving.</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="downtime-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="analog">Analog</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_analog">Current analog sensor reading from the hardware.</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="analog-value">-</div>
                                </div>
                                <div>
                                    <div style="font-size: 8px; color: var(--text-secondary);"><span data-i18n="power">Power</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_power">Power supply voltage reading from the hardware.</span></span></div>
                                    <div style="font-size: 9px; font-weight: 600;" id="power-value">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Live Inference Stats -->
                        <div class="status-box" style="padding: 5px;">
                            <div style="font-size: 9px; color: var(--text-secondary); margin-bottom: 4px;">
                                <strong><span data-i18n="capture">Capture</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_capture">Current capture mode and trigger configuration.</span></span>:</strong> <span id="inference-state-name" style="color: var(--primary-color); font-weight: 700;">...</span>
                                <span id="capture-heartbeat" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); margin-left: 4px; opacity: 0;"></span>
                            </div>
                            <div style="font-size: 9px; color: var(--text-secondary); margin-bottom: 4px;">
                                <strong><span data-i18n="inference">Inference</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_inference">AI model used for object detection (local YOLO or remote Gradio).</span></span>:</strong>
                                <strong id="inference-service-name" style="color: var(--primary-color);">...</strong>
                                <span id="inference-heartbeat" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); margin-left: 4px; opacity: 0;"></span>
                                <span id="gradio-restart-warning" style="display: none; color: var(--danger-color); font-weight: bold;"> ‚ö†Ô∏è</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 9px;">
                                <div><span data-i18n="latency">Latency</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_latency">Time to process one frame through the inference model (ms).</span></span>: <strong id="inference-time-value">...</strong></div>
                                <div><span data-i18n="inf_fps">Inf</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_inf_fps">Inference frames per second ‚Äî how fast the model processes.</span></span>: <strong id="inference-fps-value" style="color: inherit;">...</strong></div>
                                <div><span data-i18n="cap_fps">Cap</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_cap_fps">Capture frames per second ‚Äî how fast the camera captures.</span></span>: <strong id="capture-fps-value">...</strong>
                                    <span id="capture-heartbeat" style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--success-color); margin-left: 2px; opacity: 0;"></span>
                                </div>
                            </div>
                            <!-- Queue Status Indicator -->
                            <div id="queue-status-bar" style="margin-top: 6px; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; display: none; flex-wrap: wrap; align-items: center; gap: 4px;">
                                <span id="queue-icon">‚ö†Ô∏è</span>
                                <span id="queue-message" style="flex: 1; min-width: 0;">Queue building up</span>
                            </div>
                            <!-- Queue Usage Charts -->
                            <div style="margin-top: 6px; display: flex; gap: 8px; font-size: 8px; color: var(--text-secondary);">
                                <span style="flex: 1;"><span data-i18n="disk_queue">Disk Queue</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_disk_queue">Frames waiting to be saved to disk. High values mean disk I/O is slow.</span></span></span>
                                <span style="flex: 1;"><span data-i18n="inf_queue">Inference Queue</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_inf_queue">Frames waiting for AI analysis. Hot (red) = urgent for ejector, Cold (blue) = historical.</span></span></span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1;">
                                    <canvas id="disk-queue-chart" height="50" style="width: 100%; border-radius: 4px; background: rgba(0,0,0,0.2);"></canvas>
                                </div>
                                <div style="flex: 1;">
                                    <canvas id="inf-queue-chart" height="50" style="width: 100%; border-radius: 4px; background: rgba(0,0,0,0.2);"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- System Resources -->
                        <div class="status-box" style="padding: 5px;">
                            <div style="font-size: 8px; color: var(--text-secondary); margin-bottom: 3px;">üíª <span data-i18n="system">System</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_system">Live server resource usage.</span></span></div>
                            <div style="font-size: 9px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px;">
                                <div><span data-i18n="cpu">CPU</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_cpu">CPU usage percentage and core count.</span></span>: <strong id="system-cpu-value" style="color: var(--primary-color);">...</strong><br><span id="system-cpu-cores" style="font-size: 8px; color: var(--text-secondary);">...</span></div>
                                <div><span data-i18n="ram">RAM</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_ram">Memory usage percentage and total available.</span></span>: <strong id="system-ram-value" style="color: var(--primary-color);">...</strong><br><span id="system-ram-details" style="font-size: 8px; color: var(--text-secondary);">...</span></div>
                                <div><span data-i18n="disk">Disk</span> <span class="info-tooltip-sm">i<span class="info-tooltip-text" data-i18n="tip_disk">Disk usage percentage and total capacity.</span></span>: <strong id="system-disk-value" style="color: var(--primary-color);">...</strong><br><span id="system-disk-details" style="font-size: 8px; color: var(--text-secondary);">...</span></div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column: Camera Timeline -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Camera Timeline Slideshow with Embedded Controls -->
                        <div class="status-box" style="padding: 15px;">

                            <!-- Slideshow Container -->
                            <div id="timeline-slideshow-container" style="position: relative; background: #111; border: 2px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                <div id="timeline-slide-wrapper" style="width: 100%; height: 500px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                    <img id="timeline-slide" src="/timeline_image?page=0" style="max-width: 100%; max-height: 100%; width: auto; height: auto; user-select: none; display: block; object-fit: contain;" alt="Timeline" draggable="false" />
                                </div>

                                <!-- Navigation Footer -->
                                <div id="timeline-footer" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--border-color); flex-wrap: wrap;">
                                    <button id="timeline-first" class="timeline-nav-btn" title="First">&laquo;</button>
                                    <button id="timeline-prev" class="timeline-nav-btn" title="Previous">&larr;</button>
                                    <button id="timeline-next" class="timeline-nav-btn" title="Next">&rarr;</button>
                                    <button id="timeline-last" class="timeline-nav-btn" title="Last">&raquo;</button>
                                    <span style="width: 1px; height: 20px; background: var(--border-color); margin: 0 4px;"></span>
                                    <button id="timeline-zoom-in" class="timeline-nav-btn" title="Zoom In">+</button>
                                    <button id="timeline-reset-zoom" class="timeline-nav-btn" title="Reset Zoom">Reset</button>
                                    <button id="timeline-zoom-out" class="timeline-nav-btn" title="Zoom Out">‚Äì</button>
                                    <span style="width: 1px; height: 20px; background: var(--border-color); margin: 0 4px;"></span>
                                    <button id="timeline-toggle-auto" class="timeline-nav-btn" title="Stop/Resume Auto-Update">Stop</button>
                                    <span id="timeline-counter" style="font-size: 13px; font-weight: bold; color: #fff; margin-left: 8px;">1 / 1</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- End Dashboard Tab -->

            <!-- Cameras Tab -->
            <div id="tab-cameras" class="tab-content">
                <!-- Camera Discovery Section -->
                <div class="discovery-section">
                <div class="section-header">
                    <h2>üîç <span data-i18n="camera_discovery">IP Camera Discovery</span></h2>
                </div>

                <div class="discovery-controls">
                    <div class="discovery-input-group">
                        <label for="subnet-input">Network Subnet (first 3 octets)</label>
                        <input type="text" id="subnet-input" class="discovery-input" value="192.168.0" placeholder="192.168.0">
                        <small style="color: #666; font-size: 11px;">Scan for IP cameras on this subnet</small>
                    </div>
                    <div class="discovery-input-group" style="display: flex; align-items: flex-end;">
                        <button id="scan-button" class="discovery-button" onclick="scanForCameras()">üîé Scan Network</button>
                    </div>
                </div>

                <div id="discovery-status-container"></div>

                <div id="discovered-cameras-container"></div>
            </div>

            <!-- Camera Preview Modal -->
            <div id="camera-preview-modal" class="camera-preview-modal" onclick="closeCameraPreview(event)">
                <div class="camera-preview-content" onclick="event.stopPropagation()">
                    <div class="camera-preview-header">
                        <h3 id="preview-camera-title">Camera Preview</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="save-camera-button" class="discovery-button" onclick="saveDiscoveredCamera()" style="padding: 8px 16px;">üíæ Save Camera</button>
                            <button class="camera-preview-close" onclick="closeCameraPreview()">Close</button>
                        </div>
                    </div>
                    <div id="preview-camera-info"></div>
                    <img id="preview-camera-image" class="camera-preview-image" src="" alt="Camera preview">
                    <div id="preview-camera-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Camera Name (optional):</label>
                            <input type="text" id="save-camera-name" placeholder="e.g., Front Door Camera, Line 1 Camera" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Monitoring Section -->
            <div class="camera-monitor-section">
                <div class="section-header">
                    <h2>üì∑ <span data-i18n="camera_monitoring">Camera Monitoring</span></h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="camera-refresh-status" id="camera-refresh-status">Active</span>
                        <button class="control-button" style="width: auto; padding: 6px 12px;" onclick="refreshCameras()">üîÑ Refresh</button>
                    </div>
                </div>

                <div id="camera-grid" class="camera-grid">
                    <div class="camera-loading">Loading camera controls...</div>
                </div>
            </div>

            <!-- Legacy Camera Status Table (kept for backward compatibility) -->
            <div id="legacy-camera-status-container" style="display: none;">
                <h2>Camera Connection Status</h2>
                <table class="camera-table">
                    <thead>
                        <tr>
                            <th>Camera</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="camera-table-body">
                        <tr><td colspan="2">Loading...</td></tr>
                    </tbody>
                </table>

                <div class="control-section">
                    <h3 data-i18n="state_management">State Management (Camera Capture Control)</h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Current State:</span>
                            <span id="current-state-name" style="font-size: 16px; font-weight: bold; color: #007bff;">Loading...</span>
                            <span id="capture-state-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="camera-btn camera-btn-success" onclick="triggerCapture()">Trigger Capture</button>
                            <button class="camera-btn camera-btn-primary" onclick="refreshStates()">Refresh</button>
                        </div>
                        <div id="state-message" style="margin-top: 8px; padding: 6px 10px; border-radius: 4px; font-size: 12px; display: none;"></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Available States</h4>
                        <div id="states-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading states...</span>
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Create/Edit State (Multi-Phase Capture)</h4>
                        <div class="control-grid" style="margin-bottom: 15px;">
                            <div class="control-item">
                                <div class="control-label" data-i18n="state_name">State Name</div>
                                <input type="text" class="control-input" id="state-name-input" placeholder="e.g., default">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="enabled">Enabled</div>
                                <select class="control-input" id="state-enabled-input">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5 style="margin: 0; color: #495057;">Capture Phases</h5>
                                <button class="camera-btn camera-btn-success" onclick="addPhase()" style="padding: 4px 10px; font-size: 11px;">+ Add Phase</button>
                            </div>

                            <div id="phases-container">
                                <!-- Phase 1 (default) - all cameras -->
                                <div class="phase-row" id="phase-row-0" style="display: grid; grid-template-columns: 1.2fr 0.8fr 1fr 0.8fr 0.8fr auto; gap: 6px; align-items: end; margin-bottom: 8px; padding: 8px; background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(51, 65, 85, 0.4); border-radius: 4px;">
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Light Mode <span class="info-tooltip">i<span class="info-tooltip-text">Which lights to turn on/off during this capture phase.</span></span></label>
                                        <select class="control-input phase-light" style="margin: 0; padding: 4px; font-size: 12px;">
                                            <option value="U_ON_B_OFF" selected>U On, B Off</option>
                                            <option value="U_OFF_B_ON">U Off, B On</option>
                                            <option value="U_ON_B_ON">U On, B On</option>
                                            <option value="U_OFF_B_OFF">U Off, B Off</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Delay (s) <span class="info-tooltip">i<span class="info-tooltip-text">Wait time in seconds after setting lights, before capturing.</span></span></label>
                                        <input type="number" class="control-input phase-delay" value="0.1" min="0" step="0.01" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Cameras <span class="info-tooltip">i<span class="info-tooltip-text">Comma-separated camera IDs to capture in this phase.</span></span></label>
                                        <input type="text" class="control-input phase-cameras" value="1,2,3,4" placeholder="1,2,3,4" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Steps (-1=loop) <span class="info-tooltip">i<span class="info-tooltip-text">Capture every N encoder steps. -1 = continuous capture loop.</span></span></label>
                                        <input type="number" class="control-input phase-steps" value="1" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: #666;">Analog (-1=off) <span class="info-tooltip">i<span class="info-tooltip-text">Analog sensor threshold. -1 = disabled. N = trigger when value >= N.</span></span></label>
                                        <input type="number" class="control-input phase-analog" value="-1" min="-1" step="1" style="margin: 0; padding: 4px; font-size: 12px;">
                                    </div>
                                    <button class="camera-btn camera-btn-danger" onclick="removePhase(0)" style="padding: 4px 8px; font-size: 11px;">‚úï</button>
                                </div>
                            </div>
                            <p style="font-size: 10px; color: #888; margin: 8px 0 0 0;">Steps: -1=infinite loop, 1=every step, N=every N steps. Analog: -1=disabled, N=trigger when analog‚â•N.</p>
                        </div>

                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="control-button" style="background-color: #28a745;" onclick="createOrUpdateState()">Create/Update State</button>
                            <button class="control-button" style="background-color: #dc3545;" onclick="deleteCurrentState()">Delete State</button>
                        </div>
                        <div class="control-response" id="state-config-response"></div>
                    </div>
                </div>

            </div>
            </div>
            <!-- End Cameras Tab -->

            <!-- Hardware Tab -->
            <div id="tab-hardware" class="tab-content">
                <h2 style="margin: 0 0 20px 0; color: var(--text-primary); font-weight: 600;" data-i18n="hardware_config">Hardware Configuration</h2>

                <!-- Status Indicators -->
                <div class="control-section">
                    <h3 data-i18n="status_indicators">Status Indicators</h3>
                    <div class="status-box" style="padding: 16px;">
                        <div class="status-indicators" style="justify-content: center; gap: 40px;">
                            <div class="status-indicator">
                                <div class="status-circle U" id="U-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">U (Upper)</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-circle B" id="B-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">B (Bottom)</span>
                            </div>
                            <div class="status-indicator">
                                <div class="status-circle warning" id="warning-status"></div>
                                <span style="font-size: 14px; font-weight: 600;">Warning</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Controls -->
                <div class="control-section">
                    <h3 data-i18n="basic_controls">Basic Controls</h3>
                    <div class="control-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="control-item" style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 10px;">
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('U_ON_B_ON')">Both On</button>
                                <div class="control-response" id="cmd-U_ON_B_ON-response"></div>
                            </div>
                            <div class="control-item" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <button class="control-button" onclick="sendCommand('U_ON_B_OFF')">U On, B Off</button>
                                    <div class="control-response" id="cmd-U_ON_B_OFF-response"></div>
                                </div>
                                <div>
                                    <button class="control-button" onclick="sendCommand('B_ON_U_OFF')">B On, U Off</button>
                                    <div class="control-response" id="cmd-B_ON_U_OFF-response"></div>
                                </div>
                            </div>
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('B_OFF_U_OFF')">Both Off</button>
                                <div class="control-response" id="cmd-B_OFF_U_OFF-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="upper_pwm">Upper PWM Value (0-255)</div>
                                <input type="number" class="control-input" id="pwm-up" min="0" max="255" value="255">
                                <button class="control-button" onclick="sendCommand('U_SET_PWM', document.getElementById('pwm-up').value)">Set Upper PWM</button>
                                <div class="control-response" id="cmd-U_SET_PWM-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="bottom_pwm">Bottom PWM Value (0-255)</div>
                                <input type="number" class="control-input" id="pwm-down" min="0" max="255" value="255">
                                <button class="control-button" onclick="sendCommand('B_SET_PWM', document.getElementById('pwm-down').value)">Set Bottom PWM</button>
                                <div class="control-response" id="cmd-B_SET_PWM-response"></div>
                            </div>
                        </div>
                        <div class="control-item" style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 10px;">
                            <div class="control-item">
                                <button class="control-button" onclick="sendCommand('RESET_ENCODER')">Reset Encoder</button>
                                <div class="control-response" id="cmd-RESET_ENCODER-response"></div>
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="warning_led">Warning LED</div>
                                <button class="control-button" onclick="sendCommand('WARNING_ON')">Warning On</button>
                                <button class="control-button" onclick="sendCommand('WARNING_OFF')" style="margin-top: 5px;">Warning Off</button>
                                <div class="control-response" id="cmd-WARNING-response"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Serial Port Configuration -->
                <div class="control-section">
                    <h3 data-i18n="serial_config">Serial Port Configuration</h3>
                    <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Device Status:</span>
                            <span id="serial-device-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="serial-device-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="serial-device-text" style="color: var(--text-primary);">Checking...</span>
                            </span>
                            <span id="serial-device-info" style="font-size: 12px; color: var(--text-secondary);"></span>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="serial_port">Serial Port Device</div>
                            <input type="text" class="control-input" id="watcher-usb-input" value="/dev/ttyUSB0" placeholder="/dev/ttyUSB0">
                            <button class="control-button" onclick="updateConfig('watcher_usb', document.getElementById('watcher-usb-input').value)">Set Port</button>
                            <div class="control-response" id="config-watcher_usb-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="baud_rate">Baud Rate</div>
                            <select class="control-input" id="baud-rate-input">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600" selected>57600</option>
                                <option value="115200">115200</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('baud_rate', document.getElementById('baud-rate-input').value)">Set Baud Rate</button>
                            <div class="control-response" id="config-baud_rate-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="serial_mode">Serial Mode</div>
                            <select class="control-input" id="serial-mode-input">
                                <option value="new" selected>Normal</option>
                                <option value="legacy">Legacy</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('serial_mode', document.getElementById('serial-mode-input').value)">Set Mode</button>
                            <div class="control-response" id="config-serial_mode-response"></div>
                        </div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: var(--primary-color);">
                        ‚ÑπÔ∏è <strong>Auto-Apply:</strong> Serial port settings are applied immediately when changed. The connection will be reinitialized automatically.
                    </div>
                </div>

                <div class="control-section">
                    <h3 data-i18n="watcher_config">Watcher Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="downtime_threshold">Downtime Threshold (seconds)</div>
                            <input type="number" class="control-input" id="downtime-threshold" min="1" value="10">
                            <button class="control-button" onclick="sendCommand('SET_DOWNTIME', document.getElementById('downtime-threshold').value)">Set Threshold</button>
                            <div class="control-response" id="cmd-SET_DOWNTIME-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="external_reset">External Reset</div>
                            <select class="control-input" id="external-reset">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                            <button class="control-button" onclick="sendCommand('SET_EXTERNAL_RESET', document.getElementById('external-reset').value)">Set External Reset</button>
                            <div class="control-response" id="cmd-SET_EXTERNAL_RESET-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="verbose_mode">Verbose Mode</div>
                            <select class="control-input" id="verbose-mode">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                            <button class="control-button" onclick="sendCommand('SET_VERBOSE', document.getElementById('verbose-mode').value)">Set Verbose Mode</button>
                            <div class="control-response" id="cmd-SET_VERBOSE-response"></div>
                        </div>
                    </div>
                    <div class="verbose-panel" style="margin-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Watcher Verbose Configuration (Read-only)</h4>
                        <div class="verbose-grid">
                            <div>
                                <div class="verbose-item-label">OK Offset Delay (OOD)</div>
                                <div class="verbose-item-value" id="v-ood">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Duration Pulses (ODP)</div>
                                <div class="verbose-item-value" id="v-odp">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Duration Percent (ODL)</div>
                                <div class="verbose-item-value" id="v-odl">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">OK Encoder Factor (OEF)</div>
                                <div class="verbose-item-value" id="v-oef">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Offset Delay (NOD)</div>
                                <div class="verbose-item-value" id="v-nod">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Duration Pulses (NDP)</div>
                                <div class="verbose-item-value" id="v-ndp">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Duration Percent (NDL)</div>
                                <div class="verbose-item-value" id="v-ndl">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">NG Encoder Factor (NEF)</div>
                                <div class="verbose-item-value" id="v-nef">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">External Reset (EXT)</div>
                                <div class="verbose-item-value" id="v-ext">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">Baud Rate (BUD)</div>
                                <div class="verbose-item-value" id="v-bud">-</div>
                            </div>
                            <div>
                                <div class="verbose-item-label">Downtime Threshold (DWT)</div>
                                <div class="verbose-item-value" id="v-dwt">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Hardware Tab -->

            <!-- Inference Tab -->
            <div id="tab-infrastructure" class="tab-content">
                <div class="control-section">
                    <h3 data-i18n="inference_status">Inference Status</h3>
                    <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Pipeline:</span>
                            <span id="pipeline-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="pipeline-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="pipeline-text" style="color: var(--text-primary);">Checking...</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3 data-i18n="pipeline_management">Inference Pipeline Management</h3>
                    <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Active Pipeline:</span>
                            <span id="current-pipeline-name" style="font-size: 16px; font-weight: bold; color: var(--primary-color);">Loading...</span>
                            <span style="color: var(--text-secondary);">|</span>
                            <span style="font-weight: bold; color: var(--text-primary);">Current Model:</span>
                            <span id="current-model-name" style="font-size: 16px; font-weight: bold; color: var(--success-color);">Loading...</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="camera-btn camera-btn-primary" onclick="refreshPipelineConfig()">Refresh</button>
                        </div>
                    </div>

                    <!-- PIPELINES SECTION -->
                    <div style="background: rgba(30, 41, 59, 0.4); border: 2px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px;">Pipeline Configuration</h4>

                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Available Pipelines</h5>
                            <div id="pipelines-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                <span style="color: var(--text-secondary); font-style: italic;">Loading pipelines...</span>
                            </div>
                        </div>

                        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Create/Edit Pipeline</h5>
                            <div class="control-grid" style="margin-bottom: 15px;">
                                <div class="control-item">
                                    <div class="control-label">Pipeline Name <span style="color: #dc3545;">*</span></div>
                                    <input type="text" class="control-input" id="pipeline-name-input" placeholder="e.g., defect_detection">
                                </div>
                                <div class="control-item">
                                    <div class="control-label">Description</div>
                                    <input type="text" class="control-input" id="pipeline-desc-input" placeholder="Pipeline description...">
                                </div>
                                <div class="control-item" style="grid-column: span 2;">
                                    <div class="control-label">Models in Pipeline (select models to include)</div>
                                    <div id="pipeline-models-checklist" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px;">
                                        <span style="color: var(--text-secondary); font-style: italic;">Loading models...</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="control-button" style="background-color: var(--primary-color);" onclick="createOrUpdatePipeline()">Create/Update Pipeline</button>
                                <button class="control-button" style="background-color: var(--danger-color);" onclick="deletePipeline()">Delete Pipeline</button>
                            </div>
                            <div class="control-response" id="pipeline-response"></div>
                        </div>
                    </div>

                    <!-- MODELS SECTION -->
                    <div style="background: rgba(30, 41, 59, 0.4); border: 2px solid var(--success-color); border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--success-color); border-bottom: 2px solid var(--success-color); padding-bottom: 8px;">Inference Models</h4>

                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Available Models</h5>
                            <div id="models-list" style="display: flex; flex-direction: column; gap: 10px;">
                                <span style="color: var(--text-secondary); font-style: italic;">Loading models...</span>
                            </div>
                        </div>

                        <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                            <h5 style="margin: 0 0 10px 0; color: var(--text-primary);">Create/Edit Model</h5>
                            <!-- Row 1: Name, Type, URL, Confidence ‚Äî all on one line -->
                            <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 10px;">
                                <div style="flex: 1; min-width: 120px;">
                                    <label style="font-size: 10px; color: var(--text-secondary);">Name <span style="color: #dc3545;">*</span></label>
                                    <input type="text" class="control-input" id="model-name-input" placeholder="e.g., Local YOLO" style="margin: 0;">
                                </div>
                                <div style="min-width: 80px;">
                                    <label style="font-size: 10px; color: var(--text-secondary);">Type <span style="color: #dc3545;">*</span></label>
                                    <select class="control-input" id="model-type-input" onchange="handleModelTypeChange()" style="margin: 0;">
                                        <option value="gradio">Gradio</option>
                                        <option value="yolo">YOLO</option>
                                    </select>
                                </div>
                                <div style="flex: 2; min-width: 180px;">
                                    <label style="font-size: 10px; color: var(--text-secondary);">Inference URL <span style="color: #dc3545;">*</span></label>
                                    <input type="text" class="control-input" id="model-url-input" placeholder="http://yolo_inference:4442/..." onchange="fetchModelsFromGradio()" style="margin: 0;">
                                </div>
                                <!-- Gradio model name (shown when type=gradio) -->
                                <div id="gradio-name-section" style="min-width: 120px;">
                                    <label style="font-size: 10px; color: var(--text-secondary);">Gradio Model</label>
                                    <select class="control-input" id="model-gradio-name-input" style="margin: 0;">
                                        <option value="Data Matrix">Data Matrix</option>
                                        <option value="Dental Implant">Dental Implant</option>
                                        <option value="Ball Pen">Ball Pen</option>
                                        <option value="Knit Up">Knit Up</option>
                                        <option value="Knit Back">Knit Back</option>
                                        <option value="Jean Back">Jean Back</option>
                                        <option value="Jean Up">Jean Up</option>
                                        <option value="Tire Cord">Tire Cord</option>
                                        <option value="predict">predict</option>
                                        <option value="N/A">N/A</option>
                                    </select>
                                </div>
                                <div style="min-width: 80px;">
                                    <label style="font-size: 10px; color: var(--text-secondary);">Confidence</label>
                                    <input type="number" class="control-input" id="model-confidence-input" min="0" max="1" step="0.05" value="0.25" style="margin: 0;">
                                </div>
                                <button class="control-button" style="font-size: 11px; padding: 6px 10px; white-space: nowrap; margin: 0;" onclick="fetchModelsFromGradio()">Fetch</button>
                                <button class="control-button" style="background-color: #28a745; font-size: 11px; padding: 6px 10px; white-space: nowrap; margin: 0;" onclick="createOrUpdateModel()">Save</button>
                                <button class="control-button" style="background-color: #dc3545; font-size: 11px; padding: 6px 10px; white-space: nowrap; margin: 0;" onclick="deleteModel()">Delete</button>
                            </div>
                            <!-- Row 2: YOLO weights (shown when type=yolo) -->
                            <div id="yolo-weights-section" style="display: none; margin-bottom: 8px;">
                                <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                    <select class="control-input" id="yolo-weights-select" style="flex: 2; min-width: 150px; margin: 0;">
                                        <option value="">-- Select weight --</option>
                                    </select>
                                    <button class="control-button" style="font-size: 11px; padding: 6px 10px; white-space: nowrap;" onclick="activateExistingWeights()">Activate</button>
                                    <input type="file" id="yolo-weights-file" accept=".pt" style="font-size: 11px; color: var(--text-secondary); flex: 1; min-width: 120px;">
                                    <button class="control-button" style="font-size: 11px; padding: 6px 10px; white-space: nowrap; background-color: #0d6efd;" onclick="uploadWeightsFile()">Upload .pt</button>
                                </div>
                                <div id="yolo-classes-display" style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 4px;"></div>
                            </div>
                            <div class="control-response" id="model-response"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Inference Tab -->

            <!-- Gallery Tab (iframe created dynamically - no static iframe in DOM) -->
            <div id="tab-gallery" class="tab-content">
                <div id="gallery-iframe-container" style="width: 100%; height: calc(100vh - 120px); min-height: 400px;">
                    <!-- iframe injected dynamically by loadIframeForTab() -->
                </div>
            </div>
            <!-- End Gallery Tab -->

            <!-- Grafana Tab (iframe created dynamically - no static iframe in DOM) -->
            <div id="tab-grafana" class="tab-content">
                <div id="grafana-iframe-container" style="width: 100%; height: calc(100vh - 120px); min-height: 400px;">
                    <!-- iframe injected dynamically by loadIframeForTab() -->
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: #0c5460;">üìä Grafana Dashboard</h4>
                    <p style="margin: 0; font-size: 13px; color: #0c5460;">
                        <strong>Default Credentials:</strong> admin / admin<br>
                        <strong>TimescaleDB Connection:</strong><br>
                        ‚Ä¢ Host: <code>timescaledb:5432</code><br>
                        ‚Ä¢ Database: <code>monitaqc</code><br>
                        ‚Ä¢ User: <code>monitaqc</code><br>
                        ‚Ä¢ Password: <code>monitaqc2024</code>
                    </p>
                </div>
            </div>
            <script src="/static/js/iframes.js"></script>
            <!-- End Grafana Tab -->

            <!-- AI Assistant Tab -->
            <div id="tab-ai" class="tab-content">
                <div style="height: calc(100vh - 150px);">
                    <!-- Chat Interface -->
                    <div style="display: flex; flex-direction: column; background: rgba(30, 41, 59, 0.4); border-radius: 8px; box-shadow: var(--shadow-md); overflow: hidden; height: 100%; border: 1px solid rgba(51, 65, 85, 0.6);">
                        <!-- Chat Header -->
                        <div style="padding: 15px 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 18px;">ü§ñ AI Analytics Assistant</h3>
                                <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">Ask me about production data, defects, and quality metrics</p>
                            </div>
                            <button onclick="clearChatHistory()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                üóëÔ∏è Clear History
                            </button>
                        </div>

                        <!-- Chat Messages -->
                        <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(15, 23, 42, 0.3);">
                            <div style="padding: 15px; background: rgba(30, 41, 59, 0.6); border-radius: 8px; border-left: 4px solid var(--primary-color); margin-bottom: 15px; box-shadow: var(--shadow-sm);">
                                <p style="margin: 0 0 10px 0; font-weight: 600; color: var(--text-primary);">üëã Welcome! Try asking:</p>
                                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: var(--text-primary); line-height: 1.8;">
                                    <li>What's the defect rate for the last hour?</li>
                                    <li>Show me the most common defect types today</li>
                                    <li>Compare production speed vs quality metrics</li>
                                    <li>Analyze trends in the last 24 hours</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div style="padding: 15px; background: rgba(30, 41, 59, 0.6); border-top: 1px solid rgba(51, 65, 85, 0.6);">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input
                                    type="text"
                                    id="ai-input"
                                    class="control-input"
                                    placeholder="Type your question here..."
                                    style="flex: 1; margin: 0; font-size: 14px; min-width: 0; width: 100%;"
                                    onkeypress="if(event.key === 'Enter') sendAIMessage()"
                                >
                                <button class="control-button" onclick="sendAIMessage()" style="background: var(--primary-color); padding: 8px 12px; font-size: 20px; white-space: nowrap; width: 50px; flex-shrink: 0;">
                                    üöÄ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End AI Assistant Tab -->

            <!-- Process Tab -->
            <div id="tab-process" class="tab-content">
                <h2 style="margin: 0 0 20px 0; color: var(--text-primary); font-weight: 600;" data-i18n="process_config">‚öôÔ∏è Process Configuration</h2>

                <!-- Ejector Configuration (from Hardware) -->
                <div class="control-section">
                    <h3 data-i18n="ejector_config">Ejector Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="ejector_enabled">Ejector Enabled</div>
                            <select class="control-input" id="ejector-enabled-input">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('ejector_enabled', document.getElementById('ejector-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-ejector_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="ejector_offset">Ejector Offset (encoder counts)</div>
                            <input type="number" class="control-input" id="ejector-offset-input" min="0" value="1">
                            <button class="control-button" onclick="updateConfig('ejector_offset', document.getElementById('ejector-offset-input').value)">Set Offset</button>
                            <div class="control-response" id="config-ejector_offset-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="ejector_duration">Ejector Duration (seconds)</div>
                            <input type="number" class="control-input" id="ejector-duration-input" min="0" step="0.01" value="0.01">
                            <button class="control-button" onclick="updateConfig('ejector_duration', document.getElementById('ejector-duration-input').value)">Set Duration</button>
                            <div class="control-response" id="config-ejector_duration-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="class_count_check">Class Count Check (equal counts)</div>
                            <select class="control-input" id="check-class-enabled-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('check_class_counts_enabled', document.getElementById('check-class-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-check_class_counts_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="classes_to_check">Classes to Check (comma-separated)</div>
                            <input type="text" class="control-input" id="check-class-classes-input" value="socket,nozzle">
                            <button class="control-button" onclick="updateConfig('check_class_counts_classes', document.getElementById('check-class-classes-input').value)">Set Classes</button>
                            <div class="control-response" id="config-check_class_counts_classes-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="class_confidence">Class Count Confidence Threshold</div>
                            <input type="number" class="control-input" id="check-class-confidence-input" value="0.5" min="0" max="1" step="0.05">
                            <button class="control-button" onclick="updateConfig('check_class_counts_confidence', document.getElementById('check-class-confidence-input').value)">Set</button>
                            <div class="control-response" id="config-check_class_counts_confidence-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="capture_mode">Capture Mode</div>
                            <select class="control-input" id="capture-mode-input">
                                <option value="single">Single</option>
                                <option value="multiple">Multiple</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('capture_mode', document.getElementById('capture-mode-input').value)">Set Mode</button>
                            <div class="control-response" id="config-capture_mode-response"></div>
                        </div>
                    </div>

                    <!-- Ejection Procedures -->
                    <div style="margin-top: 15px; background: rgba(30, 41, 59, 0.3); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                            <h4 style="margin: 0; color: #ef4444;">Ejection Procedures</h4>
                            <button onclick="addProcedure()" class="control-button" style="padding: 5px 10px; font-size: 12px; background: #ef4444;">+ Add Procedure</button>
                        </div>
                        <div id="procedures-list">
                            <div style="padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 6px; text-align: center; color: var(--text-secondary); font-style: italic;">
                                No ejection procedures configured.
                            </div>
                        </div>
                        <div style="margin-top: 10px; text-align: right;">
                            <button onclick="saveProcedures()" class="control-button" style="padding: 6px 14px; font-size: 12px; background: var(--success-color);">Save Procedures</button>
                            <span id="procedures-save-status" style="margin-left: 8px; font-size: 12px; color: var(--text-secondary);"></span>
                        </div>
                    </div>
                </div>

                <!-- OK Configuration (from Hardware) -->
                <div class="control-section">
                    <h3 data-i18n="ok_config">OK Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="ok_counter_adj">OK Counter Adjustment</div>
                            <input type="number" class="control-input" id="ok-adjust" value="0">
                            <button class="control-button" onclick="sendCommand('OK_ADJUST', document.getElementById('ok-adjust').value)">Adjust OK Counter</button>
                            <div class="control-response" id="cmd-OK_ADJUST-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="offset_delay">Offset Delay (milliseconds)</div>
                            <input type="number" class="control-input" id="ok-offset-delay" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('OK_OFFSET_DELAY', document.getElementById('ok-offset-delay').value)">Set Offset Delay</button>
                            <div class="control-response" id="cmd-OK_OFFSET_DELAY-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="duration_pulses">Duration Pulses (16us each)</div>
                            <input type="number" class="control-input" id="ok-duration-pulses" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('OK_DURATION_PULSES', document.getElementById('ok-duration-pulses').value)">Set Duration Pulses</button>
                            <div class="control-response" id="cmd-OK_DURATION_PULSES-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="duration_percent">Duration Percent</div>
                            <input type="number" class="control-input" id="ok-duration-percent" min="0" max="100" value="0">
                            <button class="control-button" onclick="sendCommand('OK_DURATION_PERCENT', document.getElementById('ok-duration-percent').value)">Set Duration Percent</button>
                            <div class="control-response" id="cmd-OK_DURATION_PERCENT-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="encoder_factor">Encoder Factor</div>
                            <input type="number" class="control-input" id="ok-encoder-factor" value="0">
                            <button class="control-button" onclick="sendCommand('OK_ENCODER_FACTOR', document.getElementById('ok-encoder-factor').value)">Set Encoder Factor</button>
                            <div class="control-response" id="cmd-OK_ENCODER_FACTOR-response"></div>
                        </div>
                    </div>
                </div>

                <!-- NG Configuration (from Hardware) -->
                <div class="control-section">
                    <h3 data-i18n="ng_config">NG Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="ng_counter_adj">NG Counter Adjustment</div>
                            <input type="number" class="control-input" id="ng-adjust" value="0">
                            <button class="control-button" onclick="sendCommand('NG_ADJUST', document.getElementById('ng-adjust').value)">Adjust NG Counter</button>
                            <div class="control-response" id="cmd-NG_ADJUST-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="offset_delay">Offset Delay (milliseconds)</div>
                            <input type="number" class="control-input" id="ng-offset-delay" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('NG_OFFSET_DELAY', document.getElementById('ng-offset-delay').value)">Set Offset Delay</button>
                            <div class="control-response" id="cmd-NG_OFFSET_DELAY-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="duration_pulses">Duration Pulses (16us each)</div>
                            <input type="number" class="control-input" id="ng-duration-pulses" min="0" value="0">
                            <button class="control-button" onclick="sendCommand('NG_DURATION_PULSES', document.getElementById('ng-duration-pulses').value)">Set Duration Pulses</button>
                            <div class="control-response" id="cmd-NG_DURATION_PULSES-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="duration_percent">Duration Percent</div>
                            <input type="number" class="control-input" id="ng-duration-percent" min="0" max="100" value="0">
                            <button class="control-button" onclick="sendCommand('NG_DURATION_PERCENT', document.getElementById('ng-duration-percent').value)">Set Duration Percent</button>
                            <div class="control-response" id="cmd-NG_DURATION_PERCENT-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="encoder_factor">Encoder Factor</div>
                            <input type="number" class="control-input" id="ng-encoder-factor" value="0">
                            <button class="control-button" onclick="sendCommand('NG_ENCODER_FACTOR', document.getElementById('ng-encoder-factor').value)">Set Encoder Factor</button>
                            <div class="control-response" id="cmd-NG_ENCODER_FACTOR-response"></div>
                        </div>
                    </div>
                </div>

                <!-- Per-Object Detection & Alerts (from Advanced) -->
                <div class="control-section">
                    <h3>Per-Object Detection & Alerts</h3>
                    <div style="background: rgba(30, 41, 59, 0.3); padding: 15px; border-radius: 8px; border: 1px solid rgba(51, 65, 85, 0.6);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                            <h4 style="margin: 0; color: var(--text-primary);">Per-Object Detection & Alerts</h4>
                            <button onclick="fetchModelClasses()" class="control-button" style="padding: 5px 10px; font-size: 12px; background: var(--secondary-color);">Fetch Classes</button>
                        </div>

                        <!-- Per-Object Cards (dynamically populated) -->
                        <div id="audio-objects-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                            <div style="padding: 15px; background: rgba(15, 23, 42, 0.5); border-radius: 6px; text-align: center; color: var(--text-secondary); font-style: italic;">
                                No objects detected yet. Start detection to see objects here.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Processing Configuration (from Cameras) -->
                <div class="control-section">
                    <h3 data-i18n="image_processing">Image Processing Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item" style="grid-column: span 2;">
                            <div class="control-label" data-i18n="parent_objects">Parent Object List (comma-separated, use _root for no parent requirement)</div>
                            <input type="text" class="control-input" id="parent-object-list-input" value="_root,box,pack,DP-105,jean,knit">
                            <button class="control-button" onclick="updateConfig('parent_object_list', document.getElementById('parent-object-list-input').value)">Set Parent Objects</button>
                            <div class="control-response" id="config-parent_object_list-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="remove_raw">Remove Raw Image After DM Decode</div>
                            <select class="control-input" id="remove-raw-image-input">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('remove_raw_image_when_dm_decoded', document.getElementById('remove-raw-image-input').value)">Set</button>
                            <div class="control-response" id="config-remove_raw_image_when_dm_decoded-response"></div>
                        </div>
                    </div>
                </div>

                <!-- DataMatrix Configuration (from Cameras) -->
                <div class="control-section">
                    <h3 data-i18n="dm_config">DataMatrix Configuration</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="valid_dm_sizes">Valid DM Char Sizes (comma-separated)</div>
                            <input type="text" class="control-input" id="dm-chars-sizes-input" value="13,19,26">
                            <button class="control-button" onclick="updateConfig('dm_chars_sizes', document.getElementById('dm-chars-sizes-input').value)">Set Sizes</button>
                            <div class="control-response" id="config-dm_chars_sizes-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="confidence_threshold">Confidence Threshold (0-1)</div>
                            <input type="number" class="control-input" id="dm-confidence-input" min="0" max="1" step="0.05" value="0.8">
                            <button class="control-button" onclick="updateConfig('dm_confidence_threshold', document.getElementById('dm-confidence-input').value)">Set Confidence</button>
                            <div class="control-response" id="config-dm_confidence_threshold-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="overlap_threshold">Overlap Threshold (0-1)</div>
                            <input type="number" class="control-input" id="dm-overlap-input" min="0" max="1" step="0.05" value="0.2">
                            <button class="control-button" onclick="updateConfig('dm_overlap_threshold', document.getElementById('dm-overlap-input').value)">Set Overlap</button>
                            <div class="control-response" id="config-dm_overlap_threshold-response"></div>
                        </div>
                    </div>
                </div>

                <!-- Feature Toggles (from Cameras) -->
                <div class="control-section">
                    <h3 data-i18n="feature_toggles">Feature Toggles</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="histogram_feature">Histogram Feature</div>
                            <select class="control-input" id="histogram-enabled-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('histogram_enabled', document.getElementById('histogram-enabled-input').value)">Set</button>
                            <div class="control-response" id="config-histogram_enabled-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="save_histogram">Save Histogram Images</div>
                            <select class="control-input" id="histogram-save-image-input">
                                <option value="false" selected>Disabled</option>
                                <option value="true">Enabled</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('histogram_save_image', document.getElementById('histogram-save-image-input').value)">Set</button>
                            <div class="control-response" id="config-histogram_save_image-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="light_status">Light Status Check (closed-loop)</div>
                            <select class="control-input" id="light-status-check-input">
                                <option value="false" selected>Disabled (open-loop, faster)</option>
                                <option value="true">Enabled (verify via serial)</option>
                            </select>
                            <button class="control-button" onclick="updateConfig('light_status_check_enabled', document.getElementById('light-status-check-input').value)">Set</button>
                            <div class="control-response" id="config-light_status_check_enabled-response"></div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End Process Tab -->

            <!-- Advanced Tab -->
            <div id="tab-advanced" class="tab-content">
                <!-- Timeline Configuration Section -->
                <div class="control-section">
                    <h3>‚öôÔ∏è <span data-i18n="timeline_config">Timeline Configuration</span></h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="camera_order">Camera Order (Columns)</div>
                            <div style="display: flex; gap: 12px; margin-top: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                    <input type="radio" name="camera-order" value="normal" checked>
                                    <span data-i18n="ascending">Ascending (1‚Üí2‚Üí3...)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                    <input type="radio" name="camera-order" value="reverse">
                                    <span data-i18n="descending">Descending (...3‚Üí2‚Üí1)</span>
                                </label>
                            </div>
                        </div>

                        <div class="control-item">
                            <div class="control-label" data-i18n="image_rotation">Image Rotation</div>
                            <select id="timeline-rotation" class="control-input" style="margin-top: 8px;">
                                <option value="0">0¬∞</option>
                                <option value="90">90¬∞</option>
                                <option value="180">180¬∞</option>
                                <option value="270">270¬∞</option>
                            </select>
                        </div>

                        <div class="control-item">
                            <div class="control-label">Image Quality: <strong id="timeline-quality-value">85%</strong></div>
                            <input type="range" id="timeline-quality" min="50" max="100" value="85" style="width: 100%; margin-top: 8px; cursor: pointer;">
                        </div>

                        <div class="control-item">
                            <div class="control-label">Rows per Page: <strong id="timeline-rows-value">10</strong></div>
                            <input type="range" id="timeline-rows" min="1" max="50" value="10" style="width: 100%; margin-top: 8px; cursor: pointer;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Frames displayed per page</div>
                        </div>

                        <div class="control-item">
                            <div class="control-label">Total Frames Stored: <strong id="timeline-buffer-value">20</strong></div>
                            <input type="range" id="timeline-buffer" min="10" max="5000" value="20" step="10" style="width: 100%; margin-top: 8px; cursor: pointer;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Total frames kept in history (affects pages)</div>
                        </div>

                        <div class="control-item" style="grid-column: span 2;">
                            <button id="timeline-apply-config" class="control-button" style="background: var(--primary-color); color: white; font-weight: 600; padding: 10px 20px;">
                                ‚úì Apply Timeline Configuration
                            </button>
                            <div class="control-response" id="timeline-config-response"></div>
                        </div>
                    </div>

                </div>

                <!-- Redis Configuration Section -->
                <div class="control-section">
                    <h3>üî¥ <span data-i18n="redis_config">Redis Configuration</span></h3>
                    <div style="background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; color: var(--text-primary);">Redis:</span>
                            <span id="redis-status-indicator" style="display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                <span id="redis-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></span>
                                <span id="redis-text" style="color: var(--text-primary);">Checking...</span>
                            </span>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label" data-i18n="redis_host">Redis Host</div>
                            <input type="text" class="control-input" id="redis-host-input" value="redis" placeholder="redis">
                            <button class="control-button" onclick="updateConfig('redis_host', document.getElementById('redis-host-input').value)">Set Host</button>
                            <div class="control-response" id="config-redis_host-response"></div>
                        </div>
                        <div class="control-item">
                            <div class="control-label" data-i18n="redis_port">Redis Port</div>
                            <input type="number" class="control-input" id="redis-port-input" value="6379" placeholder="6379">
                            <button class="control-button" onclick="updateConfig('redis_port', document.getElementById('redis-port-input').value)">Set Port</button>
                            <div class="control-response" id="config-redis_port-response"></div>
                        </div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 12px; color: var(--primary-color);">
                        ‚ÑπÔ∏è <strong>Auto-Apply:</strong> Redis settings are applied immediately when changed. Connection will be reinitialized automatically.
                    </div>
                </div>

                <!-- AI Configuration Section -->
                <div class="control-section">
                    <h3>üîë <span data-i18n="ai_config">AI Configuration</span></h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Active Model:</span>
                            <span id="ai-active-model-name" style="font-size: 16px; font-weight: bold; color: #007bff;">None</span>
                            <span id="ai-active-model-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Configured Models</h4>
                        <div id="ai-models-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading models...</span>
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Add / Edit Model</h4>
                        <div class="control-grid">
                            <div class="control-item">
                                <div class="control-label" data-i18n="model_name">Model Name</div>
                                <input type="text" class="control-input" id="ai-model-name" placeholder="e.g., My ChatGPT">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="provider">Provider</div>
                                <select id="ai-model-provider" class="control-input" onchange="updateAIModelFields()">
                                    <option value="claude">Claude (Anthropic)</option>
                                    <option value="chatgpt">ChatGPT (OpenAI)</option>
                                    <option value="gemini">Gemini (Google)</option>
                                    <option value="local">Local Model (Ollama)</option>
                                </select>
                            </div>
                            <div class="control-item">
                                <div class="control-label" id="api-key-label" data-i18n="api_key">API Key</div>
                                <input type="password" id="ai-api-key" class="control-input" placeholder="sk-ant-...">
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <button class="camera-btn camera-btn-success" onclick="saveAIModel()">Save Model</button>
                            <button class="camera-btn camera-btn-secondary" onclick="clearAIModelForm()">Clear</button>
                            <span style="margin-left: auto; font-size: 12px; color: var(--text-secondary);">
                                <a id="ai-api-link" href="https://console.anthropic.com/" target="_blank" style="color: var(--primary-color);">Get API Key</a>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Database Configuration Section -->
                <div class="control-section">
                    <h3>‚öôÔ∏è <span data-i18n="db_config">Database Configuration</span></h3>
                    <div style="background: #f0f8ff; border: 1px solid #b0d0ff; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">Active Profile:</span>
                            <span id="db-active-profile-name" style="font-size: 16px; font-weight: bold; color: #007bff;">None</span>
                            <span id="db-active-profile-badge" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background-color: #6c757d; color: white;">-</span>
                            <div id="db-status" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; background: var(--warning-color); color: white;">Checking...</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">Configured Profiles</h4>
                        <div id="db-profiles-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: #666; font-style: italic;">Loading profiles...</span>
                        </div>
                    </div>

                    <div style="background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(51, 65, 85, 0.6); border-radius: 6px; padding: 12px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Add / Edit Profile</h4>
                        <div class="control-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="control-item">
                                <div class="control-label" data-i18n="profile_name">Profile Name</div>
                                <input type="text" class="control-input" id="db-profile-name" placeholder="e.g., Production">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="host">Host</div>
                                <input type="text" class="control-input" id="db-host" placeholder="timescaledb">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="port">Port</div>
                                <input type="number" class="control-input" id="db-port" value="5432">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="database">Database</div>
                                <input type="text" class="control-input" id="db-database" placeholder="monitaqc">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="user">User</div>
                                <input type="text" class="control-input" id="db-user" placeholder="monitaqc">
                            </div>
                            <div class="control-item">
                                <div class="control-label" data-i18n="password">Password</div>
                                <input type="password" class="control-input" id="db-password" placeholder="***">
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                            <button class="camera-btn camera-btn-success" onclick="saveDBProfile()">Save Profile</button>
                            <button class="camera-btn camera-btn-secondary" onclick="clearDBProfileForm()">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Audio Alerts section merged into Timeline Configuration above -->

                <!-- Data File Editor Section -->
                <div class="control-section">
                    <h3>üìù Data File Editor</h3>
                    <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div>
                            <span class="control-label">File: </span><span id="data-file-path">Loading...</span>
                        </div>
                        <button class="control-button" style="width: auto;" onclick="loadDataFile()">Reload</button>
                        <div style="flex: 1;"></div>
                        <button onclick="exportServiceConfig()" style="padding: 8px 12px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            ‚¨áÔ∏è Export Config
                        </button>
                        <button onclick="importServiceConfig()" style="padding: 8px 12px; background: var(--warning-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap;">
                            ‚¨ÜÔ∏è Import Config
                        </button>
                        <div class="data-source" id="dataSource" style="font-size: 11px; padding: 4px 8px; background: var(--light-bg); border-radius: 4px;">Loading...</div>
                    </div>
                    <textarea id="data-file-content" class="control-input" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="control-button" style="background-color: #6c757d;" onclick="formatDataFile()">Format JSON</button>
                    </div>
                    <div class="control-response" id="data-file-response"></div>
                    <div style="margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #17a2b8; border-radius: 4px; font-size: 12px; color: #0c5460;">
                        ‚ÑπÔ∏è <strong>Note:</strong> Use the "üíæ Save" button at the top of the page to save both service config and data file.
                    </div>
                </div>
            </div>
            <!-- End Advanced Tab -->
        </div>

        <!-- Global tooltip (lives outside all stacking contexts so it's never clipped) -->
        <div id="global-tooltip" style="display:none; position:fixed; z-index:999999; background:#1a2332; color:#e2e8f0; border:1px solid rgba(100,160,255,0.4); border-radius:6px; padding:8px 12px; font-size:11px; line-height:1.4; max-width:260px; pointer-events:none; box-shadow:0 4px 16px rgba(0,0,0,0.4);"></div>

        <script src="/static/js/audio.js"></script>
        <script src="/static/js/app-core.js"></script>
    </body>
</html>
